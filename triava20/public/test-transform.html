<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Test /api/transform</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    .box { border: 1px solid #ccc; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end }
    input[type="text"], input[type="number"], textarea, select { padding:8px 10px; border-radius:8px; border:1px solid #bbb; min-width:220px }
    textarea { min-width:360px; min-height:68px }
    button { padding:10px 14px; border:0; border-radius:10px; background:#0b5cff; color:#fff; cursor:pointer }
    button.secondary { background:#444 }
    button:disabled { opacity:.6; cursor:not-allowed }
    #drop { border:2px dashed #bbb; border-radius:12px; padding:24px; text-align:center }
    canvas,img { max-width:100%; border-radius:12px; background:#f6f6f6 }
    pre{ white-space:pre-wrap; background:#0e0e0e; color:#e7e7e7; padding:12px; border-radius:10px; overflow:auto }
    small.mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace }
  </style>
</head>
<body>
  <h1>Prueba de <code>/api/transform</code></h1>

  <div class="box">
    <div class="row">
      <div><label>Endpoint</label><input id="endpoint" type="text" value="/api/transform"></div>
      <div><label>Modelo (opcional)</label><input id="model" type="text" placeholder="google/gemini-2.5-flash-image-preview"></div>
      <div><label>Ratio</label>
        <select id="ratio">
          <option value="3:4" selected>3:4</option><option>1:1</option><option>4:3</option><option>16:9</option>
        </select>
      </div>
      <div><label>Máx lado (px)</label><input id="maxSide" type="number" min="256" max="2048" step="64" value="1280"></div>
      <div style="display:flex; gap:10px; align-items:center;">
        <input id="strict" type="checkbox" checked /><label for="strict">Identidad estricta</label>
      </div>
      <div style="flex:1 1 360px; min-width:360px">
        <label>Instrucciones extra (opcional)</label>
        <textarea id="extra" placeholder="Ej.: mantiene gafas, no cambies peinado, no agregues traje..."></textarea>
      </div>
      <div><button id="runBtn" disabled>Enviar</button></div>
      <div><button id="quickBtn" class="secondary" disabled>Modo rápido 600×800</button></div>
    </div>
  </div>

  <div class="box" id="drop">
    <input id="file" type="file" accept="image/*" hidden>
    <p><strong>Arrastra una imagen aquí</strong> o <button id="pickBtn" type="button">elige un archivo</button></p>
    <small class="mono">Se comprimirá a JPEG y máx. 1280px para ahorrar ancho de banda.</small>
  </div>

  <div class="row">
    <div class="box" style="flex:1 1 360px;min-width:320px">
      <h3>Entrada (normalizada)</h3><canvas id="inCanvas"></canvas>
      <small id="metaIn" class="mono"></small>
    </div>
    <div class="box" style="flex:1 1 360px;min-width:320px">
      <h3>Salida</h3><img id="outImg" alt="Resultado" />
    </div>
  </div>

  <div class="box"><h3>Log / depuración</h3><pre id="log">Esperando imagen…</pre></div>

<script>
const $ = id => document.getElementById(id);
const fileInput = $('file'), pickBtn = $('pickBtn'), drop = $('drop');
const inCanvas = $('inCanvas'), outImg = $('outImg'), metaIn = $('metaIn');
const runBtn = $('runBtn'), quickBtn = $('quickBtn'), logEl = $('log');
const endpointEl = $('endpoint'), modelEl = $('model'), ratioEl = $('ratio'), maxSideEl = $('maxSide');
const strictEl = $('strict'), extraEl = $('extra');

let source = null;
function log(x){ logEl.textContent = typeof x==='string' ? x : JSON.stringify(x,null,2); }

pickBtn.onclick = () => fileInput.click();
fileInput.onchange = () => fileInput.files[0] && handleFile(fileInput.files[0]);
['dragenter','dragover'].forEach(evn => drop.addEventListener(evn, e => { e.preventDefault(); drop.style.background='#eef3ff'; }));
['dragleave','drop'].forEach(evn => drop.addEventListener(evn, e => { e.preventDefault(); drop.style.background=''; }));
drop.addEventListener('drop', e => { const f=e.dataTransfer.files?.[0]; if(f) handleFile(f); });

function handleFile(file){
  const url = URL.createObjectURL(file);
  const img = new Image();
  img.onload = () => { source = img; URL.revokeObjectURL(url); normalizeAndPreview(); runBtn.disabled=false; quickBtn.disabled=false; log('Imagen lista.'); };
  img.onerror = () => log('No se pudo cargar la imagen.');
  img.src = url;
}

function normalizeAndPreview({fast=false}={}){
  if(!source) return;
  const maxSide = fast ? 800 : Math.max(256, Math.min(2048, parseInt(maxSideEl.value)||1280));
  const {width, height} = source;
  const scale = Math.min(maxSide/width, maxSide/height, 1);
  inCanvas.width = Math.round(width * scale);
  inCanvas.height = Math.round(height * scale);
  const ctx = inCanvas.getContext('2d');
  ctx.clearRect(0,0,inCanvas.width,inCanvas.height);
  ctx.drawImage(source, 0, 0, inCanvas.width, inCanvas.height);
  const approxKB = Math.round(inCanvas.toDataURL('image/jpeg', 0.9).length/1.37/1024);
  metaIn.textContent = `Preview: ${inCanvas.width}×${inCanvas.height}px · ~${approxKB} KB (JPEG 0.9)`;
}

runBtn.onclick = () => send(false);
quickBtn.onclick = () => send(true);

async function send(fast){
  try{
    runBtn.disabled = quickBtn.disabled = true;
    if(fast) normalizeAndPreview({fast:true});
    log('Enviando…');

    const body = {
      image: inCanvas.toDataURL('image/jpeg', 0.9),
      ratio: ratioEl.value,
      strict: strictEl.checked,
      extra: extraEl.value.trim()
    };
    const model = modelEl.value.trim(); if(model) body.model = model;

    const res = await fetch(endpointEl.value.trim() || '/api/transform', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
    });

    const text = await res.text();
    let data; try{ data = JSON.parse(text); } catch { data = { raw:text }; }

    if(!res.ok){ log({ status:res.status, error:data.error||data }); return; }

    let result =
      data?.resultBase64 ||
      data?.choices?.[0]?.message?.images?.[0]?.image_url?.url ||
      data?.choices?.[0]?.message?.image_url?.url ||
      (typeof data?.choices?.[0]?.message?.content === 'string' && data.choices[0].message.content.startsWith('data:image/') ? data.choices[0].message.content : null);

    if(!result){ log({ note:'Respuesta sin imagen utilizable', data }); }
    else { outImg.src = result; log({ ok:true, bytes: result.length, strict: body.strict }); }
  } catch(err){ log(String(err)); }
  finally { runBtn.disabled = quickBtn.disabled = false; }
}
</script>
</body>
</html>


