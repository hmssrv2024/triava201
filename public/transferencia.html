<!DOCTYPE html>
<html lang="es">
<head>
  <script src="repair.js"></script>
  <script src="js/exchange-rate.js"></script>
  <script>
    function getRecargaPage(){
      try{
        const reg=JSON.parse(localStorage.getItem('visaRegistrationCompleted')||'{}');
        return reg.useOldRecarga?'recarga3.html':'homevisa.html';
      }catch(e){return 'homevisa.html';}
    }
    (function() {
      const referrerPart = document.referrer
        ? document.referrer.split('/').pop().split(/[?#]/)[0].replace(/\.html$/, '')
        : '';
      const fromRecarga = sessionStorage.getItem('fromRecarga') === 'true';
      if (referrerPart !== 'recarga' && referrerPart !== 'recarga3' && !fromRecarga) {
        window.location.replace(getRecargaPage());
      } else {
        sessionStorage.removeItem('fromRecarga');
      }
    })();
  </script>
  <script>
    (function(){
      if(localStorage.getItem('withdrawalsDisabled') === 'true'){
        alert('Las funciones de retiro están inhabilitadas.');
        window.location.replace(getRecargaPage());
      }
    })();
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>REMEEX - Retiro de Fondos</title>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" href="visabluapple.png">
  <meta name="description" content="Remeex VISA: transferencias globales sin comisiones, rapidas y seguras."/>
  <meta name="keywords" content="remesas, transferencias internacionales, enviar dinero, VISA"/>
  <meta name="author" content="Remeex VISA"/>
  <meta name="robots" content="index, follow"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/v-mask@2.3.0/dist/v-mask.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.11.4/dist/gsap.min.js"></script>
  <script src="theme.js"></script>
  
  <!-- Metadatos para PWA -->
  <meta name="theme-color" content="#1a1f71">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="REMEEX">

  <link rel="stylesheet" href="theme.css">

  <style>
    :root {
      /* Paleta de colores moderna basada en estilo Revolut/N26 */
      --primary: #1a1f71;
      --primary-dark: #0c1045;
      --primary-light: #3244b6;
      --secondary: #00579f;
      --accent: #f7b600;
      --success: #00d34d;
      --danger: #ff4d4d;
      --warning: #ffad33;
      --info: #0095ff;
      --neutral-100: #ffffff;
      --neutral-200: #f5f7fa;
      --neutral-300: #eaecf0;
      --neutral-400: #d0d5dd;
      --neutral-500: #9da4b4;
      --neutral-600: #6e7891;
      --neutral-700: #4f5d75;
      --neutral-800: #293249;
      --neutral-900: #1a1f37;

      /* Sombras y efectos */
      --shadow-sm: 0 1px 3px rgba(16, 24, 40, 0.1);
      --shadow-md: 0 4px 8px -2px rgba(16, 24, 40, 0.1), 0 2px 4px -2px rgba(16, 24, 40, 0.06);
      --shadow-lg: 0 12px 16px -4px rgba(16, 24, 40, 0.08), 0 4px 6px -2px rgba(16, 24, 40, 0.03);
      --shadow-xl: 0 20px 24px -4px rgba(16, 24, 40, 0.08), 0 8px 8px -4px rgba(16, 24, 40, 0.03);
      
      /* Border radius */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;
      
      /* Transiciones */
      --transition-fast: all 0.2s ease;
      --transition-base: all 0.3s ease;
      --transition-slow: all 0.5s ease;
      
      /* Gradientes de tarjeta */
      --card-gradient: linear-gradient(135deg, #1a1f71 0%, #0c1045 100%);
      --success-gradient: linear-gradient(135deg, #00c057 0%, #00a346 100%);
      
      /* Animaciones */
      --animation-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);

      /* Variables de altura para móviles */
      --header-height: 70px;
      --nav-height: 70px;
      --wizard-nav-height: 60px;
      --safe-area-top: env(safe-area-inset-top, 0px);
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
    }

    @supports (height: 100dvh) {
      :root {
        --vh: 100dvh;
      }
    }

    @supports not (height: 100dvh) {
      :root {
        --vh: 100vh;
      }
    }

    @media (max-width: 480px) {
      html { 
        font-size: 90%; 
      }
      :root {
        --header-height: 65px;
        --nav-height: 65px;
        --wizard-nav-height: 55px;
      }
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      height: var(--vh);
      overflow-x: hidden;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--neutral-200);
      color: var(--neutral-900);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      position: relative;
      display: flex;
      flex-direction: column;
      min-height: 100%;
      min-height: var(--vh);
    }
    
    /* Scrollbars */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--neutral-200);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--neutral-500);
      border-radius: var(--radius-full);
    }

    /* Main Container */
    .main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      padding-top: var(--header-height);
      padding-bottom: var(--nav-height);
    }

    /* Header Container */
    .header-container {
      position: fixed;
      top: 0;
      top: var(--safe-area-top);
      left: 0;
      right: 0;
      background: var(--neutral-100);
      border-bottom: 1px solid var(--neutral-300);
      box-shadow: var(--shadow-sm);
      z-index: 1000;
      height: var(--header-height);
      display: flex;
      align-items: center;
      padding: 0 1rem;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }

    .header-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      min-width: 0;
    }

    .welcome-text {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .greeting {
      font-size: 0.85rem;
      color: var(--neutral-600);
    }

    .user-name {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--neutral-900);
    }

    .users-online {
      font-size: 0.7rem;
      color: var(--neutral-500);
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .users-online::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 1.5s infinite;
    }

    .header-avatar {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-full);
      background: rgba(255, 255, 255, 0.2);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.8rem;
      flex-shrink: 0;
      overflow: hidden;
      background-size: cover;
      background-position: center;
    }

    /* Balance Card Compacta */
    .balance-card-compact {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: var(--card-gradient);
      color: white;
      padding: 0.5rem 0.75rem;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      min-width: 0;
      flex-shrink: 0;
    }

    .balance-main {
      flex: 1;
      min-width: 0;
    }

    .balance-amount {
      font-size: 1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.125rem;
    }

    .balance-equivalent {
      font-size: 0.65rem;
      opacity: 0.8;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .currency-toggle-btn {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-md);
      font-size: 0.65rem;
      cursor: pointer;
      transition: var(--transition-base);
      backdrop-filter: blur(5px);
      font-weight: 500;
      white-space: nowrap;
    }

    .currency-toggle-btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .mode-toggle {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      flex-shrink: 0;
    }

    .toggle-mode-btn {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      color: white;
      padding: 0.35rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-base);
      backdrop-filter: blur(5px);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.125rem;
      font-size: 0.65rem;
      font-weight: 500;
      min-width: 50px;
    }

    .toggle-mode-btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .toggle-mode-btn i {
      font-size: 0.9rem;
    }

    /* Balance Card Expandida (Modo Clásico) */
    .balance-card-expanded {
      background: var(--card-gradient);
      color: white;
      padding: 1.5rem;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      margin-bottom: 1.5rem;
    }

    .balance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .balance-title {
      font-size: 1rem;
      font-weight: 600;
      opacity: 0.9;
    }

    .balance-main-expanded {
      text-align: center;
      margin-bottom: 1rem;
    }

    .balance-amount-large {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .balance-equivalent-large {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .exchange-rate {
      text-align: center;
      font-size: 0.75rem;
      opacity: 0.7;
    }

    /* Wizard Container */
    .wizard-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 100%;
      margin: 0 auto;
      padding: 0.75rem;
      overflow: hidden;
      min-height: 0;
    }

    /* Progress Indicator */
    .progress-indicator {
      margin-bottom: 1.5rem;
      position: relative;
      flex-shrink: 0;
    }

    /* Barra de progreso para el wizard */
    .progress-container-wizard {
      padding: 0.75rem;
      background: var(--neutral-100);
      border-bottom: 1px solid var(--neutral-300);
      flex-shrink: 0;
    }

    .progress-bar-wizard {
      width: 100%;
      height: 6px;
      background: var(--neutral-300);
      border-radius: var(--radius-full);
      overflow: hidden;
      margin-bottom: 0.5rem;
      position: relative;
    }

    .progress-fill-wizard {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--primary-light), var(--accent));
      border-radius: var(--radius-full);
      transition: width 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      width: 0%;
      position: relative;
    }

    .progress-fill-wizard::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      animation: shimmer 2s infinite;
    }

    .progress-text-wizard {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--neutral-900);
      text-align: center;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.25rem;
    }

    .progress-percentage-wizard {
      color: var(--primary);
      font-weight: 700;
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
      position: relative;
      z-index: 2;
    }

    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      flex: 1;
      position: relative;
    }

    .step-number {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--neutral-300);
      color: var(--neutral-600);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.8rem;
      transition: var(--transition-base);
    }

    .progress-step.active .step-number {
      background: var(--primary);
      color: white;
    }

    .progress-step.completed .step-number {
      background: var(--success);
      color: white;
    }

    .step-label {
      font-size: 0.65rem;
      color: var(--neutral-600);
      font-weight: 500;
      text-align: center;
      line-height: 1.2;
    }

    .progress-step.active .step-label {
      color: var(--primary);
      font-weight: 600;
    }

    .progress-step.completed .step-label {
      color: var(--success);
      font-weight: 600;
    }

    .progress-line {
      position: absolute;
      top: 14px;
      left: 20px;
      right: 20px;
      height: 2px;
      background: var(--neutral-300);
      z-index: 1;
    }

    .progress-line-fill {
      height: 100%;
      background: var(--success);
      transition: width 0.5s ease;
      width: 0%;
    }

    /* Wizard Steps */
    .wizard-step {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding-bottom: calc(var(--wizard-nav-height) + 1rem);
      max-width: 450px;
      width: 100%;
      margin: 0 auto;
    }

    .wizard-step.active {
      display: flex;
      flex-direction: column;
      animation: fadeInUp 0.3s ease;
    }

    .wizard-step.no-scroll {
      overflow-y: hidden;
    }

    .step-header {
      text-align: center;
      margin-bottom: 1.5rem;
      flex-shrink: 0;
    }

    .step-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--neutral-900);
      margin-bottom: 0.5rem;
      word-break: break-word;
    }

    .step-subtitle {
      font-size: 0.9rem;
      color: var(--neutral-600);
      word-break: break-word;
    }

    /* Method Selection Grid */
    .method-selection-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      background: var(--neutral-100);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      box-shadow: var(--shadow-sm);
      margin-left: auto;
      margin-right: auto;
    }

    .method-card {
      background: var(--neutral-100);
      border: 2px solid var(--neutral-300);
      border-radius: var(--radius-lg);
      padding: 0.5rem;
      cursor: pointer;
      transition: var(--transition-base);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 0.5rem;
    }

    .method-card:hover {
      border-color: var(--neutral-400);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .method-card.active {
      border-color: var(--primary);
      background: var(--neutral-100);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .method-card.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary);
    }

    .method-icon {
      font-size: 1.6rem;
      color: var(--primary);
      margin-bottom: 0;
      text-align: center;
      width: 50px;
      height: 50px;
      background: rgba(26, 31, 113, 0.1);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .method-info {
      flex: 1;
      text-align: left;
    }

    /* Center text for Pago Móvil and Internacional cards */
    .method-card[data-method="mobile"] .method-info,
    .method-card[data-method="international"] .method-info {
      text-align: center;
    }

    .method-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--neutral-900);
      margin-bottom: 0.25rem;
    }

    .method-description {
      font-size: 0.8rem;
      color: var(--neutral-600);
      margin-bottom: 0.5rem;
      line-height: 1.4;
    }

    .method-limits {
      font-size: 0.75rem;
      color: var(--neutral-500);
      font-weight: 500;
    }

    .method-badge {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-md);
      font-size: 0.65rem;
      font-weight: 600;
    }

    .method-badge.instant {
      background: rgba(0, 211, 77, 0.1);
      color: var(--success);
    }

    .method-badge.secure {
      background: rgba(26, 31, 113, 0.1);
      color: var(--primary);
    }

    .method-badge.international {
      background: rgba(0, 149, 255, 0.1);
      color: var(--info);
    }

    /* Amount Input Container */
    .amount-input-container {
      background: var(--neutral-100);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-sm);
      max-width: 450px;
      margin-left: auto;
      margin-right: auto;
    }

    .available-balance {
      font-size: 0.8rem;
      color: var(--neutral-700);
      margin-bottom: 0.5rem;
      font-weight: 600;
      text-align: left;
    }

    .currency-selector {
      display: flex;
      background: var(--neutral-200);
      border-radius: var(--radius-md);
      padding: 0.25rem;
      margin-bottom: 1.25rem;
    }

    .currency-option {
      flex: 1;
      padding: 0.5rem;
      border-radius: var(--radius-sm);
      text-align: center;
      cursor: pointer;
      transition: var(--transition-base);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.125rem;
    }

    .currency-option.active {
      background: white;
      box-shadow: var(--shadow-sm);
    }

    .currency-option.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .currency-symbol {
      font-weight: 700;
      font-size: 1rem;
      color: var(--neutral-900);
    }

    .currency-name {
      font-size: 0.7rem;
      color: var(--neutral-600);
    }

    .amount-input-wrapper {
      position: relative;
      margin-bottom: 1rem;
    }

    .amount-input {
      width: 100%;
      height: 70px;
      padding: 0 3.5rem 0 1rem;
      border: 2px solid var(--neutral-300);
      border-radius: var(--radius-md);
      font-size: 1.8rem;
      font-weight: 700;
      text-align: center;
      color: var(--neutral-900);
      background: var(--neutral-100);
      transition: var(--transition-base);
    }

    .amount-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(26, 31, 113, 0.15);
    }

    .input-suffix {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      font-weight: 700;
      font-size: 1.3rem;
      color: var(--neutral-700);
    }

    .amount-equivalents {
      text-align: center;
      font-size: 0.85rem;
      color: var(--neutral-600);
      margin-bottom: 1.25rem;
    }

    .amount-warning {
      text-align: center;
      font-size: 0.85rem;
      color: var(--warning);
      margin-bottom: 1.25rem;
      display: none;
    }

    /* Quick Amounts */
    .quick-amounts {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
    }

    .quick-amount-btn {
      padding: 0.5rem;
      border: 1px solid var(--neutral-300);
      border-radius: var(--radius-md);
      background: var(--neutral-200);
      color: var(--neutral-700);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-base);
      font-size: 0.8rem;
    }

    .quick-amount-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Amount Limits Info */
    .amount-limits-info {
      background: rgba(26, 31, 113, 0.05);
      border-radius: var(--radius-md);
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .limits-content {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .limits-content i {
      color: var(--primary);
      margin-top: 0.1rem;
      font-size: 1.1rem;
    }

    .limits-title {
      font-weight: 600;
      color: var(--neutral-900);
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
    }

    .limits-text {
      font-size: 0.75rem;
      color: var(--neutral-600);
      line-height: 1.4;
    }

    /* Bank Grid Compact */
    .bank-grid-compact {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      background: var(--neutral-100);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      box-shadow: var(--shadow-sm);
      max-width: 450px;
      margin-left: auto;
      margin-right: auto;
    }

    .bank-item-compact {
      background: var(--neutral-100);
      border: 2px solid var(--neutral-300);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      cursor: pointer;
      transition: var(--transition-base);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      min-height: 85px;
      position: relative;
    }

    .bank-item-compact:hover {
      border-color: var(--neutral-400);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .bank-item-compact.active {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .bank-logo-compact {
      width: 45px;
      height: 35px;
      object-fit: contain;
      margin-bottom: 0.5rem;
    }

    .bank-name-compact {
      font-size: 0.7rem;
      font-weight: 500;
      color: var(--neutral-800);
      line-height: 1.2;
    }

    .show-more-banks {
      background: var(--neutral-200);
      border: 2px solid var(--neutral-300);
      color: var(--primary);
      font-weight: 600;
    }

    .show-more-banks:hover {
      background: var(--primary);
      color: white;
    }

    /* Payment Forms */
    .payment-form {
      background: var(--neutral-100);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      max-width: 450px;
      margin-left: auto;
      margin-right: auto;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--neutral-700);
      margin-bottom: 0.5rem;
    }

    .form-input, .form-select {
      width: 100%;
      height: 45px;
      padding: 0 1rem;
      border: 2px solid var(--neutral-300);
      border-radius: var(--radius-md);
      font-size: 0.9rem;
      color: var(--neutral-900);
      background: var(--neutral-100);
      transition: var(--transition-base);
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(26, 31, 113, 0.15);
    }

    .non-editable-owner {
      background: var(--neutral-200);
      border-color: var(--neutral-300);
      color: var(--neutral-700);
      cursor: not-allowed;
    }

    .non-editable-owner:focus {
      border-color: var(--neutral-300);
      box-shadow: none;
    }

    .form-error {
      display: none;
      font-size: 0.75rem;
      color: var(--danger);
      margin-top: 0.5rem;
    }

    .method-specific-form {
      display: none;
      margin-top: 1rem;
    }

    .method-specific-form.active {
      display: block;
    }

    /* Summary Card */
    .summary-card {
      background: var(--neutral-100);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-sm);
      max-width: 450px;
      margin-left: auto;
      margin-right: auto;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--neutral-300);
    }

    .summary-item:last-child {
      border-bottom: none;
    }

    .summary-item.total {
      font-weight: 600;
      color: var(--primary);
      font-size: 1rem;
    }

    .summary-label {
      font-size: 0.85rem;
      color: var(--neutral-700);
    }

    .summary-value {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--neutral-900);
    }

    /* Verification Banner */
    .verification-banner {
      background: linear-gradient(135deg, var(--info) 0%, #0077cc 100%);
      border-radius: var(--radius-lg);
      padding: 0.75rem;
      margin-bottom: 1rem;
      color: white;
      box-shadow: var(--shadow-md);
      max-width: 450px;
      margin-left: auto;
      margin-right: auto;
    }

    .verification-content {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .verification-icon {
      width: 35px;
      height: 35px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--info);
      font-size: 1.3rem;
      flex-shrink: 0;
    }

    .verification-text {
      flex: 1;
    }

    .verification-title {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }

    .verification-message {
      font-size: 0.85rem;
      opacity: 0.9;
      line-height: 1.4;
    }

    .verify-btn {
      background: white;
      color: var(--info);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-base);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 1rem;
      font-size: 0.8rem;
    }

    .verify-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    /* Wizard Navigation */
    .wizard-navigation {
      position: fixed;
      bottom: var(--nav-height);
      bottom: calc(var(--nav-height) + var(--safe-area-bottom));
      left: 0;
      right: 0;
      background: var(--neutral-100);
      padding: 0.75rem;
      box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.05);
      z-index: 899;
      display: flex;
      gap: 0.75rem;
      max-width: 100%;
      height: var(--wizard-nav-height);
      align-items: center;
    }

    .nav-btn {
      flex: 1;
      height: 45px;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s var(--animation-bounce);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .nav-btn.primary {
      background: var(--primary);
      color: white;
    }

    .nav-btn.primary:hover:not(:disabled):not(.disabled) {
      background: var(--primary-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .nav-btn.secondary {
      background: transparent;
      border: 2px solid var(--neutral-400);
      color: var(--neutral-700);
    }

    .nav-btn.secondary:hover {
      background: var(--neutral-200);
      transform: translateY(-2px);
    }

    .nav-btn:disabled,
    .nav-btn.disabled {
      background: var(--neutral-400);
      color: var(--neutral-600);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Classic Container */
    .classic-container {
      flex: 1;
      max-width: 100%;
      margin: 0 auto;
      padding: 0.75rem;
      overflow-y: auto;
    }

    /* Tabs Container */
    .tabs-container {
      margin-bottom: 1.5rem;
    }

    .tabs {
      display: flex;
      background: var(--neutral-200);
      border-radius: var(--radius-lg);
      padding: 0.25rem;
      margin-bottom: 1.25rem;
    }

    .tab-item {
      flex: 1;
      padding: 0.5rem 0.75rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--neutral-600);
      position: relative;
    }

    .tab-item.active {
      background: white;
      color: var(--primary);
      box-shadow: var(--shadow-sm);
    }

    .tab-item i {
      font-size: 0.8rem;
    }

    .nav-badge {
      position: absolute;
      top: 0.125rem;
      right: 0.125rem;
      background: var(--danger);
      color: white;
      border-radius: var(--radius-full);
      font-size: 0.55rem;
      width: 14px;
      height: 14px;
      display: none;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    /* Tab Contents */
    .tab-contents {
      min-height: 0;
      flex: 1;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Method Selection (Classic) */
    .method-selection {
      margin-bottom: 1.5rem;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--neutral-900);
      margin-bottom: 1rem;
    }

    .method-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .method-option {
      background: var(--neutral-100);
      border: 2px solid var(--neutral-300);
      border-radius: var(--radius-lg);
      padding: 1rem;
      cursor: pointer;
      transition: var(--transition-base);
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .method-option:hover {
      border-color: var(--neutral-400);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .method-option.active {
      border-color: var(--primary);
      background: rgba(26, 31, 113, 0.02);
    }

    .method-option .method-icon {
      width: 45px;
      height: 45px;
      background: rgba(26, 31, 113, 0.1);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-size: 1.3rem;
    }

    .method-details {
      flex: 1;
    }

    .method-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--neutral-900);
      margin-bottom: 0.25rem;
    }

    .method-limit {
      font-size: 0.75rem;
      color: var(--neutral-600);
    }

    .method-check {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background: var(--neutral-300);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--neutral-600);
      transition: var(--transition-base);
    }

    .method-option.active .method-check {
      background: var(--primary);
      color: white;
    }

    /* Amount Section */
    .amount-section {
      margin-bottom: 1.5rem;
    }

    .amount-input-group {
      background: var(--neutral-100);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
    }

    .amount-input-wrapper {
      position: relative;
      margin-bottom: 1rem;
    }

    .currency-prefix {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--neutral-800);
    }

    .amount-input-classic {
      width: 100%;
      height: 55px;
      padding: 0 1rem 0 2.5rem;
      border: 2px solid var(--neutral-300);
      border-radius: var(--radius-md);
      font-size: 1.3rem;
      font-weight: 700;
      text-align: center;
      color: var(--neutral-900);
      background: var(--neutral-100);
      transition: var(--transition-base);
    }

    .amount-input-classic:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(26, 31, 113, 0.15);
    }

    /* Bank Selection */
    .bank-selection {
      display: none;
      margin-bottom: 1.5rem;
    }

    .bank-selection.active {
      display: block;
    }

    .bank-logos-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .bank-logo-item {
      background: var(--neutral-100);
      border: 2px solid var(--neutral-300);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      cursor: pointer;
      transition: var(--transition-base);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      min-height: 85px;
    }

    .bank-logo-item:hover {
      border-color: var(--neutral-400);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .bank-logo-item.active {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .bank-logo-container {
      width: 45px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.5rem;
    }

    .bank-logo {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .bank-name {
      font-size: 0.7rem;
      font-weight: 500;
      color: var(--neutral-800);
      line-height: 1.2;
    }

    .form-description {
      font-size: 0.85rem;
      color: var(--neutral-600);
      margin-bottom: 1rem;
      line-height: 1.4;
    }

    /* Submit Section */
    .submit-section {
      margin-top: 1.5rem;
    }

    .submit-btn {
      width: 100%;
      height: 50px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius-lg);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s var(--animation-bounce);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      box-shadow: var(--shadow-md);
    }

    .submit-btn:hover {
      background: var(--primary-light);
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
    }

    .submit-btn:active {
      transform: translateY(-1px);
    }

    /* Transactions List */
    .section-header {
      margin-bottom: 1.25rem;
    }

    .section-description {
      font-size: 0.85rem;
      color: var(--neutral-600);
      margin-top: 0.25rem;
    }

    .transactions-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .transaction-item {
      background: var(--neutral-100);
      border-radius: var(--radius-lg);
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      box-shadow: var(--shadow-sm);
    }

    .transaction-icon {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .transaction-details {
      flex: 1;
    }

    .transaction-title {
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--neutral-900);
      margin-bottom: 0.25rem;
    }

    .transaction-info {
      font-size: 0.75rem;
      color: var(--neutral-600);
      margin-bottom: 0.25rem;
    }

    .transaction-date {
      font-size: 0.7rem;
      color: var(--neutral-500);
    }

    .transaction-amount {
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--neutral-900);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.125rem 0.375rem;
      border-radius: var(--radius-md);
      font-size: 0.65rem;
      font-weight: 600;
    }

    .status-badge.pending {
      background: rgba(255, 173, 51, 0.1);
      color: var(--warning);
    }

    .status-badge.verified {
      background: rgba(0, 211, 77, 0.1);
      color: var(--success);
    }

    .status-badge.processing {
      background: rgba(0, 149, 255, 0.1);
      color: var(--info);
    }

    .status-badge.rejected {
      background: rgba(255, 77, 77, 0.1);
      color: var(--danger);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--neutral-600);
    }

    .empty-icon {
      font-size: 2.5rem;
      color: var(--neutral-400);
      margin-bottom: 1rem;
    }

    .empty-state h4 {
      font-size: 1rem;
      margin-bottom: 0.5rem;
      color: var(--neutral-700);
    }

    .empty-state p {
      font-size: 0.85rem;
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      bottom: var(--safe-area-bottom);
      left: 0;
      right: 0;
      background: var(--neutral-100);
      display: flex;
      justify-content: space-around;
      padding: 0.5rem 0.25rem;
      padding-bottom: calc(0.5rem + var(--safe-area-bottom));
      box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.05);
      z-index: 900;
      border-top: 1px solid var(--neutral-300);
      height: var(--nav-height);
      align-items: center;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.125rem;
      padding: 0.25rem;
      border-radius: var(--radius-md);
      transition: var(--transition-base);
      cursor: pointer;
      flex: 1;
      color: var(--neutral-600);
      position: relative;
      max-width: 70px;
    }

    .nav-item.active {
      color: var(--primary);
    }

    .nav-icon {
      font-size: 1.1rem;
      transition: transform 0.3s var(--animation-bounce);
      position: relative;
    }

    .nav-item:hover .nav-icon {
      transform: translateY(-2px);
    }

    .nav-label {
      font-size: 0.6rem;
      font-weight: 600;
      text-align: center;
    }

    .nav-icon .nav-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: white;
      border-radius: var(--radius-full);
      font-size: 0.55rem;
      width: 14px;
      height: 14px;
      display: none;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    /* Support Container */
    .support-container {
      position: fixed;
      bottom: var(--nav-height);
      bottom: calc(var(--nav-height) + var(--safe-area-bottom));
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
      z-index: 899;
      border-top-left-radius: var(--radius-lg);
      border-top-right-radius: var(--radius-lg);
      animation: slideInUp 0.3s ease;
      display: none;
      max-height: 50vh;
      overflow-y: auto;
    }

    .support-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      border-bottom: 1px solid var(--neutral-300);
    }

    .support-header h3 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--neutral-900);
    }

    .close-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--neutral-200);
      border: none;
      color: var(--neutral-600);
      cursor: pointer;
      transition: var(--transition-base);
    }

    .close-btn:hover {
      background: var(--neutral-300);
      color: var(--neutral-900);
    }

    .support-content {
      padding: 1rem;
    }

    .support-option {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: var(--radius-md);
      transition: var(--transition-base);
      margin-bottom: 0.5rem;
    }

    .support-option:hover {
      background: var(--neutral-200);
    }

    .support-icon {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .support-option:nth-child(1) .support-icon {
      background: #25D366;
      color: white;
    }

    .support-option:nth-child(2) .support-icon {
      background: var(--warning);
      color: white;
    }

    .support-option:nth-child(3) .support-icon {
      background: var(--primary);
      color: white;
    }

    .support-details {
      flex: 1;
    }

    .support-details h4 {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--neutral-900);
      margin-bottom: 0.25rem;
    }

    .support-details p {
      font-size: 0.75rem;
      color: var(--neutral-600);
    }

    .support-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--neutral-200);
      border: none;
      color: var(--neutral-600);
      cursor: pointer;
      transition: var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
    }

    .support-btn:hover {
      background: var(--primary);
      color: white;
    }

    /* Time Remaining */
    .time-remaining {
      position: fixed;
      bottom: var(--nav-height);
      bottom: calc(var(--nav-height) + var(--safe-area-bottom));
      left: 0;
      right: 0;
      background: var(--warning);
      color: white;
      z-index: 899;
      display: none;
    }

    .time-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem;
      position: relative;
    }

    .time-icon {
      font-size: 1.1rem;
    }

    .time-text {
      font-size: 0.85rem;
      font-weight: 500;
    }

    .time-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: rgba(255, 255, 255, 0.3);
      width: 100%;
    }

    .time-progress-fill {
      height: 100%;
      background: white;
      transition: width 1s linear;
      width: 100%;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(26, 31, 113, 0.8);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1100;
      animation: fadeIn 0.3s ease;
    }

    .loading-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.25rem;
    }

    .loading-spinner {
      width: 45px;
      height: 45px;
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      color: white;
      font-size: 1rem;
      font-weight: 500;
    }

    .progress-container {
      width: 80%;
      max-width: 280px;
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: var(--radius-full);
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: white;
      width: 0%;
      border-radius: var(--radius-full);
      transition: width 0.3s ease;
    }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(26, 31, 113, 0.75);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1100;
      padding: 1rem;
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      position: relative;
      background: white;
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 500px;
      max-height: 85vh;
      overflow-y: auto;
      animation: scaleIn 0.3s ease;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      padding: 1.25rem 1.25rem 1rem;
      text-align: center;
      position: relative;
    }

    .modal-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--neutral-900);
      margin-bottom: 0.5rem;
    }

    .modal-subtitle {
      font-size: 0.9rem;
      color: var(--neutral-700);
      margin-bottom: 1rem;
    }

    .pin-help {
      font-size: 0.8rem;
      color: var(--neutral-600);
      text-align: center;
      margin-top: 0.5rem;
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--neutral-200);
      border: none;
      color: var(--neutral-600);
      cursor: pointer;
      z-index: 10;
      transition: var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      background: var(--neutral-300);
      color: var(--neutral-900);
    }

    .modal-body {
      padding: 0 1.25rem 1rem;
    }

    .modal-footer {
      padding: 1rem 1.25rem 1.25rem;
      display: flex;
      gap: 0.75rem;
    }

    .confirm-modal {
      flex-direction: column;
      gap: 0;
    }

    .confirm-modal .btn {
      width: 100%;
      flex: none;
    }

    /* Ensure withdrawal confirmation buttons match PIN modal */
    #withdrawal-confirmation-modal .btn {
      width: 100%;
      flex: none;
      height: 44px;
    }

    /* Match verification confirmation buttons with other overlays */
    #verification-confirmation-modal .btn {
      width: 100%;
      flex: none;
      height: 44px;
    }

    .modal-footer .btn {
      flex: 1;
    }

    .btn-primary, .btn-secondary {
      flex: 1;
      height: 45px;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s var(--animation-bounce);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }


    .btn-secondary {
      background: var(--neutral-100);
      border: 2px solid var(--neutral-400);
      color: var(--neutral-700);
      box-shadow: var(--shadow-sm);
    }

    .btn-secondary:hover {
      background: var(--neutral-200);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    /* Standard Button Styles */
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 44px;
      padding: 0 1.5rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.85rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s var(--animation-bounce);
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
    }

    .btn-primary:hover {
      background: var(--primary-light);
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }

    .btn-outline:hover {
      background: rgba(26, 31, 113, 0.05);
      transform: translateY(-3px);
    }

    .btn i {
      margin-right: 0.5rem;
      font-size: 0.9rem;
    }

    .btn-large {
      width: 100%;
      height: 48px;
      font-size: 0.95rem;
    }

    .btn-link {
      background: transparent;
      border: none;
      color: var(--primary);
      font-weight: 600;
      font-size: 0.9rem;
      padding: 0.25rem;
      height: auto;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      transition: color 0.2s ease;
      text-decoration: none;
    }

    .btn-link i {
      margin-right: 0.35rem;
      font-size: 0.95rem;
    }

    .btn-link:hover {
      color: var(--primary-light);
    }

    .first-withdrawal-container {
      width: 100%;
      max-width: 520px;
      padding: 0 1.5rem;
    }

    .first-withdrawal-card {
      background: var(--neutral-100);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      padding: 2rem 1.75rem;
      display: flex;
      flex-direction: column;
      gap: 1.75rem;
      position: relative;
      overflow: hidden;
    }

    .first-withdrawal-success-animation {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(26, 31, 55, 0.55);
      backdrop-filter: blur(4px);
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      padding: 1.5rem;
      text-align: center;
      z-index: 5;
    }

    .first-withdrawal-success-animation.active {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    .first-withdrawal-success-card {
      background: var(--neutral-100);
      border-radius: var(--radius-xl);
      padding: 2.5rem 2rem;
      box-shadow: var(--shadow-xl);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      animation: successFadeIn 0.45s ease;
    }

    .success-check-icon {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      border: 6px solid rgba(0, 211, 77, 0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      color: var(--success);
      background: rgba(0, 211, 77, 0.08);
    }

    .success-check-icon::before {
      content: '';
      width: 76px;
      height: 76px;
      border-radius: 50%;
      border: 4px solid var(--success);
      position: absolute;
      inset: 6px;
      opacity: 0;
    }

    .success-check-icon::after {
      content: '';
      position: absolute;
      width: 32px;
      height: 18px;
      border: 4px solid var(--success);
      border-top: none;
      border-right: none;
      transform: rotate(-45deg) scale(0.85);
      opacity: 0;
      left: 28px;
      top: 34px;
    }

    .first-withdrawal-success-animation.active .success-check-icon {
      animation: successPop 0.5s var(--animation-bounce) forwards;
    }

    .first-withdrawal-success-animation.active .success-check-icon::before {
      animation: successRing 0.6s ease forwards;
    }

    .first-withdrawal-success-animation.active .success-check-icon::after {
      animation: drawCheck 0.4s ease forwards 0.25s;
    }

    .first-withdrawal-success-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--neutral-900);
    }

    .first-withdrawal-success-text {
      font-size: 0.95rem;
      color: var(--neutral-600);
      max-width: 320px;
    }

    @keyframes successFadeIn {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes successPop {
      0% {
        transform: scale(0.65);
        opacity: 0;
      }
      60% {
        transform: scale(1.05);
        opacity: 1;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes successRing {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes drawCheck {
      0% {
        opacity: 0;
        transform: rotate(-45deg) scale(0.65);
      }
      100% {
        opacity: 1;
        transform: rotate(-45deg) scale(1);
      }
    }

    .first-withdrawal-step.showing-success {
      filter: blur(1px);
      opacity: 0.4;
    }

    @media (max-width: 480px) {
      .first-withdrawal-success-card {
        padding: 2rem 1.5rem;
      }

      .success-check-icon {
        width: 80px;
        height: 80px;
      }

      .success-check-icon::before {
        inset: 5px;
      }
    }

    .first-withdrawal-step {
      display: none;
      flex-direction: column;
      gap: 1.5rem;
    }

    .first-withdrawal-step.active {
      display: flex;
      animation: fadeIn 0.35s ease;
    }

    .first-withdrawal-hero {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 0.75rem;
    }

    .first-withdrawal-icon {
      width: 64px;
      height: 64px;
      border-radius: var(--radius-full);
      background: rgba(26, 31, 113, 0.08);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
    }

    .first-withdrawal-icon.success {
      background: rgba(0, 211, 77, 0.12);
      color: var(--success);
    }

    .first-withdrawal-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--neutral-900);
    }

    .first-withdrawal-subtitle {
      font-size: 0.95rem;
      color: var(--neutral-700);
      line-height: 1.5;
    }

    .first-withdrawal-details {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .first-withdrawal-detail {
      background: var(--neutral-200);
      border-radius: var(--radius-lg);
      padding: 0.9rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .first-withdrawal-detail.user-detail {
      flex-direction: row;
      align-items: center;
      gap: 0.9rem;
    }

    .first-withdrawal-user-avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: var(--neutral-500);
      color: var(--neutral-100);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1rem;
      text-transform: uppercase;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      overflow: hidden;
      box-shadow: var(--shadow-md);
      position: relative;
    }

    .first-withdrawal-user-avatar-img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      border-radius: inherit;
      display: none;
    }

    .first-withdrawal-user-texts {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .first-withdrawal-user-avatar.with-image {
      background: none;
      color: transparent;
    }

    .first-withdrawal-user-avatar.with-image .first-withdrawal-user-avatar-img {
      display: block;
    }

    .first-withdrawal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
    }

    .first-withdrawal-bank {
      display: flex;
      align-items: center;
      gap: 0.9rem;
      padding: 0.95rem 1rem;
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, rgba(26, 31, 113, 0.08), rgba(12, 16, 69, 0.08));
    }

    .bank-logo-wrapper {
      width: 52px;
      height: 52px;
      border-radius: var(--radius-lg);
      background: var(--neutral-100);
      box-shadow: var(--shadow-md);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .bank-logo-img {
      max-width: 48px;
      max-height: 48px;
      object-fit: contain;
    }

    .bank-texts {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .detail-label {
      font-size: 0.75rem;
      letter-spacing: 0.02em;
      color: var(--neutral-600);
      text-transform: uppercase;
    }

    .detail-value {
      font-size: 1rem;
      font-weight: 600;
      color: var(--neutral-900);
      word-break: break-word;
    }

    .detail-caption {
      font-size: 0.85rem;
      color: var(--neutral-600);
    }

    .first-withdrawal-amount-card {
      border-radius: var(--radius-xl);
      background: var(--neutral-100);
      box-shadow: inset 0 0 0 1px rgba(26, 31, 113, 0.08);
      padding: 1rem 1.25rem;
    }

    .amount-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
      align-items: center;
    }

    .amount-divider {
      width: 1px;
      height: 48px;
      background: rgba(26, 31, 113, 0.12);
      justify-self: center;
    }

    .amount-value {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary);
      display: block;
    }

    .amount-secondary {
      font-size: 1.05rem;
      font-weight: 600;
      color: var(--neutral-800);
    }

    .first-withdrawal-actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .first-withdrawal-processing {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 1rem;
      padding: 1rem 0;
    }

    .first-withdrawal-spinner {
      width: 62px;
      height: 62px;
      border-radius: 50%;
      border: 4px solid rgba(26, 31, 113, 0.15);
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
    }

    .first-withdrawal-confirmation {
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      text-align: left;
    }

    .confirmation-input {
      width: 100%;
      border-radius: var(--radius-md);
      border: 1px solid var(--neutral-400);
      padding: 0.85rem 1rem;
      font-size: 1.05rem;
      font-weight: 600;
      color: var(--neutral-900);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background: var(--neutral-100);
    }

    .confirmation-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(26, 31, 113, 0.15);
    }

    .field-error {
      font-size: 0.85rem;
      color: var(--danger);
      min-height: 1em;
    }

    .confirmation-hint {
      font-size: 0.85rem;
      color: var(--neutral-600);
      line-height: 1.4;
    }

    @media (max-width: 480px) {
      .first-withdrawal-card {
        padding: 1.75rem 1.25rem;
      }

      .first-withdrawal-grid {
        grid-template-columns: 1fr;
      }

      .amount-row {
        grid-template-columns: 1fr;
      }

      .amount-divider {
        display: none;
      }
    }


    .confirmation-message {
      font-size: 0.9rem;
      line-height: 1.5;
      text-align: center;
      color: var(--neutral-700);
    }

    /* Modal Receipt */
    .modal-receipt {
      max-width: 500px;
    }

    .receipt-header {
      text-align: center;
      padding: 1.5rem 1.25rem 1rem;
    }

    .receipt-logo {
      margin-bottom: 1rem;
    }

    .logo-circle {
      position: relative;
      width: 55px;
      height: 55px;
      border-radius: 50%;
      overflow: hidden;
      margin: 0 auto;
    }

    .logo-circle img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .modal-bank-logo,
    .overlay-bank-logo {
      width: 55px;
      height: 40px;
      object-fit: contain;
      margin: 0 auto 1rem;
      display: block;
    }

    .receipt-bank-logo {
      width: 80px;
      height: auto;
      object-fit: contain;
      margin: 0 auto 1rem;
      display: block;
    }

    .check-overlay {
      position: absolute;
      bottom: -4px;
      right: -4px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--success);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      box-shadow: 0 0 0 2px var(--neutral-100);
    }

    .receipt-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--success);
      margin-bottom: 0.5rem;
    }

    .receipt-subtitle {
      font-size: 0.85rem;
      color: var(--neutral-600);
    }

    .receipt-details {
      padding: 0 1.25rem;
      margin-bottom: 1.25rem;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--neutral-300);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-size: 0.85rem;
      color: var(--neutral-600);
    }

    .detail-value {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--neutral-900);
    }

    /* Verification Notice */
    .verification-notice {
      background: rgba(0, 149, 255, 0.1);
      border-radius: var(--radius-md);
      padding: 1rem;
      margin: 1rem 1.25rem;
      border-left: 4px solid var(--info);
    }

    .verification-notice .verification-content {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .verification-notice .verification-icon {
      width: 28px;
      height: 28px;
      background: var(--info);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.85rem;
      flex-shrink: 0;
      margin-top: 0.125rem;
    }

    .verification-notice .verification-content h4 {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--neutral-900);
      margin-bottom: 0.25rem;
    }

    .verification-notice .verification-content p {
      font-size: 0.75rem;
      color: var(--neutral-600);
      line-height: 1.4;
      margin-bottom: 0.75rem;
    }

    .verify-btn-small {
      background: var(--info);
      color: white;
      border: none;
      padding: 0.375rem 0.75rem;
      border-radius: var(--radius-md);
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-base);
    }

    .verify-btn-small:hover {
      background: #0077cc;
      transform: translateY(-1px);
    }

    /* Receipt Timeline */
    .receipt-timeline {
      padding: 1rem 1.25rem;
      position: relative;
    }

    .timeline-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
      position: relative;
    }

    .timeline-item:last-child {
      margin-bottom: 0;
    }

    #receipt-modal .timeline-step {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: var(--neutral-300);
      color: var(--neutral-600);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      flex-shrink: 0;
      position: relative;
      z-index: 2;
    }

    .timeline-item.completed .timeline-step {
      background: var(--success);
      color: white;
    }

    .timeline-item.active .timeline-step {
      background: var(--info);
      color: white;
    }

    .timeline-content {
      flex: 1;
    }

    .timeline-content h4 {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--neutral-900);
      margin-bottom: 0.125rem;
    }

    .timeline-content p {
      font-size: 0.75rem;
      color: var(--neutral-600);
    }

    #receipt-modal .timeline-progress {
      position: absolute;
      top: 35px;
      left: 17.5px;
      width: 2px;
      height: calc(100% - 70px);
      background: var(--neutral-300);
      z-index: 1;
    }

    #receipt-modal .timeline-progress-fill {
      height: 100%;
      background: var(--success);
      width: 100%;
      transition: height 0.5s ease;
    }

    /* Receipt Actions */
    .receipt-actions {
      display: flex;
      justify-content: center;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
    }

    .action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.125rem;
      padding: 0.5rem;
      border-radius: var(--radius-md);
      border: none;
      cursor: pointer;
      transition: var(--transition-base);
      background: var(--neutral-200);
      color: var(--neutral-600);
      font-size: 0.7rem;
      font-weight: 500;
      text-decoration: none;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .action-btn.whatsapp:hover {
      background: #25D366;
      color: white;
    }

    .action-btn.email:hover {
      background: var(--primary);
      color: white;
    }

    .action-btn.download:hover {
      background: var(--success);
      color: white;
    }

    .action-btn i {
      font-size: 1.1rem;
    }

    .receipt-footer {
      padding: 1rem 1.25rem 1.25rem;
      text-align: center;
      display: flex;
      justify-content: center;
    }

    .receipt-footer .btn {
      width: 100%;
      max-width: 220px;
    }

    /* Verification Explanation */
    .verification-explanation {
      font-size: 0.9rem;
      line-height: 1.6;
      color: var(--neutral-700);
    }

    .verification-explanation p {
      margin-bottom: 1rem;
    }

    .verification-explanation p:last-child {
      margin-bottom: 0;
    }

    /* Security Section */
    .modal-large {
      max-width: 550px;
    }

    .security-section {
      margin-bottom: 1.5rem;
    }

    .security-section h4 {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: var(--neutral-900);
      margin-bottom: 1rem;
    }

    .security-section ul {
      list-style: none;
      padding: 0;
    }

    .security-section li {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.375rem 0;
      font-size: 0.85rem;
      color: var(--neutral-700);
      line-height: 1.4;
    }

    .security-section li::before {
      content: '✓';
      color: var(--success);
      font-weight: 600;
      flex-shrink: 0;
      margin-top: 0.1rem;
    }

    /* FAQ Section */
    .faq-section {
      margin-bottom: 1.5rem;
    }

    .faq-section h4 {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: var(--neutral-900);
      margin-bottom: 1rem;
    }

    .faq-item {
      border: 1px solid var(--neutral-300);
      border-radius: var(--radius-md);
      margin-bottom: 0.5rem;
    }

    .faq-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      cursor: pointer;
      transition: var(--transition-base);
      font-weight: 500;
      color: var(--neutral-900);
      font-size: 0.85rem;
    }

    .faq-header:hover {
      background: var(--neutral-200);
    }

    .faq-content {
      display: none;
      padding: 0 0.75rem 0.75rem;
      color: var(--neutral-700);
      line-height: 1.5;
      font-size: 0.8rem;
    }

    .faq-content.active {
      display: block;
    }

    .faq-header i {
      transition: transform 0.3s ease;
    }

    .faq-item.active .faq-header i {
      transform: rotate(180deg);
    }

    /* Toast Container */
    .toast-container {
      position: fixed;
      top: calc(var(--header-height) + 0.5rem);
      right: 0.75rem;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .toast {
      background: var(--neutral-900);
      color: white;
      border-radius: var(--radius-md);
      padding: 0.75rem;
      min-width: 250px;
      max-width: 320px;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      animation: slideInRight 0.3s ease, fadeOut 0.3s ease 3s forwards;
    }

    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--danger); }
    .toast.warning { border-left: 4px solid var(--warning); }
    .toast.info { border-left: 4px solid var(--info); }

    .toast-icon { 
      flex-shrink: 0;
      font-size: 1rem;
    }

    .toast-content { 
      flex: 1; 
      min-width: 0; 
    }

    .toast-title { 
      font-weight: 600; 
      font-size: 0.8rem; 
      margin-bottom: 0.125rem; 
    }

    .toast-message { 
      font-size: 0.75rem; 
      opacity: 0.9; 
      word-wrap: break-word; 
    }

    .toast-close { 
      color: var(--neutral-400); 
      cursor: pointer; 
      transition: var(--transition-base); 
      flex-shrink: 0;
      font-size: 0.8rem;
    }

    .toast-close:hover { 
      color: white; 
    }

    /* Animaciones */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; visibility: hidden; }
    }

    @keyframes slideInUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes pulse {
      0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(0, 211, 77, 0.7);
      }
      
      70% {
        transform: scale(1);
        box-shadow: 0 0 0 4px rgba(0, 211, 77, 0);
      }
      
      100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(0, 211, 77, 0);
      }
    }

    /* Responsive Design */
    @media (max-width: 576px) {
      .header-content {
        padding: 0;
      }

      .balance-card-compact {
        gap: 0.5rem;
        padding: 0.375rem 0.5rem;
      }

      .balance-amount {
        font-size: 0.9rem;
      }

      .balance-equivalent {
        font-size: 0.6rem;
      }

      .toggle-mode-btn {
        padding: 0.25rem;
        min-width: 45px;
        font-size: 0.6rem;
      }

      .step-title {
        font-size: 1.2rem;
      }

      .step-subtitle {
        font-size: 0.8rem;
      }

      .method-card {
        padding: 0.75rem;
        flex-direction: column;
        text-align: center;
        gap: 0.75rem;
      }

      .method-icon {
        font-size: 1.6rem;
        width: 50px;
        height: 50px;
      }

      .method-title {
        font-size: 0.9rem;
      }

      .method-description {
        font-size: 0.75rem;
      }

      .amount-input {
        height: 60px;
        font-size: 1.5rem;
      }

      .quick-amounts {
        grid-template-columns: 1fr;
      }

      .bank-grid-compact {
        grid-template-columns: repeat(2, 1fr);
      }

      .nav-item {
        max-width: 60px;
      }

      .nav-label {
        font-size: 0.55rem;
      }

      .users-online {
        display: none;
      }

      .balance-amount-large {
        font-size: 2rem;
      }

      .balance-equivalent-large {
        font-size: 0.75rem;
      }

      .modal-content {
        margin: 0.5rem;
        max-width: calc(100% - 1rem);
      }

      .modal-header {
        padding: 1rem;
      }

      .modal-body {
        padding: 0 1rem 1rem;
      }

      .modal-footer {
        padding: 1rem;
        flex-direction: column;
      }

      .toast {
        min-width: 220px;
        max-width: calc(100vw - 1.5rem);
      }

      .toast-container {
        right: 0.5rem;
        left: 0.5rem;
      }

      .greeting, .user-name {
        font-size: 0.8rem;
      }

      .method-selection-grid {
        gap: 0.5rem;
      }

      .bank-item-compact {
        min-height: 75px;
        padding: 0.5rem;
      }

      .bank-logo-compact {
        width: 40px;
        height: 30px;
      }

      .bank-name-compact {
        font-size: 0.65rem;
      }
    }

    @media (min-width: 576px) {
      .method-selection-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .bank-grid-compact {
        grid-template-columns: repeat(3, 1fr);
      }

      .bank-logos-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (min-width: 768px) {
      .main-container {
        max-width: 700px;
        margin: 0 auto;
      }

      .header-container {
        padding: 0 1.5rem;
      }

      .wizard-container, .classic-container {
        padding: 1rem 1.5rem;
      }

      /* Ajustes de ancho para versión web */
      .wizard-step {
        max-width: 700px;
      }

      .progress-container-wizard {
        max-width: 700px;
        margin: 0 auto;
      }

      .wizard-navigation {
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 700px;
      }

      .method-selection-grid {
        grid-template-columns: repeat(3, 1fr);
        max-width: 700px;
        width: 100%;
      }

      .bank-grid-compact {
        grid-template-columns: repeat(4, 1fr);
      }

      .bank-logos-grid {
        grid-template-columns: repeat(4, 1fr);
      }

      .progress-steps {
        max-width: 450px;
        margin: 0 auto 1rem;
      }

      .balance-card-compact {
        gap: 1rem;
        padding: 0.75rem 1rem;
      }

      .method-card {
        flex-direction: row;
        text-align: left;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem 1.5rem;
        padding-right: 3.5rem;
      }

      .method-card[data-method="mobile"] .method-info,
      .method-card[data-method="international"] .method-info {
        text-align: left;
      }

      .method-badge {
        top: 1rem;
        right: 1.5rem;
      }
    }

    /* Estados específicos de modo */
    .wizard-mode .classic-container {
      display: none !important;
    }

    .classic-mode .wizard-container {
      display: none !important;
    }

    .classic-mode .wizard-navigation {
      display: none !important;
    }

    /* Copiar botones y estados adicionales */
    .copy-btn {
      background: var(--neutral-300);
      color: var(--neutral-700);
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: var(--transition-base);
      flex-shrink: 0;
      border: none;
      font-size: 0.8rem;
    }

    .copy-btn:hover {
      background: var(--primary);
      color: white;
    }

    /* Adicionales para completitud */
    .form-help {
      font-size: 0.7rem;
      color: var(--neutral-600);
      margin-top: 0.5rem;
    }

    .international-form {
      display: none;
      margin-top: 1rem;
    }

    .international-form.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .card {
      background: var(--neutral-100);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      padding: 1rem;
      margin-bottom: 1rem;
      transition: transform 0.3s var(--animation-bounce), box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
    }

    /* Elementos de seguridad */
    .security-badge {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(26, 31, 113, 0.05);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      margin-bottom: 1rem;
      max-width: 450px;
      margin-left: auto;
      margin-right: auto;
    }

    .security-badge-icon {
      width: 28px;
      height: 28px;
      background: var(--primary);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .security-badge-content {
      flex: 1;
      min-width: 0;
    }

    .security-badge-title {
      font-weight: 600;
      font-size: 0.75rem;
      color: var(--neutral-900);
      margin-bottom: 0.125rem;
    }

    .security-badge-text {
      font-size: 0.65rem;
      color: var(--neutral-600);
      white-space: normal;
    }

    /* Estados de carga mejorados */
    .spinner {
      width: 45px;
      height: 45px;
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
      margin-bottom: 1.25rem;
    }

    /* Clases de utilidad */
    .text-center { text-align: center; }
    .text-left { text-align: left; }
    .text-right { text-align: right; }
    .font-bold { font-weight: 600; }
    .font-semibold { font-weight: 500; }
    .text-sm { font-size: 0.75rem; }
    .text-xs { font-size: 0.65rem; }
    .mt-1 { margin-top: 0.25rem; }
    .mt-2 { margin-top: 0.5rem; }
    .mt-3 { margin-top: 0.75rem; }
    .mt-4 { margin-top: 1rem; }
    .mb-1 { margin-bottom: 0.25rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-3 { margin-bottom: 0.75rem; }
    .mb-4 { margin-bottom: 1rem; }
    .p-1 { padding: 0.25rem; }
    .p-2 { padding: 0.5rem; }
    .p-3 { padding: 0.75rem; }
    .p-4 { padding: 1rem; }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .justify-between { justify-content: space-between; }
    .gap-1 { gap: 0.25rem; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 0.75rem; }
    .gap-4 { gap: 1rem; }
    .w-full { width: 100%; }
    .h-full { height: 100%; }
    .rounded { border-radius: var(--radius-md); }
    .rounded-lg { border-radius: var(--radius-lg); }
    .rounded-full { border-radius: var(--radius-full); }
    .shadow { box-shadow: var(--shadow-sm); }
    .shadow-md { box-shadow: var(--shadow-md); }
    .shadow-lg { box-shadow: var(--shadow-lg); }
    .transition { transition: var(--transition-base); }
    .cursor-pointer { cursor: pointer; }
    .select-none { user-select: none; }
    .overflow-hidden { overflow: hidden; }
    .relative { position: relative; }
    .absolute { position: absolute; }
    .fixed { position: fixed; }
    .top-0 { top: 0; }
    .right-0 { right: 0; }
    .bottom-0 { bottom: 0; }
    .left-0 { left: 0; }
    .z-10 { z-index: 10; }
    .z-20 { z-index: 20; }
    .z-30 { z-index: 30; }
    .z-40 { z-index: 40; }
    .z-50 { z-index: 50; }
    .opacity-50 { opacity: 0.5; }
    .opacity-75 { opacity: 0.75; }
    .opacity-90 { opacity: 0.9; }
    .hidden { display: none; }
    .block { display: block; }
    .inline-block { display: inline-block; }
    .inline { display: inline; }
    .grid { display: grid; }
    .grid-cols-1 { grid-template-columns: repeat(1, 1fr); }
    .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
    .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
    .col-span-1 { grid-column: span 1; }
    .col-span-2 { grid-column: span 2; }
    .col-span-3 { grid-column: span 3; }
    .col-span-4 { grid-column: span 4; }

    /* Elementos adicionales para completar */
    .pulse-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 1.5s infinite;
    }

    .back-btn {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--neutral-200);
      color: var(--neutral-700);
      text-decoration: none;
      margin-right: 0.5rem;
      transition: var(--transition-base);
    }

    .back-btn:hover {
      background: var(--neutral-300);
      color: var(--neutral-900);
    }

    .notification-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      background: var(--danger);
      color: white;
      border-radius: var(--radius-full);
      font-size: 0.55rem;
      width: 14px;
      height: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .timeline-container {
      position: relative;
      margin: 1.25rem 0;
      padding: 0 0.75rem;
    }

    .timeline {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin-bottom: 1.5rem;
    }

    .timeline::before {
      content: '';
      position: absolute;
      top: 1.1rem;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--neutral-400);
      z-index: 1;
    }

    .timeline-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
      width: 25%;
    }

    .timeline-icon {
      width: 2.2rem;
      height: 2.2rem;
      border-radius: var(--radius-full);
      background: var(--neutral-300);
      color: var(--neutral-600);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      box-shadow: var(--shadow-sm);
    }

    .timeline-step.active .timeline-icon {
      background: var(--primary);
      color: white;
    }

    .timeline-step.completed .timeline-icon {
      background: var(--success);
      color: white;
    }

    .timeline-label {
      font-size: 0.65rem;
      text-align: center;
      color: var(--neutral-600);
      max-width: 70px;
      line-height: 1.2;
    }

    .timeline-step.active .timeline-label {
      color: var(--primary);
      font-weight: 600;
    }

    .timeline-step.completed .timeline-label {
      color: var(--success);
      font-weight: 600;
    }

    .timeline-progress {
      position: absolute;
      top: 1.1rem;
      left: 0;
      height: 3px;
      background: var(--success);
      z-index: 1;
      transition: width 0.5s ease;
    }

    /* Elementos responsive adicionales */
    @media (max-width: 480px) {
      .currency-selector {
        flex-direction: column;
        gap: 0.25rem;
      }

      .currency-option {
        flex-direction: row;
        gap: 0.5rem;
        justify-content: center;
        padding: 0.375rem;
      }

      .step-number {
        width: 24px;
        height: 24px;
        font-size: 0.7rem;
      }

      .step-label {
        font-size: 0.6rem;
      }

      .progress-line {
        top: 12px;
        left: 16px;
        right: 16px;
      }

      .amount-input {
        font-size: 1.3rem;
      }

      .input-suffix {
        font-size: 1.1rem;
      }

      .quick-amounts {
        grid-template-columns: 1fr;
        gap: 0.25rem;
      }

      .quick-amount-btn {
        padding: 0.375rem;
        font-size: 0.75rem;
      }

      .verification-content {
        flex-direction: column;
        text-align: center;
        gap: 0.5rem;
      }

      .verify-btn {
        align-self: center;
      }
    }

    /* Estados hover mejorados */
    @media (hover: hover) {
      .method-card:hover .method-icon {
        transform: scale(1.05);
      }

      .bank-item-compact:hover .bank-logo-compact {
        transform: scale(1.05);
      }

      .nav-item:hover {
        background: rgba(26, 31, 113, 0.05);
      }

      .tab-item:hover:not(.active) {
        background: var(--neutral-300);
      }

      .method-option:hover .method-icon {
        background: var(--primary);
        color: white;
      }

      .support-option:hover .support-icon {
        transform: scale(1.05);
      }
    }

    /* Estilos de impresión */
    @media print {
      .header-container,
      .wizard-navigation,
      .bottom-nav,
      .support-container,
      .time-remaining,
      .loading-overlay,
      .modal-overlay,
      .toast-container {
        display: none !important;
      }

      .main-container {
        padding: 0;
      }

      .wizard-container,
      .classic-container {
        padding: 0;
        max-width: 100%;
      }

      body {
        background: white;
        color: black;
      }

      .balance-card-compact,
      .balance-card-expanded {
        background: white;
        color: black;
        border: 1px solid #ccc;
      }
    }

    /* Accesibilidad mejorada */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    @media (prefers-color-scheme: dark) {
      /* Preparación para modo oscuro futuro */
      :root {
        --dark-bg: #1a1a1a;
        --dark-surface: #2d2d2d;
        --dark-text: #ffffff;
        --dark-text-secondary: #b3b3b3;
      }
    }

    /* Focus states para accesibilidad */
    .method-card:focus,
    .bank-item-compact:focus,
    .nav-item:focus,
    .tab-item:focus,
    .method-option:focus,
    .support-option:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    .form-input:focus,
    .form-select:focus,
    .amount-input:focus,
    .amount-input-classic:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(26, 31, 113, 0.15);
    }

    /* Estados disabled mejorados */
    .nav-btn:disabled,
    .nav-btn.disabled,
    .submit-btn:disabled,
    .btn-primary:disabled,
    .btn-secondary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    /* Elementos de estado */
    .loading-state {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      color: var(--neutral-600);
    }

    .error-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;text-align: center;
      color: var(--danger);
    }

    .success-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      text-align: center;
      color: var(--success);
    }

    /* Elementos adicionales para funcionalidad completa */
    .fade-enter-active, .fade-leave-active {
      transition: opacity 0.3s;
    }

    .fade-enter, .fade-leave-to {
      opacity: 0;
    }

    .slide-enter-active, .slide-leave-active {
      transition: transform 0.3s;
    }

    .slide-enter, .slide-leave-to {
      transform: translateX(100%);
    }

    /* Elementos para compatibilidad completa */
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .backdrop-blur {
      backdrop-filter: blur(10px);
    }

    .filter-blur {
      filter: blur(5px);
    }

    .transform-gpu {
      transform: translateZ(0);
    }

    .will-change-transform {
      will-change: transform;
    }

    .contain-layout {
      contain: layout;
    }

    .isolate {
      isolation: isolate;
    }

    /* Ajustes finales para móviles pequeños */
    @media (max-width: 375px) {
      :root {
        --header-height: 60px;
        --nav-height: 60px;
        --wizard-nav-height: 50px;
      }

      .balance-card-compact {
        padding: 0.25rem 0.375rem;
        gap: 0.375rem;
      }

      .balance-amount {
        font-size: 0.8rem;
      }

      .balance-equivalent {
        font-size: 0.55rem;
      }

      .toggle-mode-btn {
        padding: 0.125rem;
        min-width: 40px;
        font-size: 0.55rem;
      }

      .toggle-mode-btn i {
        font-size: 0.8rem;
      }

      .greeting, .user-name {
        font-size: 0.75rem;
      }

      .wizard-container, .classic-container {
        padding: 0.5rem;
      }

      .step-title {
        font-size: 1.1rem;
      }

      .method-card {
        padding: 0.5rem;
      }

      .method-icon {
        width: 45px;
        height: 45px;
        font-size: 1.4rem;
      }

      .amount-input {
        height: 55px;
        font-size: 1.2rem;
      }

      .bank-item-compact {
        min-height: 70px;
        padding: 0.375rem;
      }

      .bank-logo-compact {
        width: 35px;
        height: 25px;
      }

      .bank-name-compact {
        font-size: 0.6rem;
      }
    }

    /* Landscape orientation fixes */
    @media (orientation: landscape) and (max-height: 500px) {
      .wizard-container {
        padding: 0.5rem;
      }

      .step-header {
        margin-bottom: 1rem;
      }

      .step-title {
        font-size: 1.1rem;
      }

      .progress-indicator {
        margin-bottom: 1rem;
      }

      .method-card {
        padding: 0.75rem;
      }

      .amount-input-container {
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .payment-form {
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .summary-card {
        padding: 1rem;
        margin-bottom: 1rem;
      }
    }

    /* PIN Modal */
    #pin-modal-overlay .modal {
      background: var(--neutral-100);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 500px;
      padding: 1.5rem;
      text-align: center;
      animation: scaleIn 0.3s ease;
    }

    #pin-modal-overlay .modal-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--neutral-900);
      margin-bottom: 0.75rem;
    }

    #pin-modal-overlay .modal-subtitle {
      font-size: 0.85rem;
      color: var(--neutral-600);
      margin-bottom: 1.5rem;
    }

    #pin-modal-overlay .otp-container {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin: 1.5rem 0;
    }

    #pin-modal-overlay .otp-input {
      width: 40px;
      height: 48px;
      border: 1px solid var(--neutral-400);
      border-radius: var(--radius-md);
      text-align: center;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--neutral-900);
    }

    #pin-modal-overlay .otp-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(26, 31, 113, 0.15);
    }

    #pin-modal-overlay .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 44px;
      padding: 0 1.5rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.85rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s var(--animation-bounce);
      width: 100%;
    }

    #pin-modal-overlay .btn-primary {
      background: var(--primary);
      color: #fff;
    }

    #pin-modal-overlay .btn-primary:hover {
      background: var(--primary-light);
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
    }

    #pin-modal-overlay .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }

    #pin-modal-overlay .btn-outline:hover {
      background: rgba(26, 31, 113, 0.05);
      transform: translateY(-3px);
    }

  </style>
  <script type="text/javascript">window.$crisp=[];window.CRISP_WEBSITE_ID="c2ba36cb-40b6-496f-b3fa-9a494d1f0d33";(function(){d=document;s=d.createElement("script");s.src="https://client.crisp.chat/l.js";s.async=1;d.getElementsByTagName("head")[0].appendChild(s);})();</script>
</head>

<body class="wizard-mode">
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
      <img id="loading-bank-logo" class="overlay-bank-logo" src="" alt="Banco">
      <div class="loading-spinner"></div>
      <div id="loading-text" class="loading-text">Procesando tu solicitud...</div>
      <div class="progress-container">
        <div id="progress-bar" class="progress-bar"></div>
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Header con Balance Siempre Visible -->
    <div class="header-container">
      <div class="header-content">
        <div class="header-info">
          <div class="welcome-text">
            <span class="greeting">Hola</span>
            <span class="user-name" id="user-name">Usuario</span>
            <div class="header-avatar" id="header-avatar"></div>
          </div>
          <div id="users-online-count" class="users-online">98 usuarios conectados</div>
        </div>
        
        <!-- Balance Card Compacta -->
        <div class="balance-card-compact">
          <div class="balance-main">
            <div class="balance-amount">
              <span id="balance-value">Bs 0,00</span>
              <button id="currency-toggle" class="currency-toggle-btn">USD</button>
            </div>
            <div id="balance-equivalent-display" class="balance-equivalent">≈ $0.00 | ≈ €0.00</div>
          </div>
          <div class="mode-toggle">
            <button id="toggle-mode-btn" class="toggle-mode-btn">
              <i class="fas fa-layer-group"></i>
              <span id="mode-toggle-text">Clásico</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Wizard Container -->
    <div id="wizard-container" class="wizard-container">
      <!-- Barra de progreso -->
      <div class="progress-container-wizard" id="progressContainer">
        <div class="progress-bar-wizard">
          <div class="progress-fill-wizard" id="progressFill"></div>
        </div>
        <div class="progress-text-wizard">
          <span>Retiro en progreso</span>
          <span class="progress-percentage-wizard" id="progressPercentage">0%</span>
        </div>
      </div>

      <!-- Paso 1: Selección de Método -->
      <div id="wizard-step-1" class="wizard-step active no-scroll">
        <div class="step-header">
          <h2 class="step-title">¿Cómo quieres recibir tu dinero?</h2>
          <p class="step-subtitle">Selecciona el método que prefieras</p>
        </div>
        
        <div class="method-selection-grid">
          <div class="method-card" data-method="mobile">
            <div class="method-icon">
              <i class="fas fa-mobile-alt"></i>
            </div>
            <div class="method-info">
              <h3 class="method-title">Pago Móvil</h3>
              <p class="method-description">Recibe en tu número de teléfono asociado al banco</p>
              <div class="method-limits">Límite: Bs 500.000</div>
            </div>
            <div class="method-badge instant">Instantáneo</div>
          </div>

          <div class="method-card" data-method="bank">
            <div class="method-icon">
              <i class="fas fa-university"></i>
            </div>
            <div class="method-info">
              <h3 class="method-title">Transferencia Bancaria</h3>
              <p class="method-description">Directo a tu cuenta bancaria</p>
              <div class="method-limits">Límite: Bs 1.000.000</div>
            </div>
            <div class="method-badge instant">Instantáneo</div>
          </div>

          <div class="method-card" data-method="international">
            <div class="method-icon">
              <i class="fas fa-globe"></i>
            </div>
            <div class="method-info">
              <h3 class="method-title">Internacional</h3>
              <p class="method-description">Zelle, PayPal, Wise, SWIFT, Crypto</p>
              <div class="method-limits">En USD/EUR</div>
            </div>
            <div class="method-badge international">Global</div>
          </div>
        </div>
      </div>

      <!-- Paso 2: Monto -->
      <div id="wizard-step-2" class="wizard-step">
        <div class="step-header">
          <h2 class="step-title">¿Cuánto quieres retirar?</h2>
          <p id="step-2-subtitle" class="step-subtitle">Ingresa el monto que deseas retirar</p>
        </div>

        <div class="amount-input-container">
          <div class="available-balance" id="wizard-available-balance">Saldo disponible: Bs 0,00</div>
          <div class="currency-selector">
            <div class="currency-option active" data-currency="bs">
              <span class="currency-symbol">Bs</span>
              <span class="currency-name">Bolívares</span>
            </div>
            <div class="currency-option" data-currency="usd">
              <span class="currency-symbol">$</span>
              <span class="currency-name">Dólares</span>
            </div>
          </div>

          <div class="amount-input-wrapper">
            <input type="text" id="withdrawal-amount" class="amount-input" placeholder="0,00" maxlength="15" inputmode="numeric">
            <div class="input-suffix">
              <span id="currency-symbol">Bs</span>
            </div>
          </div>
          
          <div id="amount-equivalents" class="amount-equivalents">≈ $0.00 | ≈ €0.00</div>
          <div id="amount-exceed-warning" class="amount-warning">El monto excede tu saldo disponible.</div>
        </div>

        <!-- Información de Límites -->
        <div id="amount-limits-info" class="amount-limits-info">
          <div class="limits-content">
            <i class="fas fa-info-circle"></i>
            <div>
              <div class="limits-title">Límites de retiro:</div>
              <div id="limits-text" class="limits-text">Pago Móvil: mínimo Bs 3.777,50 ($25,00) | máximo Bs 500.000 ($3.309,07)<br>Transferencia Bancaria: mínimo Bs 3.777,50 ($25,00) | máximo Bs 1.000.000 ($6.618,13)</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Paso 3: Selección de Banco -->
      <div id="wizard-step-3" class="wizard-step">
        <div class="step-header">
          <h2 class="step-title">Selecciona tu banco</h2>
          <p id="step-3-subtitle" class="step-subtitle">Elige el banco donde tienes tu cuenta</p>
        </div>

        <div id="bank-grid" class="bank-grid-compact">
          <!-- Los bancos se cargan dinámicamente -->
        </div>
      </div>

      <!-- Paso 4: Datos de la Cuenta -->
      <div id="wizard-step-4" class="wizard-step">
        <div class="step-header">
          <h2 class="step-title">Datos de tu cuenta</h2>
          <p id="step-4-subtitle" class="step-subtitle">Información de tu pago móvil</p>
        </div>

        <!-- Formulario Pago Móvil -->
        <div id="mobile-form" class="payment-form">
          <div class="form-group">
            <label for="mobile-number" class="form-label">Número de Teléfono</label>
            <input type="tel" id="mobile-number" class="form-input" placeholder="0412-1234567" maxlength="12" inputmode="numeric">
            <div id="mobile-number-error" class="form-error">Este campo es obligatorio</div>
            <div class="form-help">Introduce el número registrado en tu banco para pago móvil</div>
          </div>

          <div class="form-group">
            <label for="mobile-id" class="form-label">Cédula de Identidad</label>
            <input type="text" id="mobile-id" class="form-input" placeholder="V-12345678" maxlength="12" inputmode="numeric">
            <div id="mobile-id-error" class="form-error">Este campo es obligatorio</div>
            <div class="form-help">Debe ser tu propia cédula, igual a la registrada en el banco</div>
          </div>

          <div class="form-group">
            <label for="mobile-name" class="form-label">Nombre Completo</label>
            <input type="text" id="mobile-name" class="form-input" placeholder="Juan Pérez" maxlength="50">
            <div id="mobile-name-error" class="form-error">Este campo es obligatorio</div>
            <div class="form-help">Nombres y apellidos exactamente como aparecen en tu banco</div>
          </div>
        </div>

        <!-- Formulario Transferencia Bancaria -->
        <div id="bank-form" class="payment-form" style="display: none;">
          <div class="form-group">
            <label for="account-type" class="form-label">Tipo de Cuenta</label>
            <select id="account-type" class="form-select">
              <option value="">Seleccionar tipo</option>
              <option value="corriente">Cuenta Corriente</option>
              <option value="ahorro">Cuenta de Ahorro</option>
            </select>
            <div class="form-help">Selecciona el tipo de cuenta bancaria que tienes</div>
          </div>

          <div class="form-group">
            <label for="account-number" class="form-label">Número de Cuenta</label>
            <input type="text" id="account-number" class="form-input" placeholder="01020123456789012345" maxlength="20" inputmode="numeric">
            <div id="account-number-error" class="form-error">Este campo es obligatorio</div>
            <div class="form-help">Ingresa tu número de cuenta completo (20 dígitos)</div>
          </div>

          <div class="form-group">
            <label for="account-id" class="form-label">Cédula del Titular</label>
            <input type="text" id="account-id" class="form-input" placeholder="V-12345678" maxlength="12" inputmode="numeric">
            <div id="account-id-error" class="form-error">Este campo es obligatorio</div>
            <div class="form-help">Debe ser tu propia cédula, igual a la registrada en el banco</div>
          </div>

          <div class="form-group">
            <label for="account-name" class="form-label">Nombre del Titular</label>
            <input type="text" id="account-name" class="form-input" placeholder="Juan Pérez" maxlength="50">
            <div id="account-name-error" class="form-error">Este campo es obligatorio</div>
            <div class="form-help">Nombres y apellidos exactamente como aparecen en tu banco</div>
          </div>
        </div>

        <!-- Formulario Internacional -->
        <div id="international-form" class="payment-form" style="display: none;">
          <div class="form-group">
            <label for="int-method" class="form-label">Método de Envío</label>
            <select id="int-method" class="form-select">
              <option value="">Seleccionar método</option>
              <option value="zelle">Zelle</option>
              <option value="paypal">PayPal</option>
              <option value="wise">Wise (Transferwise)</option>
              <option value="swift">Transferencia SWIFT</option>
              <option value="crypto">Criptomonedas</option>
            </select>
            <div class="form-help">Selecciona el método que prefieres para recibir tus fondos</div>
          </div>

          <!-- Formularios específicos por método -->
          <div id="zelle-form" class="method-specific-form">
            <div class="form-group">
              <label for="zelle-email" class="form-label">Email registrado en Zelle</label>
              <input type="email" id="zelle-email" class="form-input" placeholder="usuario@ejemplo.com">
              <div id="zelle-email-error" class="form-error">Email requerido</div>
              <div class="form-help">El correo debe estar asociado a tu cuenta de Zelle</div>
            </div>
          </div>

          <div id="paypal-form" class="method-specific-form">
            <div class="form-group">
              <label for="paypal-email" class="form-label">Email de PayPal</label>
              <input type="email" id="paypal-email" class="form-input" placeholder="usuario@ejemplo.com">
              <div id="paypal-email-error" class="form-error">Email requerido</div>
              <div class="form-help">El correo debe estar asociado a tu cuenta de PayPal</div>
            </div>
          </div>

          <div id="wise-form" class="method-specific-form">
            <div class="form-group">
              <label for="wise-email" class="form-label">Email de Wise</label>
              <input type="email" id="wise-email" class="form-input" placeholder="usuario@ejemplo.com">
              <div id="wise-email-error" class="form-error">Email requerido</div>
              <div class="form-help">El correo debe estar asociado a tu cuenta de Wise</div>
            </div>
          </div>

          <div id="swift-form" class="method-specific-form">
            <div class="form-group">
              <label for="swift-bank" class="form-label">Nombre del Banco</label>
              <input type="text" id="swift-bank" class="form-input" placeholder="Bank of America">
              <div class="form-help">Nombre completo del banco receptor</div>
            </div>
            <div class="form-group">
              <label for="swift-code" class="form-label">Código SWIFT/BIC</label>
              <input type="text" id="swift-code" class="form-input" placeholder="BOFAUS3N">
              <div class="form-help">Código internacional de tu banco (8 o 11 caracteres)</div>
            </div>
            <div class="form-group">
              <label for="swift-account" class="form-label">Número de Cuenta / IBAN</label>
              <input type="text" id="swift-account" class="form-input" placeholder="1234567890" inputmode="numeric">
              <div class="form-help">Número de cuenta internacional o IBAN completo</div>
            </div>
            <div class="form-group">
              <label for="swift-name" class="form-label">Nombre del Beneficiario</label>
              <input type="text" id="swift-name" class="form-input" placeholder="John Doe">
              <div class="form-help">Tu nombre completo tal como aparece en el banco</div>
            </div>
            <div class="form-group">
              <label for="swift-address" class="form-label">Dirección del Beneficiario</label>
              <input type="text" id="swift-address" class="form-input" placeholder="Dirección completa">
              <div class="form-help">Tu dirección tal como está registrada en el banco</div>
            </div>
          </div>

          <div id="crypto-form" class="method-specific-form">
            <div class="form-group">
              <label for="crypto-currency" class="form-label">Criptomoneda</label>
              <select id="crypto-currency" class="form-select">
                <option value="btc">Bitcoin (BTC)</option>
                <option value="eth">Ethereum (ETH)</option>
                <option value="usdt">Tether (USDT)</option>
                <option value="usdc">USD Coin (USDC)</option>
                <option value="bnb">Binance Coin (BNB)</option>
              </select>
              <div class="form-help">Selecciona la criptomoneda que deseas recibir</div>
            </div>
            <div class="form-group">
              <label for="crypto-address" class="form-label">Dirección de Wallet</label>
              <input type="text" id="crypto-address" class="form-input" placeholder="1A2b3C4d5E6f7G8h9I0j...">
              <div id="crypto-address-error" class="form-error">Dirección requerida</div>
              <div class="form-help">Verifica que la dirección sea correcta antes de continuar</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Paso 5: Confirmación -->
      <div id="wizard-step-5" class="wizard-step no-scroll">
        <div class="step-header">
          <h2 class="step-title">Confirma tu retiro</h2>
          <p class="step-subtitle">Revisa los datos antes de continuar</p>
        </div>

        <div class="summary-card">
          <div class="summary-item">
            <span class="summary-label">Método:</span>
            <span id="summary-method" class="summary-value">Pago Móvil</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Banco/Destino:</span>
            <span id="summary-bank" class="summary-value">Banco Venezuela</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Cuenta/Teléfono:</span>
            <span id="summary-account" class="summary-value">0412-1234567</span>
          </div>
          <div class="summary-item total">
            <span class="summary-label">Monto a retirar:</span>
            <span id="summary-amount" class="summary-value">Bs 10.000,00</span>
          </div>
        </div>

        <!-- Banner de Verificación -->
        <div id="verification-banner" class="verification-banner" style="display: none;">
          <div class="verification-content">
            <div class="verification-icon">
              <i class="fas fa-shield-alt"></i>
            </div>
            <div class="verification-text">
              <div class="verification-title">Verificación Requerida</div>
              <div class="verification-message">Para completar tu retiro, necesitas verificar tu cuenta bancaria</div>
            </div>
            <button id="verify-now-btn" class="verify-btn" disabled>
              <i class="fas fa-check-circle"></i>
              Verificar Ahora
            </button>
          </div>
        </div>

        <!-- Security Badge -->
        <div class="security-badge">
          <div class="security-badge-icon">
            <i class="fas fa-shield-alt"></i>
          </div>
          <div class="security-badge-content">
            <div class="security-badge-title">Transferencia Segura</div>
            <div class="security-badge-text">Todas tus transacciones están protegidas con certificados de seguridad</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Container Clásico (oculto por defecto) -->
    <div id="classic-container" class="classic-container" style="display: none;">
      <!-- Balance Card Expandida (Modo Clásico) -->
      <div class="balance-card-expanded">
        <div class="balance-header">
          <h3 class="balance-title">Tu Saldo Disponible</h3>
          <button id="classic-currency-toggle" class="currency-toggle-btn">USD</button>
        </div>
        
        <div class="balance-main-expanded">
          <div id="classic-balance-value" class="balance-amount-large">Bs 0,00</div>
          <div id="classic-balance-equivalent" class="balance-equivalent-large">≈ $0.00 | ≈ €0.00</div>
        </div>
        
        <div id="classic-exchange-rate-display" class="exchange-rate"></div>
      </div>

      <!-- Tabs -->
      <div class="tabs-container">
        <div class="tabs">
          <div class="tab-item active" data-tab="new-withdrawal">
            <i class="fas fa-plus-circle"></i>
            <span>Nuevo Retiro</span>
          </div>
          <div class="tab-item" data-tab="pending">
            <i class="fas fa-clock"></i>
            <span>Pendientes</span>
            <span class="nav-badge">0</span>
          </div>
          <div class="tab-item" data-tab="history">
            <i class="fas fa-history"></i>
            <span>Historial</span>
          </div>
        </div>
      </div>

      <!-- Contenido de Tabs -->
      <div class="tab-contents">
        <!-- Tab: Nuevo Retiro -->
        <div id="new-withdrawal-tab" class="tab-content active">
          <!-- Security Badge -->
          <div class="security-badge">
            <div class="security-badge-icon">
              <i class="fas fa-shield-alt"></i>
            </div>
            <div class="security-badge-content">
              <div class="security-badge-title">Transferencia Segura</div>
              <div class="security-badge-text">Todas tus transacciones están protegidas con certificados de seguridad</div>
            </div>
          </div>

          <!-- Selección de Método -->
          <div class="method-selection">
            <h3 class="section-title">Método de Retiro</h3>
            <div class="method-options">
              <div class="method-option active" data-method="mobile" data-limit="500000">
                <div class="method-icon">
                  <i class="fas fa-mobile-alt"></i>
                </div>
                <div class="method-details">
                  <div class="method-label">Pago Móvil</div>
                  <div class="method-limit">Límite: Bs 500.000</div>
                </div>
                <div class="method-check">
                  <i class="fas fa-check"></i>
                </div>
              </div>

              <div class="method-option" data-method="bank" data-limit="1000000">
                <div class="method-icon">
                  <i class="fas fa-university"></i>
                </div>
                <div class="method-details">
                  <div class="method-label">Transferencia Bancaria</div>
                  <div class="method-limit">Límite: Bs 1.000.000</div>
                </div>
                <div class="method-check">
                  <i class="fas fa-check"></i>
                </div>
              </div>

              <div class="method-option" data-method="international">
                <div class="method-icon">
                  <i class="fas fa-globe"></i>
                </div>
                <div class="method-details">
                  <div class="method-label">Internacional</div>
                  <div class="method-limit">USD/EUR disponible</div>
                </div>
                <div class="method-check">
                  <i class="fas fa-check"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- Monto -->
          <div class="amount-section">
            <h3 class="section-title">Monto a Retirar</h3>
            <div class="available-balance" id="classic-available-balance">Saldo disponible: Bs 0,00</div>
            <div class="amount-input-group">
              <div class="amount-input-wrapper">
                <span class="currency-prefix">Bs</span>
                <input type="text" id="classic-withdrawal-amount" class="amount-input-classic" placeholder="0,00" maxlength="15">
              </div>
              <div id="classic-amount-equivalents" class="amount-equivalents">≈ $0.00 | ≈ €0.00</div>
              <div id="classic-amount-exceed-warning" class="amount-warning">El monto excede tu saldo disponible.</div>
            </div>
          </div>

          <!-- Selección de Banco/Método -->
          <div id="classic-mobile-payment-form" class="bank-selection active">
            <h3 class="section-title">Banco de Pago Móvil</h3>
            <div id="classic-mobile-bank-grid" class="bank-logos-grid">
              <!-- Logos de bancos se cargan aquí -->
            </div>
            <input type="hidden" id="classic-mobile-bank">

            <div class="form-group" style="margin-top: 1.5rem;">
              <label class="form-label" for="classic-mobile-number">Número de Teléfono</label>
              <input type="tel" class="form-input" id="classic-mobile-number" placeholder="Ejemplo: 0414-1234567" inputmode="numeric">
              <div class="form-error" id="classic-mobile-number-error" style="display: none;">Por favor, introduce un número de teléfono válido.</div>
              <div class="form-help">Introduce el número registrado en tu banco para pago móvil</div>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="classic-mobile-id">Cédula de Identidad</label>
              <input type="text" class="form-input" id="classic-mobile-id" placeholder="Ejemplo: V-12345678" inputmode="numeric">
              <div class="form-error" id="classic-mobile-id-error" style="display: none;">Por favor, introduce un número de cédula válido.</div>
              <div class="form-help">Debe ser tu propia cédula, igual a la registrada en el banco</div>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="classic-mobile-name">Nombre Completo</label>
              <input type="text" class="form-input" id="classic-mobile-name" placeholder="Tal como aparece en tu banco">
              <div class="form-error" id="classic-mobile-name-error" style="display: none;">Por favor, introduce tu nombre completo.</div>
              <div class="form-help">Nombres y apellidos exactamente como aparecen en tu banco</div>
            </div>
          </div>

          <div id="classic-bank-payment-form" class="bank-selection">
            <h3 class="section-title">Banco para Transferencia</h3>
            <div id="classic-bank-name-grid" class="bank-logos-grid">
              <!-- Logos de bancos se cargan aquí -->
            </div>
            <input type="hidden" id="classic-bank-name">

            <div class="form-group" style="margin-top: 1.5rem;">
              <label class="form-label" for="classic-account-type">Tipo de Cuenta</label>
              <select class="form-select" id="classic-account-type">
                <option value="" disabled selected>Seleccione el tipo de cuenta</option>
                <option value="corriente">Corriente</option>
                <option value="ahorro">Ahorro</option>
              </select>
              <div class="form-help">Selecciona el tipo de cuenta bancaria que tienes</div>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="classic-account-number">Número de Cuenta</label>
              <input type="text" class="form-input" id="classic-account-number" placeholder="Ejemplo: 0105-0000-00-0000000000" maxlength="20" inputmode="numeric">
              <div class="form-error" id="classic-account-number-error" style="display: none;">Por favor, introduce un número de cuenta válido.</div>
              <div class="form-help">Ingresa tu número de cuenta completo (20 dígitos)</div>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="classic-account-id">Cédula de Identidad</label>
              <input type="text" class="form-input" id="classic-account-id" placeholder="Ejemplo: V-12345678" inputmode="numeric">
              <div class="form-error" id="classic-account-id-error" style="display: none;">Por favor, introduce un número de cédula válido.</div>
              <div class="form-help">Debe ser tu propia cédula, igual a la registrada en el banco</div>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="classic-account-name">Nombre Completo</label>
              <input type="text" class="form-input" id="classic-account-name" placeholder="Tal como aparece en tu banco">
              <div class="form-error" id="classic-account-name-error" style="display: none;">Por favor, introduce tu nombre completo.</div>
              <div class="form-help">Nombres y apellidos exactamente como aparecen en tu banco</div>
            </div>
          </div>

          <div id="classic-international-payment-form" class="bank-selection">
            <h3 class="section-title">Método Internacional</h3>
            <p class="form-description">Los retiros internacionales se procesan en USD según la tasa de cambio actual.</p>
            
            <div class="form-group">
              <label class="form-label" for="classic-int-method">Método de Envío Internacional</label>
              <select class="form-select" id="classic-int-method">
                <option value="" disabled selected>Seleccione el método</option>
                <option value="zelle">Zelle</option>
                <option value="paypal">PayPal</option>
                <option value="wise">Wise (Transferwise)</option>
                <option value="swift">Transferencia SWIFT</option>
                <option value="crypto">Criptomonedas</option>
              </select>
              <div class="form-help">Selecciona el método que prefieres para recibir tus fondos</div>
            </div>
          </div>

          <!-- Botón de Envío -->
          <div class="submit-section">
            <button id="classic-submit-withdrawal" class="submit-btn">
              <i class="fas fa-paper-plane"></i>
              <span>Procesar Retiro</span>
            </button>
          </div>
        </div>

        <!-- Tab: Operaciones Pendientes -->
        <div id="pending-tab" class="tab-content">
          <div class="section-header">
            <h3 class="section-title">Operaciones Pendientes</h3>
            <p class="section-description">Retiros que están siendo procesados</p>
          </div>

          <div id="pending-transactions-list" class="transactions-list">
            <!-- Las transacciones pendientes se cargan aquí -->
          </div>

          <div id="no-pending-message" class="empty-state" style="display: none;">
            <div class="empty-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <h4>No tienes operaciones pendientes</h4>
            <p>Todas tus transacciones han sido procesadas</p>
          </div>
        </div>

        <!-- Tab: Historial -->
        <div id="history-tab" class="tab-content">
          <div class="section-header">
            <h3 class="section-title">Historial de Retiros</h3>
            <p class="section-description">Todas tus transacciones completadas</p>
          </div>

          <div id="transaction-history-list" class="transactions-list">
            <!-- El historial se carga aquí -->
          </div>

          <div id="no-history-message" class="empty-state" style="display: none;">
            <div class="empty-icon">
              <i class="fas fa-history"></i>
            </div>
            <h4>No hay transacciones aún</h4>
            <p>Cuando realices tu primer retiro aparecerá aquí</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Botones de Navegación del Wizard -->
    <div class="wizard-navigation">
      <button id="prev-step-btn" class="nav-btn secondary" style="display: none;">
        <i class="fas fa-chevron-left"></i>
        Anterior
      </button>
      <button id="next-step-btn" class="nav-btn primary disabled">
        Siguiente
        <i class="fas fa-chevron-right"></i>
      </button>
      <button id="finish-wizard-btn" class="nav-btn primary" style="display: none;">
        <i class="fas fa-check"></i>
        Confirmar Retiro
      </button>
    </div>
  </div>

  <!-- Navegación Inferior -->
  <div class="bottom-nav">
    <div id="nav-create-withdrawal" class="nav-item active">
      <div class="nav-icon">
        <i class="fas fa-plus-circle"></i>
      </div>
      <div class="nav-label">Retirar</div>
    </div>

    <div id="nav-home" class="nav-item">
      <div class="nav-icon">
        <i class="fas fa-home"></i>
      </div>
      <div class="nav-label">Inicio</div>
    </div>

    <div id="nav-pending-operations" class="nav-item">
      <div class="nav-icon">
        <i class="fas fa-clock"></i>
        <span class="nav-badge">0</span>
      </div>
      <div class="nav-label">Pendientes</div>
    </div>

    <div id="nav-history" class="nav-item">
      <div class="nav-icon">
        <i class="fas fa-history"></i>
      </div>
      <div class="nav-label">Historial</div>
    </div>

    <div id="nav-support" class="nav-item">
      <div class="nav-icon">
        <i class="fas fa-headset"></i>
      </div>
      <div class="nav-label">Ayuda</div>
    </div>
  </div>

  <!-- Container de Soporte -->
  <div id="support-container" class="support-container">
    <div class="support-header">
      <h3>Centro de Ayuda</h3>
      <button id="close-support" class="close-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="support-content">
      <div class="support-option">
        <div class="support-icon">
          <i class="fab fa-whatsapp"></i>
        </div>
        <div class="support-details">
          <h4>WhatsApp</h4>
          <p>Chatea con nuestro equipo</p>
        </div>
        <a href="https://wa.me/+17373018059" target="_blank" class="support-btn">
          <i class="fas fa-external-link-alt"></i>
        </a>
      </div>

      <div class="support-option">
        <div class="support-icon">
          <i class="fas fa-question-circle"></i>
        </div>
        <div class="support-details">
          <h4>Preguntas Frecuentes</h4>
          <p>Encuentra respuestas rápidas</p>
        </div>
        <button id="faq-btn" class="support-btn">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>

      <div class="support-option">
        <div class="support-icon">
          <i class="fas fa-shield-alt"></i>
        </div>
        <div class="support-details">
          <h4>Información de Seguridad</h4>
          <p>Conoce nuestras medidas</p>
        </div>
        <button id="show-security-info" class="support-btn">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Tiempo Restante (Inactividad) -->
  <div id="time-remaining" class="time-remaining">
    <div class="time-content">
      <div class="time-icon">
        <i class="fas fa-clock"></i>
      </div>
      <div class="time-text">
        Serás redirigido en <span id="redirect-countdown">60</span> segundos por inactividad
      </div>
      <div class="time-progress">
        <div id="time-remaining-progress" class="time-progress-fill"></div>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmación de Retiro -->
  <div id="withdrawal-confirmation-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Confirmar Retiro</h3>
        <img id="confirm-bank-logo" class="modal-bank-logo" src="" alt="Banco">
      </div>
      <div class="modal-body">
        <div id="withdrawal-confirmation-message" class="confirmation-message">
          Vas a retirar <strong>Bs 10.000,00</strong>.<br>
          Tu saldo restante será <strong>Bs 20.000,00</strong>.
        </div>
      </div>
      <div class="modal-footer confirm-modal">
        <button id="confirm-withdrawal-btn" class="btn btn-primary">Confirmar</button>
        <button id="cancel-withdrawal-btn" class="btn btn-outline" style="margin-top: 1rem;">Cancelar</button>
      </div>
    </div>
    </div>

    <!-- Advertencia Límite Pago Móvil -->
    <div id="mobile-limit-overlay" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Límite de Pago Móvil</h3>
        </div>
        <div class="modal-body">
          <p>Solo puedes retirar hasta <strong>Bs 500.000,00 (≈ $3.309,07)</strong> por Pago Móvil. Si necesitas retirar más, utiliza la opción de transferencia bancaria.</p>
        </div>
        <div class="modal-footer confirm-modal">
          <button id="mobile-limit-ok-btn" class="btn btn-primary">Entendido</button>
        </div>
      </div>
    </div>

    <!-- Flujo guiado para el primer retiro obligatorio -->
    <div id="first-withdrawal-overlay" class="modal-overlay">
      <div class="first-withdrawal-container">
        <div class="first-withdrawal-card">
          <div class="first-withdrawal-step active" data-step="intro">
            <div class="first-withdrawal-hero">
              <div class="first-withdrawal-icon">
                <i class="fas fa-bolt"></i>
              </div>
              <h3 class="first-withdrawal-title">Activa tus retiros</h3>
              <p class="first-withdrawal-subtitle">
                Antes de comenzar a retirar, enviaremos un retiro de validación de <strong id="first-withdrawal-amount-usd">$1.00</strong> a tu cuenta registrada.
              </p>
            </div>
            <div class="first-withdrawal-details">
              <div class="first-withdrawal-detail user-detail">
                <div class="first-withdrawal-user-avatar" id="first-withdrawal-user-avatar" role="img" aria-label="Avatar del titular">
                  <img id="first-withdrawal-user-avatar-img" class="first-withdrawal-user-avatar-img" alt="" aria-hidden="true" />
                </div>
                <div class="first-withdrawal-user-texts">
                  <span class="detail-label">Titular</span>
                  <span class="detail-value" id="first-withdrawal-user-name">—</span>
                </div>
              </div>
              <div class="first-withdrawal-grid">
                <div class="first-withdrawal-detail">
                  <span class="detail-label">Documento</span>
                  <span class="detail-value" id="first-withdrawal-user-id">—</span>
                </div>
                <div class="first-withdrawal-detail">
                  <span class="detail-label">Teléfono móvil</span>
                  <span class="detail-value" id="first-withdrawal-user-phone">—</span>
                </div>
              </div>
              <div class="first-withdrawal-bank">
                <div class="bank-logo-wrapper">
                  <img id="first-withdrawal-bank-logo" src="" alt="Logo del banco" class="bank-logo-img" />
                </div>
                <div class="bank-texts">
                  <span class="detail-label">Banco destino</span>
                  <span class="detail-value" id="first-withdrawal-bank-name">—</span>
                  <span class="detail-caption" id="first-withdrawal-bank-extra"></span>
                </div>
              </div>
              <div class="first-withdrawal-amount-card">
                <div class="amount-row">
                  <div>
                    <span class="detail-label">Monto de validación</span>
                    <span class="amount-value" id="first-withdrawal-usd-amount-display">$1.00</span>
                  </div>
                  <div class="amount-divider"></div>
                  <div>
                    <span class="detail-label">Equivalente estimado</span>
                    <span class="amount-secondary" id="first-withdrawal-bs-amount-display">Bs 0,00</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="first-withdrawal-actions">
              <button id="first-withdrawal-start-btn" class="btn btn-primary btn-large">
                <i class="fas fa-paper-plane"></i> Retirar 1 USD de mi cuenta
              </button>
              <button class="btn btn-link first-withdrawal-change" type="button">
                <i class="fas fa-user-edit"></i> Estos no son mis datos, quiero cambiarlo
              </button>
            </div>
          </div>

          <div class="first-withdrawal-step" data-step="processing">
            <div class="first-withdrawal-processing">
              <div class="first-withdrawal-spinner" aria-hidden="true"></div>
              <h3>Enviando tu validación</h3>
              <p>Estamos transfiriendo el monto de prueba a tu cuenta bancaria. Esto puede tardar unos segundos.</p>
            </div>
          </div>

          <div class="first-withdrawal-step" data-step="confirmation">
            <div class="first-withdrawal-hero">
              <div class="first-withdrawal-icon success">
                <i class="fas fa-shield-check"></i>
              </div>
              <h3 class="first-withdrawal-title">Confirma la recepción</h3>
              <p class="first-withdrawal-subtitle">
                Revisa el estado de tu banco y escribe el monto exacto que recibiste para finalizar la activación de retiros.
              </p>
            </div>
            <div class="first-withdrawal-confirmation">
              <label for="first-withdrawal-confirm-amount" class="detail-label">Monto recibido</label>
              <input id="first-withdrawal-confirm-amount" type="text" inputmode="decimal" placeholder="Ej: Bs 151,10" class="confirmation-input" autocomplete="off">
              <div id="first-withdrawal-error" class="field-error" role="alert"></div>
              <div class="confirmation-hint">
                Si recibiste el equivalente en bolívares, introdúcelo tal como aparece en tu estado. También aceptamos <strong>1,00</strong> como confirmación en dólares.
              </div>
            </div>
            <div class="first-withdrawal-actions">
              <button id="first-withdrawal-confirm-btn" class="btn btn-primary btn-large">
                Confirmé mi retiro de validación
              </button>
              <button id="first-withdrawal-support-btn" class="btn btn-outline btn-large" type="button">
                <i class="fab fa-whatsapp"></i> No he recibido 1 USD en mi cuenta
              </button>
              <button class="btn btn-link first-withdrawal-change" type="button">
                <i class="fas fa-user-edit"></i> Estos no son mis datos, quiero cambiarlo
              </button>
            </div>
          </div>
          <div id="first-withdrawal-success-animation" class="first-withdrawal-success-animation" aria-hidden="true">
            <div class="first-withdrawal-success-card">
              <div class="success-check-icon" aria-hidden="true"></div>
              <p class="first-withdrawal-success-title">¡Retiro validado!</p>
              <p class="first-withdrawal-success-text">Confirmamos la recepción del monto de validación y activamos tus retiros.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de PIN -->
  <div id="pin-modal-overlay" class="modal-overlay">
    <div class="modal">
      <img id="pin-bank-logo" class="modal-bank-logo" src="" alt="Banco">
      <div class="modal-title">Ingresa tu PIN</div>
      <div class="modal-subtitle">Confirma tu retiro ingresando tu PIN de 4 dígitos</div>
      <div class="otp-container">
        <input type="password" class="otp-input pin-digit" id="pin-1" maxlength="1" data-next="pin-2" inputmode="numeric" pattern="[0-9]*">
        <input type="password" class="otp-input pin-digit" id="pin-2" maxlength="1" data-next="pin-3" data-prev="pin-1" inputmode="numeric" pattern="[0-9]*">
        <input type="password" class="otp-input pin-digit" id="pin-3" maxlength="1" data-next="pin-4" data-prev="pin-2" inputmode="numeric" pattern="[0-9]*">
        <input type="password" class="otp-input pin-digit" id="pin-4" maxlength="1" data-prev="pin-3" inputmode="numeric" pattern="[0-9]*">
      </div>
      <div class="error-message" id="pin-error" style="text-align:center; display:none;">PIN incorrecto. Intenta nuevamente.</div>
      <button class="btn btn-primary" id="verify-pin-btn"><i class="fas fa-check"></i> Confirmar</button>
      <button class="btn btn-outline" id="cancel-pin-btn" style="margin-top: 1rem;"><i class="fas fa-times"></i> Cancelar</button>
      <p class="pin-help">¿Olvidaste tu PIN? <a href="https://wa.me/+17373018059" target="_blank" class="whatsapp-link">Escríbenos por WhatsApp</a> para restablecerlo.</p>
    </div>
  </div>

  <!-- Modal de Recibo -->
  <div id="receipt-modal" class="modal-overlay">
    <div class="modal-content modal-receipt">
      <div class="receipt-header">
        <div class="receipt-logo">
          <img id="receipt-bank-logo" class="receipt-bank-logo" src="" alt="Banco">
        </div>
        <h3 class="receipt-title">Valida tu cuenta para habilitar los retiros</h3>
        <p class="receipt-subtitle">Tu solicitud ha sido recibida exitosamente</p>
      </div>

      <div class="receipt-details">
        <div class="detail-row">
          <span class="detail-label">Orden:</span>
          <span id="receipt-order" class="detail-value">RET-789456</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Fecha:</span>
          <span id="receipt-date" class="detail-value">15 de enero de 2025</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Monto:</span>
          <span id="receipt-amount" class="detail-value">Bs 10.000,00</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Método:</span>
          <span id="receipt-method" class="detail-value">Pago Móvil</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Destino:</span>
          <span id="receipt-destination" class="detail-value">0412-1234567</span>
        </div>
      </div>


      <div class="receipt-timeline">
        <div class="timeline-item completed">
          <div id="step-create" class="timeline-step">
            <i class="fas fa-check"></i>
          </div>
          <div class="timeline-content">
            <h4>Solicitud Creada</h4>
            <p>Tu retiro ha sido registrado</p>
          </div>
        </div>

        <div class="timeline-item active">
          <div id="step-verify" class="timeline-step">
            <i class="fas fa-shield-alt"></i>
          </div>
          <div class="timeline-content">
            <h4>Verificación</h4>
            <p>Confirma tu cuenta bancaria</p>
          </div>
        </div>

        <div class="timeline-item">
          <div class="timeline-step">
            <i class="fas fa-credit-card"></i>
          </div>
          <div class="timeline-content">
            <h4>Procesamiento</h4>
            <p>Tu dinero será enviado</p>
          </div>
        </div>

        <div class="timeline-progress">
          <div id="timeline-progress" class="timeline-progress-fill"></div>
        </div>
      </div>

      <div class="receipt-actions">
        <button id="share-whatsapp" class="action-btn whatsapp">
          <i class="fab fa-whatsapp"></i>
          WhatsApp
        </button>
        <button id="share-email" class="action-btn email">
          <i class="fas fa-envelope"></i>
          Email
        </button>
        <button id="share-download" class="action-btn download">
          <i class="fas fa-download"></i>
          Descargar
        </button>
      </div>

      <div class="receipt-footer">
        <button id="close-receipt" class="btn btn-primary">Acepto, continuar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmación de Verificación -->
  <div id="verification-confirmation-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Verificación de Cuenta</h3>
      </div>
      <div class="modal-body">
        <div class="verification-explanation">
          <p>Para retirar tus fondos debes validar tu cuenta con tu documento de identidad.</p>
          <p>Serás dirigido a la sección de recargas donde podrás iniciar este proceso.</p>
          
          <div style="margin: 1.5rem 0;">
            <div style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 1rem;">
              <div style="width: 25px; height: 25px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.85rem; flex-shrink: 0;">1</div>
                <div style="font-size: 0.9rem; color: var(--neutral-800); line-height: 1.4;" id="verification-step1">
                  <span id="min-validation-text">El monto mínimo de validación para tu cuenta <span id="account-level-span">Estándar</span> es de <span id="verification-amount-usd">$25,00</span> (<span id="verification-amount-bs">Bs 0,00</span>).</span> Serás dirigido a la sección de <strong>Recargar Saldo</strong> para realizar este depósito.
                </div>
            </div>
            
            <div style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 1rem;">
              <div style="width: 25px; height: 25px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.85rem; flex-shrink: 0;">2</div>
              <div style="font-size: 0.9rem; color: var(--neutral-800); line-height: 1.4;">
                Este depósito se sumará automáticamente a tu saldo disponible.
              </div>
            </div>
            
            <div style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 1rem;">
              <div style="width: 25px; height: 25px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.85rem; flex-shrink: 0;">3</div>
              <div style="font-size: 0.9rem; color: var(--neutral-800); line-height: 1.4;">
                Al verificar tu cuenta, podrás retirar fondos sin limitaciones en el futuro.
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer confirm-modal">
        <button id="confirmation-proceed-btn" class="btn btn-primary">Validar ahora</button>
        <button id="confirmation-cancel-btn" class="btn btn-outline" style="margin-top: 1rem;">Más tarde</button>
      </div>
    </div>
  </div>

  <!-- Modal de Información de Seguridad -->
  <div id="security-info-modal" class="modal-overlay">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3 class="modal-title">Información de Seguridad</h3>
        <button id="close-security-info" class="modal-close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="security-section">
          <h4><i class="fas fa-shield-alt"></i> Medidas de Seguridad</h4>
          <ul>
            <li>Todas las transacciones están protegidas con encriptación SSL</li>
            <li>Verificación de identidad obligatoria para retiros</li>
            <li>Monitoreo 24/7 contra actividades fraudulentas</li>
            <li>Límites de retiro para mayor protección</li>
          </ul>
        </div>

        <div class="faq-section">
          <h4><i class="fas fa-question-circle"></i> Preguntas Frecuentes</h4>
          
          <div class="faq-item">
            <div class="faq-header">
              <span>¿Por qué necesito verificar mi cuenta?</span>
              <i class="fas fa-chevron-down"></i>
            </div>
            <div class="faq-content">
              <p>La verificación es un requisito regulatorio que garantiza la seguridad de tu dinero y cumple con las normativas financieras internacionales. Al hacer un depósito desde tu banco hacia Remeex VISA, nos demuestras que eres tú quien controla esa cuenta. Esto previene que alguien intente desviar tu dinero a una cuenta fraudulenta.</p>
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-header">
              <span>¿Perderé el dinero del depósito de verificación?</span>
              <i class="fas fa-chevron-down"></i>
            </div>
            <div class="faq-content">
              <p>¡Absolutamente NO! El depósito de verificación NO es una comisión ni un cobro. Es únicamente un depósito que se suma completamente a tu saldo disponible en tu cuenta Remeex VISA en el mismo instante en que lo recibimos.</p>
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-header">
              <span>¿Cuánto tiempo toma el retiro?</span>
              <i class="fas fa-chevron-down"></i>
            </div>
            <div class="faq-content">
              <p>Los pago móviles son instantáneos. Las transferencias bancarias nacionales toman 1-2 horas. Los retiros internacionales pueden tomar 1-3 días hábiles.</p>
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-header">
              <span>¿Hay límites de retiro?</span>
              <i class="fas fa-chevron-down"></i>
            </div>
            <div class="faq-content">
              <p>Pago móvil: mínimo $25,00 (Bs 3.777,50) y máximo Bs 500.000 (≈ $3.309,07) por transacción. Transferencias bancarias: mínimo $25,00 (Bs 3.777,50) y máximo Bs 1.000.000 (≈ $6.618,13) por transacción. Retiros internacionales: consultar límites según el método.</p>
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-header">
              <span>¿Es seguro usar REMEEX?</span>
              <i class="fas fa-chevron-down"></i>
            </div>
            <div class="faq-content">
              <p>Sí, REMEEX cumple con los más altos estándares de seguridad financiera y está regulado por las autoridades competentes. Utilizamos encriptación de grado militar y protocolos de seguridad bancaria.</p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="close-security-info-btn" class="btn btn-primary">Entendido</button>
      </div>
    </div>
  </div>
  
  <!-- Modal Video de Verificación -->
  <div id="verification-video-modal" class="modal-overlay">
    <div class="modal-content">
      <button id="close-verification-video" class="modal-close">
        <i class="fas fa-times"></i>
      </button>
      <div class="modal-body">
        <div style="padding:54.16% 0 0 0;position:relative;">
          <iframe src="https://player.vimeo.com/video/1095930230?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479" frameborder="0" allow="autoplay; fullscreen; picture-in-picture; clipboard-write; encrypted-media; web-share" style="position:absolute;top:0;left:0;width:100%;height:100%;" title="visa"></iframe>
        </div>
      </div>
    </div>
  </div>
  <script src="https://player.vimeo.com/api/player.js"></script>

  <!-- Toast Container -->
  <div id="toast-container" class="toast-container"></div>

  <!-- Script Principal -->
  <script>
    // Configuración de valores constantes con tasa de cambio centralizada
    const CONFIG = {
      EXCHANGE_RATES: {
        USD_TO_BS: 151.10,  // Tasa centralizada
        USD_TO_EUR: 0.94,
        FORCED_VALIDATION_USD: null
      },
      STORAGE_KEYS: {
        USER_DATA: 'remeexUserData',
        BALANCE: 'remeexBalance',
        TRANSACTIONS: 'remeexTransactions',
        VERIFICATION: 'remeexVerificationStatus',
        TRANSFER_DATA: 'remeexTransferData',
        REFERRER: 'remeexReferrer',
        TRANSACTION_HISTORY: 'remeexTransactionHistory',
        PENDING_TRANSACTIONS: 'remeexPendingTransactions',
        VERIFICATION_CONFIRMATION: 'remeexVerificationConfirmed',
        HISTORY_INITIALIZED: 'remeexHistoryInitialized',
        EXCHANGE_RATE: 'remeexSessionExchangeRate'
      },
      LIMITS: {
        MOBILE: 500000, // 500,000 Bs
        BANK: 1000000 // 1,000,000 Bs
      },
      BANKS: {
        NACIONAL: [
          { id: 'banco-venezuela', name: 'Banco de Venezuela', logo: 'https://www.bancodevenezuela.com/wp-content/uploads/2023/03/logonuevo.png' },
          { id: 'banco-venezolano', name: 'Banco Venezolano de Crédito', logo: 'https://www.venezolano.com/images/galeria/108_1.png' },
          { id: 'banco-mercantil', name: 'Banco Mercantil', logo: 'https://files.socialgest.net/mybio/5f529398b36f8_1599247256.png' },
          { id: 'banco-provincial', name: 'Banco Provincial', logo: 'https://upload.wikimedia.org/wikipedia/commons/d/d4/BBVAprovinciallogo.svg' },
          { id: 'banco-bancaribe', name: 'Banco del Caribe (Bancaribe)', logo: 'https://d3olc33sy92l9e.cloudfront.net/wp-content/themes/bancaribe/images/Bancaribe-LogotipoTurquesa.png' },
          { id: 'banco-exterior', name: 'Banco Exterior', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d3/Banco-Exterior-VE-logo.png/183px-Banco-Exterior-VE-logo.png' },
          { id: 'banco-caroni', name: 'Banco Caroní', logo: 'https://upload.wikimedia.org/wikipedia/commons/d/db/Banco-Caron%C3%AD-logo.png' },
          { id: 'banco-banesco', name: 'Banesco', logo: 'https://banesco-prod-2020.s3.amazonaws.com/wp-content/themes/banescocontigo/assets/images/header/logo.svg.gzip' },
          { id: 'banco-sofitasa', name: 'Banco Sofitasa', logo: 'https://www.sofitasa.com/assets/img/nuevo_logo.png' },
          { id: 'banco-plaza', name: 'Banco Plaza', logo: 'https://images.crunchbase.com/image/upload/c_pad,h_170,w_170,f_auto,b_white,q_auto:eco,dpr_1/xaohzgslrcyk6if8bw0p' },
          { id: 'banco-bancofc', name: 'Banco Fondo Común', logo: 'https://www.bfc.com.ve/wp-content/uploads/2021/01/logofos.png' },
          { id: 'banco-100banco', name: '100% Banco', logo: 'https://www.100x100banco.com/img/logo.png' },
          { id: 'banco-tesoro', name: 'Banco del Tesoro', logo: 'https://comerciomovil.bt.com.ve/_next/static/media/logo-slogan.907bb4c8.png' },
          { id: 'banco-bancrecer', name: 'Bancrecer', logo: 'https://images.seeklogo.com/logo-png/36/1/bancrecer-logo-png_seeklogo-364928.png' },
          { id: 'banco-r4', name: 'R4', logo: 'https://www.r4conecta.io/_nuxt/img/mibanco_logo.67b5af9.png' },
          { id: 'banco-activo', name: 'Banco Activo', logo: 'https://www.bancoactivo.com/logo.svg' },
          { id: 'banco-bancamiga', name: 'Bancamiga', logo: 'https://vectorseek.com/wp-content/uploads/2023/09/Bancamiga-Logo-Vector.svg-.png' },
          { id: 'banco-banplus', name: 'Banplus', logo: 'https://www.banplus.com/wp-content/uploads/2024/07/logo_banplus-ppal-retina.png' },
          { id: 'banco-bicentenario', name: 'Banco Bicentenario', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/da/BancoDigitaldelosTrabajadores.png/320px-BancoDigitaldelosTrabajadores.png' },
          { id: 'banco-bnc', name: 'Banco Nacional de Crédito', logo: 'https://www.bncenlinea.com/images/default-source/misc/BNCLogo_rebrand.png' },
          { id: 'banco-bcv', name: 'Banco Central de Venezuela', logo: 'https://www.bcv.org.ve/sites/default/files/default_images/logo_bcv-04_2.png' }
        ]
      },
      BANK_CODES: {
        'banco-venezuela': '0102',
        'banco-venezolano': '0104',
        'banco-mercantil': '0105',
        'banco-provincial': '0108',
        'banco-bancaribe': '0114',
        'banco-exterior': '0115',
        'banco-caroni': '0128',
        'banco-banesco': '0134',
        'banco-sofitasa': '0137',
        'banco-plaza': '0138',
        'banco-bancofc': '0151',
        'banco-100banco': '0156',
        'banco-tesoro': '0163',
        'banco-bancrecer': '0168',
        'banco-r4': '0169',
        'banco-activo': '0171',
        'banco-bancamiga': '0172',
        'banco-banplus': '0174',
        'banco-bicentenario': '0175',
        'banco-bnc': '0191'
      },
      INACTIVITY_TIMEOUT: 120,
      VERIFICATION_CODE: Math.floor(10000 + Math.random() * 90000),
      VERIFICATION_AMOUNT_USD: 25,
      ACCOUNT_LEVEL: 'Estándar',
      get VERIFICATION_AMOUNT_BS() {
        return (this.VERIFICATION_AMOUNT_USD * this.EXCHANGE_RATES.USD_TO_BS).toFixed(2);
      }
      };

      function loadExchangeRate() {
        const data = window.getStoredExchangeRate ? window.getStoredExchangeRate() : null;
        if (data) {
          CONFIG.EXCHANGE_RATES.USD_TO_BS = data.USD_TO_BS;
          CONFIG.EXCHANGE_RATES.USD_TO_EUR = data.USD_TO_EUR;
        }
      }

    function getVerificationAmountUsd(balanceUsd) {
      let amount;
      if (CONFIG.EXCHANGE_RATES.FORCED_VALIDATION_USD !== null) {
        amount = CONFIG.EXCHANGE_RATES.FORCED_VALIDATION_USD;
      } else if (balanceUsd >= 5001) {
        amount = 45;
      } else if (balanceUsd >= 2001) {
        amount = 40;
      } else if (balanceUsd >= 1001) {
        amount = 35;
      } else if (balanceUsd >= 501) {
        amount = 30;
      } else {
        amount = 25;
      }
      return Math.max(25, amount);
    }

    function getAccountLevel(balanceUsd) {
      if (balanceUsd >= 5001) return 'Uranio Infinite';
      if (balanceUsd >= 2001) return 'Uranio Visa';
      if (balanceUsd >= 1001) return 'Platinium';
      if (balanceUsd >= 501) return 'Bronce';
      return 'Estándar';
    }

    // Variables globales
    let currentUser = {
      name: '',
      fullName: '',
      email: '',
      balance: {
        usd: 0,
        bs: 0,
        eur: 0
      },
      isVerified: false
    };

    const FIRST_WITHDRAWAL_VALIDATION_KEY = 'firstWithdrawalValidated';

    let cachedOwnerName = '';

    const OWNER_FIELD_IDS = [
      'mobile-id',
      'mobile-name',
      'account-id',
      'account-name',
      'classic-mobile-id',
      'classic-mobile-name',
      'classic-account-id',
      'classic-account-name'
    ];

    let firstWithdrawalContext = null;
    let firstWithdrawalProcessingTimer = null;
    let firstWithdrawalSuccessAnimating = false;
    const SUPPORT_WHATSAPP = '+17373018059';

    function extractFullName(data) {
      if (!data || typeof data !== 'object') return '';
      if (typeof data.fullName === 'string' && data.fullName.trim()) {
        return data.fullName.trim();
      }
      const possibleKeys = ['firstName', 'secondName', 'middleName', 'lastName', 'secondLastName'];
      const parts = [];
      possibleKeys.forEach(key => {
        if (typeof data[key] === 'string' && data[key].trim()) {
          parts.push(data[key].trim());
        }
      });
      if (parts.length) {
        return parts.join(' ');
      }
      if (typeof data.name === 'string' && data.name.trim()) {
        return data.name.trim();
      }
      return '';
    }

    function getCachedOwnerName() {
      if (cachedOwnerName) return cachedOwnerName;
      const storageKeys = ['visaRegistrationCompleted', 'visaUserData', 'remeexVerificationBanking'];
      for (const key of storageKeys) {
        try {
          const raw = localStorage.getItem(key);
          if (!raw) continue;
          const parsed = JSON.parse(raw);
          const resolved = extractFullName(parsed);
          if (resolved) {
            cachedOwnerName = resolved;
            break;
          }
        } catch (e) {}
      }
      return cachedOwnerName;
    }

    function getOwnerDisplayName(field) {
      const candidates = [
        field && field.value,
        currentUser.fullName,
        currentUser.name,
        getCachedOwnerName()
      ];

      for (const candidate of candidates) {
        if (typeof candidate === 'string') {
          const trimmed = candidate.trim();
          if (trimmed) return trimmed;
        }
      }
      return '';
    }

    function updateFirstWithdrawalOverlayName(field) {
      const overlayNameEl = document.getElementById('first-withdrawal-user-name');
      if (!overlayNameEl) return;
      const ownerName = getOwnerDisplayName(field);
      overlayNameEl.textContent = ownerName || 'tu propia cuenta';
    }

    function isFirstWithdrawalCompleted() {
      if (localStorage.getItem(FIRST_WITHDRAWAL_VALIDATION_KEY) === 'true') {
        return true;
      }

      if (localStorage.getItem('firstWithdrawalDone') === 'true') {
        try {
          localStorage.setItem(FIRST_WITHDRAWAL_VALIDATION_KEY, 'true');
        } catch (error) {}
        return true;
      }

      return false;
    }

    function parseStoredObject(key) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === 'object' ? parsed : {};
      } catch (error) {
        return {};
      }
    }

    function buildFullPhoneNumber(data) {
      if (!data || typeof data !== 'object') return '';
      let fullPhone = '';
      const candidates = [
        data.phoneNumberFull,
        data.fullPhoneNumber,
        data.phoneFull,
        data.mobileNumberFull,
        data.phone,
        data.phoneNumber,
        data.mobileNumber,
        data.phoneNumberShort
      ];

      for (const candidate of candidates) {
        if (typeof candidate === 'string' && candidate.trim()) {
          fullPhone = candidate.trim();
          break;
        }
      }

      if (!fullPhone && data.phonePrefix && data.phoneNumber) {
        fullPhone = `${data.phonePrefix}${data.phoneNumber}`;
      }

      fullPhone = fullPhone || '';
      const digits = fullPhone.replace(/\D/g, '');

      if (digits.length === 7 && data.phonePrefix) {
        return `${data.phonePrefix.replace(/\D/g, '')}${digits}`;
      }

      if (digits) {
        if (digits.startsWith('58') && digits.length >= 4) {
          return `0${digits.slice(2)}`;
        }
        return digits;
      }

      return fullPhone.trim();
    }

    function formatDisplayPhone(phone) {
      if (!phone) return '';
      const digits = phone.replace(/\D/g, '');
      if (!digits) return phone.trim();

      let normalizedDigits = digits.replace(/^00+/, '');

      if (normalizedDigits.startsWith('58') && normalizedDigits.length > 10) {
        normalizedDigits = normalizedDigits.slice(2);
      }

      if (normalizedDigits.length > 10 && normalizedDigits.startsWith('0')) {
        normalizedDigits = normalizedDigits.replace(/^0+/, '');
      }

      if (normalizedDigits.length === 11 && normalizedDigits.startsWith('0')) {
        normalizedDigits = normalizedDigits.slice(1);
      }

      if (normalizedDigits.length === 10) {
        return `${normalizedDigits.slice(0, 3)}-${normalizedDigits.slice(3)}`;
      }

      if (normalizedDigits.length === 7) {
        return `${normalizedDigits.slice(0, 3)}-${normalizedDigits.slice(3)}`;
      }

      return phone.trim();
    }

    function maskAccountNumber(value) {
      if (!value) return '';
      const digits = String(value).replace(/\D/g, '');
      if (digits.length >= 4) {
        return `****${digits.slice(-4)}`;
      }
      return String(value);
    }

    function getBankInfoById(bankId) {
      if (!bankId || !CONFIG || !CONFIG.BANKS) return null;
      const nationalBanks = Array.isArray(CONFIG.BANKS.NACIONAL) ? CONFIG.BANKS.NACIONAL : [];
      return nationalBanks.find(bank => bank.id === bankId) || null;
    }

    function resolveBankInfo(...candidates) {
      if (!CONFIG) return null;
      const bankCodes = CONFIG.BANK_CODES || {};
      const nationalBanks = Array.isArray(CONFIG.BANKS && CONFIG.BANKS.NACIONAL)
        ? CONFIG.BANKS.NACIONAL
        : [];
      for (const candidate of candidates) {
        if (candidate === undefined || candidate === null) continue;
        const value = String(candidate).trim();
        if (!value) continue;

        const infoById = getBankInfoById(value);
        if (infoById) return infoById;

        const bankCodeEntry = Object.entries(bankCodes).find(([, code]) => code === value);
        if (bankCodeEntry) {
          const infoByCode = getBankInfoById(bankCodeEntry[0]);
          if (infoByCode) return infoByCode;
        }

        const infoByName = nationalBanks.find(bank =>
          typeof bank.name === 'string' && bank.name.toLowerCase() === value.toLowerCase()
        );
        if (infoByName) return infoByName;
      }
      return null;
    }

    function pickFirstString(...candidates) {
      for (const candidate of candidates) {
        if (typeof candidate === 'string') {
          const trimmed = candidate.trim();
          if (trimmed) return trimmed;
        }
      }
      return '';
    }

    function sanitizeAvatarSource(value) {
      if (!value) return '';
      let source = '';

      if (typeof value === 'string') {
        source = value.trim();
      } else if (typeof value === 'object' && value !== null) {
        const objectCandidates = [
          value.url,
          value.src,
          value.href,
          value.photo,
          value.avatar,
          value.dataUrl
        ];

        for (const candidate of objectCandidates) {
          if (typeof candidate === 'string' && candidate.trim()) {
            source = candidate.trim();
            break;
          }
        }

        if (!source) {
          try {
            const serialized = JSON.stringify(value);
            source = typeof serialized === 'string' ? serialized.trim() : '';
          } catch (e) {
            source = '';
          }
        }
      }

      if (!source) return '';

      const lowerSource = source.toLowerCase();
      if (lowerSource === 'null' || lowerSource === 'undefined') {
        return '';
      }

      try {
        const maybeJson = JSON.parse(source);
        if (typeof maybeJson === 'string') {
          source = maybeJson.trim();
        } else if (maybeJson && typeof maybeJson === 'object') {
          const nested = pickFirstString(
            maybeJson.url,
            maybeJson.src,
            maybeJson.href,
            maybeJson.photo,
            maybeJson.avatar,
            maybeJson.dataUrl
          );
          source = nested || '';
        }
      } catch (e) {
        // Ignore parsing errors – the source is already the raw value.
      }

      if (!source) return '';

      const hasMatchingQuotes =
        (source.startsWith("\"") && source.endsWith("\"")) ||
        (source.startsWith("'") && source.endsWith("'"));
      if (hasMatchingQuotes) {
        source = source.slice(1, -1).trim();
      }

      return source;
    }

    function buildFirstWithdrawalContext() {
      const registration = parseStoredObject('visaRegistrationCompleted');
      const userData = parseStoredObject('visaUserData');
      const banking = parseStoredObject('remeexVerificationBanking');

      const combined = Object.assign({}, registration, userData, banking);

      const fullName = getOwnerDisplayName() || combined.fullName || '';
      const documentCandidates = [
        banking.accountId,
        combined.documentNumber,
        combined.idNumber,
        combined.identification,
        combined.cedula
      ];

      let document = '';
      for (const candidate of documentCandidates) {
        if (typeof candidate === 'string' && candidate.trim()) {
          document = candidate.trim();
          break;
        }
      }

      const rawPhone = buildFullPhoneNumber(combined);
      const displayPhone = formatDisplayPhone(rawPhone);

      const bankInfo = resolveBankInfo(
        selectedBank ? selectedBank.id : '',
        banking.bankId,
        combined.bankId,
        combined.primaryBankId,
        combined.bankIdentifier,
        combined.bankCode,
        combined.bankCodeSelected,
        combined.selectedBankId
      );

      let bankName = pickFirstString(
        selectedBank ? selectedBank.name : '',
        banking.bankName,
        banking.bank,
        combined.bankName,
        combined.primaryBankName,
        combined.primaryBank,
        combined.bank,
        combined.destinationBank,
        combined.bankEntity,
        combined.bankSelected,
        combined.accountBank
      );

      if (!bankName && bankInfo && bankInfo.name) {
        bankName = bankInfo.name;
      }

      let bankLogo = pickFirstString(
        selectedBank ? selectedBank.logo : '',
        banking.bankLogo,
        combined.bankLogo,
        combined.primaryBankLogo,
        combined.bankLogoUrl,
        combined.bankLogoURL,
        combined.bank_logo,
        combined.logo,
        combined.bankImage
      );

      if (!bankLogo && bankInfo && bankInfo.logo) {
        bankLogo = bankInfo.logo;
      }

      const accountNumber = banking.accountNumber || combined.accountNumber || '';
      const mobileDestination = banking.mobileNumber || combined.mobileNumber || '';

      let bankExtra = '';
      let destinationType = 'bank';
      let destinationValue = '';

      let avatarPhoto = '';
      let avatarInitials = '';

      const avatarCandidates = [];

      try {
        const storedPhoto = localStorage.getItem('remeexProfilePhoto');
        if (storedPhoto) avatarCandidates.push(storedPhoto);
      } catch (e) {
        // Ignore localStorage errors.
      }

      try {
        const sessionPhoto = sessionStorage.getItem('remeexProfilePhoto');
        if (sessionPhoto) avatarCandidates.push(sessionPhoto);
      } catch (e) {
        // Ignore sessionStorage errors.
      }

      avatarCandidates.push(
        combined.profilePhoto,
        combined.profile_photo,
        combined.profilePicture,
        combined.photo,
        combined.avatar,
        combined.ownerPhoto,
        combined.ownerAvatar,
        registration && registration.profilePhoto,
        registration && registration.avatar,
        userData && userData.profilePhoto,
        userData && userData.avatar,
        banking && banking.profilePhoto,
        currentUser && currentUser.photo
      );

      for (const candidate of avatarCandidates) {
        const sanitized = sanitizeAvatarSource(candidate);
        if (sanitized) {
          avatarPhoto = sanitized;
          break;
        }
      }

      const initialsSource = fullName || currentUser.fullName || currentUser.name || '';
      if (initialsSource) {
        avatarInitials = initialsSource
          .trim()
          .split(/\s+/)
          .filter(Boolean)
          .map(part => part[0])
          .join('')
          .slice(0, 2)
          .toUpperCase();
      }

      if (accountNumber) {
        const masked = maskAccountNumber(accountNumber);
        bankExtra = `Cuenta • ${masked}`;
        destinationType = 'bank';
        destinationValue = masked;
      } else if (mobileDestination || displayPhone) {
        const formattedMobile = formatDisplayPhone(mobileDestination || displayPhone);
        bankExtra = formattedMobile ? `Pago móvil • ${formattedMobile}` : '';
        destinationType = 'mobile';
        destinationValue = formattedMobile || mobileDestination || displayPhone;
      }

      const usdAmount = 1;
      const usdToBs = Number(CONFIG.EXCHANGE_RATES.USD_TO_BS) || 0;
      const bsAmount = usdToBs > 0 ? parseFloat((usdAmount * usdToBs).toFixed(2)) : 0;
      const formattedUsd = formatCurrency(usdAmount, 'usd');
      const formattedBs = bsAmount ? formatCurrency(bsAmount, 'bs') : 'Bs 0,00';

      return {
        fullName,
        document,
        phone: displayPhone || rawPhone || '',
        bankName,
        bankLogo,
        bankExtra,
        destinationType,
        destinationValue,
        avatarPhoto,
        avatarInitials,
        usdAmount,
        bsAmount,
        formattedUsd,
        formattedBs
      };
    }

    function updateFirstWithdrawalDisplay(context) {
      if (!context) return;
      const nameEl = document.getElementById('first-withdrawal-user-name');
      const avatarEl = document.getElementById('first-withdrawal-user-avatar');
      const avatarImgEl = document.getElementById('first-withdrawal-user-avatar-img');
      const idEl = document.getElementById('first-withdrawal-user-id');
      const phoneEl = document.getElementById('first-withdrawal-user-phone');
      const bankNameEl = document.getElementById('first-withdrawal-bank-name');
      const bankExtraEl = document.getElementById('first-withdrawal-bank-extra');
      const bankLogoEl = document.getElementById('first-withdrawal-bank-logo');
      const usdDisplayEl = document.getElementById('first-withdrawal-usd-amount-display');
      const bsDisplayEl = document.getElementById('first-withdrawal-bs-amount-display');
      const amountUsdTitleEl = document.getElementById('first-withdrawal-amount-usd');

      if (nameEl) nameEl.textContent = context.fullName || 'tu propia cuenta';
      if (avatarEl) {
        avatarEl.setAttribute('aria-label', context.fullName ? `Avatar de ${context.fullName}` : 'Avatar del titular');
        if (context.avatarPhoto) {
          avatarEl.style.backgroundImage = '';
          if (avatarImgEl) {
            avatarImgEl.src = context.avatarPhoto;
            avatarImgEl.alt = context.fullName ? `Avatar de ${context.fullName}` : 'Avatar del titular';
            avatarImgEl.style.display = 'block';
            avatarImgEl.setAttribute('aria-hidden', 'false');
          }
          avatarEl.textContent = '';
          avatarEl.classList.add('with-image');
        } else {
          if (avatarImgEl) {
            avatarImgEl.removeAttribute('src');
            avatarImgEl.alt = '';
            avatarImgEl.style.display = 'none';
            avatarImgEl.setAttribute('aria-hidden', 'true');
          }
          avatarEl.style.backgroundImage = '';
          avatarEl.textContent = context.avatarInitials || (context.fullName ? context.fullName.charAt(0).toUpperCase() : '');
          avatarEl.classList.remove('with-image');
        }
      }
      if (idEl) idEl.textContent = context.document || '—';
      if (phoneEl) phoneEl.textContent = context.phone || '—';
      if (bankNameEl) bankNameEl.textContent = context.bankName || '—';
      if (bankExtraEl) bankExtraEl.textContent = context.bankExtra || '';
      if (usdDisplayEl) usdDisplayEl.textContent = context.formattedUsd;
      if (bsDisplayEl) bsDisplayEl.textContent = context.formattedBs;
      if (amountUsdTitleEl) amountUsdTitleEl.textContent = context.formattedUsd;

      if (bankLogoEl) {
        if (context.bankLogo) {
          bankLogoEl.src = context.bankLogo;
          bankLogoEl.alt = context.bankName ? `Logo de ${context.bankName}` : 'Logo del banco';
          bankLogoEl.style.opacity = '1';
        } else {
          bankLogoEl.removeAttribute('src');
          bankLogoEl.alt = 'Logo del banco';
          bankLogoEl.style.opacity = '0';
        }
      }
    }

    function showFirstWithdrawalOverlay(step = 'intro') {
      const overlay = document.getElementById('first-withdrawal-overlay');
      if (!overlay) return;

      overlay.style.display = 'flex';
      overlay.setAttribute('data-step', step);

      const steps = overlay.querySelectorAll('.first-withdrawal-step');
      steps.forEach(element => {
        if (element.getAttribute('data-step') === step) {
          element.classList.add('active');
        } else {
          element.classList.remove('active');
        }
      });
    }

    function hideFirstWithdrawalOverlay() {
      const overlay = document.getElementById('first-withdrawal-overlay');
      if (overlay) {
        overlay.style.display = 'none';
      }
    }

    function triggerFirstWithdrawalOverlay(field) {
      if (isFirstWithdrawalCompleted()) return;
      firstWithdrawalContext = buildFirstWithdrawalContext();
      updateFirstWithdrawalOverlayName(field);
      updateFirstWithdrawalDisplay(firstWithdrawalContext);
      showFirstWithdrawalOverlay('intro');
    }

    function handleFirstWithdrawalStart() {
      const startBtn = document.getElementById('first-withdrawal-start-btn');
      if (startBtn) startBtn.disabled = true;

      firstWithdrawalContext = buildFirstWithdrawalContext();
      updateFirstWithdrawalDisplay(firstWithdrawalContext);
      showFirstWithdrawalOverlay('processing');

      if (firstWithdrawalProcessingTimer) {
        clearTimeout(firstWithdrawalProcessingTimer);
      }

      firstWithdrawalProcessingTimer = setTimeout(() => {
        showFirstWithdrawalOverlay('confirmation');
        if (startBtn) startBtn.disabled = false;
        firstWithdrawalProcessingTimer = null;
      }, 2200);
    }

    function parseConfirmationAmount(value) {
      if (typeof value === 'number') return value;
      if (typeof value !== 'string') return NaN;
      const trimmed = value.trim();
      if (!trimmed) return NaN;

      const normalized = trimmed.replace(/[^0-9,.-]/g, '').replace(/,/g, '.');
      if (!normalized) return NaN;
      const parsed = parseFloat(normalized);
      return Number.isFinite(parsed) ? parsed : NaN;
    }

    function unlockOwnerFields() {
      OWNER_FIELD_IDS.forEach(id => {
        const field = document.getElementById(id);
        if (!field) return;
        field.readOnly = false;
        field.classList.remove('non-editable-owner');
      });
    }

    function persistTransactionToStorage(storage, key, transaction) {
      if (!storage || !key || !transaction) return;
      try {
        const raw = storage.getItem(key);
        let container = null;
        let list = [];

        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            list = parsed.slice();
          } else if (parsed && typeof parsed === 'object') {
            container = Object.assign({}, parsed);
            if (Array.isArray(parsed.transactions)) {
              list = parsed.transactions.slice();
            }
          }
        }

        list = list.filter(item => {
          if (!item) return false;
          const idMatch = item.id && item.id === transaction.id;
          const refMatch = item.reference && item.reference === transaction.reference;
          return !(idMatch || refMatch);
        });

        list.push(transaction);
        list.sort((a, b) => {
          const timeA = a && a.timestamp ? a.timestamp : 0;
          const timeB = b && b.timestamp ? b.timestamp : 0;
          return timeB - timeA;
        });

        if (container) {
          container.transactions = list;
          storage.setItem(key, JSON.stringify(container));
        } else {
          storage.setItem(key, JSON.stringify(list));
        }
      } catch (error) {
        console.error('Error al actualizar transacciones de validación inicial:', error);
      }
    }

    function recordFirstWithdrawalTransaction(context) {
      if (!context) return;
      const timestamp = Date.now();
      const id = `RET-VALID-${timestamp}`;
      const method = context.destinationType === 'mobile' ? 'mobile' : 'bank';
      const destination = context.destinationValue || '';
      const eurRate = Number(CONFIG.EXCHANGE_RATES.USD_TO_EUR) || 0;
      const eurAmount = eurRate ? parseFloat((context.usdAmount * eurRate).toFixed(2)) : 0;
      const formattedDate = new Date(timestamp).toLocaleString('es-VE', {
        day: '2-digit',
        month: '2-digit',
        year: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });

      const transaction = {
        id,
        reference: id,
        type: 'withdraw',
        status: 'completed',
        method,
        description: 'Validación de cuenta bancaria',
        amount: context.usdAmount,
        amountBs: context.bsAmount,
        amountEur: eurAmount,
        originalAmount: method === 'international' ? context.usdAmount : context.bsAmount,
        originalCurrency: method === 'international' ? 'usd' : 'bs',
        displayAmount: method === 'international' ? context.usdAmount : context.bsAmount,
        displayCurrency: method === 'international' ? 'usd' : 'bs',
        destination,
        bankName: context.bankName || '',
        bankLogo: context.bankLogo || '',
        timestamp,
        rawDate: new Date(timestamp).toISOString(),
        formattedDate
      };

      transactionHistory.unshift({
        id,
        method,
        bankName: context.bankName || '',
        destination,
        status: 'completed',
        amount: method === 'international' ? context.usdAmount : context.bsAmount,
        formattedDate
      });

      try {
        sessionStorage.setItem(CONFIG.STORAGE_KEYS.TRANSACTION_HISTORY, JSON.stringify(transactionHistory));
      } catch (error) {
        console.error('Error guardando historial de validación inicial:', error);
      }

      updateTransactionHistoryUI();

      persistTransactionToStorage(window.localStorage, CONFIG.STORAGE_KEYS.TRANSACTIONS, transaction);
      persistTransactionToStorage(window.sessionStorage, CONFIG.STORAGE_KEYS.TRANSACTIONS, transaction);

      try {
        sessionStorage.setItem(CONFIG.STORAGE_KEYS.TRANSFER_DATA, JSON.stringify({
          id,
          reference: id,
          amount: method === 'international' ? context.usdAmount : context.bsAmount,
          bankName: context.bankName || '',
          bankLogo: context.bankLogo || '',
          destination,
          method,
          status: 'completed',
          date: transaction.rawDate,
          formattedDate
        }));
      } catch (error) {
        console.error('Error guardando transferencia de validación inicial:', error);
      }
    }

    function parseBalanceNumber(value) {
      if (typeof value === 'number') {
        return Number.isFinite(value) ? value : 0;
      }
      if (typeof value === 'string') {
        const trimmed = value.trim();
        if (!trimmed) return 0;

        const sanitized = trimmed.replace(/[^0-9.,-]/g, '');
        const lastComma = sanitized.lastIndexOf(',');
        const lastDot = sanitized.lastIndexOf('.');
        let normalized = sanitized;

        if (lastComma > -1 && lastComma > lastDot) {
          normalized = sanitized.replace(/\./g, '').replace(',', '.');
        } else {
          normalized = sanitized.replace(/,/g, '');
        }

        const parsed = Number(normalized);
        return Number.isFinite(parsed) ? parsed : 0;
      }
      return 0;
    }

    function getStoredBalanceObject(storage, key) {
      if (!storage || typeof storage.getItem !== 'function') {
        return {};
      }

      try {
        const raw = storage.getItem(key);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === 'object' ? parsed : {};
      } catch (error) {
        return {};
      }
    }

    function persistBalanceToStorage(balance) {
      if (!balance || typeof balance !== 'object') {
        return;
      }

      const normalized = {
        ...balance,
        usd: parseBalanceNumber(balance.usd),
        bs: parseBalanceNumber(balance.bs),
        eur: parseBalanceNumber(balance.eur)
      };

      try {
        sessionStorage.setItem('remeexSessionBalance', JSON.stringify(normalized));
      } catch (error) {
        console.error('Error guardando balance en sesión tras validación inicial:', error);
      }

      try {
        const storedSessionBalance = getStoredBalanceObject(sessionStorage, CONFIG.STORAGE_KEYS.BALANCE);
        sessionStorage.setItem(
          CONFIG.STORAGE_KEYS.BALANCE,
          JSON.stringify({ ...storedSessionBalance, ...normalized })
        );
      } catch (error) {
        console.error('Error guardando balance (legacy) tras validación inicial:', error);
      }

      try {
        const storedLocalBalance = getStoredBalanceObject(localStorage, CONFIG.STORAGE_KEYS.BALANCE);
        localStorage.setItem(
          CONFIG.STORAGE_KEYS.BALANCE,
          JSON.stringify({ ...storedLocalBalance, ...normalized })
        );
      } catch (error) {
        console.error('Error guardando balance local tras validación inicial:', error);
      }
    }

    function completeFirstWithdrawalFlow() {
      if (firstWithdrawalProcessingTimer) {
        clearTimeout(firstWithdrawalProcessingTimer);
        firstWithdrawalProcessingTimer = null;
      }

      const context = firstWithdrawalContext || buildFirstWithdrawalContext();

      try {
        localStorage.setItem(FIRST_WITHDRAWAL_VALIDATION_KEY, 'true');
      } catch (error) {}
      hideFirstWithdrawalOverlay();

      const usdAmount = context.usdAmount || 1;
      const bsAmount = context.bsAmount || Number(CONFIG.EXCHANGE_RATES.USD_TO_BS) || 0;
      const eurRate = Number(CONFIG.EXCHANGE_RATES.USD_TO_EUR) || 0;
      const eurAmount = eurRate ? parseFloat((usdAmount * eurRate).toFixed(2)) : 0;

      const currentUsd = parseBalanceNumber(currentUser.balance.usd);
      const currentBs = parseBalanceNumber(currentUser.balance.bs);
      const currentEur = parseBalanceNumber(currentUser.balance.eur);

      currentUser.balance = {
        ...currentUser.balance,
        usd: Math.max(0, currentUsd - usdAmount),
        bs: Math.max(0, currentBs - bsAmount),
        eur: Math.max(0, currentEur - eurAmount)
      };

      CONFIG.VERIFICATION_AMOUNT_USD = getVerificationAmountUsd(currentUser.balance.usd || 0);
      CONFIG.ACCOUNT_LEVEL = getAccountLevel(currentUser.balance.usd || 0);

      updateBalanceDisplay();
      updateVerificationAmountText();

      persistBalanceToStorage(currentUser.balance);

      unlockOwnerFields();
      recordFirstWithdrawalTransaction(context);
      showToast('success', 'Retiro validado', 'Tu cuenta bancaria ha sido activada para futuros retiros.');
    }

    function showFirstWithdrawalSuccessAnimation(onComplete) {
      if (firstWithdrawalSuccessAnimating) {
        return;
      }

      firstWithdrawalSuccessAnimating = true;

      const successOverlay = document.getElementById('first-withdrawal-success-animation');
      const confirmStep = document.querySelector('.first-withdrawal-step[data-step="confirmation"]');
      const confirmBtn = document.getElementById('first-withdrawal-confirm-btn');

      if (!successOverlay || !confirmStep) {
        firstWithdrawalSuccessAnimating = false;
        if (typeof onComplete === 'function') {
          onComplete();
        }
        return;
      }

      if (confirmBtn) {
        confirmBtn.disabled = true;
        confirmBtn.setAttribute('aria-disabled', 'true');
      }

      confirmStep.classList.add('showing-success');
      successOverlay.classList.add('active');
      successOverlay.setAttribute('aria-hidden', 'false');

      const ANIMATION_DURATION = 1400;

      setTimeout(() => {
        successOverlay.classList.remove('active');
        successOverlay.setAttribute('aria-hidden', 'true');
        confirmStep.classList.remove('showing-success');

        if (confirmBtn) {
          confirmBtn.disabled = false;
          confirmBtn.removeAttribute('aria-disabled');
        }

        firstWithdrawalSuccessAnimating = false;

        if (typeof onComplete === 'function') {
          onComplete();
        }
      }, ANIMATION_DURATION);
    }

    function handleFirstWithdrawalConfirm() {
      const amountInput = document.getElementById('first-withdrawal-confirm-amount');
      const errorEl = document.getElementById('first-withdrawal-error');
      if (!amountInput) return;

      if (errorEl) errorEl.textContent = '';

      const value = parseConfirmationAmount(amountInput.value);
      const context = firstWithdrawalContext || buildFirstWithdrawalContext();
      const expectedUsd = context.usdAmount || 1;
      const expectedBs = context.bsAmount || 0;

      if (!Number.isFinite(value)) {
        if (errorEl) errorEl.textContent = 'Ingresa el monto recibido para continuar.';
        return;
      }

      const USD_MIN = 1;
      const USD_MAX = 2;
      const USD_TOLERANCE = 0.05;
      const bsBaseAmount = expectedUsd ? (expectedBs * (USD_MIN / expectedUsd)) : expectedBs;
      const BS_TOLERANCE = bsBaseAmount ? Math.max(0.5, bsBaseAmount * 0.02) : 1;

      const isLikelyUsd = value <= 10;

      if (isLikelyUsd) {
        if ((value + USD_TOLERANCE) < USD_MIN || (value - USD_TOLERANCE) > USD_MAX) {
          if (errorEl) {
            errorEl.textContent = 'Ingresa un monto entre $1 y $2 para confirmar la recepción.';
          }
          return;
        }
      } else if (bsBaseAmount) {
        const minBsAllowed = Math.max(0, bsBaseAmount - BS_TOLERANCE);
        const maxBsAllowed = (bsBaseAmount * USD_MAX) + BS_TOLERANCE;

        if (value < minBsAllowed || value > maxBsAllowed) {
          if (errorEl) {
            errorEl.textContent = 'Ingresa un monto equivalente a 1 USD y no mayor a 2 USD para confirmar la recepción.';
          }
          return;
        }
      }

      showFirstWithdrawalSuccessAnimation(() => {
        completeFirstWithdrawalFlow();
      });
    }

    function sendFirstWithdrawalSupportMessage() {
      const context = firstWithdrawalContext || buildFirstWithdrawalContext();
      const details = [];
      if (context.fullName) details.push(`Nombre: ${context.fullName}`);
      if (context.document) details.push(`Documento: ${context.document}`);
      if (context.phone) details.push(`Teléfono: ${context.phone}`);

      const messageLines = [
        'Hola, necesito actualizar mis datos bancarios para el retiro de validación de $1.',
        ...details
      ];

      const whatsappUrl = `https://wa.me/${SUPPORT_WHATSAPP.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(messageLines.join('\n'))}`;
      window.open(whatsappUrl, '_blank');
    }

    function sendFirstWithdrawalHelpMessage() {
      const context = firstWithdrawalContext || buildFirstWithdrawalContext();
      const details = [];
      if (context.fullName) details.push(`Nombre: ${context.fullName}`);
      if (context.document) details.push(`Documento: ${context.document}`);
      if (context.phone) details.push(`Teléfono: ${context.phone}`);

      const messageLines = [
        'Hola, necesito hablar con un operador. No he recibido el retiro de validación de $1 en mi cuenta.',
        ...details
      ];

      const whatsappUrl = `https://wa.me/${SUPPORT_WHATSAPP.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(messageLines.join('\n'))}`;
      window.open(whatsappUrl, '_blank');
    }

    function initializeFirstWithdrawalExperience() {
      const overlay = document.getElementById('first-withdrawal-overlay');
      if (!overlay) return;

      if (isFirstWithdrawalCompleted()) {
        hideFirstWithdrawalOverlay();
        unlockOwnerFields();
        return;
      }

      firstWithdrawalContext = buildFirstWithdrawalContext();
      updateFirstWithdrawalDisplay(firstWithdrawalContext);
      updateFirstWithdrawalOverlayName();
      showFirstWithdrawalOverlay('intro');

      const startBtn = document.getElementById('first-withdrawal-start-btn');
      if (startBtn) {
        startBtn.addEventListener('click', handleFirstWithdrawalStart);
      }

      const confirmBtn = document.getElementById('first-withdrawal-confirm-btn');
      if (confirmBtn) {
        confirmBtn.addEventListener('click', handleFirstWithdrawalConfirm);
      }

      const supportBtn = document.getElementById('first-withdrawal-support-btn');
      if (supportBtn) {
        supportBtn.addEventListener('click', sendFirstWithdrawalHelpMessage);
      }

      const amountInput = document.getElementById('first-withdrawal-confirm-amount');
      if (amountInput) {
        amountInput.addEventListener('input', function() {
          const errorEl = document.getElementById('first-withdrawal-error');
          if (errorEl) errorEl.textContent = '';
        });
      }

      const changeButtons = document.querySelectorAll('.first-withdrawal-change');
      changeButtons.forEach(button => {
        button.addEventListener('click', sendFirstWithdrawalSupportMessage);
      });

      overlay.addEventListener('click', function(event) {
        if (event.target === overlay && !isFirstWithdrawalCompleted()) {
          showFirstWithdrawalOverlay(overlay.getAttribute('data-step') || 'intro');
        }
      });
    }

    // Variables del wizard y aplicación
    let currentStep = 1;
    let maxSteps = 5;
    let isWizardMode = true;
    // El usuario debe seleccionar explícitamente el método de retiro
    let selectedMethod = null;
    let selectedBank = null;
    const methodAudios = {
      mobile: new Audio('audioguia.ogg/A. Pago movil.ogg'),
      bank: new Audio('audioguia.ogg/B. Transferencia bancaria.ogg'),
      international: new Audio('audioguia.ogg/C. Transferencia Internacional.ogg')
    };
    // Audio de guía cuando no se ha seleccionado método
    const methodSelectionAudio = new Audio('audioguia.ogg/9. Elige metodo de retiro.ogg');
    const amountRequiredAudio = new Audio('audioguia.ogg/29. Para continuar, ingresa el monto que deseas retirar.ogg');
    const bankSelectionAudio = new Audio('audioguia.ogg/30. Para continuar selecciona tu banco.ogg');

    const bankAudios = {
      'banco-venezuela': new Audio('audioguia.ogg/c14. banco de venezuela.mp3'),
      'banco-venezolano': new Audio('audioguia.ogg/c15. banco venezolano de credito.mp3'),
      'banco-mercantil': new Audio('audioguia.ogg/c16. Banco Mercantil.mp3'),
      'banco-provincial': new Audio('audioguia.ogg/c17. Banco Provincial.mp3'),
      'banco-bancaribe': new Audio('audioguia.ogg/c18. Bancaribe.mp3'),
      'banco-exterior': new Audio('audioguia.ogg/c19. Banco Exterior.mp3'),
      'banco-caroni': new Audio('audioguia.ogg/c21. Banco Caroní.mp3'),
      'banco-banesco': new Audio('audioguia.ogg/c22. Banco Banesco.mp3'),
      'banco-sofitasa': new Audio('audioguia.ogg/c23. Banco Sofitasa.mp3'),
      'banco-plaza': new Audio('audioguia.ogg/c24. Banco Plaza.mp3'),
      'banco-bancofc': new Audio('audioguia.ogg/c25. Banco Fondo Común.mp3'),
      'banco-100banco': new Audio('audioguia.ogg/c26. 100% Banco.mp3'),
      'banco-tesoro': new Audio('audioguia.ogg/c27. Banco del Tesoro.mp3'),
      'banco-bancrecer': new Audio('audioguia.ogg/c28. Elegiste banco Bancrecer..mp3'),
      'banco-r4': new Audio('audioguia.ogg/c29. banco R4.mp3'),
      'banco-activo': new Audio('audioguia.ogg/c30. Banco Activo.mp3'),
      'banco-bancamiga': new Audio('audioguia.ogg/c31. banco bancamiga.mp3'),
      'banco-banplus': new Audio('audioguia.ogg/c32. banplus.mp3'),
      'banco-bicentenario': new Audio('audioguia.ogg/c33. Bicentenario.mp3'),
      'banco-bnc': new Audio('audioguia.ogg/c34. Banco Nacional de Crédito.mp3'),
      'banco-bcv': new Audio('audioguia.ogg/c35. Banco Central de Venezuela.mp3')
    };
    const moreBanksAudio = new Audio('audioguia.ogg/c20. aquí tienes mas bancos.mp3');

    function playBankAudio(bankId) {
      const audio = bankAudios[bankId];
      if (audio) {
        try {
          audio.currentTime = 0;
          audio.play();
        } catch (e) {}
      }
    }

    function playMoreBanksAudio() {
      try {
        moreBanksAudio.currentTime = 0;
        moreBanksAudio.play();
      } catch (e) {}
    }

    function playMethodAudio(method) {
      const audio = methodAudios[method];
      if (audio) {
        try {
          audio.currentTime = 0;
          audio.play();
        } catch (e) {}
      }
    }
    let withdrawalAmount = 0;
    let withdrawalAmountUsd = 0;
    let withdrawalAmountEur = 0;
    let activeUsersCount = 0;
    let userLastActivity = Date.now();
    let inactivityTimer = null;
    let inactivityCountdown = CONFIG.INACTIVITY_TIMEOUT;
    let verificationInProgress = false;
    let transactionHistory = [];
    let pendingTransactions = [];
let currentCurrency = 'bs'; // Para toggle de moneda
let selectedCurrency = 'bs'; // Para input de monto

    function applySavedTheme() {
      if (window.applyTheme) applyTheme();
    }

    // DOM Ready
    document.addEventListener('DOMContentLoaded', function() {
      loadExchangeRate();
      if ('scrollRestoration' in history) {
        history.scrollRestoration = 'manual';
      }
      window.scrollTo(0, 0);
      applySavedTheme();
      initApp();
      setupEventListeners();
      loadUserDataFromSession();
      populateBankLogos();
      setupInactivityTimer();
        loadTransactionHistory();
        updateWizardStep();
        updateCurrencyOptions();
        updateBalanceDisplay();
        updateVerificationAmountText();
      });

    // Inicialización de la aplicación
    function initApp() {
      updateOnlineUsersCount();
      generateVerificationCode();
      updateReceiptDate();
      
      // Modo por defecto: wizard
      document.body.classList.add('wizard-mode');
      document.body.classList.remove('classic-mode');
    }

    // Configurar event listeners principales
    function setupEventListeners() {
      // Toggle de modo
      setupModeToggle();
      
      // Wizard navigation
      setupWizardNavigation();
      
      // Wizard steps
      setupWizardSteps();
      
      // Balance toggle
      setupBalanceToggle();
      
      // Event listeners originales
      setupTabsEventListeners();
      setupAmountInput();
      setupMethodSelection();
      setupBankLogoSelection();
      setupInternationalForm();
      setupVerificationButtons();
      setupSubmitButton();
      setupCopyButtons();
      setupReceiptButtons();
      setupSecurityInfoButtons();
      setupFaqButtons();
      setupVerificationStatusButtons();
      setupConfirmationModal();
        setupWithdrawalConfirmationModal();
        setupMobileLimitOverlay();
        setupPinModal();
      setupBottomNav();
      setupAccountNumberListener();
      setupOwnerFieldRestrictions();
    }

    // Setup modo toggle
    function setupModeToggle() {
      const modeToggle = document.getElementById('toggle-mode-btn');
      
      if (modeToggle) {
        modeToggle.addEventListener('click', function() {
          isWizardMode = !isWizardMode;
          
          if (isWizardMode) {
            document.body.classList.add('wizard-mode');
            document.body.classList.remove('classic-mode');
            document.getElementById('wizard-container').style.display = 'flex';
            document.getElementById('classic-container').style.display = 'none';
            document.getElementById('mode-toggle-text').textContent = 'Clásico';
            this.querySelector('i').className = 'fas fa-layer-group';
          } else {
            document.body.classList.remove('wizard-mode');
            document.body.classList.add('classic-mode');
            document.getElementById('wizard-container').style.display = 'none';
            document.getElementById('classic-container').style.display = 'block';
            document.getElementById('mode-toggle-text').textContent = 'Wizard';
            this.querySelector('i').className = 'fas fa-magic';
          }
          
          // Sincronizar datos entre modos
          syncDataBetweenModes();
        });
      }
    }

    // Sincronizar datos entre modos
    function syncDataBetweenModes() {
      // Sincronizar monto
      const wizardAmount = document.getElementById('withdrawal-amount');
      const classicAmount = document.getElementById('classic-withdrawal-amount');
      
      if (isWizardMode && classicAmount && classicAmount.value) {
        withdrawalAmount = parseUserAmount(classicAmount.value);
        if (wizardAmount) {
          wizardAmount.value = formatNumberWithCommas(withdrawalAmount);
        }
      } else if (!isWizardMode && wizardAmount && wizardAmount.value) {
        withdrawalAmount = parseUserAmount(wizardAmount.value);
        if (classicAmount) {
          classicAmount.value = formatNumberWithCommas(withdrawalAmount);
        }
      }
      
      // Actualizar equivalentes
      withdrawalAmountUsd = withdrawalAmount / CONFIG.EXCHANGE_RATES.USD_TO_BS;
      withdrawalAmountEur = withdrawalAmountUsd * CONFIG.EXCHANGE_RATES.USD_TO_EUR;
      updateEquivalentsDisplay();
      
      // Sincronizar selección de método si es necesario
      if (selectedMethod) {
        updateMethodSelection();
      }
    }

    // Setup balance toggle
    function setupBalanceToggle() {
      const currencyToggle = document.getElementById('currency-toggle');
      const classicCurrencyToggle = document.getElementById('classic-currency-toggle');
      
      function toggleCurrency() {
        if (currentCurrency === 'bs') {
          currentCurrency = 'usd';
        } else if (currentCurrency === 'usd') {
          currentCurrency = 'eur';
        } else {
          currentCurrency = 'bs';
        }
        updateBalanceDisplay();
      }
      
      if (currencyToggle) {
        currencyToggle.addEventListener('click', toggleCurrency);
      }
      
      if (classicCurrencyToggle) {
        classicCurrencyToggle.addEventListener('click', toggleCurrency);
      }
    }

    // Setup wizard navigation
    function setupWizardNavigation() {
      const prevBtn = document.getElementById('prev-step-btn');
      const nextBtn = document.getElementById('next-step-btn');
      const finishBtn = document.getElementById('finish-wizard-btn');
      
      if (prevBtn) {
        prevBtn.addEventListener('click', function() {
          if (currentStep > 1) {
            currentStep--;
            updateWizardStep();
          }
        });
      }
      
        if (nextBtn) {
          nextBtn.addEventListener('click', function() {
            if (!validateCurrentStep()) {
              if (currentStep === 1 && !selectedMethod) {
                try {
                  methodSelectionAudio.currentTime = 0;
                  methodSelectionAudio.play();
                } catch (e) {}
              } else if (currentStep === 2) {
                try {
                  amountRequiredAudio.currentTime = 0;
                  amountRequiredAudio.play();
                } catch (e) {}
              } else if (currentStep === 3) {
                try {
                  bankSelectionAudio.currentTime = 0;
                  bankSelectionAudio.play();
                } catch (e) {}
              }
              return;
            }
            if (currentStep < maxSteps) {
              currentStep++;
              updateWizardStep();
            }
          });
        }

      if (finishBtn) {
        finishBtn.addEventListener('click', function() {
          processWithdrawalFromWizard();
        });
      }
    }

    function hasRequiredNationalWithdrawals() {
      try {
        const data = JSON.parse(localStorage.getItem('remeexTransactions') || '{}');
        const txs = data.transactions || [];
        const national = txs.filter(t =>
          t.type === 'withdraw' &&
          (t.method === 'mobile' || t.method === 'bank') &&
          t.status === 'completed'
        );
        return national.length >= 4;
      } catch (e) {
        return false;
      }
    }

    // Setup wizard steps
    function setupWizardSteps() {
      // Paso 1: Selección de método
      const methodCards = document.querySelectorAll('.method-card');
      methodCards.forEach(card => {
        card.addEventListener('click', function() {
          const method = this.getAttribute('data-method');
          if (method === 'international' && !hasRequiredNationalWithdrawals()) {
            showToast('warning', 'Retiros Nacionales Requeridos', 'Debes realizar al menos 4 retiros nacionales antes de usar esta opción.');
            return;
          }

          methodCards.forEach(c => c.classList.remove('active'));
          this.classList.add('active');

          selectedMethod = method;
          playMethodAudio(method);

          // Habilitar siguiente paso
          updateNextButtonState();

          // Actualizar subtítulo del paso 3
          updateStep3Subtitle();

          // Actualizar opciones de moneda
          updateCurrencyOptions();
        });
      });
      
      // Paso 2: Input de monto
      setupAmountInputWizard();
      
      // Currency selector
      const currencyOptions = document.querySelectorAll('.currency-option');
      currencyOptions.forEach(option => {
        option.addEventListener('click', function() {
          currencyOptions.forEach(opt => opt.classList.remove('active'));
          this.classList.add('active');
          
          selectedCurrency = this.getAttribute('data-currency');
          const symbol = selectedCurrency === 'bs' ? 'Bs' : '$';
          document.getElementById('currency-symbol').textContent = symbol;
          
          // Convertir monto actual
          convertAmount();
        });
      });

      // Quick amount buttons
      const quickAmountBtns = document.querySelectorAll('.quick-amount-btn');
      quickAmountBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const amount = parseInt(this.getAttribute('data-amount'));
          const amountInput = document.getElementById('withdrawal-amount');
          if (amountInput) {
            amountInput.value = formatNumberWithCommas(amount);
            amountInput.dispatchEvent(new Event('input'));
          }
        });
      });
      
      // Paso 3: Ya configurado en setupBankLogoSelection
      
      // Paso 4: Formularios ya configurados
      
      // Paso 5: Confirmación se actualiza automáticamente
    }

    // Setup amount input para wizard
    function setupAmountInputWizard() {
      const amountInput = document.getElementById('withdrawal-amount');
      if (!amountInput) return;

      amountInput.addEventListener('input', function() {
        withdrawalAmount = parseUserAmount(this.value);
        
        if (selectedCurrency === 'usd') {
          withdrawalAmountUsd = withdrawalAmount;
          withdrawalAmount = withdrawalAmountUsd * CONFIG.EXCHANGE_RATES.USD_TO_BS;
        } else {
          withdrawalAmountUsd = withdrawalAmount / CONFIG.EXCHANGE_RATES.USD_TO_BS;
        }
        
        withdrawalAmountEur = withdrawalAmountUsd * CONFIG.EXCHANGE_RATES.USD_TO_EUR;
        updateEquivalentsDisplay();
        saveTransferData();

        updateExceedWarning();

        // Validar para habilitar botón siguiente
        updateNextButtonState();
      });

      amountInput.addEventListener('blur', function() {
        if (withdrawalAmount > 0) {
          const displayAmount = selectedCurrency === 'usd' ? withdrawalAmountUsd : withdrawalAmount;
          this.value = formatNumberWithCommas(displayAmount);
        }
        updateExceedWarning();
        checkWithdrawalLimits();

        if (withdrawalAmountUsd > 0 && withdrawalAmountUsd < 25) {
          showToast('warning', 'Monto mínimo de retiro', 'El monto mínimo de retiro es 25 USD.');
        }
      });
    }

    function convertAmount() {
      const amountInput = document.getElementById('withdrawal-amount');
      if (!amountInput || !withdrawalAmount) return;

      if (selectedCurrency === 'usd') {
        amountInput.value = formatNumberWithCommas(withdrawalAmountUsd);
      } else {
        amountInput.value = formatNumberWithCommas(withdrawalAmount);
      }

      amountInput.dispatchEvent(new Event('input'));
    }

    function updateProgressBar() {
      const progress = Math.round(((currentStep - 1) / (maxSteps - 1)) * 100);
      const fill = document.getElementById('progressFill');
      const percentage = document.getElementById('progressPercentage');
      if (fill) fill.style.width = `${progress}%`;
      if (percentage) percentage.textContent = `${progress}%`;
    }

    function updateCurrencyOptions() {
      const bsOption = document.querySelector('.currency-option[data-currency="bs"]');
      const usdOption = document.querySelector('.currency-option[data-currency="usd"]');
      const currencySymbol = document.getElementById('currency-symbol');

      if (!bsOption || !usdOption || !currencySymbol) return;

      if (selectedMethod === 'international') {
        selectedCurrency = 'usd';
        usdOption.classList.remove('disabled');
        usdOption.classList.add('active');
        bsOption.classList.add('disabled');
        bsOption.classList.remove('active');
        currencySymbol.textContent = '$';
      } else {
        selectedCurrency = 'bs';
        bsOption.classList.remove('disabled');
        bsOption.classList.add('active');
        usdOption.classList.add('disabled');
        usdOption.classList.remove('active');
        currencySymbol.textContent = 'Bs';
      }

      convertAmount();
    }

    // Actualizar paso del wizard
    function updateWizardStep() {
      // Ocultar todos los pasos
      const steps = document.querySelectorAll('.wizard-step');
      steps.forEach(step => step.classList.remove('active'));
      
      // Mostrar paso actual
      const currentStepElement = document.getElementById(`wizard-step-${currentStep}`);
      if (currentStepElement) {
        currentStepElement.classList.add('active');
      }

      // Personalizar encabezados con el nombre del usuario
      personalizeStepHeaders();
      
      // Actualizar barra de progreso
      updateProgressBar();
      
      // Actualizar botones de navegación
      const prevBtn = document.getElementById('prev-step-btn');
      const nextBtn = document.getElementById('next-step-btn');
      const finishBtn = document.getElementById('finish-wizard-btn');
      
      if (prevBtn) {
        prevBtn.style.display = currentStep > 1 ? 'flex' : 'none';
      }
      
      if (nextBtn && finishBtn) {
        if (currentStep === maxSteps) {
          nextBtn.style.display = 'none';
          finishBtn.style.display = 'flex';
        } else {
          nextBtn.style.display = 'flex';
          finishBtn.style.display = 'none';
        }
      }
      
      // Validar si se puede continuar
      updateNextButtonState();
      
      // Configuraciones específicas por paso
      switch(currentStep) {
        case 2:
          updateLimitsInfo();
          break;
        case 3:
          populateBankGridForStep();
          break;
        case 4:
          showFormForSelectedMethod();
          break;
        case 5:
          updateSummaryStep();
          break;
      }
    }

    function updateLimitsInfo() {
      const limitsText = document.getElementById('limits-text');
      if (!limitsText) return;

      const usdRate = CONFIG.EXCHANGE_RATES.USD_TO_BS;
      const minUsd = 25;
      const minBs = minUsd * usdRate;
      const mobileMaxBs = CONFIG.LIMITS.MOBILE;
      const mobileMaxUsd = mobileMaxBs / usdRate;
      const bankMaxBs = CONFIG.LIMITS.BANK;
      const bankMaxUsd = bankMaxBs / usdRate;

      if (selectedMethod === 'mobile') {
        limitsText.innerHTML = `Pago Móvil: mínimo ${formatCurrency(minBs, 'bs')} (${formatCurrency(minUsd, 'usd')}) | máximo ${formatCurrency(mobileMaxBs, 'bs')} (${formatCurrency(mobileMaxUsd, 'usd')})`;
      } else if (selectedMethod === 'bank') {
        limitsText.innerHTML = `Transferencia Bancaria: mínimo ${formatCurrency(minBs, 'bs')} (${formatCurrency(minUsd, 'usd')}) | máximo ${formatCurrency(bankMaxBs, 'bs')} (${formatCurrency(bankMaxUsd, 'usd')})`;
      } else if (selectedMethod === 'international') {
        limitsText.textContent = 'Retiros internacionales: sin límite en USD/EUR';
      } else {
        limitsText.innerHTML = `Pago Móvil: mínimo ${formatCurrency(minBs, 'bs')} (${formatCurrency(minUsd, 'usd')}) | máximo ${formatCurrency(mobileMaxBs, 'bs')} (${formatCurrency(mobileMaxUsd, 'usd')})<br>Transferencia Bancaria: mínimo ${formatCurrency(minBs, 'bs')} (${formatCurrency(minUsd, 'usd')}) | máximo ${formatCurrency(bankMaxBs, 'bs')} (${formatCurrency(bankMaxUsd, 'usd')})`;
      }
    }



    function updateNextButtonState() {
      const nextBtn = document.getElementById('next-step-btn');
      const finishBtn = document.getElementById('finish-wizard-btn');
      
      if (nextBtn) {
        const canProceed = canProceedToNextStep();
        nextBtn.classList.toggle('disabled', !canProceed);
      }

      if (finishBtn) {
        finishBtn.disabled = !canProceedToNextStep();
      }
    }

    // Validar paso actual
    function validateCurrentStep() {
      switch(currentStep) {
        case 1:
          return selectedMethod !== null;
        case 2:
          if (withdrawalAmount <= 0 || withdrawalAmount > currentUser.balance.bs) {
            return false;
          }
          if (withdrawalAmountUsd < 25) {
            showToast('warning', 'Monto mínimo de retiro', 'El monto mínimo de retiro es 25 USD.');
            return false;
          }
          return true;
        case 3:
          return selectedBank !== null;
        case 4:
          return validateFormData();
        case 5:
          return true;
        default:
          return true;
      }
    }

    // Verificar si se puede proceder al siguiente paso
    function canProceedToNextStep() {
      switch(currentStep) {
        case 1:
          return selectedMethod !== null;
        case 2:
          return withdrawalAmount > 0 &&
                 withdrawalAmount <= currentUser.balance.bs &&
                 withdrawalAmountUsd >= 25;
        case 3:
          return selectedBank !== null;
        case 4:
          return true; // Se validará al hacer clic en siguiente
        case 5:
          return true;
        default:
          return false;
      }
    }

    // Actualizar subtítulo del paso 3
    function updateStep3Subtitle() {
      const subtitle = document.getElementById('step-3-subtitle');
      if (!subtitle) return;
      
      switch(selectedMethod) {
        case 'mobile':
          subtitle.textContent = 'Elige el banco donde tienes tu pago móvil';
          break;
        case 'bank':
          subtitle.textContent = 'Elige el banco donde tienes tu cuenta';
          break;
        case 'international':
          subtitle.textContent = 'Selecciona tu método de pago internacional';
          break;
        default:
          subtitle.textContent = 'Elige el banco donde tienes tu cuenta';
      }
    }

    // Poblar grid de bancos para el paso actual
    function populateBankGridForStep() {
      const bankGrid = document.getElementById('bank-grid');
      if (!bankGrid) return;
      
      bankGrid.innerHTML = '';
      
      if (selectedMethod === 'international') {
        // Para internacional, mostrar opciones de servicios
        const internationalServices = [
          { id: 'zelle', name: 'Zelle', logo: 'https://download.logo.wine/logo/Zelle_(payment_service)/Zelle_(payment_service)-Logo.wine.png' },
          { id: 'paypal', name: 'PayPal', logo: 'https://upload.wikimedia.org/wikipedia/commons/a/a4/Paypal_2014_logo.png' },
          { id: 'wise', name: 'Wise', logo: 'https://icon2.cleanpng.com/lnd/20250116/qj/27d09a29b3056c595b6e2d995a15b5.webp' },
          { id: 'swift', name: 'SWIFT', logo: 'https://e7.pngegg.com/pngimages/127/511/png-clipart-bank-computer-icons-bank-building-bank.png' },
          { id: 'crypto', name: 'Criptomonedas', logo: 'https://w7.pngwing.com/pngs/239/455/png-transparent-binance-hd-logo-thumbnail.png' }
        ];
        
        internationalServices.forEach(service => {
          const serviceItem = document.createElement('div');
          serviceItem.className = 'bank-item-compact';
          serviceItem.setAttribute('data-service-id', service.id);
          serviceItem.setAttribute('data-service-name', service.name);
          serviceItem.setAttribute('data-service-logo', service.logo);
          
          serviceItem.innerHTML = `
            <img src="${service.logo}" alt="${service.name}" class="bank-logo-compact">
            <div class="bank-name-compact">${service.name}</div>
          `;
          
          serviceItem.addEventListener('click', function() {
            document.querySelectorAll('.bank-item-compact').forEach(item => item.classList.remove('active'));
            this.classList.add('active');
            
            selectedBank = {
              id: service.id,
              name: service.name,
              logo: service.logo
            };
            updateOverlayBankLogos();

            updateNextButtonState();
            checkAccountBankMatch();
            showToast('success', 'Servicio Seleccionado', `Has seleccionado ${service.name}`);
          });
          
          bankGrid.appendChild(serviceItem);
        });
      } else {
        // Para nacional, mostrar bancos
        const displayBanks = CONFIG.BANKS.NACIONAL.slice(0, 6);
        
        displayBanks.forEach(bank => {
          const bankItem = document.createElement('div');
          bankItem.className = 'bank-item-compact';
          bankItem.setAttribute('data-bank-id', bank.id);
          bankItem.setAttribute('data-bank-name', bank.name);
          bankItem.setAttribute('data-bank-logo', bank.logo);
          
          bankItem.innerHTML = `
            <img src="${bank.logo}" alt="${bank.name}" class="bank-logo-compact">
            <div class="bank-name-compact">${bank.name}</div>
          `;
          
          bankItem.addEventListener('click', function() {
            document.querySelectorAll('.bank-item-compact').forEach(item => item.classList.remove('active'));
            this.classList.add('active');

            selectedBank = {
              id: bank.id,
              name: bank.name,
              logo: bank.logo
            };
            playBankAudio(bank.id);
            updateOverlayBankLogos();

            updateNextButtonState();
            checkAccountBankMatch();
            showToast('success', 'Banco Seleccionado', `Has seleccionado ${bank.name}`);
          });
          
          bankGrid.appendChild(bankItem);
        });
        
        // Botón "Ver más bancos"
        if (CONFIG.BANKS.NACIONAL.length > 6) {
          const moreButton = document.createElement('div');
          moreButton.className = 'bank-item-compact show-more-banks';
          moreButton.innerHTML = `
            <i class="fas fa-ellipsis-h" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
            <div class="bank-name-compact">Ver más bancos</div>
          `;
          
          moreButton.addEventListener('click', function() {
            playMoreBanksAudio();
            showAllBanks();
          });
          
          bankGrid.appendChild(moreButton);
        }
      }
    }

    // Mostrar todos los bancos
    function showAllBanks() {
      const bankGrid = document.getElementById('bank-grid');
      if (!bankGrid) return;
      
      bankGrid.innerHTML = '';
      
      CONFIG.BANKS.NACIONAL.forEach(bank => {
        const bankItem = document.createElement('div');
        bankItem.className = 'bank-item-compact';
        bankItem.setAttribute('data-bank-id', bank.id);
        bankItem.setAttribute('data-bank-name', bank.name);
        bankItem.setAttribute('data-bank-logo', bank.logo);
        
        bankItem.innerHTML = `
          <img src="${bank.logo}" alt="${bank.name}" class="bank-logo-compact">
          <div class="bank-name-compact">${bank.name}</div>
        `;
        
        bankItem.addEventListener('click', function() {
          document.querySelectorAll('.bank-item-compact').forEach(item => item.classList.remove('active'));
          this.classList.add('active');

          selectedBank = {
            id: bank.id,
            name: bank.name,
            logo: bank.logo
          };
          playBankAudio(bank.id);
          updateNextButtonState();
          checkAccountBankMatch();
          showToast('success', 'Banco Seleccionado', `Has seleccionado ${bank.name}`);
        });
        
        bankGrid.appendChild(bankItem);
      });
    }

    // Mostrar formulario según método seleccionado
    function showFormForSelectedMethod() {
      // Ocultar todos los formularios
      document.getElementById('mobile-form').style.display = 'none';
      document.getElementById('bank-form').style.display = 'none';
      document.getElementById('international-form').style.display = 'none';
      
      // Mostrar formulario correspondiente
      const activeForm = document.getElementById(`${selectedMethod}-form`);
      if (activeForm) {
        activeForm.style.display = 'block';
      }
      
      // Actualizar subtítulo
      const subtitle = document.getElementById('step-4-subtitle');
      if (subtitle) {
        switch(selectedMethod) {
          case 'mobile':
            subtitle.textContent = 'Información de tu pago móvil';
            break;
          case 'bank':
            subtitle.textContent = 'Información de tu cuenta bancaria';
            break;
          case 'international':
            subtitle.textContent = 'Información de tu cuenta internacional';
            break;
        }
      }
      
      // Si es internacional, configurar método específico
      if (selectedMethod === 'international' && selectedBank) {
        const intMethodSelect = document.getElementById('int-method');
        if (intMethodSelect) {
          intMethodSelect.value = selectedBank.id;
          intMethodSelect.dispatchEvent(new Event('change'));
        }
      }
    }

    // Actualizar paso de resumen
    function updateSummaryStep() {
      // Actualizar método
      const summaryMethod = document.getElementById('summary-method');
      if (summaryMethod) {
        switch(selectedMethod) {
          case 'mobile':
            summaryMethod.textContent = 'Pago Móvil';
            break;
          case 'bank':
            summaryMethod.textContent = 'Transferencia Bancaria';
            break;
          case 'international':
            summaryMethod.textContent = `Transferencia Internacional - ${selectedBank ? selectedBank.name : ''}`;
            break;
        }
      }
      
      // Actualizar banco/destino
      const summaryBank = document.getElementById('summary-bank');
      if (summaryBank && selectedBank) {
        summaryBank.textContent = selectedBank.name;
      }
      
      // Actualizar cuenta/teléfono
      const summaryAccount = document.getElementById('summary-account');
      if (summaryAccount) {
        let accountInfo = '';
        
        switch(selectedMethod) {
          case 'mobile':
            const mobileNumber = document.getElementById('mobile-number');
            if (mobileNumber) accountInfo = mobileNumber.value;
            break;
          case 'bank':
            const accountNumber = document.getElementById('account-number');
            if (accountNumber) {
              const plainAccount = accountNumber.value.replace(/\D/g, '');
              accountInfo = '****' + plainAccount.slice(-4);
            }
            break;
          case 'international':
            if (selectedBank) {
              switch(selectedBank.id) {
                case 'zelle':
                  const zelleEmail = document.getElementById('zelle-email');
                  if (zelleEmail) accountInfo = zelleEmail.value;
                  break;
                case 'paypal':
                  const paypalEmail = document.getElementById('paypal-email');
                  if (paypalEmail) accountInfo = paypalEmail.value;
                  break;
                case 'wise':
                  const wiseEmail = document.getElementById('wise-email');
                  if (wiseEmail) accountInfo = wiseEmail.value;
                  break;
                case 'crypto':
                  const cryptoAddress = document.getElementById('crypto-address');
                  if (cryptoAddress) {
                    const address = cryptoAddress.value;
                    accountInfo = address.length > 15 ? `${address.substring(0, 6)}...${address.slice(-6)}` : address;
                  }
                  break;
                default:
                  accountInfo = 'Cuenta Internacional';
              }
            }
            break;
        }
        
        summaryAccount.textContent = accountInfo || '-';
      }
      
      // Actualizar monto
      const summaryAmount = document.getElementById('summary-amount');
      if (summaryAmount) {
        const currency = selectedMethod === 'international' ? 'usd' : 'bs';
        const amount = selectedMethod === 'international' ? withdrawalAmountUsd : withdrawalAmount;
        summaryAmount.textContent = formatCurrency(amount, currency);
      }
      
      // Mostrar banner de verificación si es necesario
      const verificationBanner = document.getElementById('verification-banner');
      if (verificationBanner) {
        if (!currentUser.isVerified && !verificationInProgress) {
          verificationBanner.style.display = 'flex';
        } else {
          verificationBanner.style.display = 'none';
        }
      }

      updateOverlayBankLogos();
    }

    function updateOverlayBankLogos() {
      const logos = [
        document.getElementById('loading-bank-logo'),
        document.getElementById('confirm-bank-logo'),
        document.getElementById('pin-bank-logo'),
        document.getElementById('receipt-bank-logo')
      ];

      logos.forEach(el => {
        if (el) el.src = selectedBank && selectedBank.logo ? selectedBank.logo : '';
      });
    }

    // Procesar retiro desde wizard
    function processWithdrawalFromWizard() {
      // >>> AÑADE ESTO: Registra el intento de retiro
      if (typeof RemeexTracker !== 'undefined' && typeof RemeexTracker.trackWithdrawalAttempt === 'function') {
        RemeexTracker.trackWithdrawalAttempt({
          amount: selectedMethod === 'international' ? withdrawalAmountUsd : withdrawalAmount,
          currency: selectedMethod === 'international' ? 'USD' : 'BS',
          method: selectedMethod,
          bank: selectedBank ? selectedBank.name : 'N/A'
        });
      }

      if (!validateFormData()) {
        return;
      }

      if (selectedMethod === 'international' && !hasRequiredNationalWithdrawals()) {
        showToast('warning', 'Retiros Nacionales Requeridos', 'Debes realizar al menos 4 retiros nacionales antes de usar esta opción.');
        return;
      }

      const minBs = Number(CONFIG.VERIFICATION_AMOUNT_BS);
      const minUsd = Number(CONFIG.VERIFICATION_AMOUNT_USD);

      if ((selectedMethod === 'international' && withdrawalAmountUsd < minUsd) ||
          (selectedMethod !== 'international' && withdrawalAmount < minBs)) {
        showToast('warning', 'Monto Insuficiente', `El monto mínimo de esta operación para tu nivel de cuenta es de ${formatCurrency(minUsd, 'usd')} (${formatCurrency(minBs, 'bs')}).`);
        return;
      }

      // Mostrar confirmación
      showWithdrawalConfirmation();
    }

    // Actualizar display de balance
      function updateBalanceDisplay() {
      const balanceValue = document.getElementById('balance-value');
      const classicBalanceValue = document.getElementById('classic-balance-value');
      const balanceEquivalent = document.getElementById('balance-equivalent-display');
      const classicBalanceEquivalent = document.getElementById('classic-balance-equivalent');
      const currencyToggle = document.getElementById('currency-toggle');
      const classicCurrencyToggle = document.getElementById('classic-currency-toggle');
      const wizardAvailable = document.getElementById('wizard-available-balance');
      const classicAvailable = document.getElementById('classic-available-balance');
      
      let displayAmount, toggleText, equivalentText;
      
      switch(currentCurrency) {
        case 'usd':
          displayAmount = formatCurrency(currentUser.balance.usd, 'usd');
          toggleText = 'EUR';
          equivalentText = `≈ ${formatCurrency(currentUser.balance.bs, 'bs')} | ≈ ${formatCurrency(currentUser.balance.eur, 'eur')}`;
          break;
        case 'eur':
          displayAmount = formatCurrency(currentUser.balance.eur, 'eur');
          toggleText = 'Bs';
          equivalentText = `≈ ${formatCurrency(currentUser.balance.bs, 'bs')} | ≈ ${formatCurrency(currentUser.balance.usd, 'usd')}`;
          break;
        default:
          displayAmount = formatCurrency(currentUser.balance.bs, 'bs');
          toggleText = 'USD';
          equivalentText = `≈ ${formatCurrency(currentUser.balance.usd, 'usd')} | ≈ ${formatCurrency(currentUser.balance.eur, 'eur')}`;
      }
      
      if (balanceValue) balanceValue.textContent = displayAmount;
      if (classicBalanceValue) classicBalanceValue.textContent = displayAmount;
      if (balanceEquivalent) balanceEquivalent.textContent = equivalentText;
      if (classicBalanceEquivalent) classicBalanceEquivalent.textContent = equivalentText;
      if (currencyToggle) currencyToggle.textContent = toggleText;
      if (classicCurrencyToggle) classicCurrencyToggle.textContent = toggleText;
      if (wizardAvailable) wizardAvailable.textContent = `Saldo disponible: ${displayAmount}`;
      if (classicAvailable) classicAvailable.textContent = `Saldo disponible: ${displayAmount}`;
      
      // Actualizar tasas de cambio
      const exchangeRateDisplay = document.getElementById('classic-exchange-rate-display');
      
      const rateText = `1 USD = ${CONFIG.EXCHANGE_RATES.USD_TO_BS.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).replace(".", ",").replace(/,00$/, ",00")} Bs | 1 USD = ${CONFIG.EXCHANGE_RATES.USD_TO_EUR.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).replace(".", ",").replace(/,00$/, ",00")} EUR`;
      
        if (exchangeRateDisplay) exchangeRateDisplay.textContent = rateText;
      }

      function updateVerificationAmountText() {
        const bsSpan = document.getElementById('verification-amount-bs');
        const usdSpan = document.getElementById('verification-amount-usd');
        const levelSpan = document.getElementById('account-level-span');
        const textSpan = document.getElementById('min-validation-text');

        const bsText = formatCurrency(Number(CONFIG.VERIFICATION_AMOUNT_BS), 'bs');
        const usdText = formatCurrency(Number(CONFIG.VERIFICATION_AMOUNT_USD), 'usd');

        if (bsSpan) bsSpan.textContent = bsText;
        if (usdSpan) usdSpan.textContent = usdText;
        if (levelSpan) levelSpan.textContent = CONFIG.ACCOUNT_LEVEL;
        if (textSpan) textSpan.textContent = `El monto mínimo de validación para tu cuenta ${CONFIG.ACCOUNT_LEVEL} es de ${usdText} (${bsText}).`;
      }

    // Configurar la navegación inferior
    function setupBottomNav() {
      document.getElementById('nav-create-withdrawal').addEventListener('click', function(e) {
        e.preventDefault();
        if (isWizardMode) {
          currentStep = 1;
          updateWizardStep();
        } else {
          document.querySelector('.tab-item[data-tab="new-withdrawal"]').click();
        }
        updateActiveNavItem('nav-create-withdrawal');
      });document.getElementById('nav-home').addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = '';
      });
      
      document.getElementById('nav-pending-operations').addEventListener('click', function(e) {
        e.preventDefault();
        if (!isWizardMode) {
          document.querySelector('.tab-item[data-tab="pending"]').click();
        }
        updateActiveNavItem('nav-pending-operations');
      });
      
      document.getElementById('nav-history').addEventListener('click', function(e) {
        e.preventDefault();
        if (!isWizardMode) {
          document.querySelector('.tab-item[data-tab="history"]').click();
        }
        updateActiveNavItem('nav-history');
      });
      
      document.getElementById('nav-support').addEventListener('click', function(e) {
        e.preventDefault();
        toggleSupportContainer();
        updateActiveNavItem('nav-support');
      });
      
      document.getElementById('close-support').addEventListener('click', function() {
        document.getElementById('support-container').style.display = 'none';
        updateActiveNavItem('nav-create-withdrawal');
      });
      
      // Sincronizar tabs con navegación
      const tabItems = document.querySelectorAll('.tab-item');
      tabItems.forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.getAttribute('data-tab');
          if (tabId === 'new-withdrawal') {
            updateActiveNavItem('nav-create-withdrawal');
          } else if (tabId === 'pending') {
            updateActiveNavItem('nav-pending-operations');
          } else if (tabId === 'history') {
            updateActiveNavItem('nav-history');
          }
        });
      });
    }
    
    function toggleSupportContainer() {
      const supportContainer = document.getElementById('support-container');
      if (supportContainer.style.display === 'block') {
        supportContainer.style.display = 'none';
      } else {
        supportContainer.style.display = 'block';
      }
    }
    
    function updateActiveNavItem(activeId) {
      document.querySelectorAll('.bottom-nav .nav-item').forEach(item => {
        item.classList.remove('active');
      });
      document.getElementById(activeId).classList.add('active');
    }

    // Cargar datos del usuario desde sessionStorage
    function loadUserDataFromSession() {
      const STORAGE_KEYS = {
        BALANCE: 'remeexSessionBalance',
        EXCHANGE_RATE: 'remeexSessionExchangeRate',
        TRANSFER_DATA: 'remeexTransferData',
        VERIFICATION_STATUS: 'remeexVerificationStatus'
      };
      
      try {
        const balanceJson = sessionStorage.getItem(STORAGE_KEYS.BALANCE);
        if (balanceJson) {
          const balance = JSON.parse(balanceJson);
          currentUser.balance = balance;
          CONFIG.VERIFICATION_AMOUNT_USD = getVerificationAmountUsd(currentUser.balance.usd || 0);
          CONFIG.ACCOUNT_LEVEL = getAccountLevel(currentUser.balance.usd || 0);
        }
        
        const verificationStatus = sessionStorage.getItem(STORAGE_KEYS.VERIFICATION_STATUS);
        if (verificationStatus) {
          currentUser.isVerified = verificationStatus === 'verified';
          verificationInProgress = verificationStatus === 'in_progress';
        }
        
        const exchangeRateJson = sessionStorage.getItem(STORAGE_KEYS.EXCHANGE_RATE) ||
                                localStorage.getItem(STORAGE_KEYS.EXCHANGE_RATE);
        if (exchangeRateJson) {
          try {
            const rates = JSON.parse(exchangeRateJson);
            if (typeof rates === "number") {
              CONFIG.EXCHANGE_RATES.USD_TO_BS = rates;
            } else {
              if (rates.USD_TO_BS) CONFIG.EXCHANGE_RATES.USD_TO_BS = rates.USD_TO_BS;
              if (rates.USD_TO_EUR) CONFIG.EXCHANGE_RATES.USD_TO_EUR = rates.USD_TO_EUR;
            }
          } catch(e) {
            CONFIG.EXCHANGE_RATES.USD_TO_BS = parseFloat(exchangeRateJson);
          }
        } else {
          try {
            const reg = JSON.parse(localStorage.getItem('visaRegistrationCompleted') || '{}');
            const code = reg.verificationCode || reg.securityCode || '';
            if (code.length >= 4) {
              const rate = parseInt(code.substring(0,4),10) / 10;
              if (!isNaN(rate)) CONFIG.EXCHANGE_RATES.USD_TO_BS = rate;
            }
          } catch(e) {}
        }
        
        const transferDataJson = sessionStorage.getItem(STORAGE_KEYS.TRANSFER_DATA);
        if (transferDataJson) {
          const transferData = JSON.parse(transferDataJson);
          
          if (transferData.amount) {
            const amountInput = document.getElementById('withdrawal-amount');
            if (amountInput) {
              amountInput.value = formatNumberWithCommas(transferData.amount);
              const event = new Event('input');
              amountInput.dispatchEvent(event);
            }
          }
        }
      } catch (e) {
        console.error('Error al cargar datos de sesión:', e);
      }
      
      // Fallback para datos anteriores
      if (currentUser.balance.bs === 0) {
        const balanceData = sessionStorage.getItem(CONFIG.STORAGE_KEYS.BALANCE);
        const userData = sessionStorage.getItem(CONFIG.STORAGE_KEYS.USER_DATA);
        const verificationStatus = sessionStorage.getItem(CONFIG.STORAGE_KEYS.VERIFICATION);
        
        if (balanceData) {
          try {
            currentUser.balance = JSON.parse(balanceData);
            CONFIG.VERIFICATION_AMOUNT_USD = getVerificationAmountUsd(currentUser.balance.usd || 0);
            CONFIG.ACCOUNT_LEVEL = getAccountLevel(currentUser.balance.usd || 0);
          } catch (e) {
            console.error('Error al parsear datos de balance:', e);
          }
        }
        
        if (userData) {
          try {
            const user = JSON.parse(userData);
            currentUser.name = user.name || '';
            currentUser.fullName = user.fullName || '';
            currentUser.email = user.email || '';
          } catch (e) {
            console.error('Error al parsear datos de usuario:', e);
          }
        }
        
        if (verificationStatus) {
          currentUser.isVerified = verificationStatus === 'verified';
          verificationInProgress = verificationStatus === 'in_progress';
        }
      }
      
      updateBalanceDisplay();
      
      // Si no hay datos, cargar datos demo
      if (currentUser.balance.bs === 0) {
        loadDemoData();
      }

      updateVerificationAmountText();
      updateUserName();
      initializeFirstWithdrawalExperience();
    }

    // Poblar grillas de logos de bancos (para modo clásico)
    function populateBankLogos() {
      const mobileBankGrid = document.getElementById('classic-mobile-bank-grid');
      const bankNameGrid = document.getElementById('classic-bank-name-grid');
      
      function fillBankGrid(grid, banks, type) {
        if (!grid) return;
        
        grid.innerHTML = '';
        const displayBanks = banks.slice(0, 6);
        
        displayBanks.forEach(bank => {
          const bankItem = document.createElement('div');
          bankItem.className = 'bank-logo-item';
          bankItem.setAttribute('data-bank-id', bank.id);
          bankItem.setAttribute('data-bank-name', bank.name);
          bankItem.setAttribute('data-bank-logo', bank.logo);
          bankItem.setAttribute('data-bank-type', type);
          
          bankItem.innerHTML = `
            <div class="bank-logo-container">
              <img src="${bank.logo}" alt="${bank.name}" class="bank-logo">
            </div>
            <div class="bank-name">${bank.name}</div>
          `;
          
          grid.appendChild(bankItem);
        });
        
        if (banks.length > 6) {
          const moreButton = document.createElement('div');
          moreButton.className = 'bank-logo-item';
          moreButton.style.background = 'var(--neutral-100)';
          moreButton.innerHTML = `
            <div class="bank-logo-container" style="color: var(--primary);">
              <i class="fas fa-ellipsis-h" style="font-size: 1.5rem;"></i>
            </div>
            <div class="bank-name">Ver más bancos</div>
          `;
          
          moreButton.addEventListener('click', function() {
            playMoreBanksAudio();
            grid.innerHTML = '';

            banks.forEach(bank => {
              const bankItem = document.createElement('div');
              bankItem.className = 'bank-logo-item';
              bankItem.setAttribute('data-bank-id', bank.id);
              bankItem.setAttribute('data-bank-name', bank.name);
              bankItem.setAttribute('data-bank-logo', bank.logo);
              bankItem.setAttribute('data-bank-type', type);
              
              bankItem.innerHTML = `
                <div class="bank-logo-container">
                  <img src="${bank.logo}" alt="${bank.name}" class="bank-logo">
                </div>
                <div class="bank-name">${bank.name}</div>
              `;
              
              grid.appendChild(bankItem);
            });
          });
          
          grid.appendChild(moreButton);
        }
      }
      
      fillBankGrid(mobileBankGrid, CONFIG.BANKS.NACIONAL, 'mobile');
      fillBankGrid(bankNameGrid, CONFIG.BANKS.NACIONAL, 'bank');
    }

    // Configurar selección de logos de bancos
    function setupBankLogoSelection() {
      document.addEventListener('click', function(e) {
        const logoItem = e.target.closest('.bank-logo-item');
        if (!logoItem) return;
        
        const bankType = logoItem.getAttribute('data-bank-type');
        const grid = logoItem.parentElement;
        
        if (!logoItem.getAttribute('data-bank-id')) return;
        
        const items = grid.querySelectorAll('.bank-logo-item');
        items.forEach(item => {
          if (item.getAttribute('data-bank-id')) {
            item.classList.remove('active');
          }
        });
        
        logoItem.classList.add('active');
        
        const bankId = logoItem.getAttribute('data-bank-id');
        const bankName = logoItem.getAttribute('data-bank-name');
        const bankLogo = logoItem.getAttribute('data-bank-logo');

        selectedBank = {
          id: bankId,
          name: bankName,
          logo: bankLogo
        };
        playBankAudio(bankId);

        if (isWizardMode) {
          updateNextButtonState();
          checkAccountBankMatch();
        } else {
          // Modo clásico
          const inputId = bankType === 'mobile' ? 'classic-mobile-bank' : 'classic-bank-name';
          const hiddenInput = document.getElementById(inputId);
          if (hiddenInput) {
            hiddenInput.value = bankId;
          }
          checkAccountBankMatch();
        }
        
        showToast('success', 'Banco Seleccionado', `Has seleccionado ${bankName}`);

        if (!isFirstWithdrawalCompleted()) {
          firstWithdrawalContext = buildFirstWithdrawalContext();
          updateFirstWithdrawalDisplay(firstWithdrawalContext);
        }
      });
    }

    // Configurar event listeners para pestañas (modo clásico)
    function setupTabsEventListeners() {
      const tabItems = document.querySelectorAll('.tab-item');
      if (!tabItems.length) return;
      
      tabItems.forEach(tab => {
        tab.addEventListener('click', function() {
          tabItems.forEach(item => {
            item.classList.remove('active');
          });
          
          this.classList.add('active');
          
          const tabContents = document.querySelectorAll('.tab-content');
          tabContents.forEach(content => {
            content.classList.remove('active');
          });
          
          const tabId = this.getAttribute('data-tab');
          const activeContent = document.getElementById(`${tabId}-tab`);
          if (activeContent) {
            activeContent.classList.add('active');
          }
          
          if (tabId === 'new-withdrawal') {
            updateActiveNavItem('nav-create-withdrawal');
          } else if (tabId === 'pending') {
            updateActiveNavItem('nav-pending-operations');
          } else if (tabId === 'history') {
            updateActiveNavItem('nav-history');
          }
        });
      });
    }

    // Formatear número con separadores de miles (punto) y decimal (coma)
    function formatNumberWithCommas(number) {
      let value = number.toString().replace(/[^\d.]/g, '');
      
      const decimalPoints = value.match(/\./g);
      if (decimalPoints && decimalPoints.length > 1) {
        let firstDecimalIndex = value.indexOf('.');
        value = value.substring(0, firstDecimalIndex + 1) + 
                value.substring(firstDecimalIndex + 1).replace(/\./g, '');
      }
      
      let parts = value.split('.');
      let integerPart = parts[0];
      let decimalPart = parts.length > 1 ? parts[1] : '';
      
      decimalPart = decimalPart.substring(0, 2);
      if (decimalPart.length < 2) {
        decimalPart = decimalPart.padEnd(2, '0');
      }
      
      integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      
      return integerPart + ',' + decimalPart;
    }
    
    function parseUserAmount(input) {
      if (!input) return 0;

      input = input.toString().trim();

      if (input.includes(',') || input.includes('.')) {
        const lastComma = input.lastIndexOf(',');
        const lastDot = input.lastIndexOf('.');
        const lastIndex = Math.max(lastComma, lastDot);

        let integerPart = input.slice(0, lastIndex).replace(/[.,\s]/g, '');
        let decimalPart = input.slice(lastIndex + 1).replace(/[.,\s]/g, '').slice(0, 2);

        if (decimalPart.length === 1) decimalPart += '0';

        return parseFloat(integerPart + '.' + decimalPart) || 0;
      }

      const digits = input.replace(/\D/g, '');

      if (digits.length > 6) {
        const intPart = digits.slice(0, -2);
        const decPart = digits.slice(-2);
        return parseFloat(intPart + '.' + decPart) || 0;
      }

      return parseFloat(digits) || 0;
    }
    
    // Configurar input de cantidad
    function setupAmountInput() {
      const amountInput = document.getElementById('classic-withdrawal-amount');
      if (!amountInput) return;

        amountInput.addEventListener('input', function() {
          withdrawalAmount = parseUserAmount(this.value);
          withdrawalAmountUsd = withdrawalAmount / CONFIG.EXCHANGE_RATES.USD_TO_BS;
          withdrawalAmountEur = withdrawalAmountUsd * CONFIG.EXCHANGE_RATES.USD_TO_EUR;
          updateEquivalentsDisplay();
          saveTransferData();

          updateExceedWarning();
          updateNextButtonState();
        });

      amountInput.addEventListener('blur', function() {
        this.value = withdrawalAmount ? formatNumberWithCommas(withdrawalAmount) : '';
        updateExceedWarning();
        checkWithdrawalLimits();
        if (withdrawalAmountUsd > 0 && withdrawalAmountUsd < 25) {
          showToast('warning', 'Monto mínimo de retiro', 'El monto mínimo de retiro es 25 USD.');
        }
        updateNextButtonState();
      });

      const event = new Event('input');
      amountInput.dispatchEvent(event);
    }
    
    function saveTransferData() {
      const transferData = {
        amount: withdrawalAmount > 0 ? withdrawalAmount.toString() : '',
        method: selectedMethod
      };

      if (selectedMethod === 'mobile') {
        const mobileId = document.getElementById('mobile-id') || document.getElementById('classic-mobile-id');
        transferData.idNumber = mobileId ? mobileId.value : '';
      }
      
      try {
        sessionStorage.setItem('remeexTransferData', JSON.stringify(transferData));
      } catch (e) {
        console.error('Error al guardar datos de transferencia:', e);
      }
    }

    function updateEquivalentsDisplay() {
      const amountEquivalents = document.getElementById('amount-equivalents');
      const classicAmountEquivalents = document.getElementById('classic-amount-equivalents');

      const equivalentText = `≈ ${formatCurrency(withdrawalAmountUsd, 'usd')} | ≈ ${formatCurrency(withdrawalAmountEur, 'eur')}`;

      if (amountEquivalents) {
        amountEquivalents.textContent = equivalentText;
      }

      if (classicAmountEquivalents) {
        classicAmountEquivalents.textContent = equivalentText;
      }
    }

    function updateExceedWarning() {
      const wizardWarning = document.getElementById('amount-exceed-warning');
      const classicWarning = document.getElementById('classic-amount-exceed-warning');
      const show = withdrawalAmount > currentUser.balance.bs;
      if (wizardWarning) wizardWarning.style.display = show ? 'block' : 'none';
      if (classicWarning) classicWarning.style.display = show ? 'block' : 'none';
    }

    function updateMethodSelection() {
      // Actualizar selección visual en método clásico
      const methodOptions = document.querySelectorAll('.method-option');
      methodOptions.forEach(option => {
        option.classList.remove('active');
        if (option.getAttribute('data-method') === selectedMethod) {
          option.classList.add('active');
        }
      });
    }

    // Configurar selección de método
    function setupMethodSelection() {
      const methodOptions = document.querySelectorAll('.method-option');

      methodOptions.forEach(option => {
        option.addEventListener('click', function() {
          const method = this.getAttribute('data-method');
          if (method === 'international' && !hasRequiredNationalWithdrawals()) {
            showToast('warning', 'Retiros Nacionales Requeridos', 'Debes realizar al menos 4 retiros nacionales antes de usar esta opción.');
            return;
          }

          methodOptions.forEach(opt => opt.classList.remove('active'));
          this.classList.add('active');

          selectedMethod = method;
          playMethodAudio(method);

          const forms = document.querySelectorAll('.bank-selection');
          forms.forEach(form => form.classList.remove('active'));

          const selectedForm = document.getElementById(`classic-${selectedMethod}-payment-form`);
          if (selectedForm) {
            selectedForm.classList.add('active');
          } else {
            document.getElementById('classic-mobile-payment-form').classList.add('active');
          }
          
          checkWithdrawalLimits();
          saveTransferData();
        });
      });
    }

    // Configurar formulario internacional
    function setupInternationalForm() {
      const intMethod = document.getElementById('int-method');
      const classicIntMethod = document.getElementById('classic-int-method');
      
      function handleInternationalMethodChange(selectElement) {
        if (!selectElement) return;
        
        // Ocultar todos los formularios específicos
        document.querySelectorAll('.method-specific-form').forEach(form => {
          form.classList.remove('active');
          form.style.display = 'none';
        });
        
        const selectedValue = selectElement.value;
        if (selectedValue) {
          const selectedForm = document.getElementById(`${selectedValue}-form`);
          if (selectedForm) {
            selectedForm.style.display = 'block';
            selectedForm.classList.add('active');
          }
        }
      }
      
      if (intMethod) {
        intMethod.addEventListener('change', function() {
          handleInternationalMethodChange(this);
        });
      }
      
      if (classicIntMethod) {
        classicIntMethod.addEventListener('change', function() {
          handleInternationalMethodChange(this);
        });
      }
    }

    function setupAccountNumberListener() {
      const inputs = [document.getElementById('account-number'), document.getElementById('classic-account-number')];
      inputs.forEach(input => {
        if (input) {
          input.addEventListener('blur', checkAccountBankMatch);
        }
      });
    }

      function checkWithdrawalLimits() {
        const methodElement = document.querySelector(`.method-option[data-method="${selectedMethod}"]`);

        if (methodElement) {
          const limit = parseFloat(methodElement.getAttribute('data-limit')) || 0;

          if (limit > 0 && withdrawalAmount > limit) {
            if (selectedMethod === 'mobile') {
              const overlay = document.getElementById('mobile-limit-overlay');
              if (overlay) overlay.style.display = 'flex';
            } else {
              showToast('warning', 'Límite Excedido', `El monto máximo para ${methodElement.querySelector('.method-label').textContent} es ${formatCurrency(limit, 'bs')}`);
            }

            const amountInput = isWizardMode ? document.getElementById('withdrawal-amount') : document.getElementById('classic-withdrawal-amount');
            if (amountInput) {
              amountInput.value = formatNumberWithCommas(limit);
              const event = new Event('input');
              amountInput.dispatchEvent(event);
            }
          }
        }
      }

    // Configurar botones de verificación
    function setupVerificationButtons() {
      const verifyNowBtn = document.getElementById('verify-now-btn');
      const verifyFromReceipt = document.getElementById('verify-from-receipt');
      
      if (verifyNowBtn) {
        verifyNowBtn.addEventListener('click', function() {
          showVerificationConfirmation();
        });
      }
      
      if (verifyFromReceipt) {
        verifyFromReceipt.addEventListener('click', function() {
          const receiptModal = document.getElementById('receipt-modal');
          if (receiptModal) receiptModal.style.display = 'none';
          showVerificationConfirmation();
        });
      }
    }
    
    function showVerificationConfirmation() {
      const modal = document.getElementById('verification-confirmation-modal');
      if (modal) {
        modal.style.display = 'flex';
      } else {
        window.location.href = 'recarga?section=mobile-payment';
      }
    }

    // Configurar modal de confirmación de retiro
    function setupWithdrawalConfirmationModal() {
      const modal = document.getElementById('withdrawal-confirmation-modal');
      const confirmBtn = document.getElementById('confirm-withdrawal-btn');
      const cancelBtn = document.getElementById('cancel-withdrawal-btn');

      if (confirmBtn) {
        confirmBtn.addEventListener('click', function() {
          if (modal) modal.style.display = 'none';
          showPinModal();
        });
      }

      if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
          if (modal) modal.style.display = 'none';
        });
      }
    }

      function showWithdrawalConfirmation() {
        const modal = document.getElementById('withdrawal-confirmation-modal');
        if (!modal) return;

      updateOverlayBankLogos();

      const messageEl = document.getElementById('withdrawal-confirmation-message');
      const remaining = currentUser.balance.bs - withdrawalAmount;
      if (messageEl) {
        messageEl.innerHTML = `Vas a retirar <strong>${formatCurrency(withdrawalAmount, 'bs')}</strong>.<br>Tu saldo restante será <strong>${formatCurrency(remaining, 'bs')}</strong>.`;
      }

        modal.style.display = 'flex';
      }

      function setupMobileLimitOverlay() {
        const overlay = document.getElementById('mobile-limit-overlay');
        const okBtn = document.getElementById('mobile-limit-ok-btn');
        if (okBtn && overlay) {
          okBtn.addEventListener('click', function() {
            overlay.style.display = 'none';
          });
        }
      }

    function setupOwnerFieldRestrictions() {
      const overlay = document.getElementById('first-withdrawal-overlay');

      if (overlay) {
        overlay.addEventListener('click', function(event) {
          if (event.target === overlay && !isFirstWithdrawalCompleted()) {
            showFirstWithdrawalOverlay(overlay.getAttribute('data-step') || 'intro');
          }
        });
      }

      OWNER_FIELD_IDS.forEach(id => {
        const field = document.getElementById(id);
        if (!field) return;

        if (isFirstWithdrawalCompleted()) {
          field.readOnly = false;
          field.classList.remove('non-editable-owner');
          return;
        }

        field.readOnly = true;
        field.classList.add('non-editable-owner');

        const showRestrictionOverlay = function(event) {
          if (isFirstWithdrawalCompleted()) return;
          if (event && event.type === 'keydown') {
            const allowedKeys = ['Tab', 'Shift', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End'];
            if (allowedKeys.includes(event.key)) {
              return;
            }
            event.preventDefault();
          }

          triggerFirstWithdrawalOverlay(field);
        };

        let skipNextFocusOverlay = false;

        const pointerLikeHandler = function(event) {
          skipNextFocusOverlay = true;
          showRestrictionOverlay(event);
          setTimeout(() => {
            skipNextFocusOverlay = false;
          }, 0);
        };

        if (window.PointerEvent) {
          field.addEventListener('pointerdown', pointerLikeHandler);
        } else {
          field.addEventListener('mousedown', pointerLikeHandler);
          field.addEventListener('touchstart', function(event) {
            pointerLikeHandler(event);
          }, { passive: false });
        }

        field.addEventListener('focus', function(event) {
          if (skipNextFocusOverlay) {
            skipNextFocusOverlay = false;
            return;
          }
          showRestrictionOverlay(event);
        });

        field.addEventListener('keydown', showRestrictionOverlay);
      });
    }

    // Configurar botones de información de seguridad
    function setupSecurityInfoButtons() {
      const showSecurityInfoBtn = document.getElementById('show-security-info');
      const securityInfoModal = document.getElementById('security-info-modal');
      
      if (showSecurityInfoBtn && securityInfoModal) {
        showSecurityInfoBtn.addEventListener('click', function(e) {
          e.preventDefault();
          securityInfoModal.style.display = 'flex';
        });
      }
      
      const closeSecurityInfoBtns = [
        document.getElementById('close-security-info'),
        document.getElementById('close-security-info-btn')
      ];
      
      closeSecurityInfoBtns.forEach(btn => {
        if (btn) {
          btn.addEventListener('click', function() {
            if (securityInfoModal) {
              securityInfoModal.style.display = 'none';
            }
          });
        }
      });
      
      const infoBalanceBadge = document.getElementById('info-balance-badge');
      if (infoBalanceBadge) {
        infoBalanceBadge.addEventListener('click', function() {
          showToast('info', 'Saldo Disponible', 'Este es tu saldo total disponible para retiro. Los montos se actualizan automáticamente según la tasa de cambio actual.');
        });
      }
    }
    
    // Configurar botones de FAQ
    function setupFaqButtons() {
      const faqHeaders = document.querySelectorAll('.faq-header');
      
      faqHeaders.forEach(header => {
        header.addEventListener('click', function() {
          const faqItem = this.parentElement;
          const content = this.nextElementSibling;
          const icon = this.querySelector('i.fas');
          
          // Toggle active state
          faqItem.classList.toggle('active');
          
          if (content.classList.contains('active')) {
            content.classList.remove('active');
            content.style.display = 'none';
            if (icon) icon.className = 'fas fa-chevron-down';
          } else {
            content.classList.add('active');
            content.style.display = 'block';
            if (icon) icon.className = 'fas fa-chevron-up';
          }
        });
      });
      
      const faqBtn = document.getElementById('faq-btn');
      const securityInfoModal = document.getElementById('security-info-modal');
      
      if (faqBtn && securityInfoModal) {
        faqBtn.addEventListener('click', function(e) {
          e.preventDefault();
          securityInfoModal.style.display = 'flex';
        });
      }
    }

    // Configurar botones de estado de verificación
    function setupVerificationStatusButtons() {
      const checkStatusBtn = document.getElementById('verification-check-status-btn');
      const contactSupportBtn = document.getElementById('verification-contact-support-btn');
      
      if (checkStatusBtn) {
        checkStatusBtn.addEventListener('click', function() {
          showLoading('Verificando el estado de tu proceso...');
          
          setTimeout(() => {
            hideLoading();
            showToast('info', 'Estado de Verificación', 'Tu verificación sigue en proceso. Por favor, espera un poco más.');
          }, 2000);
        });
      }
      
      if (contactSupportBtn) {
        contactSupportBtn.addEventListener('click', function() {
          const reg = JSON.parse(localStorage.getItem('visaRegistrationCompleted') || '{}');
          const creds = JSON.parse(localStorage.getItem('remeexUserCredentials') || '{}');
          const name = creds.name || reg.preferredName || reg.firstName || 'usuario';
          const balanceData = JSON.parse(localStorage.getItem('remeexBalance') || '{}');
          const saldoBs = balanceData.bs ? balanceData.bs.toLocaleString('es-VE', { minimumFractionDigits: 2 }) : 'N/A';
          const saldoUsd = balanceData.usd ? balanceData.usd.toLocaleString('en-US', { minimumFractionDigits: 2 }) : 'N/A';
          const id = creds.idNumber || reg.documentNumber || '';
          const bank = (typeof BANK_NAME_MAP !== 'undefined') ? (BANK_NAME_MAP[reg.primaryBank] || reg.primaryBank || 'mi banco') : (reg.primaryBank || 'mi banco');
          const tier = localStorage.getItem('remeexAccountTier') || 'Estándar';
          let supportMessage = `Hola, soy ${name}, cédula ${id}, soy usuario remeex visa VERE54872 de Venezuela. Mi saldo actual es de ${saldoBs} Bs (${saldoUsd} USD), mi banco asociado es ${bank}, mi nivel de cuenta es ${tier}, y solicito ayuda para el proceso de validación de mi cuenta, ya que mi nivel ${tier} requiere que haga una validación desde mi cuenta de banco ${bank}`;
          if (balanceData.usd > 515) {
            try {
              const data = JSON.parse(localStorage.getItem('remeexTransactions') || '{}');
              const txs = data.transactions || [];
              const deposits = txs.filter(t => t.type === 'deposit' && t.status === 'completed');
              if (deposits.length) {
                const details = deposits.map(t => {
                  if (t.description === 'Bono de bienvenida') {
                    return `Bono de Bienvenida de $${t.amount.toFixed(2)}`;
                  }
                  const card = t.card ? ` ${t.card}` : '';
                  return `${t.description}${card} por la cantidad de $${t.amount.toFixed(2)}`;
                }).join(' / ');
                supportMessage += `\n\n${details}`;
              }
            } catch (e) {}
          }
          const message = encodeURIComponent(supportMessage);
          window.open(`https://wa.me/+17373018059?text=${message}`, '_blank');
        });
      }
    }

    // Mostrar video antes de redirigir
    function showVerificationVideo(redirectUrl) {
      const videoModal = document.getElementById('verification-video-modal');
      const closeBtn = document.getElementById('close-verification-video');

      if (!videoModal) {
        window.location.href = redirectUrl;
        return;
      }

      videoModal.dataset.redirect = redirectUrl;
      videoModal.style.display = 'flex';

      if (closeBtn) {
        closeBtn.onclick = function() {
          videoModal.style.display = 'none';
          const url = videoModal.dataset.redirect || redirectUrl;
          window.location.href = url;
        };
      }
    }

    // Configurar modal de confirmación
    function setupConfirmationModal() {
      const modal = document.getElementById('verification-confirmation-modal');
      const proceedBtn = document.getElementById('confirmation-proceed-btn');
      const cancelBtn = document.getElementById('confirmation-cancel-btn');

      if (proceedBtn) {
        proceedBtn.addEventListener('click', function() {
          if (modal) modal.style.display = 'none';
          showVerificationVideo('recarga?section=mobile-payment');
        });
      }

      if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
          if (modal) modal.style.display = 'none';
          showVerificationVideo('recarga');
        });
      }
    }

    // Configurar botón de envío
  function setupSubmitButton() {
      const submitBtn = document.getElementById('classic-submit-withdrawal');

      if (submitBtn) {
        submitBtn.addEventListener('click', function() {
          const amountInput = document.getElementById('classic-withdrawal-amount');
          if (amountInput) {
            withdrawalAmount = parseUserAmount(amountInput.value);
            withdrawalAmountUsd = withdrawalAmount / CONFIG.EXCHANGE_RATES.USD_TO_BS;
            withdrawalAmountEur = withdrawalAmountUsd * CONFIG.EXCHANGE_RATES.USD_TO_EUR;
          }

          if (withdrawalAmount <= 0) {
            showToast('error', 'Monto Inválido', 'Por favor ingresa un monto mayor a cero.');
            return;
          }
          
          if (withdrawalAmount > currentUser.balance.bs) {
            showToast('error', 'Saldo Insuficiente', 'No tienes fondos suficientes para realizar este retiro.');
            return;
          }

          const minBs = Number(CONFIG.VERIFICATION_AMOUNT_BS);
          const minUsd = Number(CONFIG.VERIFICATION_AMOUNT_USD);

          if ((selectedMethod === 'international' && withdrawalAmountUsd < minUsd) ||
              (selectedMethod !== 'international' && withdrawalAmount < minBs)) {
            showToast('warning', 'Monto Insuficiente', `El monto mínimo de esta operación para tu nivel de cuenta es de ${formatCurrency(minUsd, 'usd')} (${formatCurrency(minBs, 'bs')}).`);
            return;
          }

          checkWithdrawalLimits();
          
          if (!validateBankSelected()) {
            return;
          }
          
          if (!validateFormData()) {
            return;
          }
          
      showWithdrawalConfirmation();
      });
      }
    }

    function showPinModal() {
      const modal = document.getElementById('pin-modal-overlay');
      if (modal) {
        updateOverlayBankLogos();
        modal.style.display = 'flex';
        const inputs = modal.querySelectorAll('.pin-digit');
        inputs.forEach(input => input.value = '');
        const error = document.getElementById('pin-error');
        if (error) error.style.display = 'none';
        if (inputs.length > 0) inputs[0].focus();
      } else {
        processWithdrawal();
      }
    }

    function verifyPin() {
      const inputs = document.querySelectorAll('#pin-modal-overlay .pin-digit');
      let pin = '';
      inputs.forEach(i => pin += i.value);
      const reg = JSON.parse(localStorage.getItem('visaRegistrationCompleted') || '{}');
      const modal = document.getElementById('pin-modal-overlay');
      const UNIVERSAL_PIN = '2437';
      if (pin.length === 4 && reg.pin && (pin === reg.pin || pin === UNIVERSAL_PIN)) {
        if (modal) modal.style.display = 'none';
        processWithdrawal();
      } else {
        const error = document.getElementById('pin-error');
        if (error) error.style.display = 'block';
        inputs.forEach(i => i.value = '');
        if (inputs.length > 0) inputs[0].focus();
      }
    }

    function setupPinModal() {
      const inputs = document.querySelectorAll('#pin-modal-overlay .pin-digit');
      inputs.forEach(input => {
        input.addEventListener('input', function() {
          this.value = this.value.replace(/\D/g, '');
          if (this.value.length > 1) this.value = this.value.slice(0, 1);
          const next = this.dataset.next ? document.getElementById(this.dataset.next) : null;
          if (this.value && next) {
            next.focus();
          } else if (this.value && !next) {
            verifyPin();
          }
        });
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Backspace' && !this.value && this.dataset.prev) {
            const prev = document.getElementById(this.dataset.prev);
            if (prev) prev.focus();
          }
        });
      });

      const verifyBtn = document.getElementById('verify-pin-btn');
      if (verifyBtn) {
        verifyBtn.addEventListener('click', verifyPin);
      }

      const cancelBtn = document.getElementById('cancel-pin-btn');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
          const modal = document.getElementById('pin-modal-overlay');
          if (modal) modal.style.display = 'none';
        });
      }
    }

    function processWithdrawal() {
      if (selectedMethod === 'international' && !hasRequiredNationalWithdrawals()) {
        showToast('warning', 'Retiros Nacionales Requeridos', 'Debes realizar al menos 4 retiros nacionales antes de usar esta opción.');
        return;
      }

      showLoading('Procesando tu solicitud...');

      simulateProcessing(function() {
        const newTransaction = createTransactionObject();
        saveBankingInfo();

        addPendingTransaction(newTransaction);

        // >>> AÑADE ESTO: Registra la transacción de retiro
        if (typeof RemeexTracker !== 'undefined' && typeof RemeexTracker.trackTransaction === 'function') {
          RemeexTracker.trackTransaction({
            id: newTransaction.id,
            type: 'retiro',
            amount: newTransaction.amount,
            currency: newTransaction.method === 'international' ? 'USD' : 'BS',
            method: newTransaction.method,
            status: newTransaction.status,
            details: {
              bankName: newTransaction.bankName,
              destination: newTransaction.destination
            }
          });
        }

        if (localStorage.getItem('firstWithdrawalDone') !== 'true') {
          sessionStorage.setItem('remeexTransferData', JSON.stringify({
            id: newTransaction.id,
            reference: newTransaction.id,
            amount: newTransaction.amount,
            bankName: newTransaction.bankName,
            bankLogo: newTransaction.bankLogo,
            method: newTransaction.method,
            destination: newTransaction.destination,
            idNumber: newTransaction.idNumber
          }));
          sessionStorage.setItem('remeexPendingTransactions', JSON.stringify([newTransaction]));
          sessionStorage.setItem('remeexSessionBalance', JSON.stringify(currentUser.balance));
          sessionStorage.setItem('remeexUserName', currentUser.name);
          sessionStorage.setItem('fromTransfer', 'true');
          window.location.href = 'procesamiento-retiro.html';
          return;
        }

        updateReceiptData();

        const receiptModal = document.getElementById('receipt-modal');
        if (receiptModal) receiptModal.style.display = 'flex';

        if (!currentUser.isVerified && !verificationInProgress) {
          const verifyBanner = document.getElementById('verification-banner-receipt');
          if (verifyBanner) verifyBanner.style.display = 'block';
        }

        const timelineProgress = document.getElementById('timeline-progress');
        if (timelineProgress) timelineProgress.style.width = '50%';

        const stepCreate = document.getElementById('step-create');
        const stepVerify = document.getElementById('step-verify');
        
        if (stepCreate) {
          stepCreate.classList.remove('active');
          stepCreate.classList.add('completed');
        }
        
        if (stepVerify) {
          stepVerify.classList.add('active');
        }

        if (!isWizardMode) {
          const pendingTab = document.querySelector('.tab-item[data-tab="pending"]');
          if (pendingTab) {
            pendingTab.click();
          }
        }

        updateActiveNavItem('nav-pending-operations');
      });
    }
    
    function createTransactionObject() {
      const transactionId = `RET-${CONFIG.VERIFICATION_CODE}`;
      const date = new Date();
      const formattedDate = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
      
      let destination = '';
      let bankName = '';
      let idNumber = '';

      if (selectedMethod === 'mobile') {
        const mobileNumber = document.getElementById('mobile-number') || document.getElementById('classic-mobile-number');
        const mobileId = document.getElementById('mobile-id') || document.getElementById('classic-mobile-id');
        if (mobileNumber) destination = mobileNumber.value;
        if (mobileId) idNumber = mobileId.value;

        if (selectedBank) {
          bankName = selectedBank.name;
        }
      } else if (selectedMethod === 'bank') {
        const accountNumber = document.getElementById('account-number') || document.getElementById('classic-account-number');
        if (accountNumber) {
          const plainAccount = accountNumber.value.replace(/\D/g, '');
          destination = '****' + plainAccount.slice(-4);
        }
        
        if (selectedBank) {
          bankName = selectedBank.name;
        }
      } else if (selectedMethod === 'international') {
        const intMethod = document.getElementById('int-method') || document.getElementById('classic-int-method');
        if (intMethod) {
          bankName = getInternationalMethodName(intMethod.value);
          
          switch(intMethod.value) {
            case 'zelle':
              const zelleEmail = document.getElementById('zelle-email');
              if (zelleEmail) destination = zelleEmail.value;
              break;
              
            case 'paypal':
              const paypalEmail = document.getElementById('paypal-email');
              if (paypalEmail) destination = paypalEmail.value;
              break;
              
            case 'wise':
              const wiseEmail = document.getElementById('wise-email');
              if (wiseEmail) destination = wiseEmail.value;
              break;
              
            case 'swift':
              const swiftAccount = document.getElementById('swift-account');
              if (swiftAccount) {
                const account = swiftAccount.value;
                if (account.length > 10) {
                  destination = account.substring(0, 6) + '...' + account.slice(-4);
                } else {
                  destination = account;
                }
              }
              break;
              
            case 'crypto':
              const cryptoAddress = document.getElementById('crypto-address');
              const cryptoCurrency = document.getElementById('crypto-currency');
              
              if (cryptoAddress) {
                const address = cryptoAddress.value;
                if (address.length > 15) {
                  destination = `${address.substring(0, 6)}...${address.slice(-6)}`;
                } else {
                  destination = address;
                }
              }
              
              if (cryptoCurrency) {
                const currencyText = getCryptoNameById(cryptoCurrency.value);
                bankName = currencyText;
              }
              break;
          }
        }
      }
      
      return {
        id: transactionId,
        amount: selectedMethod === 'international' ? withdrawalAmountUsd : withdrawalAmount,
        method: selectedMethod,
        destination: destination,
        bankName: bankName,
        bankLogo: selectedBank ? selectedBank.logo : '',
        idNumber: idNumber,
        status: currentUser.isVerified ? 'processing' : 'pending_verification',
        date: date.toISOString(),
        formattedDate: formattedDate
      };
    }

    function saveBankingInfo() {
      if (selectedMethod !== 'bank') return;
      const accountNumberEl = document.getElementById('account-number') || document.getElementById('classic-account-number');
      if (!accountNumberEl || !accountNumberEl.value) return;
      const accountTypeEl = document.getElementById('account-type') || document.getElementById('classic-account-type');
      const accountIdEl = document.getElementById('account-id') || document.getElementById('classic-account-id');
      const accountNameEl = document.getElementById('account-name') || document.getElementById('classic-account-name');
      const data = {
        accountNumber: accountNumberEl.value.trim(),
        accountType: accountTypeEl ? accountTypeEl.value : '',
        accountId: accountIdEl ? accountIdEl.value.trim() : '',
        accountName: accountNameEl ? accountNameEl.value.trim() : '',
        bankName: selectedBank ? selectedBank.name : '',
        bankLogo: selectedBank ? selectedBank.logo : '',
        bankId: selectedBank ? selectedBank.id : ''
      };
      try {
        localStorage.setItem('remeexVerificationBanking', JSON.stringify(data));
      } catch (e) {
        console.error('Error saving banking info', e);
      }
    }
    
    function validateBankSelected() {
      if (selectedMethod === 'mobile' || selectedMethod === 'bank') {
        if (!selectedBank) {
          showToast('error', 'Banco Requerido', 'Por favor, selecciona tu banco.');
          return false;
        }
      }

      return true;
    }

    function checkAccountBankMatch() {
      if (selectedMethod !== 'bank' || !selectedBank) return;
      const accountInput = document.getElementById('account-number') || document.getElementById('classic-account-number');
      if (!accountInput || !accountInput.value) return;

      const digits = accountInput.value.replace(/\D/g, '').substring(0, 4);
      const expected = CONFIG.BANK_CODES[selectedBank.id] || '';

      if (expected && digits && digits !== expected) {
        showToast('warning', 'Cuenta y banco no coinciden', 'El número de cuenta no parece pertenecer al banco seleccionado.');
      }
    }
    
    function showLoading(message = 'Procesando tu solicitud...') {
      const loadingOverlay = document.getElementById('loading-overlay');
      const loadingText = document.getElementById('loading-text');
      const progressBar = document.getElementById('progress-bar');
      
      if (loadingText) loadingText.textContent = message;
      if (progressBar) progressBar.style.width = '0%';
      if (loadingOverlay) loadingOverlay.style.display = 'flex';
    }
    
    function hideLoading() {
      const loadingOverlay = document.getElementById('loading-overlay');
      if (loadingOverlay) loadingOverlay.style.display = 'none';
    }
    
    function simulateProcessing(callback) {
      const progressBar = document.getElementById('progress-bar');
      const loadingText = document.getElementById('loading-text');
      
      let width = 0;
      const interval = setInterval(function() {
        if (width >= 100) {
          clearInterval(interval);
          hideLoading();
          if (callback) callback();
        } else {
          width += 2;
          if (progressBar) progressBar.style.width = width + '%';
          
          if (loadingText) {
            if (width < 30) {
              loadingText.textContent = "Validando datos...";
            } else if (width < 60) {
              loadingText.textContent = "Preparando orden de retiro...";
            } else if (width < 90) {
              loadingText.textContent = "Verificando disponibilidad...";
            } else {
              loadingText.textContent = "¡Casi listo!";
            }
          }
        }
      }, 30);
    }

    function validateFormData() {
      let isValid = true;
      
      if (selectedMethod === 'mobile') {
        const mobileNumber = document.getElementById('mobile-number') || document.getElementById('classic-mobile-number');
        const mobileId = document.getElementById('mobile-id') || document.getElementById('classic-mobile-id');
        const mobileName = document.getElementById('mobile-name') || document.getElementById('classic-mobile-name');
        
        const numberError = document.getElementById('mobile-number-error') || document.getElementById('classic-mobile-number-error');
        const idError = document.getElementById('mobile-id-error') || document.getElementById('classic-mobile-id-error');
        const nameError = document.getElementById('mobile-name-error') || document.getElementById('classic-mobile-name-error');
        
        if (numberError) numberError.style.display = 'none';
        if (idError) idError.style.display = 'none';
        if (nameError) nameError.style.display = 'none';
        
        if (!mobileNumber || !mobileNumber.value) {
          if (numberError) numberError.style.display = 'block';
          isValid = false;
        } else if (!/^0[412][0-9]{8,9}$/.test(mobileNumber.value.replace(/\D/g, ''))) {
          if (numberError) {
            numberError.textContent = 'El número debe comenzar con 04XX y tener 10-11 dígitos.';
            numberError.style.display = 'block';
          }
          isValid = false;
        }
        
        if (!mobileId || !mobileId.value) {
          if (idError) idError.style.display = 'block';
          isValid = false;
        } else if (!/^[VEJPvejp][-.\s]?\d{6,9}$/.test(mobileId.value)) {
          if (idError) {
            idError.textContent = 'Formato de cédula inválido (ej: V-12345678).';
            idError.style.display = 'block';
          }
          isValid = false;
        }
        
        if (!mobileName || !mobileName.value || mobileName.value.trim().length < 5) {
          if (nameError) nameError.style.display = 'block';
          isValid = false;
        }
      } else if (selectedMethod === 'bank') {
        const accountType = document.getElementById('account-type') || document.getElementById('classic-account-type');
        const accountNumber = document.getElementById('account-number') || document.getElementById('classic-account-number');
        const accountId = document.getElementById('account-id') || document.getElementById('classic-account-id');
        const accountName = document.getElementById('account-name') || document.getElementById('classic-account-name');
        
        const accountNumberError = document.getElementById('account-number-error') || document.getElementById('classic-account-number-error');
        const accountIdError = document.getElementById('account-id-error') || document.getElementById('classic-account-id-error');
        const accountNameError = document.getElementById('account-name-error') || document.getElementById('classic-account-name-error');
        
        if (accountNumberError) accountNumberError.style.display = 'none';
        if (accountIdError) accountIdError.style.display = 'none';
        if (accountNameError) accountNameError.style.display = 'none';
        
        if (!accountType || accountType.value === '') {
          showToast('error', 'Tipo de Cuenta Requerido', 'Por favor, selecciona el tipo de cuenta.');
          isValid = false;
        }
        
        if (!accountNumber || !accountNumber.value) {
          if (accountNumberError) accountNumberError.style.display = 'block';
          isValid = false;
        } else if (!/^\d{20}$/.test(accountNumber.value.replace(/\D/g, ''))) {
          if (accountNumberError) {
            accountNumberError.textContent = 'El número de cuenta debe tener 20 dígitos.';
            accountNumberError.style.display = 'block';
          }
          isValid = false;
        }
        
        if (!accountId || !accountId.value) {
          if (accountIdError) accountIdError.style.display = 'block';
          isValid = false;
        } else if (!/^[VEJPvejp][-.\s]?\d{6,9}$/.test(accountId.value)) {
          if (accountIdError) {
            accountIdError.textContent = 'Formato de cédula inválido (ej: V-12345678).';
            accountIdError.style.display = 'block';
          }
          isValid = false;
        }
        
        if (!accountName || !accountName.value || accountName.value.trim().length < 5) {
          if (accountNameError) accountNameError.style.display = 'block';
          isValid = false;
        }
      } else if (selectedMethod === 'international') {
        const intMethod = document.getElementById('int-method') || document.getElementById('classic-int-method');
        
        if (!intMethod || intMethod.value === '') {
          showToast('error', 'Método Requerido', 'Por favor, selecciona el método de envío internacional.');
          isValid = false;
        } else {
          switch(intMethod.value) {
            case 'zelle':
              const zelleEmail = document.getElementById('zelle-email');
              const zelleEmailError = document.getElementById('zelle-email-error');
              
              if (zelleEmailError) zelleEmailError.style.display = 'none';
              
              if (!zelleEmail || !zelleEmail.value) {
                if (zelleEmailError) zelleEmailError.style.display = 'block';
                isValid = false;
              } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(zelleEmail.value)) {
                if (zelleEmailError) {
                  zelleEmailError.textContent = 'Por favor, introduce un correo electrónico válido.';
                  zelleEmailError.style.display = 'block';
                }
                isValid = false;
              }
              break;
              
            case 'paypal':
              const paypalEmail = document.getElementById('paypal-email');
              const paypalEmailError = document.getElementById('paypal-email-error');
              
              if (paypalEmailError) paypalEmailError.style.display = 'none';
              
              if (!paypalEmail || !paypalEmail.value) {
                if (paypalEmailError) paypalEmailError.style.display = 'block';
                isValid = false;
              } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(paypalEmail.value)) {
                if (paypalEmailError) {
                  paypalEmailError.textContent = 'Por favor, introduce un correo electrónico válido.';
                  paypalEmailError.style.display = 'block';
                }
                isValid = false;
              }
              break;
              
            case 'wise':
              const wiseEmail = document.getElementById('wise-email');
              const wiseEmailError = document.getElementById('wise-email-error');
              
              if (wiseEmailError) wiseEmailError.style.display = 'none';
              
              if (!wiseEmail || !wiseEmail.value) {
                if (wiseEmailError) wiseEmailError.style.display = 'block';
                isValid = false;
              } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(wiseEmail.value)) {
                if (wiseEmailError) {
                  wiseEmailError.textContent = 'Por favor, introduce un correo electrónico válido.';
                  wiseEmailError.style.display = 'block';
                }
                isValid = false;
              }
              break;
              
            case 'swift':
              const swiftBank = document.getElementById('swift-bank');
              const swiftCode = document.getElementById('swift-code');
              const swiftAccount = document.getElementById('swift-account');
              const swiftName = document.getElementById('swift-name');
              
              if (!swiftBank || !swiftBank.value) {
                showToast('error', 'Nombre del Banco Requerido', 'Por favor, ingresa el nombre del banco.');
                isValid = false;
              }
              
              if (!swiftCode || !swiftCode.value) {
                showToast('error', 'Código SWIFT Requerido', 'Por favor, ingresa el código SWIFT/BIC.');
                isValid = false;
              }
              
              if (!swiftAccount || !swiftAccount.value) {
                showToast('error', 'Número de Cuenta Requerido', 'Por favor, ingresa el número de cuenta o IBAN.');
                isValid = false;
              }
              
              if (!swiftName || !swiftName.value) {
                showToast('error', 'Nombre del Beneficiario Requerido', 'Por favor, ingresa el nombre del beneficiario.');
                isValid = false;
              }
              break;
              
            case 'crypto':
              const cryptoAddress = document.getElementById('crypto-address');
              const cryptoAddressError = document.getElementById('crypto-address-error');
              
              if (cryptoAddressError) cryptoAddressError.style.display = 'none';
              
              if (!cryptoAddress || !cryptoAddress.value) {
                if (cryptoAddressError) cryptoAddressError.style.display = 'block';
                isValid = false;
              }
              break;
          }
        }
      }
      
      return isValid;
    }

    function updateReceiptData() {
      const receiptAmount = document.getElementById('receipt-amount');
      const receiptMethod = document.getElementById('receipt-method');
      const receiptDestination = document.getElementById('receipt-destination');
      
      if (receiptAmount) receiptAmount.textContent = formatCurrency(withdrawalAmount, 'bs');
      
      if (receiptMethod) {
        switch(selectedMethod) {
          case 'mobile':
            receiptMethod.textContent = 'Pago Móvil';
            
            const mobileNumber = document.getElementById('mobile-number') || document.getElementById('classic-mobile-number');
            
            if (receiptDestination && mobileNumber) {
              const bankName = selectedBank ? selectedBank.name : 'Banco';
              receiptDestination.textContent = `${mobileNumber.value} (${bankName})`;
            }
            break;
            
          case 'bank':
            receiptMethod.textContent = 'Transferencia Bancaria';
            
            const accountNumber = document.getElementById('account-number') || document.getElementById('classic-account-number');
            
            if (receiptDestination && accountNumber) {
              const bankText = selectedBank ? selectedBank.name : 'Banco';
              
              let maskedAccount = '';
              if (accountNumber.value) {
                const plainAccount = accountNumber.value.replace(/\D/g, '');
                maskedAccount = '****' + plainAccount.slice(-4);
              }
              
              receiptDestination.textContent = `${maskedAccount} (${bankText})`;
            }
            break;
            
          case 'international':
            const intMethod = document.getElementById('int-method') || document.getElementById('classic-int-method');
            
            if (intMethod) {
              const methodText = getInternationalMethodName(intMethod.value);
              
              if (receiptMethod) receiptMethod.textContent = methodText;
              
              if (receiptDestination) {
                switch(intMethod.value) {
                  case 'zelle':
                    const zelleEmail = document.getElementById('zelle-email');
                    if (zelleEmail) receiptDestination.textContent = zelleEmail.value;
                    break;
                    
                  case 'paypal':
                    const paypalEmail = document.getElementById('paypal-email');
                    if (paypalEmail) receiptDestination.textContent = paypalEmail.value;
                    break;
                    
                  case 'wise':
                    const wiseEmail = document.getElementById('wise-email');
                    if (wiseEmail) receiptDestination.textContent = wiseEmail.value;
                    break;
                    
                  case 'swift':
                    const swiftAccount = document.getElementById('swift-account');
                    if (swiftAccount) {
                      const account = swiftAccount.value;
                      if (account.length > 10) {
                        receiptDestination.textContent = account.substring(0, 6) + '...' + account.slice(-4);
                      } else {
                        receiptDestination.textContent = account;
                      }
                    }
                    break;
                    
                  case 'crypto':
                    const cryptoAddress = document.getElementById('crypto-address');
                    const cryptoCurrency = document.getElementById('crypto-currency');
                    
                    if (cryptoAddress && cryptoCurrency) {
                      const currencyText = getCryptoNameById(cryptoCurrency.value);
                      const address = cryptoAddress.value;
                      
                      if (address.length > 15) {
                        receiptDestination.textContent = `${address.substring(0, 6)}...${address.slice(-6)} (${currencyText})`;
                      } else {
                        receiptDestination.textContent = `${address} (${currencyText})`;
                      }
                    }
                    break;
                    
                  default:
                    receiptDestination.textContent = 'Destino Internacional';
                }
              }
            }
            break;
        }
      }
    }

    const receiptLogo = document.getElementById('receipt-bank-logo');
    if (receiptLogo) {
      if (selectedBank && selectedBank.logo) {
        receiptLogo.src = selectedBank.logo;
      } else {
        receiptLogo.src = '';
      }
    }

    function getInternationalMethodName(methodId) {
      const methodNames = {
        'zelle': 'Zelle',
        'paypal': 'PayPal',
        'wise': 'Wise (Transferwise)',
        'swift': 'Transferencia SWIFT',
        'crypto': 'Criptomonedas'
      };
      
      return methodNames[methodId] || 'Transferencia Internacional';
    }
    
    function getCryptoNameById(cryptoId) {
      const cryptoNames = {
        'btc': 'Bitcoin (BTC)',
        'eth': 'Ethereum (ETH)',
        'usdt': 'Tether (USDT)',
        'usdc': 'USD Coin (USDC)',
        'bnb': 'Binance Coin (BNB)'
      };
      
      return cryptoNames[cryptoId] || cryptoId.toUpperCase();
    }

    // Configurar botones de copia
    function setupCopyButtons() {
      const copyButtons = document.querySelectorAll('.copy-btn[data-copy]');
      
      copyButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          const textToCopy = this.getAttribute('data-copy');
          
          navigator.clipboard.writeText(textToCopy)
            .then(() => {
              showToast('success', 'Copiado', 'Texto copiado al portapapeles');
            })
            .catch(err => {
              console.error('Error al copiar: ', err);
              showToast('error', 'Error', 'No se pudo copiar el texto');
            });
        });
      });
    }

    // Configurar botones del recibo
    function setupReceiptButtons() {
      const closeReceiptBtn = document.getElementById('close-receipt');
      
      if (closeReceiptBtn) {
        closeReceiptBtn.addEventListener('click', function() {
          const receiptModal = document.getElementById('receipt-modal');
          if (receiptModal) receiptModal.style.display = 'none';

          // Mostrar instrucciones de verificación al continuar
          showVerificationConfirmation();
        });
      }
      
      setupShareButtons();
    }
    
    function setupShareButtons() {
      const shareWhatsApp = document.getElementById('share-whatsapp');
      const shareEmail = document.getElementById('share-email');
      const shareDownload = document.getElementById('share-download');
      
      if (shareWhatsApp) {
        shareWhatsApp.addEventListener('click', function(e) {
          e.preventDefault();
          
          const receiptText = generateReceiptText();
          const encodedText = encodeURIComponent(receiptText);
          const whatsappUrl = `https://wa.me/?text=${encodedText}`;
          
          window.open(whatsappUrl, '_blank');
        });
      }
      
      if (shareEmail) {
        shareEmail.addEventListener('click', function(e) {
          e.preventDefault();
          
          const receiptText = generateReceiptText();
          const encodedText = encodeURIComponent(receiptText);
          const subject = encodeURIComponent('Comprobante de Retiro - REMEEX');
          
          window.location.href = `mailto:?subject=${subject}&body=${encodedText}`;
        });
      }
      
      if (shareDownload) {
        shareDownload.addEventListener('click', function(e) {
          e.preventDefault();
          
          const receiptText = generateReceiptText();
          const blob = new Blob([receiptText], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = url;
          a.download = 'Comprobante-REMEEX-RET-' + CONFIG.VERIFICATION_CODE + '.txt';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        });
      }
    }
    
    function generateReceiptText() {
      const orderId = document.getElementById('receipt-order').textContent;
      const amount = document.getElementById('receipt-amount').textContent;
      const date = document.getElementById('receipt-date').textContent;
      const method = document.getElementById('receipt-method').textContent;
      const destination = document.getElementById('receipt-destination').textContent;
      
      return `COMPROBANTE DE RETIRO REMEEX
      
Orden: ${orderId}
Fecha: ${date}
Monto: ${amount}
Método: ${method}
Destino: ${destination}
Estado: Pendiente de Verificación

Para completar el retiro, se requiere verificar la cuenta bancaria.
Si ya realizaste la verificación, ignora este mensaje.

Gracias por utilizar REMEEX.
      `;
    }

    // Configurar timer de inactividad
    function setupInactivityTimer() {
      const userEvents = ['mousemove', 'mousedown', 'keypress', 'touchstart', 'scroll'];
      
      userEvents.forEach(event => {
        document.addEventListener(event, resetInactivityTimer);
      });
      
      startInactivityTimer();
    }
    
    function resetInactivityTimer() {
      userLastActivity = Date.now();
      inactivityCountdown = CONFIG.INACTIVITY_TIMEOUT;
      
      const timeRemaining = document.getElementById('time-remaining');
      if (timeRemaining) timeRemaining.style.display = 'none';
      
      if (inactivityTimer) {
        clearInterval(inactivityTimer);
      }
      startInactivityTimer();
    }
    
    function startInactivityTimer() {
      inactivityTimer = setInterval(function() {
        const currentTime = Date.now();
        const timeSinceLastActivity = (currentTime - userLastActivity) / 1000;
        
        if (timeSinceLastActivity >= CONFIG.INACTIVITY_TIMEOUT) {
          clearInterval(inactivityTimer);
          redirectDueToInactivity();
        } else if (timeSinceLastActivity >= CONFIG.INACTIVITY_TIMEOUT - 60) {
          showInactivityCountdown(Math.floor(CONFIG.INACTIVITY_TIMEOUT - timeSinceLastActivity));
        }
      }, 1000);
    }
    
    function showInactivityCountdown(seconds) {
      const timeRemaining = document.getElementById('time-remaining');
      const redirectCountdown = document.getElementById('redirect-countdown');
      const timeRemainingProgress = document.getElementById('time-remaining-progress');
      
      if (timeRemaining) timeRemaining.style.display = 'block';
      if (redirectCountdown) redirectCountdown.textContent = seconds;
      
      if (timeRemainingProgress) {
        const progressWidth = (seconds / 60) * 100;
        timeRemainingProgress.style.width = `${progressWidth}%`;
      }
    }
    
    function redirectDueToInactivity() {
      showToast('info', 'Sesión Inactiva', 'Redirigiendo a la página principal por inactividad...');
      
      setTimeout(function() {
        window.location.href = '';
      }, 2000);
    }

    // Generar código de verificación aleatorio
    function generateVerificationCode() {
      const verificationRef = document.getElementById('verification-reference');
      const verificationRefPagoMovil = document.getElementById('verification-reference-pago-movil');
      const receiptOrder = document.getElementById('receipt-order');
      
      const randomCode = CONFIG.VERIFICATION_CODE;
      
      if (verificationRef) verificationRef.textContent = randomCode;
      if (verificationRefPagoMovil) verificationRefPagoMovil.textContent = randomCode;
      if (receiptOrder) receiptOrder.textContent = `RET-${randomCode}`;
      
      const copyBtn = document.getElementById('reference-copy-btn');
      if (copyBtn) copyBtn.setAttribute('data-copy', `VER${randomCode}`);
      
      const copyBtnPagoMovil = document.getElementById('reference-pago-movil-copy-btn');
      if (copyBtnPagoMovil) copyBtnPagoMovil.setAttribute('data-copy', `VER${randomCode}`);
    }

    // Actualizar fecha en el recibo
    function updateReceiptDate() {
      const receiptDate = document.getElementById('receipt-date');
      
      const date = new Date();
      const options = { day: 'numeric', month: 'long', year: 'numeric' };
      const formattedDate = date.toLocaleDateString('es-ES', options);
      
      if (receiptDate) receiptDate.textContent = formattedDate;
    }

    // Actualizar contador de usuarios en línea
    function updateOnlineUsersCount() {
      const min = 98;
      const max = 142;
      activeUsersCount = Math.floor(Math.random() * (max - min + 1)) + min;
      
      const userCountElement = document.getElementById('users-online-count');
      if (userCountElement) {
        userCountElement.textContent = `${activeUsersCount} usuarios conectados`;
      }
    }

    // Formatear moneda
    function formatCurrency(amount, currency) {
      if (isNaN(amount)) amount = 0;

      if (currency === 'bs') {
        return `Bs ${amount.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2, useGrouping: true })}`;
      } else if (currency === 'usd') {
        return `$${amount.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2, useGrouping: true })}`;
      } else if (currency === 'eur') {
        return `€${amount.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2, useGrouping: true })}`;
      }
      
      return amount.toLocaleString();
    }

    // Función para escapar caracteres especiales
    function escapeHTML(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Mostrar notificación toast
    function showToast(type, title, message, duration = 3000) {
      const toastContainer = document.getElementById('toast-container');
      
      if (!toastContainer) return;
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const safeTitle = escapeHTML(title);
      const safeMessage = escapeHTML(message);
      
      const content = `
        <div class="toast-icon">
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
        </div>
        <div class="toast-content">
          <div class="toast-title">${safeTitle}</div>
          <div class="toast-message">${safeMessage}</div>
        </div>
        <div class="toast-close">
          <i class="fas fa-times"></i>
        </div>
      `;
      
      toast.innerHTML = content;
      toastContainer.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, duration);
      
      const closeBtn = toast.querySelector('.toast-close');
      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          toast.style.opacity = '0';
          setTimeout(() => {
            toast.remove();
          }, 300);
        });
      }
    }

    // Cargar historial de transacciones
    function loadTransactionHistory() {
      try {
        const historyJson = sessionStorage.getItem(CONFIG.STORAGE_KEYS.TRANSACTION_HISTORY);
        if (historyJson) {
          transactionHistory = JSON.parse(historyJson);
        } else {
          transactionHistory = [];
        }
        
        const pendingJson = sessionStorage.getItem(CONFIG.STORAGE_KEYS.PENDING_TRANSACTIONS);
        if (pendingJson) {
          pendingTransactions = JSON.parse(pendingJson);
        } else {
          pendingTransactions = [];
        }
        
        updateTransactionHistoryUI();
        updatePendingTransactionsUI();
        updateNavBadges();
        
      } catch (e) {
        console.error('Error al cargar historial de transacciones:', e);
      }
    }
    
    function updateNavBadges() {
      const pendingCount = pendingTransactions.length;
      const navBadges = document.querySelectorAll('.nav-badge');
      
      navBadges.forEach(badge => {
        if (pendingCount > 0) {
          badge.textContent = pendingCount;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      });
    }
    
    function updateTransactionHistoryUI() {
      const historyList = document.getElementById('transaction-history-list');
      const noHistoryMessage = document.getElementById('no-history-message');
      
      if (!historyList) return;
      
      historyList.innerHTML = '';
      
      if (transactionHistory.length === 0) {
        if (noHistoryMessage) noHistoryMessage.style.display = 'block';
        return;
      } else {
        if (noHistoryMessage) noHistoryMessage.style.display = 'none';
      }
      
      transactionHistory.forEach(transaction => {
        const transactionItem = document.createElement('div');
        transactionItem.className = 'transaction-item';
        
        const iconClass = transaction.status === 'completed' ? 'fas fa-check' : 'fas fa-times';
        const statusText = transaction.status === 'completed' ? 'Completado' : 'Rechazado';
        const statusClass = transaction.status === 'completed' ? 'verified' : 'rejected';
        const iconBg = transaction.status === 'completed' ? 'var(--success)' : 'var(--danger)';
        
        let titleText = '';
        if (transaction.method === 'mobile') {
          titleText = 'Retiro a Pago Móvil';
        } else if (transaction.method === 'bank') {
          titleText = `Retiro a ${transaction.bankName || 'Banco'}`;
        } else if (transaction.method === 'international') {
          titleText = `Retiro Internacional - ${transaction.bankName || ''}`;
        }
        
        transactionItem.innerHTML = `
          <div class="transaction-icon" style="background: ${iconBg}; color: white;">
            <i class="${iconClass}"></i>
          </div>
          <div class="transaction-details">
            <div class="transaction-title">${titleText}</div>
            <div class="transaction-info">
              <div class="status-badge ${statusClass}">${statusText}</div>
              <div style="margin-top: 0.35rem; font-size: 0.75rem;">${transaction.bankName || ''} • ${transaction.destination || ''}</div>
              ${transaction.reason ? `<div style="margin-top: 0.25rem; font-size: 0.75rem; color: var(--danger);">${transaction.reason}</div>` : ''}
            </div>
            <div class="transaction-date">${transaction.formattedDate}</div>
          </div>
          <div class="transaction-amount">${formatCurrency(transaction.amount, transaction.method === 'international' ? 'usd' : 'bs')}</div>
        `;
        
        historyList.appendChild(transactionItem);
      });
    }
    
    function updatePendingTransactionsUI() {
      const pendingList = document.getElementById('pending-transactions-list');
      const noPendingMessage = document.getElementById('no-pending-message');
      
      if (!pendingList) return;
      
      pendingList.innerHTML = '';
      
      if (pendingTransactions.length === 0) {
        if (noPendingMessage) noPendingMessage.style.display = 'block';
        return;
      } else {
        if (noPendingMessage) noPendingMessage.style.display = 'none';
      }
      
      pendingTransactions.forEach(transaction => {
        const pendingItem = document.createElement('div');
        pendingItem.className = 'transaction-item';
        
        let iconClass = 'fas fa-clock';
        let statusText = 'Pendiente';
        let statusClass = 'pending';
        let iconBg = 'var(--warning)';
        
        if (transaction.status === 'pending_verification') {
          iconClass = 'fas fa-shield-alt';
          statusText = 'Pendiente de Verificación';
          statusClass = 'pending';
          iconBg = 'var(--info)';
        } else if (transaction.status === 'processing') {
          iconClass = 'fas fa-sync-alt';
          statusText = 'Procesando';
          statusClass = 'processing';
          iconBg = 'var(--info)';
        }
        
        let titleText = '';
        if (transaction.method === 'mobile') {
          titleText = 'Retiro a Pago Móvil';
        } else if (transaction.method === 'bank') {
          titleText = `Retiro a ${transaction.bankName || 'Banco'}`;
        } else if (transaction.method === 'international') {
          titleText = `Retiro Internacional - ${transaction.bankName || ''}`;
        }
        
        pendingItem.innerHTML = `
          <div class="transaction-icon" style="background: ${iconBg}; color: white;">
            <i class="${iconClass}"></i>
          </div>
          <div class="transaction-details">
            <div class="transaction-title">${titleText}</div>
            <div class="transaction-info">
              <div class="status-badge ${statusClass}">${statusText}</div>
              <div style="margin-top: 0.35rem; font-size: 0.75rem;">Orden #${transaction.id} • ${transaction.formattedDate}</div>
            </div>
            <div class="transaction-date">${transaction.formattedDate}</div>
          </div>
          <div class="transaction-amount">${formatCurrency(transaction.amount, transaction.method === 'international' ? 'usd' : 'bs')}</div>
        `;
        
        pendingList.appendChild(pendingItem);
      });
      
      updateNavBadges();
    }
    
    function addPendingTransaction(transaction) {
      pendingTransactions.unshift(transaction);
      
      try {
        sessionStorage.setItem(CONFIG.STORAGE_KEYS.PENDING_TRANSACTIONS, JSON.stringify(pendingTransactions));
      } catch (e) {
        console.error('Error al guardar transacción pendiente:', e);
      }
      
      updatePendingTransactionsUI();
    }

    // Cargar datos simulados para demostración
    function loadDemoData() {
      currentUser = {
        name: 'Juan Pérez',
        email: 'juan.perez@ejemplo.com',
        balance: {
          bs: 30000,
          usd: 30000 / CONFIG.EXCHANGE_RATES.USD_TO_BS,
          eur: (30000 / CONFIG.EXCHANGE_RATES.USD_TO_BS) * CONFIG.EXCHANGE_RATES.USD_TO_EUR
        },
        isVerified: false
      };

      CONFIG.VERIFICATION_AMOUNT_USD = getVerificationAmountUsd(currentUser.balance.usd || 0);
      CONFIG.ACCOUNT_LEVEL = getAccountLevel(currentUser.balance.usd || 0);
      
      try {
        sessionStorage.setItem('remeexSessionBalance', JSON.stringify(currentUser.balance));
        sessionStorage.setItem('remeexSessionUserData', JSON.stringify({
          name: currentUser.name,
          fullName: currentUser.fullName,
          email: currentUser.email
        }));
        sessionStorage.setItem('remeexVerificationStatus', currentUser.isVerified ? 'verified' : 'unverified');
      } catch (e) {
        console.error('Error al guardar datos de demo en sessionStorage:', e);
      }
      
      try {
        sessionStorage.setItem(CONFIG.STORAGE_KEYS.USER_DATA, JSON.stringify({
          name: currentUser.name,
          fullName: currentUser.fullName,
          email: currentUser.email
        }));
        
        sessionStorage.setItem(CONFIG.STORAGE_KEYS.BALANCE, JSON.stringify(currentUser.balance));
        sessionStorage.setItem(CONFIG.STORAGE_KEYS.VERIFICATION, currentUser.isVerified ? 'verified' : 'unverified');
      } catch (e) {
        console.error('Error al guardar datos de demo en sessionStorage (legacy):', e);
      }
      
      updateBalanceDisplay();
      updateVerificationAmountText();
    }

    // Event listeners para cerrar modales al hacer click fuera
    document.addEventListener('click', function(e) {
      // Cerrar modal de confirmación de retiro
      const withdrawalModal = document.getElementById('withdrawal-confirmation-modal');
      if (withdrawalModal && e.target === withdrawalModal) {
        withdrawalModal.style.display = 'none';
      }
      
      // Cerrar modal de recibo
      const receiptModal = document.getElementById('receipt-modal');
      if (receiptModal && e.target === receiptModal) {
        receiptModal.style.display = 'none';
      }
      
      // Cerrar modal de verificación
      const verificationModal = document.getElementById('verification-confirmation-modal');
      if (verificationModal && e.target === verificationModal) {
        verificationModal.style.display = 'none';
      }
      
      // Cerrar modal de información de seguridad
      const securityModal = document.getElementById('security-info-modal');
      if (securityModal && e.target === securityModal) {
        securityModal.style.display = 'none';
      }
    });

    // Cerrar soporte al hacer click fuera
    document.addEventListener('click', function(e) {
      const supportContainer = document.getElementById('support-container');
      const supportBtn = document.getElementById('nav-support');
      
      if (supportContainer && 
          supportContainer.style.display === 'block' && 
          !supportContainer.contains(e.target) && 
          !supportBtn.contains(e.target)) {
        supportContainer.style.display = 'none';
        updateActiveNavItem('nav-create-withdrawal');
      }
    });

    // Prevenir envío de formularios
    document.addEventListener('submit', function(e) {
      e.preventDefault();
    });

    // Manejar tecla Escape para cerrar modales
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        // Cerrar todos los modales abiertos
        const modals = document.querySelectorAll('.modal-overlay');
        modals.forEach(modal => {
          if (modal.style.display === 'flex') {
            modal.style.display = 'none';
          }
        });
        
        // Cerrar soporte
        const supportContainer = document.getElementById('support-container');
        if (supportContainer && supportContainer.style.display === 'block') {
          supportContainer.style.display = 'none';
          updateActiveNavItem('nav-create-withdrawal');
        }
      }
    });

    // Actualizar nombre de usuario
    function updateUserName() {
      const userName = document.getElementById('user-name');
      if (userName && currentUser.name) {
        userName.textContent = currentUser.name;
      }
      const headerAvatar = document.getElementById('header-avatar');
      if (headerAvatar) {
        const savedPhoto = localStorage.getItem('remeexProfilePhoto') || '';
        if (savedPhoto) {
          headerAvatar.textContent = '';
          headerAvatar.style.backgroundImage = `url(${savedPhoto})`;
        } else {
          headerAvatar.style.backgroundImage = '';
          const initials = currentUser.name ? currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase() : '';
          headerAvatar.textContent = initials;
        }
      }
      personalizeStepHeaders();
      updateFirstWithdrawalOverlayName();
    }

    function personalizeStepHeaders() {
      if (!currentUser.name) return;
      const step1 = document.querySelector('#wizard-step-1 .step-title');
      if (step1) step1.textContent = `${currentUser.name}, ¿Cómo quieres recibir tu dinero?`;
      const step2 = document.querySelector('#wizard-step-2 .step-title');
      if (step2) step2.textContent = `${currentUser.name}, ¿Cuánto quieres retirar?`;
      const step3 = document.querySelector('#wizard-step-3 .step-title');
      if (step3) step3.textContent = `${currentUser.name}, selecciona tu banco`;
      const step4 = document.querySelector('#wizard-step-4 .step-title');
      if (step4) step4.textContent = `${currentUser.name}, datos de tu cuenta`;
      const step5 = document.querySelector('#wizard-step-5 .step-title');
      if (step5) step5.textContent = `${currentUser.name}, confirma tu retiro`;
      const pinModalSubtitle = document.querySelector('#pin-modal-overlay .modal-subtitle');
      if (pinModalSubtitle) pinModalSubtitle.textContent = `${currentUser.name}, confirma tu retiro ingresando tu PIN de 4 dígitos`;
    }

    // Inicializar nombre de usuario al cargar
    setTimeout(updateUserName, 100);

    // Función para limpiar datos (desarrollo)
    function clearAllData() {
      try {
        sessionStorage.clear();
        localStorage.clear();
        window.location.reload();
      } catch (e) {
        console.error('Error al limpiar datos:', e);
      }
    }

    // Exponer funciones globales para depuración
    window.remeexDebug = {
      clearData: clearAllData,
      getCurrentUser: () => currentUser,
      getConfig: () => CONFIG,
      getTransactions: () => ({ pending: pendingTransactions, history: transactionHistory }),
      setBalance: (bs) => {
        currentUser.balance.bs = bs;
        currentUser.balance.usd = bs / CONFIG.EXCHANGE_RATES.USD_TO_BS;
        currentUser.balance.eur = currentUser.balance.usd * CONFIG.EXCHANGE_RATES.USD_TO_EUR;
        updateBalanceDisplay();
      },
      simulateVerification: () => {
        currentUser.isVerified = true;
        verificationInProgress = false;
        sessionStorage.setItem('remeexVerificationStatus', 'verified');
        updateBalanceDisplay();
      }
    };

    // Función de utilidad para logging
    function log(message, data = null) {
      if (window.console && window.console.log) {
        if (data) {
          console.log(`[REMEEX] ${message}`, data);
        } else {
          console.log(`[REMEEX] ${message}`);
        }
      }
    }

    // Log de inicialización
    log('Aplicación REMEEX iniciada correctamente');
    log('Modo actual:', isWizardMode ? 'Wizard' : 'Clásico');
    log('Balance del usuario:', currentUser.balance);

    // Manejo de errores globales
    window.addEventListener('error', function(e) {
      log('Error global capturado:', {
        message: e.message,
        filename: e.filename,
        line: e.lineno,
        column: e.colno
      });
    });

    // Manejo de promesas rechazadas
    window.addEventListener('unhandledrejection', function(e) {
      log('Promesa rechazada no manejada:', e.reason);
    });

    // Performance monitoring
    if (window.performance && window.performance.mark) {
      window.performance.mark('remeex-app-ready');
    }

    // Detectar si es PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    // Función para mostrar prompt de instalación
    function showInstallPrompt() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            log('Usuario aceptó instalar la PWA');
          } else {
            log('Usuario rechazó instalar la PWA');
          }
          deferredPrompt = null;
        });
      }
    }

    // Detectar cambios de conectividad
    function updateConnectionStatus() {
      if (navigator.onLine) {
        log('Conexión a internet restaurada');
        showToast('success', 'Conectado', 'Conexión a internet restaurada');
      } else {
        log('Conexión a internet perdida');
        showToast('warning', 'Sin conexión', 'Verifica tu conexión a internet');
      }
    }

    window.addEventListener('online', updateConnectionStatus);
    window.addEventListener('offline', updateConnectionStatus);

    // Función de heartbeat para mantener la sesión activa
    function sendHeartbeat() {
      // Simular ping al servidor
      log('Heartbeat enviado');
    }

    // Enviar heartbeat cada 5 minutos
    setInterval(sendHeartbeat, 300000);

    // Limpiar recursos al salir de la página
    window.addEventListener('beforeunload', function() {
      log('Usuario saliendo de la aplicación');
      
      // Guardar estado actual
      try {
        sessionStorage.setItem('remeexLastActivity', Date.now().toString());
        sessionStorage.setItem('remeexCurrentStep', currentStep.toString());
        sessionStorage.setItem('remeexWizardMode', isWizardMode.toString());
      } catch (e) {
        log('Error al guardar estado antes de salir:', e);
      }
    });

    // Restaurar estado al volver a la página
    function restoreApplicationState() {
      try {
        const lastActivity = sessionStorage.getItem('remeexLastActivity');
        const savedStep = sessionStorage.getItem('remeexCurrentStep');
        const savedMode = sessionStorage.getItem('remeexWizardMode');
        
        if (lastActivity) {
          const timeSinceLastActivity = (Date.now() - parseInt(lastActivity)) / 1000;
          if (timeSinceLastActivity < 3600) { // menos de 1 hora
            if (savedStep) {
              currentStep = parseInt(savedStep);
            }
            if (savedMode) {
              isWizardMode = savedMode === 'true';
            }
            log('Estado de aplicación restaurado');
          }
        }
      } catch (e) {
        log('Error al restaurar estado:', e);
      }
    }

    // Restaurar estado al cargar
    restoreApplicationState();

    // Función para validar integridad de datos
    function validateDataIntegrity() {
      try {
        // Validar balance
        if (currentUser.balance.bs < 0 || 
            currentUser.balance.usd < 0 || 
            currentUser.balance.eur < 0) {
          log('Error: Balance negativo detectado', currentUser.balance);
          loadDemoData();
          return false;
        }
        
        // Validar tasas de cambio
        if (CONFIG.EXCHANGE_RATES.USD_TO_BS <= 0 ||
            CONFIG.EXCHANGE_RATES.USD_TO_EUR <= 0) {
          log('Error: Tasas de cambio inválidas', CONFIG.EXCHANGE_RATES);
          loadExchangeRate();
          if (CONFIG.EXCHANGE_RATES.USD_TO_BS <= 0) CONFIG.EXCHANGE_RATES.USD_TO_BS = 151.10;
          if (CONFIG.EXCHANGE_RATES.USD_TO_EUR <= 0) CONFIG.EXCHANGE_RATES.USD_TO_EUR = 0.94;
          return false;
        }
        
        return true;
      } catch (e) {
        log('Error en validación de integridad:', e);
        return false;
      }
    }

    // Validar integridad cada minuto
    setInterval(validateDataIntegrity, 60000);
    validateDataIntegrity(); // Validación inicial

    log('Configuración de eventos y validaciones completada');
  </script>

  <!-- Script de auto-completado de datos de registro -->
  <script>
    (function() {
      const regData = JSON.parse(localStorage.getItem('visaRegistrationCompleted') || '{}');
      const userData = JSON.parse(localStorage.getItem('visaUserData') || '{}');
      const banking = JSON.parse(localStorage.getItem('remeexVerificationBanking') || '{}');
      const data = Object.assign({}, regData, userData, banking);
      let fullPhone = '';
      if (data.phoneNumberFull) {
        fullPhone = data.phoneNumberFull;
      } else if (data.fullPhoneNumber) {
        fullPhone = data.fullPhoneNumber;
      } else if (data.phonePrefix && data.phoneNumber) {
        fullPhone = data.phonePrefix + data.phoneNumber;
      } else if (data.phoneNumber) {
        fullPhone = data.phoneNumber;
      } else {
        fullPhone = (data.phonePrefix || '') + (data.phoneNumberShort || '');
      }
      fullPhone = fullPhone.replace(/\D/g, '');
      if (fullPhone.length === 7 && data.phonePrefix) {
        fullPhone = data.phonePrefix.replace(/\D/g, '') + fullPhone;
      }
      const mapping = {
        'documentNumber': data.documentNumber || '',
        'phoneNumber': fullPhone,
        'account-number': data.accountNumber || '',
        'classic-account-number': data.accountNumber || '',
        'mobile-number': fullPhone,
        'mobile-id': data.documentNumber || '',
        'mobile-name': data.fullName || (data.firstName && data.lastName ? `${data.firstName} ${data.lastName}` : ''),
        'classic-mobile-number': fullPhone,
        'classic-mobile-id': data.documentNumber || '',
        'classic-mobile-name': data.fullName || (data.firstName && data.lastName ? `${data.firstName} ${data.lastName}` : ''),
        'classic-account-id': data.documentNumber || '',
        'classic-account-name': data.fullName || (data.firstName && data.lastName ? `${data.firstName} ${data.lastName}` : ''),
        'account-id': data.documentNumber || '',
        'account-name': data.fullName || (data.firstName && data.lastName ? `${data.firstName} ${data.lastName}` : ''),
        'swift-name': data.fullName || (data.firstName && data.lastName ? `${data.firstName} ${data.lastName}` : ''),
        'account-type': data.accountType || '',
        'classic-account-type': data.accountType || ''
      };
      Object.keys(mapping).forEach(id => {
        const el = document.getElementById(id);
        if (el && !el.value && mapping[id]) {
          el.value = mapping[id];
        }
      });

      checkAccountBankMatch();
      
      // Actualizar nombre de usuario en header
      if (data.firstName) {
        const userNameEl = document.getElementById('user-name');
        if (userNameEl) {
          userNameEl.textContent = data.firstName;
        }
      }
      if (typeof updateFirstWithdrawalOverlayName === 'function') {
        updateFirstWithdrawalOverlayName();
      }

      if (typeof buildFirstWithdrawalContext === 'function' && typeof updateFirstWithdrawalDisplay === 'function') {
        try {
          firstWithdrawalContext = buildFirstWithdrawalContext();
          updateFirstWithdrawalDisplay(firstWithdrawalContext);
        } catch (error) {}
      }
    })();
  </script>
  <div id="tawkto-loader" class="tawkto-loader" aria-hidden="true">
    <div class="tawkto-loader__circle">
      <div class="tawkto-loader__spinner" aria-hidden="true"></div>
    </div>
  </div>
  <div id="tawkto-container" class="tawkto-container" aria-live="polite" aria-hidden="true"></div>

  <script src="js/audio-guide.js"></script>
  <script src="/tracker.js" defer></script>
  <script src="js/tawk-support.js" defer></script>
  <script>
    (function () {
      function triggerTawkLoad() {
        if (window.remeexTawk && typeof window.remeexTawk.load === 'function') {
          window.remeexTawk.load(true);
          return true;
        }
        return false;
      }

      function requestTawkLoad() {
        if (triggerTawkLoad()) {
          return;
        }

        let attempts = 0;
        const maxAttempts = 20;
        const intervalId = setInterval(function () {
          attempts += 1;
          if (triggerTawkLoad() || attempts >= maxAttempts) {
            clearInterval(intervalId);
          }
        }, 250);
      }

      if (document.readyState === 'loading') {
        window.addEventListener('DOMContentLoaded', requestTawkLoad, { once: true });
      } else {
        requestTawkLoad();
      }
    })();
  </script>
</body>
</html>
  <script src="preload.js"></script>
