
# üéØ Sistema de Administraci√≥n Completo - REMEEX VISA

## ‚úÖ ¬øQu√© Puedes Hacer Como Administrador?

Este sistema te permite gestionar completamente a tus usuarios desde el panel de administraci√≥n:

### **1. Asignar Saldo** üí∞
- Enviar dinero a usuarios
- Usuario recibe notificaci√≥n tipo overlay
- Usuario puede **aceptar o rechazar** la transferencia
- Si acepta: saldo se actualiza autom√°ticamente
- Si rechaza: transferencia se cancela

### **2. Bloquear/Desbloquear Cuentas** üîí
- Bloquear acceso de cualquier usuario
- Especificar motivo del bloqueo
- Usuario ve overlay al intentar entrar
- Desbloquear cuando lo desees

### **3. Enviar Notificaciones** üîî
- Notificaciones tipo overlay (modal bloqueante)
- Toast (notificaciones peque√±as en esquina)
- Prioridad: baja, normal, alta, urgente
- Tipos: info, success, warning, error, reminder

### **4. Modificar Monto de Validaci√≥n** üìä
- Cambiar el monto m√≠nimo requerido por usuario
- Default: $5.00 USD
- Configurable individualmente para cada usuario

### **5. Enviar Recordatorios** üì®
- Mensajes personalizados
- Aparecen como overlay en homevisa.html del usuario

### **6. Ver Logs de Actividad** üìù
- Historial de todas las acciones de admin
- Auditor√≠a completa
- Filtros por admin, usuario, tipo de acci√≥n

---

## üìã Paso 1: Configurar Base de Datos

### **Ejecutar SQL en Supabase**

1. Ve a: https://supabase.com/dashboard/project/ewdkxszfkqwlkyszodxu
2. Click en **SQL Editor**
3. Click en **New Query**
4. Copia y pega el contenido de: `SUPABASE_ADMIN_SCHEMA.sql`
5. Click en **Run** (‚ñ∂Ô∏è)

Esto crear√°:
- ‚úÖ 4 nuevas tablas (notifications, pending_transfers, admin_activity_log, admin_settings)
- ‚úÖ Nuevos campos en tabla `registrations`
- ‚úÖ Funciones SQL autom√°ticas
- ‚úÖ Triggers y pol√≠ticas de seguridad

**Verificaci√≥n**:
```sql
-- Ejecuta esto para verificar
SELECT 'notifications' as tabla, COUNT(*) FROM notifications
UNION ALL
SELECT 'pending_transfers', COUNT(*) FROM pending_transfers
UNION ALL
SELECT 'admin_activity_log', COUNT(*) FROM admin_activity_log
UNION ALL
SELECT 'admin_settings', COUNT(*) FROM admin_settings;
```

---

## üì¶ Paso 2: Incluir Scripts en HTML

### **En homevisa.html (panel de usuario)**

Agrega antes de `</body>`:

```html
<!-- Supabase Integration -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase-client-frontend.js"></script>

<!-- Sistema de Notificaciones -->
<script src="js/user-notifications.js"></script>

<script>
  // Inicializar cuando el usuario est√© logueado
  const userEmail = 'usuario@ejemplo.com'; // Obtener del sistema de login

  // Iniciar notificaciones
  const notifications = new UserNotificationSystem();
  notifications.init(userEmail);
</script>
```

### **En admin-usuarios.html (panel de administraci√≥n - NUEVO)**

Crear archivo `public/admin-usuarios.html`:

```html
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administraci√≥n - Gesti√≥n de Usuarios</title>
  <link rel="stylesheet" href="admin-usuarios.css">
</head>
<body>
  <div class="admin-container">
    <h1>üéØ Gesti√≥n de Usuarios</h1>

    <!-- Lista de usuarios -->
    <div id="users-list"></div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-client-frontend.js"></script>
  <script src="js/admin-manager.js"></script>

  <script>
    // Inicializar gestor
    const adminEmail = 'admin@remeexvisa.com';
    const adminManager = new AdminManager();
    adminManager.init(adminEmail);

    // Cargar usuarios
    async function loadUsers() {
      const result = await adminManager.getAllUsers();
      if (result.ok) {
        displayUsers(result.data);
      }
    }

    function displayUsers(users) {
      const container = document.getElementById('users-list');
      container.innerHTML = users.map(user => `
        <div class="user-card">
          <h3>${user.full_name}</h3>
          <p>${user.email}</p>
          <p>Saldo: $${user.user_balances?.current_balance || 0}</p>

          <button onclick="sendMoney('${user.email}')">üí∞ Enviar Dinero</button>
          <button onclick="blockUser('${user.email}')">üîí Bloquear</button>
          <button onclick="sendNotification('${user.email}')">üîî Notificar</button>
        </div>
      `).join('');
    }

    // Funciones de acci√≥n
    async function sendMoney(email) {
      const amount = prompt('¬øCu√°nto dinero enviar?');
      const description = prompt('Descripci√≥n (opcional):');

      if (amount) {
        const result = await adminManager.sendBalanceToUser(email, parseFloat(amount), description);
        if (result.ok) {
          alert('‚úÖ Transferencia enviada. El usuario puede aceptar o rechazar.');
        }
      }
    }

    async function blockUser(email) {
      const reason = prompt('Motivo del bloqueo:');
      if (reason) {
        const result = await adminManager.blockUser(email, reason);
        if (result.ok) {
          alert('‚úÖ Usuario bloqueado');
          loadUsers();
        }
      }
    }

    async function sendNotification(email) {
      const title = prompt('T√≠tulo de la notificaci√≥n:');
      const message = prompt('Mensaje:');

      if (title && message) {
        const result = await adminManager.sendNotification(email, {
          title,
          message,
          type: 'info',
          priority: 'normal',
          showAsOverlay: true
        });

        if (result.ok) {
          alert('‚úÖ Notificaci√≥n enviada');
        }
      }
    }

    // Cargar al iniciar
    loadUsers();
  </script>
</body>
</html>
```

---

## üöÄ Paso 3: Uso del Sistema

### **Como Administrador**

#### **1. Enviar Dinero a Usuario**

```javascript
const adminManager = new AdminManager();
await adminManager.init('admin@remeexvisa.com');

// Enviar $100 a un usuario
const result = await adminManager.sendBalanceToUser(
  'usuario@ejemplo.com',
  100.00,
  'Bono de bienvenida'
);

console.log('Transferencia ID:', result.transferId);
```

**¬øQu√© pasa?**
1. Se crea transferencia pendiente en BD
2. Usuario recibe notificaci√≥n overlay autom√°ticamente
3. Usuario ve: "Has recibido $100 USD. Bono de bienvenida"
4. Usuario puede: ‚úÖ Aceptar o ‚ùå Rechazar
5. Si acepta: saldo se actualiza, se crea transacci√≥n
6. Si rechaza: transferencia marcada como rechazada

#### **2. Bloquear Usuario**

```javascript
await adminManager.blockUser(
  'spammer@ejemplo.com',
  'Actividad sospechosa detectada'
);
```

**¬øQu√© pasa?**
1. Cuenta marcada como bloqueada
2. Usuario recibe notificaci√≥n overlay
3. Al intentar usar homevisa.html, ve:
   - "‚õî Cuenta Bloqueada"
   - "Motivo: Actividad sospechosa detectada"
   - Bot√≥n: "Contactar Soporte"

#### **3. Desbloquear Usuario**

```javascript
await adminManager.unblockUser('spammer@ejemplo.com');
```

**¬øQu√© pasa?**
1. Cuenta marcada como activa
2. Usuario recibe notificaci√≥n: "¬°Tu cuenta ha sido reactivada!"

#### **4. Enviar Notificaci√≥n**

```javascript
await adminManager.sendNotification('usuario@ejemplo.com', {
  title: 'Nuevas Funcionalidades',
  message: 'Hemos agregado nuevas opciones de transferencia. ¬°Pru√©balas!',
  type: 'info',
  priority: 'high',
  showAsOverlay: true,
  actionUrl: '/features',
  actionLabel: 'Ver Nuevas Funciones'
});
```

**Tipos disponibles**:
- `info` - Informaci√≥n (azul)
- `success` - √âxito (verde)
- `warning` - Advertencia (amarillo)
- `error` - Error (rojo)
- `transfer` - Transferencia (morado)
- `reminder` - Recordatorio (naranja)

**Prioridades**:
- `low` - Baja
- `normal` - Normal
- `high` - Alta
- `urgent` - Urgente

#### **5. Enviar Recordatorio**

```javascript
await adminManager.sendReminder(
  'usuario@ejemplo.com',
  'Recuerda validar tu cuenta para acceder a todas las funcionalidades'
);
```

#### **6. Modificar Monto de Validaci√≥n**

```javascript
await adminManager.updateValidationAmount('usuario@ejemplo.com', 10.00);
```

**Default**: $5.00 USD por usuario

#### **7. Notificaci√≥n Masiva**

```javascript
const emails = [
  'usuario1@ejemplo.com',
  'usuario2@ejemplo.com',
  'usuario3@ejemplo.com'
];

await adminManager.sendBulkNotification(emails, {
  title: 'Mantenimiento Programado',
  message: 'El sistema estar√° en mantenimiento ma√±ana de 2-4 AM',
  type: 'warning',
  priority: 'high',
  showAsOverlay: true
});
```

#### **8. Ver Logs de Actividad**

```javascript
// √öltimos 100 logs
const logs = await adminManager.getActivityLogs();

// Filtrar por admin
const logs = await adminManager.getActivityLogs({
  adminEmail: 'admin@remeexvisa.com',
  limit: 50
});

// Filtrar por usuario afectado
const logs = await adminManager.getActivityLogs({
  targetUser: 'usuario@ejemplo.com'
});

// Filtrar por tipo de acci√≥n
const logs = await adminManager.getActivityLogs({
  actionType: 'send_transfer'
});
```

**Tipos de acciones registradas**:
- `block_user` - Bloqueo de usuario
- `unblock_user` - Desbloqueo de usuario
- `send_transfer` - Env√≠o de transferencia
- `cancel_transfer` - Cancelaci√≥n de transferencia
- `send_notification` - Env√≠o de notificaci√≥n
- `update_validation_amount` - Actualizaci√≥n de monto de validaci√≥n
- `update_setting` - Actualizaci√≥n de configuraci√≥n

#### **9. Ver Transferencias Pendientes**

```javascript
// Todas las transferencias pendientes
const transfers = await adminManager.getPendingTransfers();

// De un usuario espec√≠fico
const transfers = await adminManager.getPendingTransfers('usuario@ejemplo.com');
```

#### **10. Cancelar Transferencia**

```javascript
await adminManager.cancelTransfer('uuid-de-transferencia');
```

#### **11. Obtener Todos los Usuarios**

```javascript
// Todos los usuarios
const users = await adminManager.getAllUsers();

// Filtrar solo bloqueados
const blockedUsers = await adminManager.getAllUsers({ blocked: true });

// Filtrar por status
const activeUsers = await adminManager.getAllUsers({ status: 'active' });

// Buscar por nombre/email
const results = await adminManager.getAllUsers({ search: 'juan' });
```

---

### **Como Usuario (Lado del Cliente)**

El usuario NO necesita hacer nada manualmente. El sistema funciona autom√°ticamente:

#### **Cuando el usuario entra a homevisa.html:**

```javascript
// Auto-inicializaci√≥n (ya incluido en el c√≥digo)
const userEmail = 'usuario@ejemplo.com'; // Del sistema de login

const notifications = new UserNotificationSystem();
await notifications.init(userEmail);
```

**El sistema autom√°ticamente**:
1. ‚úÖ Verifica si la cuenta est√° bloqueada ‚Üí Muestra overlay bloqueante
2. ‚úÖ Carga notificaciones no le√≠das ‚Üí Muestra overlay/toast
3. ‚úÖ Carga transferencias pendientes ‚Üí Muestra overlay para aceptar/rechazar
4. ‚úÖ Verifica estado de validaci√≥n ‚Üí Muestra aviso si no est√° validado
5. ‚úÖ Inicia polling cada 10 segundos ‚Üí Notificaciones en tiempo real

#### **Usuario ve overlay de transferencia:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                    ‚îÇ
‚îÇ            üí∞                      ‚îÇ
‚îÇ                                    ‚îÇ
‚îÇ   Nueva Transferencia              ‚îÇ
‚îÇ                                    ‚îÇ
‚îÇ   Has recibido $100 USD            ‚îÇ
‚îÇ   Bono de bienvenida               ‚îÇ
‚îÇ                                    ‚îÇ
‚îÇ   [‚úÖ Aceptar]  [‚ùå Rechazar]      ‚îÇ
‚îÇ                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

Click en **Aceptar**:
- Saldo actualizado
- Toast: "‚úÖ ¬°Transferencia aceptada! Tu saldo ha sido actualizado."
- Panel de saldo se refresca autom√°ticamente

Click en **Rechazar**:
- Transferencia cancelada
- Toast: "Transferencia rechazada"

#### **Usuario ve cuenta bloqueada:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                    ‚îÇ
‚îÇ            ‚õî                      ‚îÇ
‚îÇ                                    ‚îÇ
‚îÇ   Cuenta Bloqueada                 ‚îÇ
‚îÇ                                    ‚îÇ
‚îÇ   Tu cuenta ha sido suspendida.    ‚îÇ
‚îÇ                                    ‚îÇ
‚îÇ   Motivo: Actividad sospechosa     ‚îÇ
‚îÇ   detectada                        ‚îÇ
‚îÇ                                    ‚îÇ
‚îÇ   [Contactar Soporte]              ‚îÇ
‚îÇ                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**NO puede cerrar el overlay** - Solo puede contactar soporte

---

## üìä Estructura de Base de Datos

### **Tabla: notifications**

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id | UUID | ID √∫nico |
| user_email | TEXT | Email del usuario receptor |
| title | TEXT | T√≠tulo de la notificaci√≥n |
| message | TEXT | Mensaje completo |
| type | TEXT | info, success, warning, error, transfer, reminder |
| priority | TEXT | low, normal, high, urgent |
| is_read | BOOLEAN | Si fue le√≠da |
| show_as_overlay | BOOLEAN | Mostrar como overlay (modal) |
| action_url | TEXT | URL a donde redirigir |
| action_label | TEXT | Texto del bot√≥n de acci√≥n |
| created_by | TEXT | Email del admin que cre√≥ |
| created_at | TIMESTAMPTZ | Fecha de creaci√≥n |

### **Tabla: pending_transfers**

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id | UUID | ID √∫nico |
| user_email | TEXT | Usuario receptor |
| amount | NUMERIC | Monto a transferir |
| currency | TEXT | Moneda (USD por defecto) |
| description | TEXT | Descripci√≥n |
| status | TEXT | pending, accepted, rejected, expired, cancelled |
| user_response | TEXT | Respuesta del usuario |
| responded_at | TIMESTAMPTZ | Cu√°ndo respondi√≥ |
| created_by | TEXT | Admin que cre√≥ la transferencia |
| expires_at | TIMESTAMPTZ | Fecha de expiraci√≥n (7 d√≠as por defecto) |
| transaction_id | UUID | ID de la transacci√≥n final (si se acepta) |

### **Tabla: admin_activity_log**

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id | UUID | ID √∫nico |
| admin_email | TEXT | Email del admin |
| action_type | TEXT | Tipo de acci√≥n |
| target_user_email | TEXT | Usuario afectado |
| description | TEXT | Descripci√≥n de la acci√≥n |
| data | JSONB | Datos adicionales |
| created_at | TIMESTAMPTZ | Timestamp |

### **Tabla: admin_settings**

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| setting_key | TEXT | Clave √∫nica del setting |
| setting_value | JSONB | Valor (JSON flexible) |
| description | TEXT | Descripci√≥n |
| updated_by | TEXT | √öltimo admin que actualiz√≥ |

### **Campos Nuevos en `registrations`**

| Campo | Tipo | Default | Descripci√≥n |
|-------|------|---------|-------------|
| account_blocked | BOOLEAN | false | Si cuenta est√° bloqueada |
| block_reason | TEXT | NULL | Motivo del bloqueo |
| blocked_at | TIMESTAMPTZ | NULL | Cu√°ndo fue bloqueada |
| blocked_by | TEXT | NULL | Admin que bloque√≥ |
| validation_amount | NUMERIC | 5.00 | Monto de validaci√≥n requerido |
| is_validated | BOOLEAN | false | Si cuenta est√° validada |
| validated_at | TIMESTAMPTZ | NULL | Cu√°ndo se valid√≥ |
| admin_notes | TEXT | NULL | Notas del administrador |

---

## üß™ Ejemplos Pr√°cticos

### **Ejemplo 1: Promoci√≥n de Bienvenida**

```javascript
// Obtener usuarios nuevos (√∫ltimos 7 d√≠as)
const { data: newUsers } = await supabase
  .from('registrations')
  .select('email')
  .gte('created_at', new Date(Date.now() - 7*24*60*60*1000).toISOString());

// Enviar $10 a cada uno
for (const user of newUsers) {
  await adminManager.sendBalanceToUser(
    user.email,
    10.00,
    '¬°Bienvenido a REMEEX VISA! Aqu√≠ tienes $10 de regalo üéÅ'
  );
}
```

### **Ejemplo 2: Recordatorio de Validaci√≥n**

```javascript
// Obtener usuarios sin validar
const { data: unvalidated } = await supabase
  .from('registrations')
  .select('email, validation_amount')
  .eq('is_validated', false);

// Enviar recordatorio
for (const user of unvalidated) {
  await adminManager.sendReminder(
    user.email,
    `Recuerda validar tu cuenta con $${user.validation_amount} para acceder a todas las funcionalidades`
  );
}
```

### **Ejemplo 3: Bloqueo Masivo**

```javascript
// Bloquear m√∫ltiples cuentas sospechosas
const suspiciousEmails = ['spam1@example.com', 'spam2@example.com'];

for (const email of suspiciousEmails) {
  await adminManager.blockUser(email, 'Actividad sospechosa detectada');
}
```

### **Ejemplo 4: Dashboard de Admin**

```javascript
// Obtener estad√≠sticas
const allUsers = await adminManager.getAllUsers();
const blockedUsers = await adminManager.getAllUsers({ blocked: true });
const pendingTransfers = await adminManager.getPendingTransfers();
const recentLogs = await adminManager.getActivityLogs({ limit: 10 });

console.log('Total usuarios:', allUsers.data.length);
console.log('Bloqueados:', blockedUsers.data.length);
console.log('Transferencias pendientes:', pendingTransfers.data.length);
console.log('√öltima actividad:', recentLogs.data[0]);
```

---

## ‚ö†Ô∏è Consideraciones Importantes

### **Seguridad**

1. **Autenticaci√≥n Admin**: Actualmente usa localStorage. Para producci√≥n, implementa autenticaci√≥n real con Supabase Auth.

2. **Validaci√≥n de Permisos**: Las pol√≠ticas RLS est√°n abiertas. Debes configurarlas para que solo admins puedan escribir.

3. **Logs Inmutables**: Los logs de actividad no se pueden borrar (solo lectura para auditor√≠a).

### **L√≠mites**

- Transferencias expiran en 7 d√≠as (configurable)
- Notificaciones le√≠das se mantienen 30 d√≠as (configurable)
- Polling cada 10 segundos (configurable)

### **Rendimiento**

- Usa √≠ndices en BD para b√∫squedas r√°pidas
- Polling optimizado con timestamps
- Overlay no bloquea funcionalidad cr√≠tica

---

## üìù Checklist de Implementaci√≥n

- [ ] Ejecutar `SUPABASE_ADMIN_SCHEMA.sql` en Supabase
- [ ] Verificar que las 4 tablas se crearon
- [ ] Incluir scripts en homevisa.html
- [ ] Crear admin-usuarios.html (panel de gesti√≥n)
- [ ] Probar env√≠o de transferencia
- [ ] Probar aceptar/rechazar transferencia
- [ ] Probar bloqueo de cuenta
- [ ] Probar env√≠o de notificaci√≥n
- [ ] Verificar logs de actividad
- [ ] Configurar polling interval (si es necesario)

---

## üéâ Resultado Final

**Como Admin puedes**:
‚úÖ Enviar dinero a usuarios (con aprobaci√≥n)
‚úÖ Bloquear/desbloquear cuentas
‚úÖ Enviar notificaciones overlay/toast
‚úÖ Modificar montos de validaci√≥n
‚úÖ Enviar recordatorios personalizados
‚úÖ Ver logs completos de actividad
‚úÖ Gestionar transferencias pendientes
‚úÖ Configuraci√≥n global del sistema

**El usuario ver√°**:
‚úÖ Overlays de notificaciones autom√°ticos
‚úÖ Opciones para aceptar/rechazar transferencias
‚úÖ Avisos de cuenta bloqueada
‚úÖ Recordatorios personalizados
‚úÖ Actualizaciones de saldo en tiempo real
‚úÖ Sistema completamente autom√°tico (sin intervenci√≥n manual)

**Todo en tiempo real, autom√°tico y sin backend adicional** üöÄ
